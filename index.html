<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University of San Agustin Comprehensive Exam Countdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&display=swap');
        
        /* Custom Font for the Title (Mimics Excel/Google Sheets Look) */
        .header-font {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
        }

        /* Custom Styles for the Maroon/Brown Theme */
        .header-bg {
            background-color: #6d1b1b; /* Deep Maroon/Brown */
            border-bottom: 5px solid #a32a2a;
        }
        .card-header-bg {
            background-color: #7f2b2b; /* Slightly lighter maroon for card headers */
        }

        /* Countdown Display Styles */
        .time-value {
            font-size: 2rem; /* REDUCED SIZE: 2rem (32px) for better balance */
            font-weight: 900;
            line-height: 1;
            color: #1a202c; /* Dark text */
        }
        .time-label {
            font-size: 0.875rem; /* 14px */
            font-weight: 700;
            color: #4a5568; /* Gray text */
            text-transform: uppercase;
        }
        
        /* DATE EMPHASIS STYLES (REVISED & CLEANED) */
        .date-display-wrapper { 
            display: inline-block; /* Ensure click area fits content */
            padding-bottom: 0;
            cursor: pointer;
            transition: color 0.2s;
        }
        .date-display-wrapper:hover .date-text {
            color: #1d4ed8; /* Dark blue color on hover */
        }
        .date-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.25rem;
            font-weight: 800;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            line-height: 1; 
        }
        .edit-icon {
            display: none;
        }

        /* SYLLABUS PANEL STYLES - Kept here since they apply to the dynamically loaded content */
        .syllabus-panel-container {
            border-radius: 0.75rem; 
            overflow: hidden;
        }
        .syllabus-header {
            background-color: #674ea7;
            border-left: 5px solid #8e7cc3;
        }
        .syllabus-summary {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            list-style: none;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .syllabus-summary-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .syllabus-progress-metrics {
            display: flex;
            gap: 1.5rem; 
            align-items: center;
            width: 100%;
            font-size: 0.75rem; 
        }
        .progress-stats {
            display: flex;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .progress-overall-text {
            white-space: nowrap;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        /* CHEVRONS */
        .main-summary-chevron {
            transition: transform 0.2s;
        }
        .syllabus-panel[open] > .syllabus-summary .main-summary-chevron {
            transform: rotate(90deg);
        }

        .syllabus-summary::-webkit-details-marker { display: none; }
        .syllabus-content {
            padding: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        /* DEPTH 1 SECTION STYLES */
        .syllabus-sub-section {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
        }
        .topic-header {
            background-color: #ede9fe; /* Pastel Purple (Violet-100) */
            padding: 0.75rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            list-style: none;
        }
        .topic-header::-webkit-details-marker { display: none; }
        .chevron-icon {
            transition: transform 0.2s;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .syllabus-sub-section[open] > details > .topic-header .chevron-icon {
            transform: rotate(90deg);
        }
        
        /* DEPTH 2 COLLAPSIBLE STYLES (New) */
        .depth2-details {
            list-style: none; /* Hide default marker */
            margin-bottom: 0.25rem; /* Slight spacing for inner container */
            border: 1px solid #f3f4f6;
            border-radius: 0.375rem;
            overflow: hidden;
            background-color: #fafafa;
        }
        .depth2-details > summary {
             /* Ensure summary element respects layout but hides marker */
            list-style: none;
            cursor: pointer;
            padding: 0;
            background-color: #ffffff; /* Contrast with the wrapper */
        }
        .depth2-details > summary::-webkit-details-marker {
            display: none;
        }
        .depth2-chevron {
            transition: transform 0.2s;
            transform: rotate(0deg); /* Collapsed state */
            flex-shrink: 0;
            margin-right: 0.5rem; /* Space between chevron and text */
        }
        .depth2-details[open] .depth2-chevron {
            transform: rotate(90deg);
        }

        /* CHECKLIST GRID STYLES */
        .font-trackable-lg {
            font-size: 1rem;
            font-weight: 600;
        }
        .checklist-grid {
            display: grid;
            grid-template-columns: 2fr repeat(5, 70px) minmax(40px, 50px); 
            gap: 0.2rem;
            padding: 0.5rem 0;
            align-items: center;
            border-bottom: 1px dashed #e5e7eb;
        }
        /* MODIFIED: Ensure the topic column is a flex container for vertical centering */
        .checklist-grid > div:first-child {
            padding-left: 1.5rem;
            font-size: 0.875rem;
            color: #374151;
            /* New: Ensure content inside is vertically centered */
            display: flex; 
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
        }
        
        /* NEW: Style for the content wrapper inside the first cell to align text/chevron */
        .topic-content-wrapper {
             display: flex;
             align-items: center; /* Vertical center alignment */
             padding-left: 0.5rem; /* Added slight indentation here for the content within the cell */
        }
        /* Reset spacing for the Header row's first child */
        .checklist-grid.checklist-grid-header > div:first-child {
            padding-left: 0;
            align-items: center;
            text-align: center;
        }
        .checklist-grid > div:nth-child(n+2):nth-child(-n+6) {
            border-right: 1px dashed #d1d5db;
        }
        .checklist-grid > div:nth-child(6) {
            border-right: none;
        }

        .checklist-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #4b5563;
            text-align: center;
            word-break: keep-all; 
            padding: 0 0.1rem;
            line-height: 1.1;
        }
        .progress-bar-container {
            height: 0.75rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            width: 100%;
            flex-grow: 1;
            max-width: none;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .tick-all-icon {
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
            color: #9ca3af;
        }
        .tick-all-icon.checked {
            color: #10b981;
        }
        .tick-all-icon.partial {
            color: #f59e0b;
        }
        .tick-all-icon:hover {
            transform: scale(1.1);
        }
        .col-progress-bar-container {
            height: 0.4rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 0.25rem;
            width: 100%;
        }
        .col-progress-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }

        /* COLUMN COLORS */
        .col-progress-codal { background-color: #8b5cf6; } 
        .col-progress-lectures { background-color: #facc15; } 
        .col-progress-reviewer { background-color: #3b82f6; } 
        .col-progress-barqas { background-color: #10b981; } 
        .col-progress-cases { background-color: #f97316; } 
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    
    <div class="max-w-6xl mx-auto space-y-4">

        <header class="header-bg text-white p-4 sm:p-6 rounded-xl shadow-2xl">
            <div class="flex items-center justify-between">
                
                <div class="flex-shrink-0 w-16 h-16 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/USA.png" 
                            alt="USA Logo" 
                            class="w-full h-full object-cover"
                            onerror="this.outerHTML = '<i data-lucide=\'graduation-cap\' class=\'w-12 h-12 text-yellow-300\'></i>'">
                </div>
                
                <div class="text-center mx-4 flex-grow">
                    <h1 class="text-xl sm:text-3xl font-extrabold header-font tracking-wider mb-2 underline">
                        UNIVERSITY OF SAN AGUSTIN
                    </h1>
                    <h2 class="text-3xl sm:text-5xl italic font-extrabold header-font tracking-widest" style="text-shadow: 2px 2px 0 #000000;">
                        2026 COMPREHENSIVE EXAM REVIEW TRACKER
                    </h2>
                </div>
                
                <div class="flex-shrink-0 w-24 h-24 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/usacol%20logo.png" 
                            alt="USACoL Logo" 
                            class="w-full h-full object-cover"
                            onerror="this.outerHTML = '<i data-lucide=\'shield\' class=\'w-12 h-12 text-yellow-300\'></i>'">
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div id="card-day-1" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <div class="flex items-center justify-between card-header-bg text-white p-3 text-lg font-bold text-center border-b-4 border-black/50">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>
                    Comprehensive Exam Day 1
                    <i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                
                <div class="p-4 text-center">
                    
                    <div class="mb-4 flex justify-center items-center">
                        <span id="target-date-display-1" 
                                class="date-display-wrapper"
                                data-target-date="2026-06-14">
                            <span class="date-text"></span>
                        </span>
                    </div>

                    <div class="grid grid-cols-4 py-3 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col">
                            <span id="days-1" class="time-value">000</span>
                            <span class="time-label">Days</span>
                        </div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300">
                            <span id="hrs-1" class="time-value">00</span>
                            <span class="time-label">Hrs</span>
                        </div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300">
                            <span id="mins-1" class="time-value">00</span>
                            <span class="time-label">Mins</span>
                        </div>
                        <div class="flex flex-col">
                            <span id="secs-1" class="time-value">00</span>
                            <span class="time-label">Secs</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="card-day-2" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <div class="flex items-center justify-between card-header-bg text-white p-3 text-lg font-bold text-center border-b-4 border-black/50">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>
                    Comprehensive Exam Day 2
                    <i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                
                <div class="p-4 text-center">
                    <div class="mb-4 flex justify-center items-center">
                        <span id="target-date-display-2" 
                                class="date-display-wrapper"
                                data-target-date="2026-06-21">
                            <span class="date-text"></span>
                        </span>
                    </div>

                    <div class="grid grid-cols-4 py-3 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col">
                            <span id="days-2" class="time-value">000</span>
                            <span class="time-label">Days</span>
                        </div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300">
                            <span id="hrs-2" class="time-value">00</span>
                            <span class="time-label">Hrs</span>
                        </div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300">
                            <span id="mins-2" class="time-value">00</span>
                            <span class="time-label">Mins</span>
                        </div>
                        <div class="flex flex-col">
                            <span id="secs-2" class="time-value">00</span>
                            <span class="time-label">Secs</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="card-day-3" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <div class="flex items-center justify-between card-header-bg text-white p-3 text-lg font-bold text-center border-b-4 border-black/50">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>
                    Comprehensive Exam Day 3
                    <i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                
                <div class="p-4 text-center">
                    <div class="mb-4 flex justify-center items-center">
                        <span id="target-date-display-3" 
                                class="date-display-wrapper"
                                data-target-date="2026-06-28">
                            <span class="date-text"></span>
                        </span>
                    </div>

                    <div class="grid grid-cols-4 py-3 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col">
                            <span id="days-3" class="time-value">000</span>
                            <span class="time-label">Days</span>
                        </div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300">
                            <span id="hrs-3" class="time-value">00</span>
                            <span class="time-label">Hrs</span>
                        </div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300">
                            <span id="mins-3" class="time-value">00</span>
                            <span class="time-label">Mins</span>
                        </div>
                        <div class="flex flex-col">
                            <span id="secs-3" class="time-value">00</span>
                            <span class="time-label">Secs</span>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div id="rem-ethics-tracker-container">
            <p class="text-center p-8 text-gray-500">Loading Remedial Law Tracker...</p>
        </div>

    </div>

    <div id="date-edit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Edit Target Date</h3>
            <label for="new-target-date" class="block text-sm font-medium text-gray-700 mb-2">Select New Date:</label>
            <input type="date" id="new-target-date" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
            
            <p id="modal-error" class="text-sm text-red-600 hidden mb-4">Please select a future date.</p>

            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-upload-input" accept=".json" class="hidden">

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-sm">
            <h3 id="message-modal-title" class="text-xl font-bold text-gray-900 mb-4">Message</h3>
            <div id="message-modal-content" class="text-sm text-gray-700 mb-4 break-words"></div>
            
            <div id="modal-actions" class="flex justify-end space-x-3 mt-4">
                <button id="message-modal-close-btn" class="px-3 py-1.5 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Close</button>
            </div>
        </div>
    </div>


    <script>
        // GLOBAL VARIABLES - REM_ETHICS_SYLLABUS will be populated after the syllabus HTML file is loaded.
        let REM_ETHICS_SYLLABUS = [];
        let TOPICS_WITH_CHILDREN = new Set();
        
        // Column names used for storage keys (corresponding to CSV columns 11-15)
        const CHECKLIST_COLUMNS = ['codal', 'books', 'reviewer', 'barqas', 'cases'];
        const SYLLABUS_STORAGE_KEY = 'rem_ethics_progress';

        const COUNTDOWN_DATA = [
            { id: 1, targetDate: localStorage.getItem('comp_exam_date_1') || '2026-06-14' },
            { id: 2, targetDate: localStorage.getItem('comp_exam_date_2') || '2026-06-21' },
            { id: 3, targetDate: localStorage.getItem('comp_exam_date_3') || '2026-06-28' },
        ];

        const DOM_ELEMENTS = {
            modal: document.getElementById('date-edit-modal'),
            modalTitle: document.getElementById('modal-title'),
            dateInput: document.getElementById('new-target-date'),
            saveBtn: document.getElementById('modal-save-btn'),
            cancelBtn: document.getElementById('modal-cancel-btn'),
            errorMsg: document.getElementById('modal-error'),
            // These will be defined when the external HTML is loaded:
            syllabusContainer: null, 
            progressDisplay: null,
            progressDone: null,
            progressToRead: null,
            progressBar: null,
            importBtn: null,
            exportBtn: null,
            collapseBtn: null,
            
            fileUploadInput: document.getElementById('file-upload-input'),
            messageModal: document.getElementById('message-modal'),
            messageModalTitle: document.getElementById('message-modal-title'),
            messageModalContent: document.getElementById('message-modal-content'),
            messageModalCloseBtn: document.getElementById('message-modal-close-btn'),
        };
        
        let currentEditingId = null; 
        
        function hasChildren(topicId) {
            return TOPICS_WITH_CHILDREN.has(topicId);
        }
        
        // === SYLLABUS PROGRESS LOGIC ===

        function getSyllabusProgress() {
            try {
                const saved = localStorage.getItem(SYLLABUS_STORAGE_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error("Error loading syllabus progress:", e);
                return {};
            }
        }

        function saveSyllabusProgress(progressData) {
            localStorage.setItem(SYLLABUS_STORAGE_KEY, JSON.stringify(progressData));
            updateOverallProgress();
        }

        function handleCheckboxChange(event) {
            const checkbox = event.target;
            const id = checkbox.dataset.id;
            const column = checkbox.dataset.column;
            const isChecked = checkbox.checked;

            const progressData = getSyllabusProgress();
            
            if (!progressData[id]) {
                progressData[id] = {};
            }
            progressData[id][column] = isChecked;

            // Re-render the panel to update the row/section tick-all icons instantly
            saveSyllabusProgress(progressData);
            renderSyllabusPanel();
        }

        function getTopicStatus(topicId, progressData) {
            const topic = REM_ETHICS_SYLLABUS.find(t => t.id === topicId);
            if (!topic) return 0;

            if (topic.depth === 1) {
                let sectionBoxesTotal = 0;
                let sectionBoxesChecked = 0;
                const startIndex = REM_ETHICS_SYLLABUS.findIndex(t => t.id === topicId);
                
                for (let i = startIndex; i < REM_ETHICS_SYLLABUS.length; i++) {
                    const currentItem = REM_ETHICS_SYLLABUS[i];
                    if (i > startIndex && currentItem.depth <= topic.depth) break;
                    
                    if (currentItem.depth === 2 && currentItem.trackable) { 
                        const prog = progressData[currentItem.id] || {};
                        CHECKLIST_COLUMNS.forEach(col => {
                            sectionBoxesTotal++;
                            if (prog[col] === true) sectionBoxesChecked++;
                        });
                    }
                }
                if (sectionBoxesTotal === 0) return 0;
                if (sectionBoxesChecked === sectionBoxesTotal) return 2;
                if (sectionBoxesChecked > 0) return 1;
                return 0;
            } else if (topic.trackable) {
                const topicProgress = progressData[topicId] || {};
                const checkedCount = CHECKLIST_COLUMNS.filter(col => topicProgress[col] === true).length;
                if (checkedCount === CHECKLIST_COLUMNS.length) return 2;
                if (checkedCount > 0) return 1;
                return 0;
            }
            return 0;
        }

        function handleTickAll(topicId) {
            const progressData = getSyllabusProgress();
            let topicsToUpdate = [];
            const currentStatus = getTopicStatus(topicId, progressData);
            const targetState = (currentStatus === 2) ? false : true; 

            const item = REM_ETHICS_SYLLABUS.find(t => t.id === topicId);
            if (!item) return;

            const startDepth = item.depth;
            const startIndex = REM_ETHICS_SYLLABUS.findIndex(t => t.id === topicId);
            
            if (startDepth === 2 && item.trackable) {
                topicsToUpdate.push(item);
            } else if (startDepth === 1) {
                for (let i = startIndex; i < REM_ETHICS_SYLLABUS.length; i++) {
                    const currentItem = REM_ETHICS_SYLLABUS[i];
                    if (i > startIndex && currentItem.depth <= startDepth) break;
                    
                    if (currentItem.depth === 2 && currentItem.trackable) {
                        topicsToUpdate.push(currentItem);
                    }
                }
            }

            topicsToUpdate.forEach(topic => {
                const id = topic.id;
                if (!progressData[id]) {
                    progressData[id] = {};
                }
                CHECKLIST_COLUMNS.forEach(col => {
                    progressData[id][col] = targetState;
                });
            });

            saveSyllabusProgress(progressData);
            renderSyllabusPanel();
        }

        function updateOverallProgress() {
            if (!DOM_ELEMENTS.progressDone) return; // Exit if elements haven't been loaded yet

            const progressData = getSyllabusProgress();
            const mainTopics = REM_ETHICS_SYLLABUS.filter(t => t.depth === 2 && t.trackable);
            
            let topicsDoneCount = 0;
            let topicsToReadCount = 0;
            const columnProgress = CHECKLIST_COLUMNS.map(() => 0);
            const totalMainTopics = mainTopics.length;
            
            mainTopics.forEach(topic => {
                const topicProgress = progressData[topic.id] || {};
                let boxesTicked = 0;

                CHECKLIST_COLUMNS.forEach((col, index) => {
                    if (topicProgress[col] === true) {
                        boxesTicked++;
                        columnProgress[index]++;
                    }
                });

                if (boxesTicked >= 3) {
                    topicsDoneCount++;
                } else {
                    topicsToReadCount++;
                }
            });

            const overallProgressPercentage = (totalMainTopics > 0) 
                ? ((topicsDoneCount / totalMainTopics) * 100).toFixed(1)
                : 0.0;
            
            let barColor;
            if (overallProgressPercentage <= 25) {
                barColor = '#ef4444';
            } else if (overallProgressPercentage <= 50) {
                barColor = '#f97316';
            } else if (overallProgressPercentage <= 75) {
                barColor = '#facc15';
            } else {
                barColor = '#10b981';
            }

            DOM_ELEMENTS.progressDisplay.textContent = `(${overallProgressPercentage}%)`;
            DOM_ELEMENTS.progressDone.textContent = topicsDoneCount;
            DOM_ELEMENTS.progressToRead.textContent = topicsToReadCount;
            
            if (DOM_ELEMENTS.progressBar) {
                 DOM_ELEMENTS.progressBar.style.width = `${overallProgressPercentage}%`;
                 DOM_ELEMENTS.progressBar.style.backgroundColor = barColor;
            }

            const columnHeaderNames = ['codal', 'books', 'reviewer', 'barqas', 'cases'];
            columnProgress.forEach((tickedCount, index) => {
                const elementId = `col-progress-bar-${columnHeaderNames[index]}`;
                const percentElementId = `col-percent-${columnHeaderNames[index]}`; 
                const barElement = document.getElementById(elementId);
                const percentElement = document.getElementById(percentElementId); 
                
                if (barElement) {
                    const colPercentage = (totalMainTopics > 0) 
                        ? ((tickedCount / totalMainTopics) * 100).toFixed(1)
                        : 0.0;
                    barElement.style.width = `${colPercentage}%`;

                    if (percentElement) {
                        percentElement.textContent = `${colPercentage}%`;
                    }
                }
            });
        }
        
        function renderSyllabusPanel() {
            if (!DOM_ELEMENTS.syllabusContainer) return;

            // Capture the open state of all sections BEFORE rerender
            const openSections = {};
            document.querySelectorAll('.syllabus-panel details, .depth2-details').forEach(details => {
                if (details.id) { openSections[details.id] = details.open; }
            });
            
            // Update main summary chevron state based on current main details state
            const mainDetails = document.querySelector('.syllabus-panel');
            const mainChevron = document.querySelector('.main-summary-chevron');
            if (mainDetails && mainChevron) {
                mainChevron.style.transform = mainDetails.open ? 'rotate(90deg)' : 'rotate(0deg)';
            }

            const progress = getSyllabusProgress();
            let html = '';
            let currentSectionOpen = false; // Tracks if a DEPTH 1 section is open
            let isDepth2Open = false; // Tracks if a collapsible DEPTH 2 section is currently open

            REM_ETHICS_SYLLABUS.forEach((item, index) => {
                const topicId = item.id;
                const nextItem = REM_ETHICS_SYLLABUS[index + 1];

                const currentStatus = getTopicStatus(topicId, progress);
                const iconName = (currentStatus === 2) ? 'circle-dot' : (currentStatus === 1 ? 'circle-half' : 'circle');
                const iconColor = (currentStatus === 2) ? 'checked' : (currentStatus === 1 ? 'partial' : 'empty');
                const iconSize = item.depth === 1 ? 'w-5 h-5' : 'w-4 h-4'; 
                const iconTitle = (currentStatus === 2) ? 'Clear All' : (currentStatus === 1 ? 'Clear All' : 'Tick All');

                if (item.depth === 1) {
                    // ------------------------------------
                    // 1. DEPTH 1: MAJOR SECTION
                    // ------------------------------------
                    
                    // Close previous DEPTH 2 block if it was open
                    if (isDepth2Open) {
                        html += `</div></details></div>`; // Close .depth3-content-wrapper, </details>, .depth2-details
                        isDepth2Open = false;
                    }
                    
                    // Close previous DEPTH 1 section if it was open
                    if (currentSectionOpen) {
                        html += `</div></details></div>`; // Close DEPTH 1 content div and details tag
                    }

                    // Start new DEPTH 1 collapsible section
                    const sectionId = `section-${item.id}`;
                    const isOpen = (openSections[sectionId] === true) || (item.id === 1 && openSections[sectionId] !== false); 
                    const openAttr = isOpen ? 'open' : '';

                    html += `
                        <div class="syllabus-sub-section">
                            <details id="${sectionId}" class="w-full" ${openAttr}>
                                <summary class="topic-header">
                                    <div class="topic-header-text">
                                        <i data-lucide="chevron-right" class="w-4 h-4 mr-2 chevron-icon"></i>
                                        <span class="font-extrabold text-lg text-black/90">${item.topic}</span>
                                    </div>
                                    <i data-lucide="${iconName}" 
                                       class="tick-all-icon ${iconColor} ${iconSize} flex-shrink-0" 
                                       title="${iconTitle}"
                                       onclick="handleTickAll(${item.id}); event.stopPropagation(); event.preventDefault();"></i>
                                </summary>
                                <div class="p-2">
                    `;
                    currentSectionOpen = true;

                } else if (item.depth === 2 && item.trackable) {
                    // ------------------------------------
                    // 2. DEPTH 2: TRACKABLE TOPIC
                    // ------------------------------------
                    
                    const topicProgress = progress[topicId] || {};
                    const isCollapsible = hasChildren(topicId);
                    
                    // Close previous DEPTH 2 block if it was open AND the current item is NOT its child
                    if (isDepth2Open && !isCollapsible) {
                        html += `</div></details></div>`; // Close .depth3-content-wrapper, </details>, .depth2-details
                        isDepth2Open = false;
                    }

                    const checklist = CHECKLIST_COLUMNS.map(col => {
                        const checked = topicProgress[col] === true ? 'checked' : '';
                        return `
                            <div class="flex justify-center">
                                <input type="checkbox" data-id="${topicId}" data-column="${col}" ${checked} class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 syllabus-checkbox">
                            </div>
                        `;
                    }).join('');

                    let rowContent = `
                        <div class="col-span-1 font-trackable-lg">
                            <div class="topic-content-wrapper" style="padding-left: 1.5rem;"> 
                                ${isCollapsible ? `<i data-lucide="chevron-right" class="w-3 h-3 depth2-chevron"></i>` : `<span class="w-3 h-3 mr-2 inline-block"></span>`}
                                ${item.topic}
                            </div>
                        </div>
                        ${checklist}
                        <div class="flex items-center justify-center space-x-1 pl-2">
                            <i data-lucide="${iconName}" 
                               class="tick-all-icon w-4 h-4 ${iconColor}" 
                               title="${iconTitle}"
                               onclick="handleTickAll(${item.id}); event.stopPropagation(); event.preventDefault();"></i>
                        </div>
                    `;
                    
                    if (isCollapsible) {
                        const depth2Id = `depth2-${item.id}`;
                        const isOpen = openSections[depth22Id] === true;
                        const openAttr = isOpen ? 'open' : '';
                        
                        html += `<div class="depth2-details">`;
                        html += `<details id="${depth2Id}" class="w-full" ${openAttr}>`;
                        html += `<summary class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</summary>`;
                        html += `<div class="depth3-content-wrapper pt-1 pb-2">`; 
                        isDepth2Open = true;
                    } else {
                        html += `<div class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</div>`;
                    }


                } else if (item.depth >= 3) {
                    // ------------------------------------
                    // 3. DEPTH 3+ : UNTRACKABLE SUB-TOPICS
                    // ------------------------------------
                    
                    // Dynamic padding calculation
                    const dynamicPadding = ((item.depth - 3) * 1.25) + 4.5; 
                    const fontStyle = item.depth <= 4 ? 'font-medium' : 'font-normal'; 
                    
                    html += `<div class="p-1 border-b border-black/10 text-black/70 italic ${fontStyle} text-sm" style="padding-left: ${dynamicPadding}rem;">${item.topic}</div>`;
                }
                
                // Final closing logic for the depth 2 collapsible block
                if (item.depth >= 3 && isDepth2Open && (!nextItem || nextItem.depth <= 2)) {
                    html += `</div></details></div>`; // Close .depth3-content-wrapper, </details>, .depth2-details
                    isDepth2Open = false;
                }
            });

            // Close the very last DEPTH 1 section
            if (currentSectionOpen) {
                if (isDepth2Open) {
                    html += `</div></details></div>`; // Close final DEPTH 2 block
                }
                html += `</div></details></div>`; // Close final DEPTH 1 block
            }

            DOM_ELEMENTS.syllabusContainer.innerHTML = html;

            // Re-attach listeners to newly rendered elements
            document.querySelectorAll('.syllabus-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
            
            // Re-attach toggle listener to newly rendered Depth 2 details elements
            document.querySelectorAll('.depth2-details details').forEach(details => {
                 details.addEventListener('toggle', (event) => {
                     if (lucide && lucide.createIcons) {
                        lucide.createIcons();
                     }
                 });
             });


            // Rerender icons after updating content
            if (lucide && lucide.createIcons) {
                lucide.createIcons();
            }

            updateOverallProgress();
            updateCollapseButtonText();
        }
        
        function handleMainPanelToggle() {
            const mainChevron = document.querySelector('.main-summary-chevron');
            const mainDetails = document.querySelector('.syllabus-panel');

            if (mainDetails.open) {
                mainChevron.style.transform = 'rotate(90deg)';
            } else {
                mainChevron.style.transform = 'rotate(0deg)';
            }
        }
        
        // === IMPORT / EXPORT / COLLAPSE LOGIC ===
        
        function downloadFile(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showMessageModal(title, content) {
            const modal = document.getElementById('message-modal');
            const titleEl = document.getElementById('message-modal-title');
            const contentEl = document.getElementById('message-modal-content');
            
            if (titleEl) titleEl.textContent = title;
            if (contentEl) contentEl.innerHTML = content;
            
            const actionsEl = document.getElementById('modal-actions');
            if (actionsEl) {
                 actionsEl.innerHTML = `
                     <button id="message-modal-close-btn" class="px-3 py-1.5 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Close</button>
                 `;
            }
            
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.getElementById('message-modal-close-btn')?.addEventListener('click', closeMessageModal);
            }
        }
        
        function closeMessageModal() {
            const modal = document.getElementById('message-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        function exportProgress() {
            const progressData = localStorage.getItem(SYLLABUS_STORAGE_KEY);
            
            if (!progressData || progressData === '{}') {
                showMessageModal("Download Failed", "<p class='text-red-600'>No progress data found to download.</p>");
                return;
            }

            downloadFile(progressData, 'rem-ethics-progress.json', 'application/json');
            showMessageModal("Download Complete", "<p class='text-green-600'>Your progress has been downloaded as **rem-ethics-progress.json**.</p>");
        }

        function importProgress() {
            DOM_ELEMENTS.fileUploadInput.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];

            if (!file) {
                showMessageModal("Upload Canceled", "No file was selected for upload.");
                return;
            }

            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                showMessageModal("Upload Error", `<p class='text-red-600'>Invalid file type. Please upload a **.json** file.</p>`);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const jsonString = e.target.result;
                try {
                    const importedData = JSON.parse(jsonString);
                    if (typeof importedData !== 'object' || importedData === null) {
                        throw new Error("Invalid JSON structure.");
                    }
                    
                    saveSyllabusProgress(importedData); 
                    renderSyllabusPanel();
                    showMessageModal("Success!", "<p class='text-green-600'>Progress successfully uploaded and applied.</p>");

                } catch (e) {
                    console.error("Import error:", e);
                    showMessageModal("Upload Error", `<p class='text-red-600'>Failed to upload. The file content is not valid JSON.</p>`);
                }
            };
            reader.onerror = function() {
                showMessageModal("Upload Error", `<p class='text-red-600'>Error reading the file.</p>`);
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function toggleAllSections() {
            // Include both Depth 1 (.syllabus-panel details) and Depth 2 (.depth2-details details) elements
            const allDetails = document.querySelectorAll('.syllabus-panel details, .depth2-details details');
            
            // Check if ANY section is currently CLOSED. If yes, the goal is to OPEN ALL.
            let shouldOpen = false;
            for (const details of allDetails) {
                if (!details.open) {
                    shouldOpen = true;
                    break;
                }
            }

            allDetails.forEach(details => {
                details.open = shouldOpen;
            });
            
            if (lucide && lucide.createIcons) {
                 lucide.createIcons();
            }
            updateCollapseButtonText(shouldOpen);
        }

        function updateCollapseButtonText(isOpen) {
            const btn = DOM_ELEMENTS.collapseBtn;
            if (btn) {
                if (typeof isOpen === 'undefined') {
                    const allDetails = document.querySelectorAll('.syllabus-panel details, .depth2-details details');
                    let anyClosed = false;
                    for (const details of allDetails) {
                        if (!details.open) {
                            anyClosed = true;
                            break;
                        }
                    }
                    isOpen = !anyClosed;
                }
                const iconName = isOpen ? 'chevrons-up' : 'chevrons-down';
                const text = isOpen ? 'Collapse All' : 'Expand All';

                btn.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4 mr-1"></i> ${text}`;
                
                if (!btn.classList.contains('flex')) {
                    btn.classList.add('flex', 'items-center', 'justify-center');
                }

                if (lucide && lucide.createIcons) {
                    lucide.createIcons();
                }
            }
        }

        // === DATE FORMATTING / COUNTDOWN LOGIC (Untouched) ===
        function formatUniqueDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
        }
        function formatNumber(num) {
            return num.toString().padStart(num >= 100 ? 3 : 2, '0');
        }
        function calculateCountdown(targetDateString, id) {
            const now = new Date();
            const target = new Date(targetDateString + 'T00:00:00Z'); 
            
            if (target <= now) {
                const elements = [`days-${id}`, `hrs-${id}`, `mins-${id}`, `secs-${id}`];
                elements.forEach(elId => {
                    const el = document.getElementById(elId);
                    if (el) el.textContent = (elId === `days-${id}`) ? '000' : '00';
                });
                return;
            }
            
            const diffInMilliseconds = target - now;
            const days = Math.floor(diffInMilliseconds / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffInMilliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffInMilliseconds % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffInMilliseconds % (1000 * 60)) / 1000); 

            document.getElementById(`days-${id}`).textContent = formatNumber(days);
            document.getElementById(`hrs-${id}`).textContent = formatNumber(hours);
            document.getElementById(`mins-${id}`).textContent = formatNumber(minutes);
            document.getElementById(`secs-${id}`).textContent = formatNumber(seconds); 
        }
        function updateAllCountdowns() {
            COUNTDOWN_DATA.forEach(data => {
                calculateCountdown(data.targetDate, data.id);
            });
        }
        function openModal(id) {
            currentEditingId = id;
            const data = COUNTDOWN_DATA.find(d => d.id === id);
            
            document.getElementById('modal-title').textContent = `Edit Target Date - Day ${id}`;
            document.getElementById('new-target-date').value = data.targetDate;
            document.getElementById('modal-error').classList.add('hidden');
            document.getElementById('date-edit-modal').classList.remove('hidden');
            document.getElementById('date-edit-modal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('date-edit-modal').classList.add('hidden');
            document.getElementById('date-edit-modal').style.display = 'none';
            currentEditingId = null;
        }
        function saveModal() {
            const newDateString = document.getElementById('new-target-date').value;
            const newDate = new Date(newDateString);
            const now = new Date();

            if (newDate <= now || !newDateString) {
                document.getElementById('modal-error').textContent = "Please select a future date.";
                document.getElementById('modal-error').classList.remove('hidden');
                return;
            }

            const data = COUNTDOWN_DATA.find(d => d.id === currentEditingId);
            if (data) {
                data.targetDate = newDateString;
                document.querySelector(`#target-date-display-${currentEditingId} .date-text`).textContent = formatUniqueDate(newDateString);
                localStorage.setItem(`comp_exam_date_${currentEditingId}`, newDateString);
                updateAllCountdowns();
            }
            closeModal();
        }

        // === NEW LOADING FUNCTION ===
        async function loadExternalContent(containerId, url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const html = await response.text();
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = html;
                    
                    // After content is loaded, define the DOM_ELEMENTS that were placeholders
                    DOM_ELEMENTS.syllabusContainer = document.getElementById('syllabus-rem');
                    DOM_ELEMENTS.progressDisplay = document.getElementById('progress-rem');
                    DOM_ELEMENTS.progressDone = document.getElementById('progress-done');
                    DOM_ELEMENTS.progressToRead = document.getElementById('progress-toread');
                    DOM_ELEMENTS.progressBar = document.getElementById('progress-bar-rem');
                    DOM_ELEMENTS.importBtn = document.getElementById('import-progress-btn');
                    DOM_ELEMENTS.exportBtn = document.getElementById('export-progress-btn');
                    DOM_ELEMENTS.collapseBtn = document.getElementById('collapse-all-btn');

                    return true;
                }
            } catch (error) {
                console.error(`Could not load external content from ${url}:`, error);
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<p class="text-center p-8 text-red-600">Failed to load subject tracker. Please ensure **syllabus_rem_ethics.html** is in the same directory.</p>`;
                }
                return false;
            }
        }
        
        // === INITIALIZATION ===
        window.onload = async () => {
            // 1. Load the external HTML content first
            const loadSuccess = await loadExternalContent('rem-ethics-tracker-container', 'syllabus_rem_ethics.html');
            
            // 2. Only proceed if the loading was successful AND the syllabus data is available (which it should be now)
            if (loadSuccess && window.REM_ETHICS_SYLLABUS) {
                REM_ETHICS_SYLLABUS = window.REM_ETHICS_SYLLABUS;
                
                // Pre-calculate which topics have children now that the array is loaded
                REM_ETHICS_SYLLABUS.forEach((item, index) => {
                    const nextItem = REM_ETHICS_SYLLABUS[index + 1];
                    if (nextItem && nextItem.depth > item.depth) {
                        TOPICS_WITH_CHILDREN.add(item.id);
                    }
                });

                // Run the core syllabus setup
                renderSyllabusPanel(); 
                
                // Re-attach event listeners for the newly loaded panel elements
                DOM_ELEMENTS.exportBtn?.addEventListener('click', exportProgress);
                DOM_ELEMENTS.importBtn?.addEventListener('click', importProgress);
                DOM_ELEMENTS.collapseBtn?.addEventListener('click', toggleAllSections);
                
                const loadedMainDetails = document.querySelector('.syllabus-panel');
                if (loadedMainDetails) {
                    loadedMainDetails.addEventListener('toggle', handleMainPanelToggle);
                }
                
                // Re-initialise the main event listeners since the elements are new
                document.querySelectorAll('.syllabus-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleCheckboxChange);
                });
                
                document.querySelectorAll('.depth2-details details').forEach(details => {
                    details.addEventListener('toggle', (event) => {
                        if (lucide && lucide.createIcons) {
                           lucide.createIcons();
                        }
                    });
                });
            }
            
            // 3. Run Countdown initialization (independent of syllabus load)
            COUNTDOWN_DATA.forEach(data => {
                const savedDate = localStorage.getItem(`comp_exam_date_${data.id}`);
                const finalDate = savedDate || data.targetDate; 
                if (finalDate) {
                    data.targetDate = finalDate;
                    document.querySelector(`#target-date-display-${data.id} .date-text`).textContent = formatUniqueDate(finalDate);
                }
            });

            updateAllCountdowns();
            setInterval(updateAllCountdowns, 1000); 

            document.getElementById('target-date-display-1').addEventListener('click', () => openModal(1));
            document.getElementById('target-date-display-2').addEventListener('click', () => openModal(2));
            document.getElementById('target-date-display-3').addEventListener('click', () => openModal(3));

            document.getElementById('modal-save-btn').addEventListener('click', saveModal);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            
            DOM_ELEMENTS.fileUploadInput.addEventListener('change', handleFileUpload);
            document.getElementById('message-modal-close-btn').addEventListener('click', closeMessageModal);
            
            // Render icons across the entire page (including the newly loaded content)
            if (lucide && lucide.createIcons) {
                lucide.createIcons();
            }
        };
    </script>
</body>
</html>
