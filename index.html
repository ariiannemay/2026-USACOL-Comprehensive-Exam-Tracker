â€‹â€‹<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Comprehensive Exam Review Tracker</title>
    <!-- FIX: Updated favicon link -->
    <link rel="icon" href="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/usacol.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- ADDED: Calendar Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- END: Calendar Dependencies -->
    
    <!-- ADDED: Case Tracker Dependencies -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- END: Case Tracker Dependencies -->
    
    <style>
        /* Attempt to import a decorative font for the quote */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&family=Cormorant+Garamond:ital,wght@1,600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap');

:root {
    /* Brand Colors */
    --theme-primary: #6D1B1B;    
    --theme-secondary: #FECE1B;  
    
    /* Surface Colors (For Cards/Backgrounds) */
    --theme-bg-main: #F3F4F6;    /* Light Gray page background */
    --theme-bg-card: #FFFFFF;    /* White card background */
    --theme-border: #D1D5DB;     /* Standard border gray */
    
    /* Text Colors */
    --theme-text-main: #1F2937;  /* Dark gray text */
    --theme-text-on-primary: #FFFFFF; /* White text for buttons/headers */

    /* Legend/Status Colors (The ones you noticed!) */
    --status-done: #10B981;      /* Green for Finished */
    --status-toread: #EF4444;    /* Red for Pending */
    
    /* Legacy Sync (Keep these to prevent calendar/case tracker bugs) */
    --color-primary-dark: var(--theme-primary);
    --color-secondary-gold: var(--theme-secondary);
    --color-light-bg: var(--theme-bg-main);
    --maroon: var(--theme-primary);
    --gold: var(--theme-secondary);
}


        /* Calendar Stylesheet START */
        /* Minified/Consolidated Styles */
        .calendar-wrapper{max-width:1280px;margin:0 auto;padding:0 1rem;margin-top:0;padding-bottom:1.9rem;overflow-x:hidden}.calendar-wrapper.mx-auto{max-width:1280px;padding:0}.calendar-wrapper.p-0{padding:0}#calendar-grid-container{display:grid;grid-template-columns:3fr 1fr;gap:1.5rem;align-items:start;padding:.25rem .5rem .5rem .5rem}#calendar-details{border-radius:.75rem;overflow:hidden}#calendar-details summary{background-color:var(--color-primary-dark);color:#fff;border-bottom:3px solid var(--color-secondary-gold);padding:.75rem 1.5rem;font-size:1.125rem;font-weight:700}.toggle-indicator{transition:transform .2s}#notepad-sidebar{background-color:#fff;border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:1.5rem;display:flex;flex-direction:column;border:1px solid #e5e7eb;grid-column:2}#calendar-details[data-calendar-ready=true] #notepad-sidebar{min-height:var(--calendar-height,450px)}#notepad-sidebar h3{background-color:var(--color-primary-dark);color:#fff;border-radius:.375rem .375rem 0 0;padding:.4rem .75rem;margin:calc(-1.5rem - 1px) -1.5rem .75rem -1.5rem;text-transform:uppercase;font-weight:800;font-size:.9rem;border-bottom:3px solid var(--color-secondary-gold)}#review-notes{width:100%;flex-grow:1;padding:1.5rem 1rem 1rem 1rem;font-size:.95rem;border:none;border-radius:.5rem;box-shadow:inset 0 1px 4px rgba(0,0,0,.1);resize:none;font-family:'Dancing Script',cursive;font-weight:600;line-height:1.95;color:#333;overflow-y:auto;background-color:#f7f7f7;background-image: url('https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/blank-cream-notepaper.jpg');background-size:cover;background-position:center;background-repeat:no-repeat}#review-notes::placeholder{font-family:'Dancing Script',cursive;font-weight:700;color:#b33a3a;opacity:.8;transform:translateY(-5px);display:block}#calendar-content{grid-column:1;padding:0}#calendar-card{background-color:#fff;border-radius:.75rem;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:0}.fc-toolbar{padding:.1rem .75rem;background-color:var(--color-primary-dark);margin-bottom:0;border:0 solid var(--color-secondary-gold);color:#fff;border-radius:.5rem;display:flex;align-items:center;font-size:.85rem}#customMonthTitle{color:#fff;font-weight:800;text-transform:uppercase;font-size:1.4em;padding:.3em .6em;margin-right:.5rem;font-family:inherit}

.fc-widget-header{background-color:var(--color-primary-dark) !important;color:#fff !important;text-transform:uppercase !important;font-weight:700 !important;padding: 0 !important;height:100%}

.fc-view-container .fc-view>table{border-top:none !important}.fc-toolbar + div{border-top:none !important}.fc-head{border-top:none !important;border-bottom:3px solid var(--color-secondary-gold) !important}#calendar{padding:0 !important}.fc-view-container{border-top:none !important}.fc-unthemed,.fc-unthemed table{border-top:none !important;border-color:transparent !important}.fc-unthemed td,.fc-unthemed th{border-color:#e5e7eb}#dateJump{display:none !important;visibility:hidden !important;position:absolute;top:0;left:0}#dateJump.temp-visible{display:block !important;visibility:visible !important;position:fixed !important;z-index:9999;width:200px;height:40px;opacity:.01;pointer-events:auto}
.fc-toolbar .fc-right{flex-grow:1;display:flex;justify-content:flex-end;margin:0 !important;width:auto !important}.fc-toolbar .fc-button-group:last-child{margin-left:.5rem}
.fc-toolbar .fc-button,#jumpToDateButton{padding:.3em .6em !important;line-height:1.2 !important;font-size:.75rem !important;background-color:#fff !important;color:var(--color-primary-dark) !important;border-color:var(--color-primary-dark) !important;box-shadow:none;text-transform:uppercase;font-weight:700;border-radius:.25rem;margin-left:.5rem}#jumpToDateButton{background-color:var(--color-secondary-gold) !important;color:var(--color-primary-dark) !important;border-color:var(--color-primary-dark) !important}
.fc-toolbar .fc-button:hover:not(.fc-state-active),#jumpToDateButton:hover{background-color:#f0f0f0 !important;color:var(--color-primary-dark) !important}#jumpToDateButton:hover{filter:brightness(.9)}.fc-toolbar .fc-state-active,.fc-toolbar .fc-state-active:hover{background-color:var(--color-secondary-gold) !important;color:var(--color-primary-dark) !important;border-color:var(--color-primary-dark) !important}.fc-toolbar .fc-today-button.fc-state-active{background-color:var(--color-secondary-gold) !important;color:var(--color-primary-dark) !important}
.fc-day-number{display:inline-block;background-color:transparent;color:#4b5563;font-weight:700;padding:2px 4px;margin-right:0;float:right;line-height:1.2;font-size:.9rem}
.fc-other-month .fc-day-number{color:#9ca3af;background-color:transparent}
.fc-event{border-radius:.25rem !important;border:1px solid rgba(0,0,0,.1);font-size:.6rem;font-weight:600;padding:2px 5px;white-space:normal;text-transform:uppercase}
.fc-event-title-wrap{display:flex;align-items:center}
.event-status-icon{font-size:.8rem;margin-right:.5rem;width:1.25rem;text-align:center}.event-icon-book{color:#fff}
.modal { z-index: 1000; background-color: rgba(0,0,0,.75); display: none; }
.modal-content{background-color:#fff !important;padding:1.5rem;border-radius:.75rem;box-shadow:0 25px 50px -12px rgba(0, 0, 0, 0.5);min-width:300px;width:90%;max-width:500px}
.syllabus-select-wrapper select{min-height:200px}
        /* Calendar Stylesheet END */

/* --- CALENDAR MODAL ENHANCEMENTS --- */
#calendar-icon-picker, #calendar-color-picker {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
    gap: 4px;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
}

.calendar-picker-btn {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}

.calendar-picker-btn.active {
    ring: 2px solid var(--theme-primary);
    transform: scale(1.1);
    background: white;
}

#calendar-color-picker {
    max-height: none !important; /* Removes scrollbar for colors */
    padding-bottom: 10px;
}
        /* -------------------------------------------------------------------------- */
        /* 1. CORE LAYOUT & TYPOGRAPHY STYLES */
        /* -------------------------------------------------------------------------- */
        
        /* Global & Countdown Styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex; 
            flex-direction: column;
        }
        .main-content-wrapper { flex-grow: 1; }
        .header-font { font-family: 'Bebas Neue', sans-serif; letter-spacing: .1em; }
        .header-bg { background-color: var(--theme-primary); border-bottom: 5px solid var(--theme-secondary); }
        .card-header-bg { background-color: var(--theme-primary); }
        .time-value { font-size: 1.5rem; font-weight: 900; line-height: 1; color: #1a202c; }
        .time-label { font-size: .5rem; font-weight: 700; color: #4a5568; text-transform: uppercase; }
        .date-display-wrapper { display: inline-block; padding-bottom: 0; cursor: pointer; transition: color .2s; }
        .date-display-wrapper:hover .date-text { color: #1d4ed8; }
        .date-text { font-family: 'Bebas Neue', sans-serif; font-size: 1.75rem; font-weight: 800; color: #000000; text-transform: uppercase; letter-spacing: .15em; line-height: 1; }
        .today-date-text { font-size: 0.9rem; white-space: nowrap; font-weight: 700; line-height: 1; }
        .dashboard-footer-text { font-size: 0.65rem; margin-top: 0.5rem; }
        .text-miss { color: #000000; }
        .text-atty { color: #674ea7; }
        .text-cpa { color: #f472b6; }
        .global-app-footer { text-align: center; padding: 0.25rem 0; margin-top: 0; }
        .global-app-footer .quote, .global-app-footer .signature .date-text-signature { font-family: 'Cormorant Garamond', 'Times New Roman', serif; font-style: italic; font-weight: 600; font-size: 1rem; color: #4a5568; }
        .global-app-footer .signature { font-family: 'Inter', sans-serif; font-style: italic; font-weight: 600; font-size: 0.75rem; color: #4a5568; }


        /* -------------------------------------------------------------------------- */
        /* 2. DASHBOARD & SCHEDULE STYLES (Existing) */
        /* -------------------------------------------------------------------------- */

        .border-custom-yellow { border-color: var(--theme-secondary); }
        .text-custom-yellow { color: var(--theme-secondary); }
        .bg-chart-done { background-color: #38761d; }
        .text-chart-done { color: #38761d; }
        .bg-chart-toread { background-color: #ef4444; }
        .text-chart-toread { color: #ef4444; }
        .text-chart-title { color: var(--theme-primary); font-size: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        
        #overall-dashboard { background-color: transparent; box-shadow: none; border: none; padding: 0; }
        .dashboard-container { display: flex; flex-wrap: wrap; padding: 0; }

.chart-panel { 
    width: 100%; 
    padding: 0 0.3rem; 
    border-bottom: 1px solid #e5e7eb; 
    background-color: #fff; 
    border-radius: 0.75rem; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
}

        .schedule-panel { width: 100%; padding: 0.5rem 0.3rem; background-color: #fff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        @media (min-width: 1024px) {
            #overall-dashboard { padding: 0; }
            .dashboard-container { display: grid; grid-template-columns: 1fr 1.5rem 1fr 1.5rem 1fr; padding: 0; }
            .chart-panel { grid-column: 1 / span 1; padding: 0.5rem 1rem; border-bottom: none; }
            .schedule-panel { grid-column: 3 / span 3; padding: 0.5rem 1rem; border-left: none; }
            .dashboard-container > div:nth-child(2) { grid-column: 2 / span 1; border-right: none; }
            .chart-panel .flex-col, .chart-panel .text-center { align-items: center; text-align: center; justify-content: center; }
        }

        .pie-chart-wrapper { position: relative; display: flex; align-items: center; justify-content: center; margin: 0.5rem auto 0.1rem; width: 100%; }
        .metric-pie-side { position: absolute; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.7rem; text-align: center; line-height: 1.2; }
        .metric-pie-side.left { right: 50%; margin-right: 105px; transform: translateY(-50%); top: 50%; }
        .metric-pie-side.right { left: 50%; margin-left: 105px; transform: translateY(-50%); top: 50%; }
        .metric-pie-side .metric-value { font-size: 1rem; font-weight: 900; }
        
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .schedule-table th, .schedule-table td { padding: 0.1rem 0.3rem; vertical-align: middle; }
        .schedule-header th { background-color: var(--theme-primary); color: #FFFFFF; font-weight: 700; text-transform: uppercase; border: 2px solid var(--theme-secondary); font-size: 0.75rem; }
        .subject-cell { font-weight: 600; color: white; padding: 0.4rem; text-align: center; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); font-size: 0.7rem; text-transform: uppercase; }
        .progress-bar-sparkline { width: 100%; height: 0.8rem; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 2px; }
        .bg-progress-red { background-color: #ef4444; }
        .bg-progress-orange { background-color: #f97316; }
        .bg-progress-yellow { background-color: #facc15; }
        .bg-progress-green { background-color: #10b981; }

        .sparkline-fill { height: 100%; transition: width 0.5s ease-in-out; border-radius: 9999px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); border: 2px solid white; max-width: 100%; }

        .bg-poli { background-color: #795548; }
        .bg-comm { background-color: #eab308; }
        .bg-civ { background-color: #1e3a8a; }
        .bg-lab { background-color: #38761d; }
        .bg-crim { background-color: #b33a3a; }
        .bg-rem { background-color: #674ea7; }
        
        /* -------------------------------------------------------------------------- */
        /* 3. SUBJECT TRACKER STYLES (Checklist Fix Applied) */
        /* -------------------------------------------------------------------------- */

        .syllabus-panel-container { border-radius: .75rem; overflow: hidden; }
        .syllabus-summary { padding: 1rem; font-size: 1.25rem; font-weight: 700; color: white; cursor: pointer; list-style: none; display: flex; flex-direction: column; align-items: flex-start; justify-content: space-between; gap: .5rem; border-top-left-radius: .75rem; border-top-right-radius: .75rem; }
        .topic-header { padding: .75rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; justify-content: space-between; cursor: pointer; list-style: none; }
        
        /* ðŸš¨ MODIFIED: Increased width for 6 columns (1.5fr for topic text, 6x 100px for material, 1x 50px for final checkmark) */
        .checklist-grid { 
            display: grid; 
            grid-template-columns: 1.5fr repeat(6, 100px) minmax(40px, 50px); 
            gap: .2rem; 
            padding: .3rem 0; 
            align-items: center; 
            border-bottom: 1px dashed #e5e7eb; 
        }
        
        /* CRITICAL CHECKBOX STYLING OVERRIDE */
        .checklist-grid input[type="checkbox"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 1rem; height: 1rem; border: 1px solid #d1d5db; border-radius: 0.25rem;
            cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
            background-color: #ffffff; align-self: center; position: relative;
        }

        .checklist-grid input[type="checkbox"]:checked { border-color: transparent !important; }

/* NEW: Column-specific colors for CHECKED state */
        .checkbox-codal:checked { background-color: #8b5cf6 !important; } /* Violet/Rem */
        /* NEW COLUMNS */
        .checkbox-first_reading:checked { background-color: #eab308 !important; } /* Yellow/Comm */
        .checkbox-second_reading:checked { background-color: #3b82f6 !important; } /* Blue/Civ */
        .checkbox-pre_bar_notes:checked { background-color: #10b981 !important; } /* Green */
        .checkbox-pre_week:checked { background-color: #f97316 !important; } /* Orange */
        .checkbox-lmts:checked { background-color: #ef4444 !important; } /* Red */

        .checklist-grid input[type="checkbox"]:checked::before {
        content: ''; position: absolute; width: 0.25rem; height: 0.5rem;
        border: solid white; border-width: 0 2px 2px 0; top: 50%; left: 50%;
        transform: translate(-50%, -55%) rotate(45deg);
        }
        
        .checklist-grid>div:first-child { 
            padding-left: 0.125rem; 
            font-size: .875rem; 
            color: #374151; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            justify-content: center; 
            /* SAFARI FIX */
            min-width: 0;
            overflow: hidden;
            /* END SAFARI FIX */
        }
        .font-trackable-lg { font-size: 1.5rem; font-weight: 600; }
        .progress-percent-bold { font-weight: 700; font-size: .8rem; }
        .syllabus-summary-title-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .syllabus-progress-metrics { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center; width: 100%; font-size: .75rem; }
        .progress-stats { display: flex; gap: .5rem; white-space: nowrap; }
        .progress-overall-text { white-space: nowrap; font-weight: 700; margin-right: .5rem; }
        .progress-bar-container { height: .75rem; background: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 100%; flex-grow: 1; max-width: none; }
        .progress-bar { height: 100%; transition: width .5s ease-in-out; }
        .main-summary-chevron { transition: transform .2s; }
        .syllabus-panel[open]>.syllabus-summary .main-summary-chevron { transform: rotate(90deg); }
        .syllabus-summary::-webkit-details-marker, .topic-header::-webkit-details-marker { display: none; }
        .syllabus-content { padding: .5rem 1rem 1rem 1rem; background: white; border: 1px solid #e5e7eb; border-top: none; border-bottom-left-radius: .75rem; border-bottom-right-radius: .75rem; }
        .syllabus-sub-section { border-bottom: 1px solid #e5e7eb; margin-bottom: .5rem; }
        .chevron-icon { transition: transform .2s; display: inline-block; margin-right: .5rem; }
        .syllabus-sub-section[open]>details>.topic-header .chevron-icon { transform: rotate(90deg); }
        .depth2-details { list-style: none; margin-bottom: .25rem; border: 1px solid #f3f4f6; border-radius: .375rem; overflow: hidden; background-color: #fafafa; }
        .depth2-details>summary { list-style: none; cursor: pointer; padding: 0; background-color: #ffffff; }
        .depth2-details>summary::-webkit-details-marker { display: none; }
        .depth2-chevron { transition: transform .2s; transform: rotate(0deg); flex-shrink: 0; margin-right: .5rem; }
        .depth2-details[open] .depth2-chevron { transform: rotate(90deg); }
        .topic-content-wrapper { display: flex; align-items: flex-start; padding-left: .5rem; }
        /* ðŸš¨ MODIFIED: Matched grid template to 6 columns */
        .checklist-grid.checklist-grid-header>div:first-child { grid-column: 1 / span 1; padding-left: 0; align-items: center; text-align: center; }
        .checklist-grid.checklist-grid-header { grid-template-columns: 1.5fr repeat(6, 100px) minmax(40px, 50px); }
        .checklist-grid-micro-progress { border-bottom: 1px solid #e5e7eb; }

        .depth3-content-wrapper>div { display: block; padding: .25rem .5rem; }
        /* ðŸš¨ MODIFIED: Border on 6 columns (n+2 through n+7) */
        .checklist-grid>div:nth-child(n+2):nth-child(-n+7) { border-right: 1px dashed #d1d5db; }
        /* ðŸš¨ MODIFIED: Remove border on the 7th cell (6th material column) */
        .checklist-grid>div:nth-child(7) { border-right: none; }
        .checklist-label-capsule { font-size: .65rem; font-weight: 7-00; text-transform: uppercase; text-align: center; word-break: keep-all; padding: .15rem .35rem; border-radius: 9999px; line-height: 1; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, .05); }
        .col-progress-bar-container { height: .4rem; background: #e5e7eb; border-radius: 9999px; overflow: hidden; width: 100%; }
        .col-progress-bar { height: 100%; transition: width .3s ease-in-out; }
        .status-message-row { padding-top: .25rem; padding-bottom: .25rem; }
        
        .depth3-content-wrapper>div:first-child { grid-column: 1 / span 8; padding-left: 2.5rem; }
        .depth2-topic-row { grid-column: 1 / span 1; display: flex; align-items: flex-start; }
        
        /* SUBJECT PANEL THEMES */
        .syllabus-panel-rem .syllabus-summary { background-color: #674ea7; border-left: 5px solid #8e7cc3; }
        .syllabus-panel-rem .topic-header { background-color: #ede9fe; border-left: 3px solid #8b5cf6; }
        .syllabus-checkbox-rem { accent-color: #8b5cf6; }

        .syllabus-panel-crim .syllabus-summary { background-color: #b33a3a; border-left: 5px solid #d94a4a; }
        .syllabus-panel-crim .topic-header { background-color: #fee2e2; border-left: 3px solid #ef4444; }
        .syllabus-checkbox-crim { accent-color: #ef4444; }

        .syllabus-panel-lab { --lab-color: #38761d; --lab-color-dark: #274e13; }
        .syllabus-panel-lab .syllabus-summary { background-color: var(--lab-color); border-left: 5px solid #6aa84f; }
        .syllabus-panel-lab .topic-header { background-color: #f6fff6; border-left: 3px solid var(--lab-color); }
        .syllabus-checkbox-lab { accent-color: var(--lab-color); }
        .bg-lab-button { background-color: var(--lab-color); }
        .hover\:bg-lab-button-dark:hover { background-color: var(--lab-color-dark); }

        .syllabus-panel-civ { --civ-color: #1e3a8a; --civ-color-dark: #142a63; }
        .syllabus-panel-civ .syllabus-summary { background-color: var(--civ-color); border-left: 5px solid #3b82f6; }
        .syllabus-panel-civ .topic-header { background-color: #eff6ff; border-left: 3px solid var(--civ-color); }
        .syllabus-checkbox-civ { accent-color: #2563eb; }
        .bg-civ-button { background-color: #2563eb; }
        .hover\:bg-civ-button-dark:hover { background-color: #1d4ed8; }

        .syllabus-panel-comm { --comm-color: #eab308; --comm-color-dark: #b88f06; --comm-color-light: #fefce8; --comm-checkbox-color: #eab308; }
        .syllabus-panel-comm .syllabus-summary { background-color: var(--comm-color); border-left: 5px solid #facc15; color: #000000 !important; }
        .syllabus-panel-comm .syllabus-summary i {
            color: #000000 !important; }
        .syllabus-panel-comm .syllabus-summary-title-row .flex:first-child, .syllabus-panel-comm .syllabus-progress-metrics span, .syllabus-panel-comm .syllabus-progress-metrics i { color: #000000 !important; }
        .syllabus-panel-comm .topic-header { background-color: var(--comm-color-light); border-left: 3px solid var(--comm-color); }
        .syllabus-checkbox-comm { accent-color: var(--comm-checkbox-color); }
        .bg-comm-button { background-color: var(--comm-color); }
        .hover\:bg-comm-button-dark:hover { background-color: var(--comm-color-dark); }
        
        .syllabus-panel-comm .syllabus-progress-metrics .text-gray-200 {
            color: #000000 !important;}
        
        .syllabus-panel-poli { --poli-color: #795548; --poli-color-dark: #553b32; --poli-color-light: #efe9e0; }
        .syllabus-panel-poli .syllabus-summary { background-color: var(--poli-color); border-left: 5px solid #a1887f; }
        .syllabus-panel-poli .topic-header { background-color: var(--poli-color-light); border-left: 3px solid var(--poli-color); }
        .syllabus-checkbox-poli { accent-color: var(--poli-color); }
        .bg-poli-button { background-color: var(--poli-color); }
        .hover\:bg-poli-button-dark:hover { background-color: var(--poli-color-dark); }
        /* END SUBJECT PANEL THEMES */

        /* -------------------------------------------------------------------------- */
        /* MERGED: Case Tracker Styles (Integrated from case_tracker.html) */
        /* -------------------------------------------------------------------------- */

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Bebas+Neue&family=Dancing+Script:wght@600&display=swap');
        
        body { background-color: var(--bg-light); font-family: 'Inter', sans-serif; }
        .header-font { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        /* Checkbox Styling */
        .custom-checkbox {
            appearance: none; background-color: #fff; margin: 0;
            font: inherit; color: currentColor; width: 1.15em; height: 1.15em;
            border: 2px solid #cbd5e1; border-radius: 0.25em; display: grid; place-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .custom-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white;
            transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

/* Start Edit at Line 538 */
.custom-checkbox:checked { 
    background-color: var(--theme-primary); 
    border-color: var(--theme-primary); 
    display: grid;
    place-content: center;
}

.custom-checkbox:checked::before { 
    content: "";
    width: 0.65em;
    height: 0.65em;
    transform: scale(1); /* Changed from scale(0) to 1 */
    transition: 120ms transform ease-in-out;
    box-shadow: inset 1em 1em white; /* This creates the white check */
    transform-origin: center;
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
}
/* End Edit at Line 543 */

.modal-label {
    display: inline-block;
    border-bottom: 2px solid #000;
    padding-bottom: 2px;
    margin-bottom: 8px;
}

.animated-hourglass-svg {
    animation: flip 3s infinite linear; /* Flip every 3 seconds */
    transform-origin: center;
}

@keyframes flip {
    0% { transform: rotate(0deg); }
    45% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
    95% { transform: rotate(180deg); }
    100% { transform: rotate(360deg); }
}

/* Flowing sand effect */
.sand {
    animation: flow 8s infinite linear;
}

@keyframes flow {
    0% { opacity: 1; }
    45% { opacity: 1; }
    50% { opacity: 0; } /* Sand "disappears" during flip */
    95% { opacity: 0; }
    100% { opacity: 1; }
}

/* When flipped, reverse the look */
.animated-hourglass-svg:hover { /* Optional: pause on hover */
    animation-play-state: paused;
}

/* After your #review-notes:focus style */
#review-notes:focus {
    outline: none;
    border-right: 2px solid var(--color-secondary-gold);
}

@keyframes pulse-purple {
    0% { transform: scale(1); color: var(--theme-primary); } 
    50% { transform: scale(1.1); color: var(--theme-secondary); text-shadow: 0 0 8px rgba(254, 206, 27, 0.4); } 
    100% { transform: scale(1); color: var(--theme-primary); } 
}


.save-pulse {
    display: inline-block; 
    animation: pulse-purple 0.8s ease-in-out;
}


/* --- TAB NAVIGATION STYLES --- */
.sticky-top-pane {
    position: relative;
    top: 0;
    background-color: #f3f4f6;
    padding-top: 2px; /* Minimal space at very top */
}
/* --- START PINPOINTED FIX: DASHED TAB DIVIDERS & THEMED HOVER --- */

.tab-btn {
    transition: all 0.2s;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.05em;
    font-size: 0.8rem;
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
    border: none !important;
    position: relative; /* Required for the absolute line positioning */
}

.tab-btn::after {
    content: "";
    position: absolute;
    right: 0;
    top: 20%;      /* Starts 20% from the top */
    bottom: 20%;   /* Ends 20% from the bottom */
    width: 1px;
    border-right: 1px dashed var(--theme-primary);
    opacity: 0.5;  /* Makes it look more professional/subtle */
}

/* Removes the extra line from the very last tab (Links) */
.tab-btn:last-child {
    border-right: none !important;
}

/* Remove line from the last tab */
.tab-btn:last-child::after {
    display: none;
}

/* Hide line when a tab is active or hovered for a cleaner look */
.tab-btn.active::after,
.tab-btn:hover::after {
    opacity: 0;
}

.tab-btn:hover:not(.active) {
    /* Adjusted from Maroon to a Soft Purple Tint to match your #AweSAMBar theme */
    background-color: rgba(51, 0, 102, 0.05); 
    color: var(--theme-primary) !important;
    transform: translateY(-1px);
}

.tab-btn.active {
    color: white !important;
    background-color: var(--theme-primary) !important;
    border-bottom: 2px solid var(--theme-secondary) !important;
    /* Hides the dashed line when the tab is purple/active so it stays clean */
    border-right-color: transparent !important;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
    display: block;
}

/* --- END PINPOINTED FIX --- */

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Ensure body doesn't jump when header sticks */
body { scroll-behavior: smooth; }

/* --- ADVANCED ANALYTICS & HEATMAP STYLES --- */
#analytics-chart-container { 
    min-height: 200px; 
    display: flex;
    align-items: flex-end; /* Ensures bars sit on the bottom */
}
/* --- PURPLE THEMED ANALYTICS STYLES (var(--theme-primary) & var(--theme-secondary)) --- */

/* Ensures the monthly grid overrides the flex behavior */
#analytics-chart-container.grid {
    display: grid !important;
}

.heatmap-cell {
    aspect-ratio: 1 / 1;
    border-radius: 6px;
    transition: all 0.2s ease;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    font-family: 'Inter', sans-serif;
}

.heatmap-cell:hover {
    transform: translateY(-2px);
    filter: brightness(1.1);
    z-index: 10;
    /* Updated to Purple Shadow */
    box-shadow: 0 4px 12px rgba(51, 0, 102, 0.2);
}

/* Date number inside the box */
.heatmap-date {
    font-size: 11px;
    font-weight: 800;
    pointer-events: none;
}

/* Professional Floating Tooltip */
#chart-tooltip {
    position: fixed;
    pointer-events: none;
    background: #1a1a1a;
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    white-space: nowrap;
    z-index: 10000;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
    display: none;
    /* Updated to Purple Accent */
    border-bottom: 2px solid var(--theme-secondary);
}

#chart-tooltip::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px 5px 0;
    border-style: solid;
    border-color: #1a1a1a transparent transparent;
}

/* START EDITING HERE: Hide manual resize and set base transition */
/* Remove manual resize corner and hide scrollbars for a clean notepad look */
#digestModal textarea {
    resize: none;
    overflow-y: hidden;
    min-height: 40px;
    transition: height 0.1s ease;
}

/* Start of Width Fix */
#tab-calendar .calendar-wrapper, 
#tab-calendar .calendar-wrapper.mx-auto {
    max-width: 100% !important;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

#calendar-grid-container {
    grid-template-columns: 1fr !important; /* Forces vertical stack on mobile if needed, but we want the grid wide */
}

@media (min-width: 1024px) {
    #calendar-grid-container {
        grid-template-columns: 3.5fr 1fr !important; /* Gives the calendar even more room */
    }
}
/* End of Width Fix */ 


#notes-subject-tabs {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Force full width expansion */
gap: 0.5rem;
width: 100%;
}
#notes-subject-tabs .notes-sub-tab {
    padding: 8px 6px !important;
    min-height: unset;
    border-radius: 10px;
}

/* --- SUBJECT SPECIFIC TABS --- */
.notes-sub-tab[data-sub="poli"].active { background-color: #795548 !important; border-color: #795548 !important; }
.notes-sub-tab[data-sub="civ"].active { background-color: #1e3a8a !important; border-color: #3b82f6 !important; }
.notes-sub-tab[data-sub="rem"].active { background-color: #674ea7 !important; border-color: #8b5cf6 !important; }
.notes-sub-tab[data-sub="lab"].active { background-color: #38761d !important; border-color: #38761d !important; }
.notes-sub-tab[data-sub="tax"].active { background-color: #eab308 !important; border-color: #eab308 !important; }
.notes-sub-tab[data-sub="crim"].active { background-color: #b33a3a !important; border-color: #ef4444 !important; }

/* Master Progress Bar Styling */
#notes-master-progress-wrapper {
background: #e5e7eb;
border-radius: 999px;
height: 8px;
overflow: hidden;
margin-bottom: 2rem;
border: 1px solid #d1d5db;
}
#notes-master-progress-fill {
height: 100%;
background: linear-gradient(90deg, #6D1B1B, #FECE1B);
width: 0%;
transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.notes-sub-tab {
width: 100%;
font-size: 0.75rem;
font-weight: 800;
text-transform: uppercase;
padding: 10px 4px;
border-radius: 8px;
transition: all 0.2s;
border: 1px solid #e5e7eb;
background: white;
color: #4b5563;
text-align: center;
}

/* Match the color coding of your #AweSAMBar2026 brand */
.notes-sub-tab.active {
background: var(--color-primary-dark); /* #6D1B1B */
color: white;
border-color: var(--color-secondary-gold); /* #FECE1B */
box-shadow: 0 4px 6px -1px rgba(178, 102, 255, 0.2);
}

.notes-sub-tab:hover:not(.active) {
background: #f3e8ff;
border-color: #d8b4fe;
}

.auto-expand {
font-family: 'Inter', sans-serif; /* Back to clean default */
font-size: 0.95rem;
line-height: 1.6;
padding: 1rem;
width: 100%;
min-height: 120px;
background-color: #ffffff; /* Clean white */
border: 1px solid #e5e7eb;
border-radius: 8px;
resize: none;
overflow: hidden;
display: block;
color: #374151;
}

/* UI for the Export Button */
.export-btn {
padding: 6px 12px;
border-radius: 6px;
font-size: 10px;
font-weight: 800;
text-transform: uppercase;
display: flex;
align-items: center;
gap: 6px;
transition: all 0.2s;
background: #f3f4f6;
color: #4b5563;
border: 1px solid #d1d5db;
}

.export-btn:hover {
background: #6D1B1B;
color: white;
border-color: #FECE1B;
}

.todo-paper {
background: white; background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
background-size: 24px 24px; min-height: 600px; border-radius: 12px;
box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Custom grid logic for the pill links */
#links-grid > a:last-child:nth-child(odd) {
grid-column: span 2; /* If it's the 3rd, 5th, etc link, it spans both columns */
}

.link-pill {
display: flex;
align-items: center;
padding: 1rem;
border-radius: 12px;
color: white;
font-weight: 800;
text-transform: uppercase;
font-size: 0.8rem;
transition: all 0.2s;
position: relative;
}

.link-pill:hover {
transform: translateY(-2px);
filter: brightness(1.1);
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.delete-link {
position: absolute;
right: 8px;
top: 50%;
transform: translateY(-50%);
opacity: 0;
transition: 0.2s;
}

.link-pill:hover .delete-link {
opacity: 1;
}
/* TO-DO LAYOUT & MINI-CALENDARS */
.daily-layout-grid {
display: grid;
grid-template-columns: 1fr 320px;
gap: 2rem;
min-height: 600px;
}

.task-input-small {
font-size: 9px !important;
font-weight: 600;
line-height: 1.2;
word-wrap: break-word;
white-space: normal;
overflow-wrap: anywhere;
flex: 1;
min-width: 0;
height: auto;
}

.task-input-large {
font-size: 14px !important;
font-weight: 700;
color: var(--color-primary-dark);
}

.mini-calendar-sidebar { border-left: 1px dashed #e5e7eb; padding-left: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
.weekly-calendar-footer { display: flex; gap: 1rem; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; }
.weekly-calendar-footer .mini-cal { flex: 1; }

/* Updated Weekly Planner Layout */
.weekly-planner-grid {
display: grid;
grid-template-columns: 1fr 300px; /* Planner on left, Cal on right */
gap: 2rem;
align-items: start;
}

.weekly-tasks-stack {
display: grid;
grid-template-columns: repeat(3, 1fr); /* 3 columns for Sun-Fri */
gap: 1rem;
}

.weekly-day-card {
background: rgba(255, 255, 255, 0.5);
border-radius: 12px;
padding: 1rem;
border: 1px solid #f3e8ff;
height: 100%;
min-height: 200px;
display: flex;
flex-direction: column;
text-align: left; /* Back to left-aligned! */
}

/* Optional: Ensure Saturday also follows a similar height or stays larger */
.weekly-day-card.saturday-span {
grid-column: 1 / -1;
min-height: 150px;
}

.mini-cal {
background: #fff; border-radius: 8px; padding: 0.75rem; width: 100%;
box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #f3f4f6;
}

.mini-cal-header {
font-weight: 900; font-size: 0.7rem; text-transform: uppercase;
color: var(--color-primary-dark); text-align: center; margin-bottom: 0.5rem;
border-bottom: 2px solid var(--color-secondary-gold);
}

.mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 0.6rem; }
.mini-cal-day-label { font-weight: 800; color: #9ca3af; padding-bottom: 4px; }
.mini-cal-date { padding: 4px 0; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.mini-cal-date:hover { background: #f3f4f6; color: var(--color-primary-dark); }
.mini-cal-today { background-color: var(--color-secondary-gold); color: white; }
.mini-cal-viewing { outline: 2px solid var(--color-primary-dark); font-weight: 900; }

.todo-mode-btn {
transition: all 0.2s;
}

/* Only the active one should be white with purple text */
.todo-mode-btn.selected-active {
background-color: white !important;
color: var(--color-primary-dark) !important;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* The non-selected one should always stay transparent with white text */
.todo-mode-btn:not(.selected-active) {
background-color: transparent !important;
color: white !important;
}

/* Weekly View Column Fixes */
.task-row {
display: flex;
align-items: center;
gap: 0.5rem; /* Reduced gap */
padding: 0.25rem 0.5rem; /* Reduced vertical padding */
border-bottom: 1px dashed #e5e7eb;
width: 100%;
transition: all 0.2s;
border-radius: 6px;
}

.task-row:hover {
background-color: rgba(178, 102, 255, 0.05);
outline: 1px solid rgba(178, 102, 255, 0.2);
}

.task-row textarea {
flex: 1;
min-width: 0;
background: transparent;
border: none;
outline: none;
resize: none;
margin: 0;
padding: 4px 0;
display: block;
white-space: pre-wrap;
word-wrap: break-word;
overflow-wrap: break-word;
height: auto;
width: 100%;
}

.day-pill-header {
background: #f3e8ff;
border-radius: 8px;
padding: 12px 0;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
margin-bottom: 1rem;
border: 1px solid #e9d5ff;
width: 100%; /* Spans the full width of the flex-1 container */
box-sizing: border-box; /* Critical: ensures border doesn't push width out */
}

/* Make Weekday Font Larger */
.day-pill-header span:first-child {
font-size: 14px !important; /* Increased from 10px */
letter-spacing: 0.05em;
}

/* Make Add Task Thinner */
.add-task-btn-thin {
padding-top: 2px !important;
padding-bottom: 2px !important;
min-height: unset !important;
line-height: 1.5 !important;
}

/* Custom Checkbox Styling */
.task-row input[type="checkbox"] {
appearance: none;
-webkit-appearance: none;
width: 1.25rem;
height: 1.25rem;
border: 2px solid #FECE1B;
border-radius: 4px;
background-color: white;
cursor: pointer;
position: relative;
flex-shrink: 0;
margin-top: 2px; /* Pulls checkbox down slightly to match first line of text */
transition: all 0.2s;
}

.task-row input[type="checkbox"]:checked {
background-color: #FECE1B;
border-color: #6D1B1B;
}

.task-row input[type="checkbox"]:checked::after {
content: '';
position: absolute;
left: 6px;
top: 2px;
width: 5px;
height: 10px;
border: solid white;
border-width: 0 2px 2px 0;
transform: rotate(45deg);
}
.task-actions {
display: flex;
align-items: center; /* Centers trash icon with text */
flex-shrink: 0;
gap: 0.25rem;
/* Use margin-top to align with the first line of text */
margin-top: 4px;
}

.task-actions i {
width: 0.8rem !important;
height: 0.8rem !important;
}

/* Fixes the "white box" selected pill issue */
.todo-mode-btn.bg-white {
background-color: white !important;
color: var(--color-primary-dark) !important;
}

#todo-render-container .text-gray-400.font-bold {
font-size: 8px !important;
white-space: nowrap; /* Keeps the month and day on one line */
letter-spacing: -0.02em;
}

.todo-column:nth-child(even) {
background-color: rgba(178, 102, 255, 0.03);
}


.clear-all-btn {
padding: 2px 6px !important;
border: 1px solid #fee2e2;
background: #fef2f2;
color: #ef4444;
font-size: 8px !important;
border-radius: 4px;
text-transform: uppercase;
font-weight: 800;
transition: all 0.2s;
}

.clear-all-btn:hover {
background: #ef4444;
color: white;
}
/* --- THEMED MODAL SYSTEM --- */
#themed-modal-container {
transition: all 0.3s ease-in-out;
}

.modal-animate-in {
animation: modalScaleUp 0.2s ease-out forwards;
}

@keyframes modalScaleUp {
from { opacity: 0; transform: scale(0.95); }
to { opacity: 1; transform: scale(1); }
}

.modal-header-bg {
background: linear-gradient(135deg, #6D1B1B 0%, #4c0099 100%);
border-bottom: 3px solid #FECE1B;
}

.edit-link {
position: absolute;
right: 32px; /* Positioned to the left of the delete button */
top: 50%;
transform: translateY(-50%);
opacity: 0;
transition: 0.2s;
}

.link-pill:hover .edit-link {
opacity: 1;
}

#date-jumper::-webkit-calendar-picker-indicator {
cursor: pointer;
}

/* Optional: Make the Today/Jump group look like a single unit */
.rounded-l-full { border-top-right-radius: 0; border-bottom-right-radius: 0; }
.rounded-r-full { border-top-left-radius: 0; border-bottom-left-radius: 0; }

#notes-master-progress-fill {
height: 100%;
transition: width 0.5s ease, background-color 0.5s ease; /* Added background-color transition */
}

@keyframes spin {
from { transform: rotate(0deg); }
to { transform: rotate(360deg); }
}
.animate-spin {
animation: spin 1s linear infinite;
}

.confetti-piece {
position: fixed;
top: -10px;
width: 10px;
height: 10px;
z-index: 9999;
pointer-events: none;
animation: fall linear forwards;
}

@keyframes fall {
to {
transform: translateY(105vh) rotate(360deg);
}
}

@keyframes successPop {
0% { transform: scale(1); }
50% { transform: scale(1.25); }
100% { transform: scale(1.1); }
}
.success-pop {
animation: successPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
/* Animation for search results filtering */
#notes-list-wrapper details.hidden {
display: none;
}
#notes-list-wrapper details:not(.hidden) {
animation: fadeIn 0.2s ease-out;
}
.material-card {
background: white;
border-radius: 12px;
border: 1px solid #e5e7eb;
overflow: hidden;
height: fit-content;
}
.nested-topic {
margin-left: 1.5rem;
border-left: 2px dashed #f3e8ff;
padding-left: 0.75rem;
}
.trackable-item:hover {
background-color: #f9fafb;
}

/* Material Tracker Specifics */
#materials-grid > div:last-child:nth-child(odd) {
grid-column: 1 / -1; /* This forces any "last odd" item to span the full width */
}

@media (min-width: 768px) {
#materials-grid > div:last-child:nth-child(odd) {
grid-column: span 2; /* Stretches the 1st, 3rd, 5th, etc. if it's the last one */
}
}

.material-panel {
border-top: 4px solid var(--panel-color, #FECE1B);
transition: transform 0.2s;
}
.material-panel:hover {
transform: translateY(-2px);
}
.nested-topic {
margin-left: 1.25rem;
border-left: 1px dashed #e5e7eb;
padding-left: 0.75rem;
}
.subject-progress-container {
background: rgba(0, 0, 0, 0.05);
height: 6px;
border-radius: 999px;
overflow: hidden;
margin-top: 4px;
}
.subject-progress-fill {
height: 100%;
transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
/* Ensure the topic dropdown takes full height and width available in the grid */
#topicSelect {
    width: 100% !important;
    min-height: 180px;
}

/* Force the color picker to span 7 columns for maximum width */
#calendar-color-picker {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    max-height: none;
    padding: 4px;
}

/* Red Cancel Button Theme */
.btn-cancel-red {
    color: #ef4444 !important;
    font-weight: 800;
}
.btn-cancel-red:hover {
    background-color: #fef2f2;
    border-radius: 8px;
}
.digest-card {
    border-left: 4px solid var(--theme-primary);
    background: white; /* Ensure this isn't set to black */
}

/* If you have a header style for the digest modal, ensure it's this: */
#digestModal .modal-header {
    background-color: var(--theme-primary) !important;
}

</style>
    
    <!-- Vercel Web Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
    
</head>



<body class="bg-gray-100 min-h-screen p-1 sm:p-2">
<div id="auth-overlay" class="fixed inset-0 z-[9999] bg-gray-100 overflow-hidden flex flex-col items-center transition-opacity duration-500">

    <div class="denial-content-container w-full max-w-[1152px] mt-1 mb-10 px-[10px]">
        
<header class="header-bg text-white py-1 px-4 sm:py-2 sm:px-6 rounded-xl shadow-2xl mt-0">            
<div class="flex items-center justify-between">

                <div class="flex-shrink-0 w-32 h-32 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/USA.png" alt="USA Logo" class="w-24 h-24 object-cover">
                </div>

                <div class="text-center mx-4 flex-grow">
                    <h1 class="text-xl sm:text-3xl font-extrabold header-font tracking-wider mb-2 underline" style="text-shadow: 2px 2px 0 #000000;">UNIVERSITY OF SAN AGUSTIN</h1>
                    <h2 class="text-2xl sm:text-5xl italic font-extrabold header-font tracking-widest" style="text-shadow: 2px 2px 0 #000000; line-height: 1.1; font-size: 2.75em;">2026 COMPREHENSIVE EXAM REVIEW TRACKER</h2>
                </div>

                <div class="flex-shrink-0 w-32 h-32 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/usacol.png" alt="USACoL Icon" class="w-28 h-28 object-cover">

                </div>
            </div>
        </header>

        <div class="denial-message-box bg-[#f7f7f7] border-4 border-[var(--theme-primary)] rounded-[10px] shadow-[0_4px_15px_rgba(0,0,0,0.4)] p-[20px_10px_20px_10px] mt-[5px] text-center mb-[-10px]">
            <h1 class="header-font text-[#cc0000] text-[3.5em] tracking-[0.1em] mb-[2px]" style="text-shadow: 0 0 10px rgba(109, 27, 27, 0.4);">ACCESS TRACKER</h1>            
            <div class="max-w-md mx-auto px-4 mb-4">
                <input type="password" id="auth-input" 
                       class="w-full px-6 py-3 rounded-lg border-2 border-gray-300 focus:border-[var(--theme-primary)] outline-none text-center text-xl tracking-[0.3em] font-black mb-4"
                       placeholder="enter password here">
                <button onclick="validateAuth()" 
                        class="try-again-btn w-full bg-[#1d4ed8] text-white font-[900] py-[12px] px-[40px] rounded-[8px] shadow-[0_5px_#0f34a0] transition-all active:translate-y-[3px] active:shadow-[0_2px_#0f34a0] text-[1.2em] uppercase">
                    UNLOCK TRACKER
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <i data-lucide="hourglass" class="w-6 h-6 mr-2" style="color: var(--theme-secondary);"></i>COMPRE EXAM DAY 1<i data-lucide="hourglass" class="w-6 h-6 ml-2" style="color: var(--theme-secondary);"></i>
                    </div>
                    <div class="p-2 text-center text-black">
                        <div class="mb-2 text-2xl header-font font-extrabold uppercase">JULY 12, 2026</div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="auth-days-1" class="text-[1.75rem] font-black">---</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="auth-hrs-1" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="auth-mins-1" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Mins</span></div>
                            <div class="flex flex-col"><span id="auth-secs-1" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Secs</span></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <i data-lucide="hourglass" class="w-6 h-6 mr-2" style="color: var(--theme-secondary);"></i>COMPRE EXAM DAY 2<i data-lucide="hourglass" class="w-6 h-6 ml-2" style="color: var(--theme-secondary);"></i>
                    </div>
                    <div class="p-2 text-center text-black">
                        <div class="mb-2 text-2xl header-font font-extrabold uppercase">JULY 19, 2026</div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="auth-days-2" class="text-[1.75rem] font-black">---</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="auth-hrs-2" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="auth-mins-2" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Mins</span></div>
                            <div class="flex flex-col"><span id="auth-secs-2" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Secs</span></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <i data-lucide="hourglass" class="w-6 h-6 mr-2" style="color: var(--theme-secondary);"></i>COMPRE EXAM DAY 3<i data-lucide="hourglass" class="w-6 h-6 ml-2" style="color: var(--theme-secondary);"></i>
                    </div>
                    <div class="p-2 text-center text-black">
                        <div class="mb-2 text-2xl header-font font-extrabold uppercase">JULY 26, 2026</div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="auth-days-3" class="text-[1.75rem] font-black">---</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="auth-hrs-3" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="auth-mins-3" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Mins</span></div>
                            <div class="flex flex-col"><span id="auth-secs-3" class="text-[1.75rem] font-black">--</span><span class="text-[0.5rem] uppercase font-bold text-gray-500">Secs</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-4 text-center">
            <p class="quote text-black font-semibold text-[15px]" style="font-family: 'Cormorant Garamond', serif;">Trust that your hard work will never betray you. You did not come this far to only come this far.</p>
            <p class="signature mt-1">
                <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/missattycpa.PNG" alt="missattycpa signature" class="inline-block h-4">
                <span class="date-quote-style text-black ml-1 font-bold" style="font-family: 'Cormorant Garamond', serif; font-size: 0.9rem;">| november 2025</span>
            </p>
        </footer>
    </div>
</div>


<div class="main-content-wrapper">

<div class="sticky-top-pane pt-1 pb-2">

<header class="header-bg text-white py-1 px-4 sm:py-2 sm:px-6 rounded-xl shadow-2xl mt-0">            
        <div class="flex items-center justify-between">
                        <div class="flex-shrink-0 w-32 h-32 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/USA.png" alt="USA Logo" class="w-24 h-24 object-cover" onerror="this.outerHTML = '<i data-lucide=\'graduation-cap\' class=\'w-full h-full object-cover\'></i>'">
                        </div>
                        <div class="text-center mx-4 flex-grow">
                    <h1 class="text-xl sm:text-3xl font-extrabold header-font tracking-wider mb-2 underline" style="text-shadow: 2px 2px 0 #000000;">
UNIVERSITY OF SAN AGUSTIN</h1>

                    <h2 class="text-2xl sm:text-4xl italic font-extrabold header-font tracking-widest" style="text-shadow: 2px 2px 0 #000000; line-height: 1.1; font-size: 3em;">
2026 COMPREHENSIVE EXAM REVIEW TRACKER</h2>
                        </div>
                        <div class="flex-shrink-0 w-32 h-32 flex items-center justify-center rounded-full overflow-hidden">
                        <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/usacol.png" alt="USACOL Logo" class="w-28 h-28 object-cover" onerror="this.outerHTML = '<i data-lucide=\'shield\' class=\'w-full h-full object-cover\'></i>'">
                        </div>
                    </div>
                </header>
                <!-- NAVIGATION TABS -->
    <!-- Changed rounded-lg to rounded-b-xl, p-1 to p-0.5, py-2 to py-1 -->
    <nav class="flex overflow-x-auto no-scrollbar bg-white rounded-b-xl shadow-md border-x border-b border-gray-200 p-0.5 gap-1">

        <button onclick="switchTab('tab-dashboard')" class="tab-btn active flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span>Dashboard</span></button>
        <button onclick="switchTab('tab-calendar')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-calendar">
            <i data-lucide="calendar" class="w-4 h-4"></i> <span>Review Calendar</span></button>
        <button onclick="switchTab('tab-subjects')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-subjects">
            <i data-lucide="book-marked" class="w-4 h-4"></i> <span>Bar Subjects</span></button>
        <button onclick="switchTab('tab-gaerlan')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-gaerlan">
            <i data-lucide="pen-tool" class="w-4 h-4"></i> <span>Gaerlan Cases</span></button>
<button onclick="switchTab('tab-materials')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-materials">
<i data-lucide="book-open-check" class="w-4 h-4"></i> <span>Materials Tracker</span></button>
<button onclick="switchTab('tab-todo')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-todo">
<i data-lucide="list-checks" class="w-4 h-4"></i> <span>To-Do List</span></button>
<button onclick="switchTab('tab-notes')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-notes">
<i data-lucide="notebook" class="w-4 h-4"></i> <span>Review Notes</span></button>
<button onclick="switchTab('tab-links')" class="tab-btn flex-1 py-1 px-4 rounded-md text-gray-500 font-bold uppercase flex items-center justify-center gap-2" id="btn-links">
<i data-lucide="external-link" class="w-4 h-4"></i> <span>Links</span></button>

    </nav>
            </div>
        
            <!-- 2. COUNTDOWN PANELS (Hourglass color fixed to inherited white) -->
<div id="tab-dashboard" class="tab-content active space-y-2">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="card-day-1" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-sm font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg>COMPRE EXAM DAY 1<svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg>
                    </div>
                    <div class="p-2 text-center">
                        <div class="mb-2 flex justify-center items-center">
<!-- Day 1 -->
<span id="target-date-display-1" class="date-display-wrapper cursor-pointer relative inline-block">
    <input type="date" id="date-picker-1" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
    <span class="date-text pointer-events-none"></span>
</span>

                        </div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="days-1" class="time-value">000</span><span class="time-label">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-1" class="time-value">00</span><span class="time-label">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-1" class="time-value">00</span><span class="time-label">Mins</span></div>
                            <div class="flex flex-col"><span id="secs-1" class="time-value">00</span><span class="time-label">Secs</span></div>
                        </div>
                    </div>
                </div>
                <div id="card-day-2" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-sm font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg></i>COMPRE EXAM DAY 2<svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg>
                    </div>
                    <div class="p-2 text-center">
                        <div class="mb-2 flex justify-center items-center">
<!-- Day 2 -->
<span id="target-date-display-2" class="date-display-wrapper cursor-pointer relative inline-block">
    <input type="date" id="date-picker-2" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
    <span class="date-text pointer-events-none"></span>
</span>

                        </div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="days-2" class="time-value">000</span><span class="time-label">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-2" class="time-value">00</span><span class="time-label">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-2" class="time-value">00</span><span class="time-label">Mins</span></div>
                            <div class="flex flex-col"><span id="secs-2" class="time-value">00</span><span class="time-label">Secs</span></div>
                        </div>
                    </div>
                </div>
                <div id="card-day-3" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                    <div class="flex items-center justify-between card-header-bg text-white p-2 text-sm font-bold text-center border-b-4 border-custom-yellow uppercase">
                        <svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg></i>COMPRE EXAM DAY 3<svg class="animated-hourglass-svg w-5 h-5 text-white" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">    <!-- Frame -->    <path d="M20 10 H80 V20 H70 L50 40 L30 20 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <path d="M20 90 H80 V80 H70 L50 60 L30 80 H20 Z" fill="none" stroke="currentColor" stroke-width="4"/>    <line x1="50" y1="40" x2="50" y2="60" stroke="currentColor" stroke-width="4"/>
    <!-- Top sand (flows down) -->     <path class="sand top-sand" d="M30 20 L50 35 L70 20 Z" fill="var(--theme-secondary)"/>    
    <!-- Bottom sand (builds up) -->    <path class="sand bottom-sand" d="M30 80 L50 65 L70 80 Z" fill="var(--theme-secondary)"/></svg>
                    </div>
                    <div class="p-2 text-center">
                        <div class="mb-2 flex justify-center items-center">
<!-- Day 3 -->
<span id="target-date-display-3" class="date-display-wrapper cursor-pointer relative inline-block">
    <input type="date" id="date-picker-3" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
    <span class="date-text pointer-events-none"></span>
</span>

                        </div>
                        <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                            <div class="flex flex-col"><span id="days-3" class="time-value">000</span><span class="time-label">Days</span></div>
                            <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-3" class="time-value">00</span><span class="time-label">Hrs</span></div>
                            <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-3" class="time-value">00</span><span class="time-label">Mins</span></div>
                            <div class="flex flex-col"><span id="secs-3" class="time-value">00</span><span class="time-label">Secs</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Overall Progress (DASHBOARD) - Floating Effect -->
            <div id="overall-dashboard" class="mt-2 p-0">
                <div class="dashboard-container">
                    
                    <!-- LEFT SIDE: CHART & METRICS - Aligns with Day 1 Card -->
<div class="chart-panel py-1.5">
    
    <div class="header-bg p-0.5 rounded-lg mb-1 text-center header-font flex flex-col items-center justify-center border-b-2 border-custom-yellow">
        <span id="today-date-display" class="text-white today-date-text block font-extrabold" style="text-shadow: none;"></span>
    </div>
    
<div class="w-full flex items-center justify-center mb-1 relative"> 
<input type="text" id="user-name-input" placeholder="Input your name here..." 
       class="w-[90%] text-center text-xl font-bold header-font border-b border-gray-300 
              focus:border-[var(--theme-secondary)] outline-none p-0 bg-transparent text-gray-800" 
       maxlength="30" autocomplete="off"
       onblur="saveUserName(this.value)" 
       onkeydown="if(event.key==='Enter') { saveUserName(this.value); this.blur(); }">

    <button onclick="window.showThemedModal({
                title: 'LOCK TRACKER',
                message: 'Are you sure you want to lock the tracker and log out?',
                type: 'confirm',
                confirmText: 'LOGOUT',
                onConfirm: () => { localStorage.removeItem('auth_session_start'); location.reload(); }
            })" 
            title="Lock Tracker (Logout)"
            class="absolute right-0 text-gray-400 hover:text-purple-600 transition-all flex-shrink-0 hover-pulse">
        <i data-lucide="power" class="w-4 h-4"></i>
    </button>
</div>

    <h3 class="text-xl font-extrabold header-font tracking-wider text-chart-title text-center mt-1 mb-1">YOUR REVIEW PROGRESS</h3>
    
    <div class="pie-chart-wrapper" style="margin-top: 0.1rem; margin-bottom: 0.1rem;">
        <div id="global-pie-chart" class="relative" style="width: 160px; height: 160px;">
            </div>                            
                            <!-- Done Metric (Left of Pie) -->
                            <div class="metric-pie-side left">
                                <span id="global-progress-done" class="text-chart-done metric-value">0.0%</span>
                                <span class="text-chart-done block leading-tight">DONE</span>
                                <span class="text-gray-600 font-normal block leading-tight"><span id="global-total-done-count">0</span> TOPICS</span>
                            </div>

                            <!-- To Read Metric (Right of Pie, Red) -->
<div class="metric-pie-side right">
                                <span id="global-progress-toread" class="text-chart-toread metric-value">0.0%</span>
                                <span class="text-chart-toread block leading-tight">TO-READ</span>
                                <span class="text-gray-600 font-normal block leading-tight"><span id="global-total-toread-count">0</span> TOPICS</span>
                            </div>
                        </div>

                        <div class="mt-4 px-4 py-2 bg-purple-50/30  border border-dashed border-[#A500FF4D] rounded-lg shadow-inner">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-[10px] font-black text-[var(--theme-primary)] tracking-tighter flex items-center">
                                    <i data-lucide="pen-tool" class="w-3 h-3 mr-1"></i> GAERLAN PENNED CASES
                                </span>
                                <span id="casePercentText" class="text-[10px] font-black text-gray-500">0.0%</span>
                            </div>
                            <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                                <div id="caseProgressBar" class="h-full bg-black transition-all duration-700" style="width: 0%"></div>
                            </div>
                            <div class="text-[7px] text-center mt-1 text-gray-400 font-bold uppercase tracking-widest" id="caseCountText">0/0 CASES READ</div>
                        </div>
                    </div>

                    <!-- Spacer Column -->
                    <div class="hidden lg:block border-r border-gray-300"></div>

                    <!-- RIGHT SIDE: SCHEDULE TABLE -->
                    <div class="schedule-panel">
                        <table class="schedule-table">
                            <thead>
                                <tr class="schedule-header">
                                    <th style="width: 20%;" class="border-b-2 border-r-2 border-t-2 border-l-2 text-white">DATE</th>
                                    <th style="width: 55%;" class="border-b-2 border-t-2 border-r-2 text-white">SUBJECT</th>
                                    <th style="width: 25%;" class="border-b-2 border-t-2 border-r-2 text-white">PROGRESS*</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <!-- Rows dynamically populated by JS -->
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

</div>

                
<div id="tab-calendar" class="tab-content">
                <div id="calendar-module-placeholder"></div>
</div>

<div id="tab-subjects" class="tab-content space-y-4">
               <!-- Subject panels will be dynamically injected here -->
                <div id="subject-tracker-panel-rem"></div>
                <div id="subject-tracker-panel-crim"></div>
                <div id="subject-tracker-panel-lab"></div>
                <div id="subject-tracker-panel-civ"></div>
                <div id="subject-tracker-panel-comm"></div>
                <div id="subject-tracker-panel-poli"></div> 
</div>
</div>

<div id="tab-gaerlan" class="tab-content">
                <!-- MAIN COLLAPSIBLE CARD FROM case_tracker.html -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 overflow-hidden mb-6">       
                    <details class="group" open>
                        <!-- HEADER (SUMMARY) -->
<summary class="block p-0 cursor-pointer select-none transition-colors hover:bg-[var(--theme-primary)]/90"
    style="background-color: var(--theme-primary); border-bottom: 5px solid var(--theme-secondary);">
    <div class="flex flex-col items-start justify-between py-3 px-6 text-white gap-2">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center">
                <i data-lucide="pen-tool" class="w-6 h-6 mr-3"></i>
                <h1 class="text-xl sm:text-2xl font-bold uppercase tracking-tight">GAERLAN PENNED CASES</h1>
            </div>
            <div class="flex items-center text-xs">
                <span class="text-gray-300 mr-2 font-light hidden sm:inline">Press to Expand/Collapse</span>
                <i data-lucide="chevron-right" class="w-6 h-6 ml-2 transform transition-transform duration-300 group-open:rotate-90"></i>
            </div>
        </div>

<div class="flex flex-wrap items-center gap-6 w-full text-[0.7rem]">
    <div class="flex items-center gap-4 whitespace-nowrap">
        <span class="flex items-center font-bold tracking-tight uppercase"><i data-lucide="check-circle-2" class="w-4 h-4 mr-1 text-gray-200"></i>DONE:&nbsp;<span id="headerDone">0</span>&nbsp;CASES</span>
        <span class="flex items-center font-bold tracking-tight uppercase"><i data-lucide="book-open" class="w-4 h-4 mr-1 text-gray-200"></i>TO READ:&nbsp;<span id="headerRemaining">0</span>&nbsp;CASES</span>
    </div>
    
    <div class="flex items-center space-x-2 flex-grow min-w-[200px]">
        <span class="whitespace-nowrap flex items-center font-bold tracking-tight uppercase"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-1"></i>OVERALL PROGRESS:</span>
                <div class="flex-grow bg-white/20 h-3 rounded-full overflow-hidden relative">
                    <div id="headerProgressBar" class="bg-white h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <span id="headerPercent" class="font-bold">0.0%</span>
            </div>
        </div>
    </div>
</summary>
 
                        <!-- EXPANDABLE CONTENT -->
<div class="bg-black border-t border-gray-200">
                            
<!-- 1. COMPACT TOOLBAR (Search & Filters) -->
<div class="bg-white p-2 border-b border-gray-200 flex flex-col md:flex-row gap-2 items-center justify-between sticky top-0 z-20 shadow-sm">
    
    <!-- Search + Buttons Row -->
    <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto items-center">
        <div class="relative w-full md:w-80 group flex items-center">
            <i data-lucide="search" class="absolute left-3 z-10 h-4 w-4 text-gray-500 group-focus-within:text-[var(--theme-secondary)] transition-colors pointer-events-none"></i>
            <input type="text" id="searchInput" onkeyup="filterTable()"
                   placeholder="Quick search title, date..."
                   class="w-full pl-10 pr-3 py-1.5 rounded-lg border border-gray-300 bg-white text-gray-800 text-xs font-semibold focus:outline-none focus:border-black focus:ring-1 focus:ring-black placeholder-gray-400 transition-all">
        </div>
        
<div class="flex gap-2">
    <button onclick="exportAllDigests()" class="px-3 py-1.5 bg-emerald-600 text-white text-[10px] font-bold uppercase rounded hover:bg-[#2a0052] flex items-center gap-1 border-b-2 border-[var(--theme-primary)] transition-all">
        <i data-lucide="download" class="w-3 h-3"></i> Export All
    </button>
    
    <button onclick="triggerImport()" class="px-3 py-1.5 bg-blue-600 text-white text-[10px] font-bold uppercase rounded hover:bg-[#2a0052] flex items-center gap-1 border-b-2 border-[var(--theme-primary)] transition-all">
        <i data-lucide="upload" class="w-3 h-3"></i> Import All
    </button>
    
    <button onclick="preloadLatestDigests()" class="px-3 py-1.5 bg-[var(--theme-secondary)] text-black text-[10px] font-bold uppercase rounded hover:opacity-90 flex items-center gap-1 border-b-2 border-[var(--theme-primary)] transition-all" title="Pull the latest pre-written digests from the repo">
        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Preload Digests
    </button>
            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importDigests(event)">
        </div>
    </div>

    <!-- Filters (Division + Type + Shown count) -->
    <div class="flex gap-2 w-full md:w-auto overflow-x-auto no-scrollbar">
        <select id="filterDivision" onchange="filterTable()" class="px-2 py-1.5 bg-gray-50 border border-gray-300 rounded text-[10px] font-bold uppercase text-gray-600 focus:outline-none focus:border-black cursor-pointer hover:bg-gray-100">
            <option value="">All Divisions</option>
            <option value="EN BANC">En Banc</option>
            <option value="1ST DIVISION">1st Division</option>
            <option value="2ND DIVISION">2nd Division</option>
            <option value="3RD DIVISION">3rd Division</option>
        </select>
        
        <select id="filterType" onchange="filterTable()" class="px-2 py-1.5 bg-gray-50 border border-gray-300 rounded text-[10px] font-bold uppercase text-gray-600 focus:outline-none focus:border-[var(--theme-secondary)] cursor-pointer hover:bg-gray-100">
            <option value="">All Types</option>
            <option value="DECISION">Decision</option>
            <option value="RESOLUTION">Resolution</option>
        </select>

        <div class="px-3 py-1.5 bg-white-50 text-[var(--theme-primary)] border border-white-100 rounded text-[10px] font-bold uppercase whitespace-nowrap flex items-center">
            <span id="visibleCount">0</span>&nbsp;Shown
        </div>
    </div>
</div>
  
                            <!-- 2. TABLE CONTAINER -->
<div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 relative" id="mainTable">
<thead class="bg-gray-50 sticky top-0 z-10 shadow-xs text-xs font-bold text-[var(--theme-primary)] uppercase tracking-wider">
    <tr>
        <th onclick="sortTable(0, 'number')" class="sortable px-2 py-2 border-b border-gray-200 group">
            <div class="flex items-center justify-start gap-1">
                <span class="text-[10px]">NO.</span>
                <i data-lucide="arrow-up-down" class="sort-icon w-3 h-3 opacity-30"></i>
            </div>
        </th>
        <th onclick="sortTable(1, 'string')" class="sortable px-3 py-2 text-left border-b border-gray-200 min-w-[300px] group">
            <div class="flex items-center justify-start gap-1">
                <span>Case Title</span>
                <i data-lucide="arrow-up-down" class="sort-icon w-3 h-3 opacity-30"></i>
            </div>
        </th>
        <th onclick="sortTable(2, 'string')" class="sortable px-3 py-2 border-b border-gray-200 w-32 group">
            <div class="flex items-center justify-center gap-1">
                <span>Division</span>
                <i data-lucide="arrow-up-down" class="sort-icon w-3 h-3 opacity-30"></i>
            </div>
        </th>
        <th onclick="sortTable(3, 'date')" class="sortable px-3 py-2 border-b border-gray-200 w-28 group">
            <div class="flex items-center justify-center gap-1">
                <span>Date</span>
                <i data-lucide="arrow-up-down" class="sort-icon w-3 h-3 opacity-30"></i>
            </div>
        </th>
        <th onclick="sortTable(4, 'string')" class="sortable px-3 py-2 border-b border-gray-200 w-24 group">
            <div class="flex items-center justify-center gap-1">
                <span>Type</span>
                <i data-lucide="arrow-up-down" class="sort-icon w-3 h-3 opacity-30"></i>
            </div>
        </th>
        <th class="px-3 py-2 text-center border-b border-gray-200 w-24">Digest</th>
        <th class="px-3 py-2 text-center border-b border-gray-200 w-24">
            <div class="flex items-center justify-center gap-2">
                <span class="text-[10px] tracking-tighter">DONE</span>
                <input type="checkbox" id="checkAll" onclick="toggleAll(this)" class="custom-checkbox w-4 h-4">
            </div>
        </th>
    </tr>
</thead>
                                <tbody id="caseTableBody" class="divide-y divide-gray-100 text-xs text-gray-700 bg-white">
                                    <!-- JS WILL INJECT ROWS HERE -->
</tbody>
                            </table>
                        </div> <!-- Closes table container -->
                    </div> <!-- Closes black header background -->
                </details>
            </div> <!-- Closes white card wrapper -->
        </div> <!-- Closes tab-gaerlan -->


            <!-- NOTEPAD MODAL FROM case_tracker.html -->
<div id="digestModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-2 transition-opacity duration-300">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-[98vw] max-h-[95vh] flex flex-col overflow-hidden transform transition-all scale-95 duration-300 ease-out" id="digestModalContent">
    
<div class="bg-[var(--theme-primary)] border-b border-[var(--theme-secondary)]">
    <div class="p-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i data-lucide="notebook-pen" class="w-5 h-5 text-[var(--theme-secondary)]"></i>
            <h2 class="text-sm header-font tracking-widest text-white uppercase">Case Digest</h2>
        </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="px-4 pb-3">
            <h1 id="modalCaseTitle" class="text-xl sm:text-2xl font-black text-white uppercase tracking-tighter leading-tight drop-shadow-sm">
                Select a case...
            </h1>
        </div>
    </div>

<div class="p-3 pt-1 overflow-y-auto bg-[#f9fafb] flex-grow space-y-4">
        <input type="hidden" id="currentCaseId">

    
<div class="flex flex-col space-y-0.5 mb-2 px-1">
    <div class="flex items-center gap-2">
        <span class="text-sm font-black text-black uppercase tracking-tight">G.R. No:</span>
        <input type="text" id="noteGRNo" class="bg-transparent text-sm text-gray-800 font-bold focus:outline-none border-b border-dashed border-gray-300 flex-grow" placeholder="Enter GR Number...">
    </div>
    <div class="flex items-center gap-2">
        <span class="text-sm font-black text-black uppercase tracking-tight">Date:</span>
        <input type="text" id="noteCaseDate" class="bg-transparent text-sm text-gray-800 font-bold focus:outline-none border-b border-dashed border-gray-300 flex-grow" readonly placeholder="Detected from CSV...">
    </div>
    <div class="flex items-center gap-2">
        <span class="text-sm font-black text-black uppercase tracking-tight">Division:</span>
        <input type="text" id="noteDivision" class="bg-transparent text-sm text-gray-800 font-bold focus:outline-none border-b border-dashed border-gray-300 flex-grow" readonly placeholder="Detected from CSV...">
    </div>
</div>

<div class="bg-orange-50/50 p-2 rounded-r-lg shadow-sm border border-orange-200 border-l-[6px] border-l-orange-500">
        <label class="modal-label text-[10px] font-extrabold text-orange-700 border-orange-700 uppercase tracking-wider mb-1 block">Doctrine / Syllabus</label>
<textarea id="noteDoctrine" class="w-full p-1 bg-transparent text-sm text-gray-800 leading-snug focus:outline-none font-bold auto-expand" style="text-align: justify;" placeholder="Enter doctrine..."></textarea>
</div>

    <div class="bg-yellow-50/50 p-2 rounded-r-lg shadow-sm border border-yellow-200 border-l-[6px] border-l-yellow-500">
        <label class="modal-label text-[10px] font-extrabold text-yellow-700 border-yellow-700 uppercase tracking-wider mb-1 block">Facts</label>
<textarea id="noteFacts" class="w-full p-1 bg-transparent text-sm text-gray-700 focus:outline-none font-bold" placeholder="Brief facts..."></textarea>
    </div>

    <div class="bg-green-50/50 p-2 rounded-r-lg shadow-sm border border-green-200 border-l-[6px] border-l-green-500">
        <label class="modal-label text-[10px] font-extrabold text-green-700 border-green-700 uppercase tracking-wider mb-1 block">Issue/s</label>
<textarea id="noteIssue" class="w-full p-1 bg-transparent text-sm text-gray-700 focus:outline-none font-bold" placeholder="Legal issues..."></textarea>
    </div>

<div class="bg-pink-50/50 p-2 rounded-r-lg shadow-sm border border-pink-200 border-l-[6px] border-l-pink-500">
    <label class="modal-label text-[10px] font-extrabold text-pink-700 border-pink-700 uppercase tracking-wider mb-1 block">Ruling</label>
<textarea id="noteRuling" class="w-full p-1 bg-transparent text-sm text-gray-700 focus:outline-none font-bold" placeholder="Court's ruling..."></textarea>
</div>

    <div class="bg-red-50/50 p-2 rounded-r-lg shadow-sm border border-red-200 border-l-[6px] border-l-red-500">
        <label class="modal-label text-[10px] font-extrabold text-red-700 border-red-700 uppercase tracking-wider mb-1 block">Dispositive Portion</label>
<textarea id="noteDispositive" class="w-full p-1 bg-transparent text-sm text-gray-700 focus:outline-none font-bold" placeholder="WHEREFORE..."></textarea>
    </div>

<div class="bg-white px-4 py-2 border-t border-gray-100 flex justify-between items-center">
    <span class="text-[10px] text-gray-400 italic">Auto-saves on 'Save'</span>
    <div class="flex gap-2 items-center">

        <button onclick="exportSingleDigest()" class="px-3 py-1.5 bg-emerald-600 text-white text-[10px] font-bold uppercase rounded hover:bg-emerald-700 flex items-center gap-1">
            <i data-lucide="file-text" class="w-3 h-3"></i> Export
        </button>

        <button onclick="triggerImport()" class="px-3 py-1.5 bg-blue-600 text-white text-[10px] font-bold uppercase rounded hover:bg-blue-700 flex items-center gap-1">
            <i data-lucide="upload" class="w-3 h-3"></i> Import
        </button>
        
        <button onclick="closeModal()" class="px-3 py-1.5 bg-red-600 text-white text-[10px] font-bold uppercase rounded hover:bg-blue-700 flex items-center gap-1">
            <i data-lucide="trash" class="w-3 h-3"></i> Cancel</button>

        <button onclick="saveDigest()" class="px-3 py-1.5 bg-[var(--theme-primary)] text-white text-[10px] font-bold uppercase rounded hover:bg-emerald-700 flex items-center gap-1">
            <i data-lucide="save" class="w-3 h-3"></i> Save Digest
        </button>

    </div>
</div>
        </div>
    </div>
</div>
            </div> <!-- End Case Tracker -->
</div>



<div id="tab-notes" class="tab-content">
<div class="bg-white p-4 rounded-xl shadow border border-gray-200">


<div class="header-bg px-5 py-4 rounded-xl shadow-lg border-b-4 border-[#FECE1B] mb-6">
<div class="flex justify-between items-center mb-1">
<h2 class="header-font text-xl text-white tracking-widest uppercase">Overall Notes Progress</h2>
<span id="notes-master-percent" class="font-black text-sm text-white">0%</span>
</div>

<div id="notes-master-progress-wrapper" class="bg-white/10 h-1 rounded-full overflow-hidden mt-2 mb-3">
<div id="notes-master-progress-fill" class="h-full bg-white shadow-[0_0_8px_#FECE1B] transition-all duration-700 w-0"></div>
</div>

<div class="relative group">
<i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3 h-3 text-white/40 group-focus-within:text-white transition-colors"></i>
<input type="text" id="notes-search" placeholder="Search topics..."
class="w-full pl-8 pr-3 py-1.5 bg-white/10 border border-white/10 rounded-lg outline-none focus:bg-white/20 transition-all text-[10px] text-white placeholder:text-white/30 font-medium"
oninput="handleNotesSearch(this.value)">
</div>
</div>


<div class="w-full mb-6 border-b pb-4" id="notes-subject-tabs">
<button onclick="switchNotesSubject('rem')" class="notes-sub-tab" id="sub-btn-rem" data-sub="rem">Remedial Law</button>
<button onclick="switchNotesSubject('crim')" class="notes-sub-tab" id="sub-btn-crim" data-sub="crim">Criminal Law</button>
<button onclick="switchNotesSubject('lab')" class="notes-sub-tab" id="sub-btn-lab" data-sub="lab">Labor Law</button>
<button onclick="switchNotesSubject('civ')" class="notes-sub-tab" id="sub-btn-civ" data-sub="civ">Civil Law</button>
<button onclick="switchNotesSubject('tax')" class="notes-sub-tab" id="sub-btn-tax" data-sub="tax">Commercial Law</button>
<button onclick="switchNotesSubject('poli')" class="notes-sub-tab active" id="sub-btn-poli" data-sub="poli">Political Law</button>
</div>

<div id="notes-container" class="space-y-4"></div>
</div>
</div>

<div id="tab-materials" class="tab-content">
<div class="header-bg p-4 rounded-t-xl flex justify-between items-center">
<div class="flex flex-col">
<h2 class="header-font text-2xl text-white tracking-widest uppercase leading-none">Materials Tracker</h2>
<p class="text-[10px] font-bold text-white/60 italic tracking-widest mt-1 uppercase">
Use this to track progress for review books, video lectures, or handouts
</p>
</div>
<button onclick="openMaterialModal()" class="bg-[#FECE1B] text-[var(--theme-primary)] px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:scale-105 transition-all">
+ Track a Review Material
</button>
</div>

<div id="materials-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 p-4"></div>
</div>

<div id="topic-entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[260] p-4">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-animate-in">
<div class="modal-header-bg p-4 text-white font-black header-font text-xl tracking-widest uppercase">
Add Topic
</div>
<div class="p-6 space-y-4">
<input type="text" id="topic-title" placeholder="Topic Title..." class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#FECE1B]">
<label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer">
<input type="checkbox" id="topic-trackable" class="w-5 h-5 rounded border-gray-300 text-[#6D1B1B]">
<span class="text-xs font-bold text-gray-600 uppercase">Make Trackable (Add Checkbox)</span>
</label>
</div>
<div class="p-4 bg-gray-50 flex gap-2">
    <button type="button" onclick="document.getElementById('topic-entry-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">CANCEL</button>
    <button id="save-topic-btn" class="flex-1 py-3 bg-[#330066] text-white font-black uppercase text-[10px] rounded-xl shadow-lg">Save Topic</button>
</div>
</div>
</div>

<div id="material-entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[250] p-4">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-animate-in">
<div class="modal-header-bg p-4 text-white font-black header-font text-2xl tracking-widest uppercase flex justify-between">
<span id="mat-modal-title">New Review Material</span>
<button onclick="closeMaterialModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="p-8 space-y-6">
<input type="text" id="mat-name" placeholder="Material Name (e.g. 2026 eCodal - POLITICAL LAW)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#FECE1B]">

<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
<div>
<label class="block text-[10px] font-black uppercase text-gray-400 mb-3">Select Icon</label>
<div id="mat-icon-picker" class="grid grid-cols-5 gap-1 p-2 border border-gray-100 rounded-xl bg-gray-50/30"></div>
</div>
<div>
<label class="block text-[10px] font-black uppercase text-gray-400 mb-3">Select Color</label>
<div id="mat-color-picker" class="grid grid-cols-5 gap-3 p-1"></div>
</div>
</div>
</div>
<div class="p-6 bg-gray-50 flex gap-3">
<button onclick="closeMaterialModal()" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest hover:text-gray-600 transition-colors">Cancel</button>
<button onclick="saveMaterialEntry()" class="flex-1 py-3 bg-[#6D1B1B] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg hover:bg-[#FECE1B] transition-all">Save Material</button>
</div>
</div>
</div>



<div id="tab-todo" class="tab-content">
<div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden flex flex-col min-h-[700px]">
<div class="header-bg p-4 flex flex-col md:flex-row justify-between items-center gap-4">
<div class="flex items-center gap-4">
<button onclick="navigateTodo(-1)" class="p-2 hover:bg-white/10 rounded-full text-white">
<i data-lucide="chevron-left"></i>
</button>
<div class="text-white text-center md:text-left min-w-[180px]">
<h2 id="todo-view-title" class="header-font text-2xl tracking-widest uppercase">Agenda</h2>
<p id="todo-date-display" class="text-[10px] font-bold uppercase opacity-80"></p>
</div>
<button onclick="navigateTodo(1)" class="p-2 hover:bg-white/10 rounded-full text-white">
<i data-lucide="chevron-right"></i>
</button>

<div class="flex items-center ml-2 bg-[#FECE1B] rounded-lg overflow-hidden border border-white/20 shadow-sm">
    <button onclick="jumpToToday()" class="px-3 py-1.5 text-[10px] font-black uppercase text-[#6D1B1B] hover:bg-white transition-all border-r border-white/20">
        Today
    </button>
    <button onclick="document.getElementById('date-jumper').showPicker()" class="px-3 py-1.5 text-[#6D1B1B] hover:bg-white transition-all flex items-center justify-center">
        <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
    </button>
<input type="date" id="date-jumper" class="absolute invisible" onchange="handleJumpToDate(this.value)">
</div>
</div>


<div class="flex bg-white/10 p-1 rounded-lg gap-1">
<button onclick="switchTodoMode('daily')" id="todo-btn-daily" class="todo-mode-btn px-4 py-1 text-[10px] font-black uppercase rounded bg-white text-[#6D1B1B]">Daily</button>
<button onclick="switchTodoMode('weekly')" id="todo-btn-weekly" class="todo-mode-btn px-4 py-1 text-[10px] font-black uppercase rounded text-white">Weekly</button>
</div>
</div>

<div id="todo-render-container" class="p-6 flex-grow todo-paper overflow-x-auto"></div>
</div>
</div>



<div id="tab-links" class="tab-content">

<div class="header-bg p-4 rounded-lg mb-6 flex justify-between items-center">
<div class="flex flex-col">
<h2 class="header-font text-2xl text-white tracking-widest uppercase leading-none">Resource Links</h2>
<p class="text-[10px] font-bold text-white/60 italic tracking-widest mt-1 uppercase">
Centralized database for drive links, lectures, and online reviewers
</p>
</div>
<button onclick="toggleLinkModal(true)" class="bg-[#FECE1B] text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase hover:scale-105 transition-all">
+ Add New Link
</button>
</div>

<div id="links-grid" class="grid grid-cols-2 gap-3">
</div>
</div>
</div>

<div id="link-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[250] p-4">
<div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-animate-in">
<div class="modal-header-bg p-4 text-white font-black header-font text-2xl tracking-widest uppercase flex justify-between">
<span id="link-modal-title">Add Resource Link</span>
<button onclick="toggleLinkModal(false)"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="p-8 space-y-6">
<div class="space-y-4">
<input type="text" id="link-title" placeholder="Link Title (e.g. Civ Law Drive)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#FECE1B]">
<input type="text" id="link-url" placeholder="URL (https://...)" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none focus:border-[#FECE1B]">
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
<div>
<label class="block text-[10px] font-black uppercase text-gray-400 mb-3 tracking-widest">Select Icon</label>
<div id="icon-picker" class="grid grid-cols-5 gap-1 p-2 border border-gray-100 rounded-xl bg-gray-50/30"></div>
</div>
<div>
<label class="block text-[10px] font-black uppercase text-gray-400 mb-3 tracking-widest">Select Color</label>
<div id="color-picker" class="grid grid-cols-5 gap-3 p-1"></div>
</div>
</div>
</div>
<div class="p-6 bg-gray-50 flex gap-3">
<button onclick="toggleLinkModal(false)" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest">Cancel</button>
<button onclick="saveLink()" class="flex-1 py-3 bg-[#6D1B1B] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg">Save Link</button>
</div>
</div>
</div>

<!-- 6. ANALYTICS TAB (PURPLE THEMED DASHBOARD) -->
        <div id="tab-analytics" class="tab-content mt-1">
            <div class="bg-white rounded-xl shadow-lg border border-gray-300 overflow-hidden mb-6">
                <details id="review-targets-panel" class="group" open>
                    <!-- Header: Deep Purple Background & Bright Purple Accent -->
<summary class="block p-0 cursor-pointer select-none transition-colors hover:bg-[#2a0052]"
    style="background-color: var(--theme-primary); border-bottom: 5px solid var(--theme-secondary);">
    <div class="flex flex-col items-start justify-between py-3 px-6 text-white gap-2">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center">
                <i data-lucide="pen-tool" class="w-6 h-6 mr-3 text-[var(--theme-secondary)]"></i>
                <h1 class="text-xl sm:text-2xl font-bold uppercase tracking-tight">GAERLAN PENNED CASES</h1>
            </div>
                                <div class="flex items-center text-xs opacity-80">
                                    <span class="mr-2 font-bold uppercase hidden sm:inline">Toggle View</span>
                                    <i data-lucide="chevron-right" class="w-6 h-6 transform transition-transform duration-300 group-open:rotate-90"></i>
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-8 w-full">
                                <div class="flex items-center gap-6">
                                    <div class="flex flex-col">
                                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-tighter">Boxes Checked</span>
                                        <span class="text-2xl font-black text-[var(--theme-secondary)]" id="daily-total">0</span>
                                    </div>
                                    <div class="h-8 border-l border-white/20"></div>
                                    <div class="flex flex-col">
                                        <span class="text-[10px] font-bold text-white/60 uppercase tracking-tighter">Remaining Goal</span>
                                        <span class="text-2xl font-black" id="daily-todo">0</span>
                                    </div>
                                </div>
                                
                                <div class="flex-grow min-w-[250px]">
                                    <div class="flex justify-between items-end mb-1.5">
                                        <span class="text-[10px] font-black uppercase tracking-widest">Target Progress</span>
                                        <span id="daily-target-percent-header" class="text-sm font-black text-[var(--theme-secondary)]">0%</span>
                                    </div>
                                    <div class="bg-white/10 h-3 rounded-full overflow-hidden border border-white/5">
                                        <div id="daily-target-bar-header" class="bg-[var(--theme-secondary)] h-full rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </summary>
                    
                    <!-- 5-Column Grid: Left Spans 3 (Wider), Right Spans 2 (Narrower) -->
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-5 gap-6 bg-gray-50/50 items-stretch">
                        
                        <!-- LEFT SIDE: Wider Insights (3 Columns) -->
                        <div class="lg:col-span-3 space-y-3 lg:pr-6 border-b lg:border-b-0 lg:border-r border-gray-200">
                            
                            <!-- Purple Study Streak -->
                            <div class="bg-[var(--theme-primary)] p-4 rounded-xl shadow-md text-white relative overflow-hidden group">
                                <div class="absolute -right-2 -top-2 opacity-10 group-hover:scale-110 transition-transform duration-700">
                                    <i data-lucide="flame" class="w-16 h-16 text-[var(--theme-secondary)]"></i>
                                </div>
                                <span class="text-[9px] font-bold text-white/60 uppercase tracking-widest block">Study Streak</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-3xl font-black italic" id="streak-count">0</span>
                                    <span class="text-[10px] font-black text-[var(--theme-secondary)] uppercase italic">Days Active</span>
                                </div>
                            </div>

                            <!-- Purple Goal Setting -->
                            <div class="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm">
                                <label class="block text-[8px] font-black text-gray-400 uppercase mb-2 tracking-widest">Adjust Target</label>
                                <div class="flex gap-2">
                                    <input type="number" id="daily-goal-input" class="w-full px-3 py-1.5 rounded-lg border-2 border-gray-50 focus:border-[var(--theme-primary)] outline-none font-black text-base text-[var(--theme-primary)]">
                                    <button onclick="window.updateAnalyticsGoal()" class="bg-[var(--theme-primary)] text-white px-4 py-1.5 rounded-lg font-black text-[9px] uppercase hover:bg-[#2a0052]">SET</button>
                                </div>
                            </div>

                            <!-- Purple Intensity -->
                            <div class="p-3.5 bg-white rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Today's Progress</span>
                                    <span id="daily-target-percent" class="text-sm font-black text-[var(--theme-primary)]">0%</span>
                                </div>
                                <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                    <div id="daily-target-bar" class="h-full transition-all duration-1000 shadow-inner"></div>
                                </div>
                            </div>

                            <button onclick="window.resetAnalyticsData()" class="w-full py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg text-[9px] font-black uppercase hover:bg-red-600 hover:text-white transition-all">
                                Wipe History
                            </button>
                        </div>

                        <!-- RIGHT SIDE: Narrower Timeline (2 Columns) -->
                        <div class="lg:col-span-2 flex flex-col">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3">
                                <h3 class="text-[10px] font-black text-[var(--theme-primary)] uppercase tracking-widest flex items-center">
                                    <i data-lucide="bar-chart-big" class="w-3.5 h-3.5 mr-2 text-[var(--theme-secondary)]"></i> Productivity Map
                                </h3>
                                <div class="flex bg-gray-200/60 p-0.5 rounded-lg">
                                    <button onclick="window.setAnalyticsRange('weekly')" id="range-weekly" class="range-tab px-3 py-1 text-[8px] font-black uppercase rounded-md transition-all bg-white shadow-sm text-[var(--theme-primary)]">Weekly</button>
                                    <button onclick="window.setAnalyticsRange('monthly')" id="range-monthly" class="range-tab px-3 py-1 text-[8px] font-black uppercase rounded-md transition-all text-gray-500">Monthly</button>
                                    <button onclick="window.setAnalyticsRange('custom')" id="range-custom" class="range-tab px-3 py-1 text-[8px] font-black uppercase rounded-md transition-all text-gray-500">Custom</button>
                                </div>
                            </div>

                            <div id="custom-range-picker" class="hidden grid grid-cols-2 gap-3 mb-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm animate-fadeIn">
                                <div>
                                    <span class="text-[8px] font-black text-gray-400 uppercase ml-1 block mb-1">Start Point</span>
                                    <input type="date" id="custom-start" class="w-full text-[10px] p-1.5 bg-gray-50 border border-gray-200 rounded-lg font-black uppercase outline-none focus:border-[var(--theme-primary)]" onchange="window.refreshTargetsUI()">
                                </div>
                                <div>
                                    <span class="text-[8px] font-black text-gray-400 uppercase ml-1 block mb-1">End Point</span>
                                    <input type="date" id="custom-end" class="w-full text-[10px] p-1.5 bg-gray-50 border border-gray-200 rounded-lg font-black uppercase outline-none focus:border-[var(--theme-primary)]" onchange="window.refreshTargetsUI()">
                                </div>
                            </div>

                            <div class="flex-grow flex flex-col justify-center min-h-[200px] bg-white/50 rounded-xl p-2">
                                <div id="analytics-chart-container" class="w-full h-full transition-all duration-500"></div>
                                <div id="analytics-labels-container" class="w-full transition-all duration-500"></div>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

<!-- START: LIMITATIONS & DATA MANAGEMENT COMBINED UNIT -->
            <div class="mt-4 mb-6 w-full">
                <div class="bg-blue-50/70 backdrop-blur-sm border border-blue-200 shadow-xl p-5 rounded-xl transition duration-300 hover:shadow-2xl hover:border-blue-300">
                    
                    <!-- 1. Tracker Limitations Content (Top) -->
                    <p class="font-bold text-sm text-blue-800 mb-2 flex items-center">
                        <i data-lucide="cloud" class="w-4 h-4 mr-2 text-blue-500"></i>
                        TRACKER LIMITATIONS
                    </p>
                    <ul class="list-disc list-outside ml-5 text-sm text-gray-700 space-y-2 mb-6">
                        <li class="pl-1">
                            <strong style="color: var(--theme-primary);">Progress Metric:</strong> Overall progress updates and a topic counts as â€œdoneâ€ only once <strong>4 out of 6 boxes</strong> per topic row are checked.
                        </li>
                        <li class="pl-1">
                            <strong style="color: var(--theme-primary);">Data Portability:</strong> Your review progress is saved <strong>only within your current browser</strong> (Local Storage). Your data will not be synchronized automatically if you clear your browsing data or switch devices. To transfer your progress to a new device or browser, please use the <strong> Export All Data</strong> and <strong> Import Existing Data</strong> functions.
                        </li>
                        <li class="pl-1">
                            <strong style="color: var(--theme-primary);">Device Compatibility:</strong> This tracker is optimized for <strong>Laptop/Desktop</strong> use to ensure all features and layouts render correctly.
                        </li>
                    </ul>

                    <!-- 2. Smaller Data Management Buttons (Bottom) -->
                    <div class="flex space-x-2 w-full pt-4 border-t border-blue-200">
                        <button onclick="exportAllData()" class="flex-1 px-2 py-1.5 bg-green-600 text-white font-bold text-[10px] rounded-lg shadow-md hover:bg-green-700 transition duration-150 uppercase flex items-center justify-center">
                            <i data-lucide="download-cloud" class="w-3 h-3 mr-1"></i> Export All Data
                        </button>
                        <button onclick="document.getElementById('global-file-input').click()" class="flex-1 px-2 py-1.5 bg-blue-600 text-white font-bold text-[10px] rounded-lg shadow-md hover:bg-blue-700 transition duration-150 uppercase flex items-center justify-center">
                            <i data-lucide="upload-cloud" class="w-3 h-3 mr-1"></i> Import Existing Data
                        </button>
                    </div>
                    <input type="file" id="global-file-input" class="hidden" accept=".json" onchange="importAllData(event)">
                </div>
            </div>
            <!-- END: DATA MANAGEMENT & LIMITATIONS BLOCK -->


    <!-- GLOBAL FOOTER -->
<footer class="global-app-footer">
    <p class="quote">
        Trust that your hard work will never betray you. You did not come this far to only come this far.
    </p>
    <p class="signature mt-1">
        <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/Images/missattycpa.PNG"
             alt="missattycpa signature"
             class="inline-block h-3.5"
             onerror="this.outerHTML = '<span class=\'text-miss\'>made by miss</span><span class=\'text-atty\'>atty</span><span class=\'text-cpa\'>cpa</span>'">
        <span class="date-text-signature">| november 2025</span>
        <!-- ADD THIS LINE -->
<p class="mt-2 text-center"> 
   <span class="inline-flex items-center px-3 py-1 bg-[var(--theme-primary)] text-white text-[10px] font-black uppercase tracking-widest rounded-full border-2 border-[var(--theme-secondary)] shadow-lg italic" 
         style="font-family: 'Inter', sans-serif;" 
         id="last-saved">
      â€¢ Last saved: never â€¢ 
   </span>    
</p>
</footer>

<div id="universal-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[10000] p-4 transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-95 duration-300 ease-out" id="universal-modal-content">
        <div class="header-bg p-3 flex items-center gap-3 border-b-4 border-custom-yellow">
            <i id="modal-icon" data-lucide="alert-circle" class="w-5 h-5 text-white"></i>
            <h2 id="modal-header-title" class="text-2xl header-font tracking-widest text-white uppercase mt-1">Notification</h2>
        </div>
        <div class="p-6 bg-gray-50">
            <p id="modal-body-text" class="text-sm font-bold text-gray-800 text-center leading-relaxed uppercase"></p>
        </div>
        <div class="bg-white p-4 border-t border-gray-100 flex gap-3 justify-center">
            <button id="modal-cancel-btn" class="hidden px-5 py-2 text-gray-500 font-black text-xs uppercase hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
            <button id="modal-confirm-btn" class="px-8 py-2 bg-[var(--theme-primary)] text-white font-black text-xs uppercase rounded-lg shadow-md hover:bg-purple-900 border-b-4 border-black/20 active:border-b-0 active:translate-y-1 transition-all">Confirm</button>
        </div>
    </div>
</div>

    <script>
const ALLOWED_PASSWORDS = ["ama", "bar", "2026", "bar2026"];
const AUTH_TARGET_DATES = ["2026-07-12", "2026-07-19", "2026-07-26"];

/* --- AUTO-EXPAND LOGIC START --- */
function autoExpandTextarea(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
}

window.showThemedModal = function(options) {
    const modal = document.getElementById('universal-modal');
    const titleEl = document.getElementById('modal-header-title');
    const textEl = document.getElementById('modal-body-text');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');

    titleEl.innerText = options.title || "NOTIFICATION";
    textEl.innerText = options.message || "";
    confirmBtn.innerText = options.confirmText || "OK";
    
    if (options.type === 'confirm') {
        cancelBtn.classList.remove('hidden');
        cancelBtn.innerText = options.cancelText || "CANCEL";
    } else {
        cancelBtn.classList.add('hidden');
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    confirmBtn.onclick = () => { modal.classList.add('hidden'); if (options.onConfirm) options.onConfirm(); };
    cancelBtn.onclick = () => { modal.classList.add('hidden'); if (options.onCancel) options.onCancel(); };
};


function updateAuthCountdown() {
    const now = new Date();
    AUTH_TARGET_DATES.forEach((dateStr, i) => {
        const id = i + 1;
        const target = new Date(dateStr + 'T00:00:00Z');
        const diff = target - now;
        
        if (diff > 0) {
            document.getElementById(`auth-days-${id}`).textContent = Math.floor(diff / (1000 * 60 * 60 * 24)).toString().padStart(3, '0');
            document.getElementById(`auth-hrs-${id}`).textContent = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            document.getElementById(`auth-mins-${id}`).textContent = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            document.getElementById(`auth-secs-${id}`).textContent = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');
        }
    });
}

// 1. Move validateAuth UP so the listener can see it
// 1. Defined globally so the listener can see it immediately
window.validateAuth = function() {
    const input = document.getElementById('auth-input');
    if (ALLOWED_PASSWORDS.includes(input.value.trim().toLowerCase())) {
        // Save current timestamp to local storage
        localStorage.setItem('auth_session_start', Date.now());
        document.getElementById('auth-overlay').style.display = "none";
        document.body.style.overflow = "auto";
        loadUserName(); 
        if(window.updateOverallDashboard) window.updateOverallDashboard();
    } else {
        window.location.href = 'denied.html';
    }
};


function checkAccess() {
    const overlay = document.getElementById('auth-overlay');
    const sessionStart = localStorage.getItem('auth_session_start');
    const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;

    // Check if session exists and is within 7 days
// Check if session exists and is within 7 days
    if (sessionStart && (Date.now() - sessionStart < sevenDaysInMs)) {
        overlay.style.display = "none";
        document.body.style.overflow = "auto";
        document.body.style.display = "block";
    } else {
        // No session or expired: show the portal
        document.body.style.display = "block";
        document.body.style.overflow = "hidden";
        overlay.style.display = "flex";
        
        setTimeout(() => { 
            const input = document.getElementById('auth-input');
            if(input) input.focus(); 
        }, 50);
    }
    
    setInterval(updateAuthCountdown, 1000);
    updateAuthCountdown();
}

// 2. Event listener for the Enter key
document.addEventListener('keydown', function(e) {
    const overlay = document.getElementById('auth-overlay');
    if (e.key === 'Enter' && overlay && overlay.style.display !== 'none') {
        e.preventDefault(); 
        validateAuth();
    }
});

checkAccess();


        // --- INLINED CALENDAR MODULE HTML CONTENT ---
        const CALENDAR_MODULE_HTML = `
            <div id="calendar-module-container" class="mt-1">
                <div class="calendar-wrapper mx-auto max-w-6xl p-0">
                    <details id="calendar-details" class="bg-white rounded-xl shadow-lg border border-gray-300" open>
                        <summary class="flex justify-between items-center p-4 font-bold text-lg cursor-pointer select-none" style="background-color: var(--theme-primary); color: white; border-bottom: 3px solid var(--theme-secondary);">
                            <div class="summary-title-content text-2xl flex-grow text-center flex items-center justify-center gap-2">
                                <i class="fa-solid fa-calendar-days"></i>
                                <span>REVIEW CALENDAR</span>
                                <i class="fa-solid fa-calendar-days"></i>
                            </div>
                            <span class="text-white text-sm toggle-indicator">
                                <i class="fa-solid fa-chevron-down"></i>
                            </span>
                        </summary>
                         
                        <div id="calendar-grid-container" style="display: grid; grid-template-columns: 3fr 1fr; gap: 1.5rem; align-items: start; padding: 0.25rem 0.5rem 0.5rem 0.5rem;"> 
                             
                            <div id="calendar-content" style="grid-column: 1; padding: 0;">
                                <div id='calendar-card' style="background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 0;">
                                    <div class="fc-toolbar fc-header-toolbar flex justify-between items-center p-2 rounded-lg border-1 border-secondary-gold" style="background-color: var(--theme-primary);">
                                        <div class="fc-left flex items-center">
                                            <span id="customMonthTitle" class="text-secondary-gold font-extrabold text-lg" style="color: #fff;"></span>
                                            <div class="fc-button-group ml-4">
                                                <button type="button" class="fc-today-button fc-button fc-state-default fc-corner-left fc-corner-right" onclick="window.CALENDAR_APP.setActiveButton(this, 'today'); $('#calendar').fullCalendar('today')">today</button>
                                            </div>
                                            <div class="fc-button-group ml-1">
                                                <button type="button" class="fc-month-button fc-button fc-state-default fc-corner-left" onclick="window.CALENDAR_APP.setActiveButton(this); $('#calendar').fullCalendar('changeView', 'month')">month</button>
                                                <button type="button" class="fc-basicWeek-button fc-button fc-state-default" onclick="window.CALENDAR_APP.setActiveButton(this); $('#calendar').fullCalendar('changeView', 'basicWeek')">week</button>
                                                <button type="button" class="fc-basicDay-button fc-button fc-state-default fc-corner-right" onclick="window.CALENDAR_APP.setActiveButton(this); $('#calendar').fullCalendar('changeView', 'basicDay')">day</button>
                                            </div>
                                            <button id="jumpToDateButton" type="button" onclick="window.CALENDAR_APP.toggleDateJumpPicker()" class="fc-button fc-state-default font-inter ml-4" style="background-color: var(--theme-secondary) !important; color: var(--theme-primary) !important; border-color: var(--theme-primary) !important;">JUMP TO DATE</button>
                                        </div>
                                        <div class="fc-right flex items-center">
                                            <div class="fc-button-group">
                                                <button type="button" class="fc-prev-button fc-button fc-state-default fc-corner-left" onclick="$('#calendar').fullCalendar('prev')"><i class="fa-solid fa-chevron-left"></i></button>
                                                <button type="button" class="fc-next-button fc-button fc-state-default fc-corner-right" onclick="$('#calendar').fullCalendar('next')"><i class="fa-solid fa-chevron-right"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id='calendar'></div>
                                </div>
                            </div>
                            <div id="notepad-sidebar" style="background-color: #FFF; border-radius: 1.0rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 1.5rem; display: flex; flex-direction: column; border: 1px solid #e5e7eb; grid-column: 2;">
<h3 class="text-4xl font-bold uppercase" 
    style="
        background-color: var(--theme-primary); 
        color: white; 
        border-bottom: 3px solid var(--theme-secondary);
        /* Increase internal vertical padding for height balance */
        padding: 0.75rem 1.5rem; 
        /* Ensure the font size stays maximized */
        font-size: 1.25rem; 
        font-weight: 800;
        line-height: 1.1;
    "
>
    <!-- INCREASE ICON SIZE -->
    <i class="fa-solid fas fa-pencil-alt mr-2" style="font-size: 1.25rem; vertical-align: middle;"></i>
    NOTES
</h3>                                <div class="flex space-x-2 mb-3">
                                    <button onclick="window.CALENDAR_APP.undoNotes()" class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 flex items-center" title="Undo Last Change">
                                        <i class="fa-solid fa-undo mr-1"></i> Undo
                                    </button>
                                    <button onclick="window.CALENDAR_APP.redoNotes()" class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 flex items-center" title="Redo Last Undo">
                                        <i class="fa-solid fa-redo mr-1"></i> Redo
                                    </button>
                                    <button onclick="window.CALENDAR_APP.clearNotes()" class="text-xs px-2 py-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150 flex items-center" title="Clear All Notes">
                                        <i class="fa-solid fa-eraser mr-1"></i> Clear
                                    </button>
                                    <button onclick="window.CALENDAR_APP.copyNotes()" class="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition duration-150 flex items-center" title="Copy Notes to Clipboard">
                                        <i class="fa-solid fa-copy mr-1"></i> Copy
                                    </button>
                                </div>
                                <textarea 
                                    id="review-notes" 
placeholder="Input your notes here...&#10;&#10;WHEREFORE, it is most respectfully prayed that the reviewee be awarded a passing score, no less than 75%, more preferably 85%+, with grace, confidence, and faith...."
                                    oninput="window.CALENDAR_APP.saveNotes()"
                                    style="font-family: 'Dancing Script', cursive; font-weight: 600; line-height: 1.95; padding: 1.5rem 1.0rem 1.0rem 1.0rem; flex-grow: 1; resize: none;"
                                ></textarea>
                            </div>
                             
                        </div>
                    </details>
                </div>
                 
<div id="topicModal" class="modal fixed inset-0 flex items-center justify-center hidden">
    <div class="modal-content" style="max-width: 750px; width: 95%;">
        <h2 id="modalTitle" class="text-xl font-black header-font tracking-widest mb-4 text-[var(--theme-primary)] uppercase">Schedule Item</h2>
        
        <input type="hidden" id="topicEventId">
        
        <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
            <button onclick="window.CALENDAR_APP.switchModalMode('task')" id="mode-btn-task" class="flex-1 py-2 text-[10px] font-black uppercase rounded-lg bg-white shadow-sm text-[var(--theme-primary)]">Study Task</button>
            <button onclick="window.CALENDAR_APP.switchModalMode('event')" id="mode-btn-event" class="flex-1 py-2 text-[10px] font-black uppercase rounded-lg text-gray-500">Custom Event</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div id="item-title-container">
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Item Title</label>
                    <input type="text" id="eventNameInput" placeholder="e.g. Rest Day or Subject Name" class="w-full p-2.5 border rounded-lg outline-none focus:border-[var(--theme-secondary)] font-bold text-sm">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Start Date</label>
                        <input type="date" id="topicStart" class="w-full p-2 border rounded-lg text-xs font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">End Date</label>
                        <input type="date" id="topicEnd" class="w-full p-2 border rounded-lg text-xs font-bold">
                    </div>
                </div>
            </div>

            <div id="modal-options-right">
                <div id="subject-container">
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Subject</label>
                    <select id="subjectSelect" onchange="window.CALENDAR_APP.populateTopics()" class="w-full p-2 border rounded-lg text-xs font-bold uppercase"></select>
                </div>

                <div id="mode-options-event" class="hidden">
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Select Icon</label>
                    <div id="calendar-icon-picker" class="grid grid-cols-6 gap-1"></div>
                </div>
            </div>
        </div>

        <div id="full-width-topic-container" class="mt-6 pt-4 border-t border-gray-100">
            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 tracking-widest">Specific Topic</label>
            <select id="topicSelect" size="8" class="w-full p-2 border rounded-lg text-[10px] font-black uppercase overflow-y-auto" style="width: 100%; min-height: 160px;"></select>
        </div>

        <div id="mode-options-color" class="hidden mt-6 pt-4 border-t border-gray-100">
            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 text-center tracking-widest">Select Event Color</label>
<div id="calendar-color-picker" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; width: 100%;"></div>
        </div>

        <div class="flex justify-between items-center mt-6 pt-4 border-t">
            <button type="button" onclick="window.CALENDAR_APP.closeTopicModal()" class="px-6 py-2 text-red-500 hover:bg-red-50 rounded-lg font-black text-[10px] uppercase transition-colors">Cancel</button>
            <div class="flex gap-2">
                <button id="deleteTopicBtn" onclick="window.CALENDAR_APP.deleteTopicTask()" class="px-6 py-2 bg-red-50 text-red-600 font-black text-[10px] rounded-lg uppercase hidden">Delete</button>
                <button id="saveTopicBtn" onclick="window.CALENDAR_APP.saveTopicTask()" class="px-8 py-2 bg-[var(--theme-primary)] text-white font-black text-[10px] rounded-lg shadow-lg uppercase">Schedule Item</button>
            </div>
        </div>
    </div>
</div>
                 
                <div id="custom-alert-modal" class="modal fixed inset-0 flex items-center justify-center hidden">
                    <div class="modal-content max-w-sm p-6 rounded-xl text-center">
                        <h3 id="alertTitle" class="text-lg font-bold mb-3 text-gray-800">ALERT</h3>
                        <p id="alertMessage" class="text-sm text-gray-700 mb-4"></p>
                        <div class="flex justify-end">
                            <button onclick="window.CALENDAR_APP.closeCustomAlert()" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">OK</button>
                        </div>
                    </div>
                </div>
                <!-- Hidden input to trigger native date picker, positioned absolutely initially -->
                <input type="date" id="dateJump" onchange="window.CALENDAR_APP.jumpToDate(this.value)"> 
                 
            </div>
        `;
        // --- END INLINED CALENDAR MODULE HTML CONTENT ---

        
        // --- CORE UTILITY AND COUNTDOWN LOGIC (REMAINS IN INDEX) ---
        
        // ðŸš¨ MODIFIED: Added two columns, renamed existing columns
        const CHECKLIST_COLUMNS = ['codal', 'first_reading', 'second_reading', 'pre_bar_notes', 'pre_week', 'lmts'];
        const COUNTDOWN_DATA = [
            {id:1,targetDate:localStorage.getItem('comp_exam_date_1')||'2026-07-12'},
            {id:2,targetDate:localStorage.getItem('comp_exam_date_2')||'2026-07-19'},
            {id:3,targetDate:localStorage.getItem('comp_exam_date_3')||'2026-07-26'}
        ];
        
        const DOM_ELEMENTS = {
            modal: document.getElementById('date-edit-modal'),
            modalTitle: document.getElementById('modal-title'),
            dateInput: document.getElementById('new-target-date'),
            saveBtn: document.getElementById('modal-save-btn'),
            cancelBtn: document.getElementById('modal-cancel-btn'),
            errorMsg: document.getElementById('modal-error'),
            globalFileInput: document.getElementById('global-file-input'),
            messageModal: document.getElementById('message-modal'),
            messageModalTitle: document.getElementById('message-modal-title'),
            messageModalContent: document.getElementById('message-modal-content'),
            messageModalCloseBtn: document.getElementById('message-modal-close-btn'),
            subjectContainer: document.getElementById('subject-trackers-container')
        };
        
        let currentEditingId = null;
        const SUBJECT_LOGIC_MAP = {};
        const ALL_SUBJECT_STORAGE_KEYS = [
            'rem_ethics_progress', 'crim_progress', 'lab_progress', 
            'civ_progress', 'comm_tax_progress', 'poli_progress'
        ];


        // --- Schedule Data (Central source of truth for table) ---
        const SCHEDULE_DATA = [
            { id: 1, dateId: 1, day: 'SUNDAY', subject: 'Political and Public International Law', weight: '15%', subjectName: 'poli' },
            { id: 2, dateId: 1, day: 'SUNDAY', subject: 'Commercial and Taxation Laws', weight: '20%', subjectName: 'comm' },
            { id: 3, dateId: 2, day: 'SUNDAY', subject: 'Civil Law and Land Titles and Deeds', weight: '20%', subjectName: 'civ' },
            { id: 4, dateId: 2, day: 'SUNDAY', subject: 'Labor and Social Legislation', weight: '10%', subjectName: 'lab' },
            { id: 5, dateId: 3, day: 'SUNDAY', subject: 'Criminal Law', weight: '10%', subjectName: 'crim' },
            { id: 6, dateId: 3, day: 'SUNDAY', subject: 'Remedial Law, Legal Ethics, & Legal Forms', weight: '25%', subjectName: 'rem' }
        ];

        function updateScheduleTable() {
            const tableBody = document.getElementById('schedule-table-body');
            if (!tableBody) return;

            let html = '';
            let lastDateId = null;
            
            // ðŸš¨ MODIFIED: Updated threshold from 3 to 4
            const DONE_THRESHOLD = 4;

            SCHEDULE_DATA.forEach((item, index) => {
                const countdownData = COUNTDOWN_DATA.find(d => d.id === item.dateId);
                const dateString = countdownData ? countdownData.targetDate : 'N/A';
                
                let dayOfWeek = item.day;
                let displayDate = dateString;
                if (dateString !== 'N/A') {
                    const dateObj = new Date(dateString + 'T00:00:00Z');
                    if (!isNaN(dateObj)) {
                        dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
                        displayDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    }
                }
                
                const subjectLogic = SUBJECT_LOGIC_MAP[item.subjectName];
                
                let progressPercent = '0.0';
                let progressFraction = 0;
                
                if (subjectLogic) {
                    // CRITICAL: This pulls the Syllabus data from the EXTERNAL JS file via SUBJECT_LOGIC_MAP
                    const progress = subjectLogic.getProgress();
                    const syllabusData = subjectLogic.SYLLABUS_DATA;
                    const mainTopics = syllabusData.filter(t => t.depth === 2 && t.trackable);
                    const currentSubjectTrackable = mainTopics.length;
                    let currentSubjectDone = 0;

                    mainTopics.forEach(topic => {
                        const topicProgress = progress[topic.id] || {};
                        const boxesTicked = CHECKLIST_COLUMNS.filter(col => topicProgress[col] === true).length;
                        if (boxesTicked >= DONE_THRESHOLD) { // ðŸš¨ MODIFIED: Uses DONE_THRESHOLD
                            currentSubjectDone++;
                        }
                    });
                    progressFraction = currentSubjectTrackable > 0 ? (currentSubjectDone / currentSubjectTrackable) : 0;
                    progressPercent = (progressFraction * 100).toFixed(1);
                }
                
                let progressClass;
                if (progressFraction <= 0.25) { progressClass = 'bg-progress-red'; } 
                else if (progressFraction <= 0.5) { progressClass = 'bg-progress-orange'; } 
                else if (progressFraction <= 0.75) { progressClass = 'bg-progress-yellow'; } 
                else { progressClass = 'bg-progress-green'; }


                let dateCell = '';
                if (item.dateId !== lastDateId) {
                    dateCell = `<td rowspan="2" class="text-center font-bold text-sm border-r border-gray-300">
                                    ${displayDate.toUpperCase()}<br><span class="text-gray-400 font-normal text-xs">${dayOfWeek}</span>
                                </td>`;
                    lastDateId = item.dateId;
                }

                const rowClass = (index + 1) % 2 === 0 ? 'border-b-2 border-gray-300/50' : 'border-b border-gray-200';
                
                html += `
                    <tr class="${rowClass}">
                        ${dateCell}
                        <td class="border-r border-gray-300">
                            <div class="subject-cell bg-${item.subjectName}" data-subject="${item.subjectName}">
                                ${item.subject} <span class="font-normal">(${item.weight})</span>
                            </div>
                        </td>
                        <td>
                            <div class="text-center text-sm font-semibold mb-0.5">${progressPercent}%</div>
                            <div id="sparkline-${item.subjectName}" class="progress-bar-sparkline">
                                <div class="sparkline-fill ${progressClass}" style="width: ${progressPercent}%;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

    // Aesthetic Quote Row
// Aesthetic Quote Row with Purple Dashed Lines and Styled Buttons
// Replacement Code for BOTH files:
html += `
    <tr>
        <td colspan="3" class="p-2 border-none">
            <div class="bg-[var(--theme-primary)]/5 border border-dashed border-[var(--theme-primary)]/30 rounded-xl p-3 relative flex flex-col justify-center items-center text-center italic mt-2">
                <button onclick="window.changeQuote(-1)" class="absolute left-2 p-1 text-[var(--theme-primary)] hover:opacity-70 transition-all">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </button>

                    
<p id="quoteText" 
                       class="text-[12px] sm:text-sm text-[var(--theme-primary)] font-medium leading-relaxed px-10 italic" 
                       style="font-family: 'Cormorant Garamond', cursive; letter-spacing: 0.5px;">
                        "${MOTIVATIONAL_QUOTES[currentQuoteIndex]}"
                    </p>
                    
                    <button onclick="window.changeQuote(1)" 
                            class="absolute right-2 p-1 text-[var(--theme-secondary)] hover:bg-[var(--theme-secondary)] hover:text-white rounded-full transition-all duration-200 z-30">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        </tr>`;
    tableBody.innerHTML = html;
    if (window.lucide) lucide.createIcons();
}

// --- USERNAME LOGIC ---
        const USER_NAME_KEY = 'user_display_name';
        const EMOJI = 'âœ¨';

function loadUserName() {
    const nameInput = document.getElementById('user-name-input');
    const savedName = localStorage.getItem(USER_NAME_KEY);
    if (nameInput && savedName) {
        nameInput.value = `Welcome, ${savedName}! ${EMOJI}`;
    }
}

function saveUserName(name) {
    if (!name || name.trim() === "" || name.includes("Input your name here")) return;
    
    // Remove the "Welcome," "!" and emoji before saving the raw name
    let cleanedName = name.replace(/^Welcome,\s?/, '').replace('!', '').replace(EMOJI, '').trim();
    
    if (cleanedName) {
        localStorage.setItem(USER_NAME_KEY, cleanedName);
        document.getElementById('user-name-input').value = `Welcome, ${cleanedName}! ${EMOJI}`;
        if (typeof updateLastSaved === 'function') updateLastSaved();
    }
}

        // Utility Functions
        function formatUniqueDate(dateString){
            if(!dateString)return'';
            const date=new Date(dateString+'T00:00:00');
            return date.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}).toUpperCase();
        }
        
        function getLocalDisplayDate() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const weekdayOptions = { weekday: 'long' };

            const datePart = now.toLocaleDateString('en-US', dateOptions).toUpperCase();
            const weekdayPart = now.toLocaleDateString('en-US', weekdayOptions).toUpperCase();
            const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
            const timeText = now.toLocaleTimeString('en-US', timeOptions).toUpperCase();
            
            return `TODAY IS ${datePart} | ${weekdayPart} | ${timeText}`;
        }

        function formatNumber(num){return num.toString().padStart(num>=100?3:2,'0');}
        function downloadFile(data,filename,type){const blob=new Blob([data],{type:type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
        function showMessageModal(title,content){
            const modal=DOM_ELEMENTS.messageModal;
            const titleEl=DOM_ELEMENTS.messageModalTitle;
            const contentEl=DOM_ELEMENTS.messageModalContent;
            if(titleEl)titleEl.textContent=title;
            if(contentEl)contentEl.innerHTML=content;
            
            const actionsEl=document.getElementById('modal-actions');
            if(actionsEl){
                actionsEl.innerHTML=`\n<button id="message-modal-close-btn" class="px-3 py-1.5 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Close</button>\n`;
                document.getElementById('message-modal-close-btn')?.addEventListener('click', closeMessageModal);
            }
            if(modal){
                modal.classList.remove('hidden');
                modal.style.display='flex';
            }
        }
        function closeMessageModal(){DOM_ELEMENTS.messageModal.classList.add('hidden');DOM_ELEMENTS.messageModal.style.display='none';}
        
        // Countdown Logic
        function calculateCountdown(targetDateString,id){const now=new Date();const target=new Date(targetDateString+'T00:00:00Z');if(target<=now){const elements=[`days-${id}`,`hrs-${id}`,`mins-${id}`,`secs-${id}`];elements.forEach(elId=>{const el=document.getElementById(elId);if(el)el.textContent=elId===`days-${id}`?'000':'00';});return;}const diffInMilliseconds=target-now;const days=Math.floor(diffInMilliseconds/(1000*60*60*24));const hours=Math.floor(diffInMilliseconds%(1000*60*60*24)/(1000*60*60));const minutes=Math.floor(diffInMilliseconds%(1000*60*60)/(1000*60));const seconds=Math.floor(diffInMilliseconds%(1000*60)/1000);document.getElementById(`days-${id}`).textContent=formatNumber(days);document.getElementById(`hrs-${id}`).textContent=formatNumber(hours);document.getElementById(`mins-${id}`).textContent=formatNumber(minutes);document.getElementById(`secs-${id}`).textContent=formatNumber(seconds);}
        function updateAllCountdowns(){COUNTDOWN_DATA.forEach(data=>{calculateCountdown(data.targetDate,data.id);});}
        function openModal(id){currentEditingId=id;const data=COUNTDOWN_DATA.find(d=>d.id===id);document.getElementById('modal-title').textContent=`Edit Target Date - Day ${id}`;document.getElementById('new-target-date').value=data.targetDate;document.getElementById('modal-error').classList.add('hidden');document.getElementById('date-edit-modal').classList.remove('hidden');document.getElementById('date-edit-modal').style.display='flex';}
        function closeModal(){document.getElementById('date-edit-modal').classList.add('hidden');document.getElementById('date-edit-modal').style.display='none';currentEditingId=null;}
        
function saveModal(){
            const newDateString=document.getElementById('new-target-date').value;
            const newDate=new Date(newDateString);
            const now=new Date();
            if(newDate<=now||!newDateString){
                document.getElementById('modal-error').textContent="Please select a future date.";
                document.getElementById('modal-error').classList.remove('hidden');
                return;
            }
            const data=COUNTDOWN_DATA.find(d=>d.id===currentEditingId);
            if(data){
                data.targetDate=newDateString;
                document.querySelector(`#target-date-display-${currentEditingId} .date-text`).textContent = formatUniqueDate(newDateString);
                localStorage.setItem(`comp_exam_date_${currentEditingId}`,newDateString);
                
                // --- TRIGGER REFRESHES ---
                updateAllCountdowns();   // Updates the countdown numbers
                updateScheduleTable();   // Updates the Date/Subject table rows
                
                // Updates the "Exam Day" markers in the Calendar module
                if (window.CALENDAR_APP && typeof window.CALENDAR_APP.refreshCalendar === 'function') {
                    window.CALENDAR_APP.refreshCalendar();
                }
            }
            closeModal();
        }

        // Global File Upload Handler
        function handleFileUpload(event){
            const file = event.target.files[0];
            const targetSubject = event.target.dataset.targetSubject;
            
            if (file && targetSubject && SUBJECT_LOGIC_MAP[targetSubject]) {
                SUBJECT_LOGIC_MAP[targetSubject].processImport(file);
            } else if (!file) {
                showMessageModal("Upload Canceled", "No file was selected for upload.");
            } else {
                showMessageModal("Upload Error", "Could not determine the target subject for the upload.");
            }
            event.target.value = '';
        }

        // --- GLOBAL EXPORT/IMPORT FUNCTIONS (UPDATED) ---

function exportAllData() {
    const data = {};

    // 1. Core (Name, Dates)
    data.user_name = localStorage.getItem('user_display_name');
    data.dates = {};
    [1,2,3].forEach(i => {
        data.dates[`comp_exam_date_${i}`] = localStorage.getItem(`comp_exam_date_${i}`);
    });

    // 2. Subjects Progress
    data.subjects = {};
    const subjectKeys = ['rem_ethics_progress', 'crim_progress', 'lab_progress', 'civ_progress', 'comm_tax_progress', 'poli_progress'];
    subjectKeys.forEach(key => {
        data.subjects[key] = localStorage.getItem(key);
    });

    // 3. Calendar & Notepad
    data.calendar_events = localStorage.getItem('review_calendar_events');
    data.notepad_content = localStorage.getItem('review_notepad_content');

    // 4. Gaerlan Cases
    data.gaerlan = localStorage.getItem('gaerlan_tracker_v1');

    // 5. To-Do List
    data.todos = localStorage.getItem('bar_todos_v2');

    // 6. Resource Links
    data.links = localStorage.getItem('bar_user_links');

    // 7. Materials Tracker
    data.materials = localStorage.getItem('bar_materials');

    // 8. Analytics
    data.analytics = localStorage.getItem('bar_tracker_analytics_v3');

    // 9. Quotes
    data.quote_index = localStorage.getItem('selected_quote_index');

    // 10. Review Notes (all individual notes)
    data.notes = {};
    Object.keys(NOTES_SYLLABUS).forEach(sub => {
        NOTES_SYLLABUS[sub].forEach((item, i) => {
            if (item.depth === 2) {
                const parent = NOTES_SYLLABUS[sub].slice(0, i).reverse().find(p => p.depth === 1);
                const key = `note_${sub}_${parent ? parent.topic : ''}_${item.topic}`;
                data.notes[key] = localStorage.getItem(key);
            }
        });
    });

    // 11. Collapsed States
    data.collapsed_topics = localStorage.getItem('bar_collapsed_topics');

    downloadFile(JSON.stringify(data, null, 2), 'full-bar-tracker-backup.json', 'application/json');
    showMessageModal("Export Complete", "<p class='text-green-600'>All data across ALL tabs exported!</p>");
}

function importAllData(event) {
    const file = event.target.files[0];
    event.target.value = '';
    if (!file || !file.name.endsWith('.json')) return showMessageModal("Error", "<p class='text-red-600'>Invalid file. Use .json backup.</p>");

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);

            // Import Core
            if (imported.user_name) localStorage.setItem('user_display_name', imported.user_name);
            Object.keys(imported.dates || {}).forEach(k => localStorage.setItem(k, imported.dates[k]));

            // Import Subjects
            Object.keys(imported.subjects || {}).forEach(k => localStorage.setItem(k, imported.subjects[k]));

            // Import Calendar/Notepad
            if (imported.calendar_events) localStorage.setItem('review_calendar_events', imported.calendar_events);
            if (imported.notepad_content) localStorage.setItem('review_notepad_content', imported.notepad_content);

            // Import Gaerlan
            if (imported.gaerlan) localStorage.setItem('gaerlan_tracker_v1', imported.gaerlan);

            // Import To-Do
            if (imported.todos) localStorage.setItem('bar_todos_v2', imported.todos);

            // Import Links
            if (imported.links) localStorage.setItem('bar_user_links', imported.links);

            // Import Materials
            if (imported.materials) localStorage.setItem('bar_materials', imported.materials);

            // Import Analytics
            if (imported.analytics) localStorage.setItem('bar_tracker_analytics_v3', imported.analytics);

            // Import Quotes
            if (imported.quote_index) localStorage.setItem('selected_quote_index', imported.quote_index);

            // Import Notes
            Object.keys(imported.notes || {}).forEach(k => localStorage.setItem(k, imported.notes[k]));

            // Import Collapsed
            if (imported.collapsed_topics) localStorage.setItem('bar_collapsed_topics', imported.collapsed_topics);

            location.reload(); // Full refresh to apply all
            showMessageModal("Import Success", "<p class='text-green-600'>All data across tabs imported! Reloaded.</p>");
        } catch (e) {
            showMessageModal("Error", "<p class='text-red-600'>Invalid backup file.</p>");
        }
    };
    reader.readAsText(file);
}

        // --- END GLOBAL EXPORT/IMPORT FUNCTIONS ---

        // Subject Logic Loader - MODIFIED TO LOAD EXTERNAL JS
        function loadSubjectPanel(subjectName, filePath) {
            const script = document.createElement('script');
            script.src = filePath;
            script.type = 'text/javascript';
            script.onload = () => {
                // 1. Instantiate the logic object (The function is now defined in the external file)
                const logicCreator = window[`create${subjectName.toUpperCase()}_LOGIC`];
                if (logicCreator) {
                    const logic = logicCreator(); // This calls the creator function in the external script
                    SUBJECT_LOGIC_MAP[subjectName] = logic;
                    
                    // 2. Inject the panel structure 
                    const panelPlaceholder = document.getElementById(`subject-tracker-panel-${subjectName}`);
                    if (panelPlaceholder) {
                        const newPanelHtml = logic.getPanelHtmlWrapper(logic.SUBJECT_NAME, logic.SUBJECT_TITLE, logic.SUBJECT_ICON);
                        panelPlaceholder.outerHTML = newPanelHtml;
                    }
                    
                    // 3. Re-attach event listeners and render
                    const currentLogic = SUBJECT_LOGIC_MAP[subjectName];
                    
                    window.requestAnimationFrame(() => {
                        const collapseBtn = document.getElementById(`collapse-all-btn-${subjectName}`);
                        collapseBtn?.addEventListener('click', currentLogic.toggleAllSections);
                        currentLogic.render(); // This uses the full syllabus data loaded inside the external JS
                    });
                } else {
                    console.error(`Failed to find initialization function for ${subjectName}. Check external JS file.`);
                }
            };
            document.head.appendChild(script);
        }
                
        // --- CALENDAR DATA SOURCE (SIMPLIFIED FOR CALENDAR ONLY) ---
const CONSOLIDATED_SYLLABUS = {
            poli: { 
                title: 'POLITICAL AND PUBLIC INTERNATIONAL LAW', 
                shortTitle: 'POLI LAW', 
                color: '#795548', 
                data: [
                    {id: 5001, topic: "I. BASIC CONCEPTS", depth: 1, trackable: true},
                    {id: 5007, topic: "II. NATIONAL TERRITORY", depth: 1, trackable: true},
                    {id: 5012, topic: "III. CITIZENSHIP", depth: 1, trackable: true},
                    {id: 5016, topic: "IV. LEGISLATIVE DEPARTMENT", depth: 1, trackable: true},
                    {id: 5022, topic: "V. EXECUTIVE DEPARTMENT", depth: 1, trackable: true},
                    {id: 5028, topic: "VI. JUDICIAL DEPARTMENT", depth: 1, trackable: true},
                    {id: 5033, topic: "VII. CONSTITUTIONAL COMMISSIONS", depth: 1, trackable: true},
                    {id: 5036, topic: "VIII. CONSTITUTIONAL RIGHTS", depth: 1, trackable: true},
                    {id: 5045, topic: "IX. NATIONAL ECONOMY AND PATRIMONY", depth: 1, trackable: true},
                    {id: 5048, topic: "X. ADMINISTRATIVE LAW", depth: 1, trackable: true},
                    {id: 5052, topic: "XI. LAW ON PUBLIC OFFICERS", depth: 1, trackable: true},
                    {id: 5056, topic: "XII. ELECTION LAW", depth: 1, trackable: true},
                    {id: 5060, topic: "XIII. LOCAL GOVERNMENTS", depth: 1, trackable: true},
                    {id: 5064, topic: "XIV. PUBLIC INTERNATIONAL LAW", depth: 1, trackable: true},
                ]
            },
            comm: { 
                title: 'COMMERCIAL AND TAXATION LAWS', 
                shortTitle: 'COMM & TAX', 
                color: '#eab308', 
                data: [
                    {id: 4001, topic: 'I. BUSINESS ORGANIZATIONS', depth: 1, trackable: true},
                    {id: 4005, topic: 'II. INSURANCE', depth: 1, trackable: true},
                    {id: 4010, topic: 'III. TRANSPORTATION', depth: 1, trackable: true},
                    {id: 4014, topic: 'IV. BANKING', depth: 1, trackable: true},
                    {id: 4019, topic: 'V. INTELLECTUAL PROPERTY', depth: 1, trackable: true},
                    {id: 4023, topic: 'VI. SPECIAL COMMERCIAL LAWS', depth: 1, trackable: true},
                    {id: 4027, topic: 'VII. TAXATION LAW', depth: 1, trackable: true},
                ]
            },
            civ: { 
                title: 'CIVIL LAW AND LAND TITLES AND DEEDS', 
                shortTitle: 'CIVIL LAW', 
                color: '#1e3a8a', 
                data: [
                    {id: 3001, topic: "I. EFFECT AND APPLICATION OF LAWS", depth: 1, trackable: true},
                    {id: 3005, topic: "II. PERSONS", depth: 1, trackable: true},
                    {id: 3011, topic: "III. FAMILY CODE", depth: 1, trackable: true},
                    {id: 3015, topic: "IV. CIVIL REGISTER", depth: 1, trackable: true},
                    {id: 3024, topic: "V. PROPERTY, OWNERSHIP, AND ITS MODIFICATIONS", depth: 1, trackable: true},
                    {id: 3030, topic: "VI. LAND TITLES AND DEEDS", depth: 1, trackable: true},
                    {id: 3035, topic: "VII. SUCCESSION", depth: 1, trackable: true},
                    {id: 3041, topic: "VIII. OBLIGATIONS AND CONTRACTS", depth: 1, trackable: true},
                    {id: 3046, topic: "IX. SPECIAL CONTRACTS", depth: 1, trackable: true},
                    {id: 3050, topic: "X. QUASI-CONTRACTS", depth: 1, trackable: true},
                    {id: 3053, topic: "XI. TORTS AND QUASI-DELICTS", depth: 1, trackable: true},
                    {id: 3060, topic: "XII. DAMAGES", depth: 1, trackable: true},
                ]
            },
            lab: { 
                title: 'LABOR AND SOCIAL LEGISLATION', 
                shortTitle: 'LABOR LAW', 
                color: '#38761d', 
                data: [
                    {id: 2001, topic: "I. BASIC PRINCIPLES AND CONCEPTS", depth: 1, trackable: true},
                    {id: 2008, topic: "II. RECRUITMENT AND PLACEMENT", depth: 1, trackable: true},
                    {id: 2014, topic: "III. EMPLOYMENT RELATIONSHIP", depth: 1, trackable: true},
                    {id: 2019, topic: "IV. LABOR STANDARDS", depth: 1, trackable: true},
                    {id: 2025, topic: "V. LABOR RELATIONS", depth: 1, trackable: true},
                    {id: 2031, topic: "VI. SUSPENSION AND TERMINATION OF EMPLOYMENT", depth: 1, trackable: true},
                    {id: 2037, topic: "VII. SOCIAL LEGISLATION", depth: 1, trackable: true},
                    {id: 2042, topic: "VIII. LABOR ADJUDICATION-JURISDICTION & REMEDIES", depth: 1, trackable: true},
                ]
            },
            crim: { 
                title: 'CRIMINAL LAW', 
                shortTitle: 'CRIM LAW', 
                color: '#b33a3a', 
                data: [
                    {id: 1001, topic: "I. FUNDAMENTAL PRINCIPLES", depth: 1, trackable: true},
                    {id: 1013, topic: "II. FELONIES AND CRIMINAL LIABILITY", depth: 1, trackable: true},
                    {id: 1032, topic: "III. CRIMES AND THEIR PENALTIES", depth: 1, trackable: true},
                ]
            },
            rem: { 
                title: 'REMEDIAL LAW, LEGAL ETHICS, & LEGAL FORMS', 
                shortTitle: 'REM LAW', 
                color: '#674ea7', 
                data: [
                    {id: 1, topic: "I. GENERAL PRINCIPLES", depth: 1, trackable: true},
                    {id: 9, topic: "II. JURISDICTION", depth: 1, trackable: true},
                    {id: 43, topic: "III. CIVIL PROCEDURE", depth: 1, trackable: true},
                    {id: 158, topic: "IV. PROVISIONAL REMEDIES", depth: 1, trackable: true},
                    {id: 174, topic: "V. SPECIAL CIVIL ACTIONS", depth: 1, trackable: true},
                    {id: 190, topic: "VI. SPECIAL PROCEEDINGS AND WRITS", depth: 1, trackable: true},
                    {id: 217, topic: "VII. CRIMINAL PROCEDURE", depth: 1, trackable: true},
                    {id: 335, topic: "VIII. EVIDENCE", depth: 1, trackable: true},
                    {id: 414, topic: "IX. LEGAL AND JUDICIAL ETHICS", depth: 1, trackable: true},
                    {id: 583, topic: "X. PRACTICAL EXERCISES", depth: 1, trackable: true},
                    ]
            },
        };
        const CALENDAR_EVENTS_KEY = 'review_calendar_events';
        const NOTEPAD_CONTENT_KEY = 'review_notepad_content'; 
        const CALENDAR_SUBJECT_KEYS = Object.keys(CONSOLIDATED_SYLLABUS);
        const history = { stack: [], current: 0 };
        const MAX_HISTORY = 30;
        
        let calendarInstance = null;

        function pushHistory(content) {
            if (history.current < history.stack.length - 1) {
                history.stack = history.stack.slice(0, history.current + 1);
            }
            history.stack.push(content);
            if (history.stack.length > MAX_HISTORY) {
                history.stack.shift(); 
            }
            history.current = history.stack.length - 1;
        }

        function loadNotes() {
            const notes = localStorage.getItem(NOTEPAD_CONTENT_KEY);
            $('#review-notes').val(notes || '');
            if (notes) {
                pushHistory(notes);
            } else {
                pushHistory('');
            }
            history.current = history.stack.length - 1;
        }

function saveNotes() {
    const notes = document.getElementById('review-notes').value;
    // Direct key usage prevents conflicts
    localStorage.setItem('review_notepad_content', notes);
    
    if (history.stack[history.current] !== notes) {
        pushHistory(notes);
    }
if (typeof updateLastSaved === 'function') updateLastSaved();
}

function applyNotesContent(content) {
            const noteArea = document.getElementById('review-notes');
            if (noteArea) noteArea.value = content;
            localStorage.setItem('review_notepad_content', content);
if (typeof updateLastSaved === 'function') updateLastSaved();
        }

function undoNotes() {
            if (history.current > 0) {
                history.current--;
                applyNotesContent(history.stack[history.current]);
            } else {
                window.showThemedModal({
                    title: 'NO UNDO',
                    message: 'NO EARLIER HISTORY FOUND.'
                });
            }
        }
        function redoNotes() {
            if (history.current < history.stack.length - 1) {
                history.current++;
                applyNotesContent(history.stack[history.current]);
            } else {
                window.showThemedModal({
                    title: 'NO REDO',
                    message: 'NO FUTURE HISTORY FOUND.'
                });
            }
        }
function clearNotes() {
            window.showThemedModal({
                title: 'CLEAR ALL NOTES',
                message: 'ARE YOU SURE YOU WANT TO DELETE ALL CONTENT IN THE NOTEPAD? THIS ACTION CAN BE UNDONE VIA THE UNDO BUTTON.',
                type: 'confirm',
                confirmText: 'CLEAR ALL',
                cancelText: 'CANCEL',
                onConfirm: () => {
                    applyNotesContent("");
                    pushHistory("");
                    window.showThemedModal({
                        title: 'NOTEPAD CLEARED',
                        message: 'ALL NOTES HAVE BEEN REMOVED.'
                    });
                }
            });
        }
function copyNotes() {
            const notes = $('#review-notes').val();
            if (!notes) {
                window.showThemedModal({
                    title: 'COPY FAILED',
                    message: 'NO CONTENT TO COPY.'
                });
                return;
            }
            const textarea = document.getElementById('review-notes');
            textarea.select();
            
            try {
                document.execCommand('copy');
                window.showThemedModal({
                    title: 'COPY COMPLETE',
                    message: 'NOTES COPIED TO CLIPBOARD.'
                });
            } catch (err) {
                window.showThemedModal({
                    title: 'COPY FAILED',
                    message: 'UNABLE TO COPY NOTES TO CLIPBOARD.'
                });
            }
        }
        function getExamDates() {
            // Accessing global COUNTDOWN_DATA defined in the main script
            return COUNTDOWN_DATA.map(examData => {
                const dateString = localStorage.getItem(`comp_exam_date_${examData.id}`) || examData.targetDate;
                const examTitle = `EXAM - DAY ${examData.id}`;
                return { 
                    id: `exam-${examData.id}`, 
                    title: examTitle.toUpperCase(), 
                    start: dateString, 
                    end: dateString, 
                    allDay: true,
                    backgroundColor: 'red', 
                    textColor: '#FFFFF',
                    borderColor: 'var(--theme-secondary)',
                    className: 'exam-day-marker',
                    editable: false 
                };
            });
        }
        
function showCustomAlert(title, message) {
            // Redirects all calendar alerts to the professional themed modal
            window.showThemedModal({
                title: title.toUpperCase(),
                message: message.toUpperCase().replace(/\*\*(.*?)\*\*/g, '$1') 
            });
        }
        function closeCustomAlert() {
            $('#custom-alert-modal').addClass('hidden').css('display', 'none');
        }
        function saveEventsToLocalStorage(events) {
            try {
                localStorage.setItem(CALENDAR_EVENTS_KEY, JSON.stringify(events));
            } catch (e) {
                console.error("ERROR SAVING CALENDAR TO LOCAL STORAGE:", e);
                CALENDAR_APP.showCustomAlert("STORAGE ERROR", "COULD NOT SAVE EVENTS. LOCAL STORAGE MIGHT BE FULL.");
            }
        }
        
        function generateUniqueId() {
            return 'event-' + Date.now() + Math.random().toString(36).substring(2, 9);
        }
        function populateSubjectSelect() {
            const select = $('#subjectSelect');
            select.empty();
            select.append('<option value="">-- SELECT A SUBJECT --</option>');
            CALENDAR_SUBJECT_KEYS.forEach(key => {
                select.append(`<option value="${key}">${CONSOLIDATED_SYLLABUS[key].title.toUpperCase()}</option>`);
            });
            populateTopics(); 
        }
        
        // CRITICAL: This function must fetch topic data from the loaded SUBJECT_LOGIC_MAP 
        // because CONSOLIDATED_SYLLABUS only holds Depth 1 topics now.
        function populateTopics(selectedTopicId = null) {
            const subjectKey = $('#subjectSelect').val();
            const select = $('#topicSelect');
            select.empty();
            $('#topic-error').attr('hidden', true);
            
            if (!subjectKey) {
                select.append('<option value="">-- SELECT A SUBJECT FIRST --</option>');
                select.prop('disabled', true);
                return;
            }
            select.prop('disabled', false);
            select.append('<option value="">-- SELECT A TOPIC --</option>');
            
            // *** FIX: Get the full syllabus data from the externally loaded logic map ***
            const subjectLogic = SUBJECT_LOGIC_MAP[subjectKey];
            if (!subjectLogic || !subjectLogic.SYLLABUS_DATA) {
                 select.append('<option value="">-- SYLLABUS DATA NOT YET LOADED --</option>');
                 return;
            }
            const data = subjectLogic.SYLLABUS_DATA;
            // Filter only the Depth 1 Topics (or the main trackable sections) for the calendar dropdown
            const topicsToSchedule = data.filter(item => item.depth === 1); // Filtering by Depth 1 seems safer based on your provided calendar list
            // *************************************************************************
            
            topicsToSchedule.forEach(item => {
                const topicText = item.topic.toUpperCase();
                const optionValue = `${item.id}|${topicText}`; 
                const isSelected = item.id == selectedTopicId ? 'selected' : '';
                
                select.append(`<option value="${optionValue}" data-topic-id="${item.id}" ${isSelected}>${topicText}</option>`);
            });
            
            if (selectedTopicId) {
                const correctValue = select.find(`option[data-topic-id="${selectedTopicId}"]`).val();
                if (correctValue) {
                   select.val(correctValue);
                }
            }
        }

        function openTopicModal(dateStr = null, event = null) {
window.CALENDAR_APP.switchModalMode('task');

            $('#topicEventId').val('');
            $('#topicStart').val(dateStr || moment().format('YYYY-MM-DD'));
            $('#topicEnd').val('');
            $('#subjectSelect').val('');
            $('#eventNameInput').val('');
            $('#deleteTopicBtn').addClass('hidden');
            $('#modalTitle').text('SCHEDULE NEW EVENT OR TOPIC');
            $('#saveTopicBtn').text('SCHEDULE TASK');
            $('#topic-error').attr('hidden', true);
            
            // This relies on CONSOLIDATED_SYLLABUS
            populateSubjectSelect(); 
            
            if (event) {
                $('#topicEventId').val(event.id);
                $('#topicStart').val(event.start.format('YYYY-MM-DD'));
                $('#topicEnd').val(event.end ? event.end.clone().subtract(1, 'days').format('YYYY-MM-DD') : '');
                
                if (event.subjectKey === 'CUSTOM') {
                    $('#eventNameInput').val(event.title); 
                    $('#subjectSelect').val(''); 
                    populateTopics();
                } else {
                    $('#subjectSelect').val(event.subjectKey);
                    // Pass the topicId for selection in the newly populated list
                    populateTopics(event.topicId); 
                }

                $('#modalTitle').text('EDIT SCHEDULED ITEM');
                $('#saveTopicBtn').text('UPDATE ITEM');
                $('#deleteTopicBtn').removeClass('hidden');
            }
            $('#topicModal').removeClass('hidden').css('display', 'flex');
        }

// Replace the current function with this one:
        function closeTopicModal() {
            $('#topicModal').addClass('hidden').css('display', 'none');
            if (calendarInstance) {
                calendarInstance.fullCalendar('refetchEvents');
            }
        }

function saveTopicTask() {
    const id = $('#topicEventId').val() || generateUniqueId();
    const mode = calModalMode;
    const start = $('#topicStart').val();
    const end = $('#topicEnd').val();
    
    if (!start) {
        window.showThemedModal({ 
            title: "INVALID DATE", 
            message: "PLEASE SELECT A START DATE." 
        });
        return;
    }

    let eventData = {
        id: id,
        start: start,
        end: end ? moment(end).add(1, 'days').format('YYYY-MM-DD') : null,
        allDay: true
    };

    if (mode === 'task') {
        const subKey = $('#subjectSelect').val();
        const topicVal = $('#topicSelect').val();
        
        if (!subKey || !topicVal) {
            window.showThemedModal({ 
                title: "SELECTION REQUIRED", 
                message: "PLEASE SELECT BOTH A SUBJECT AND A SPECIFIC TOPIC." 
            });
            return;
        }

        const [topicId, topicName] = topicVal.split('|');
        eventData.title = `${subKey.toUpperCase()}: ${topicName}`;
        eventData.subjectKey = subKey;
        eventData.topicId = topicId;
        eventData.color = CONSOLIDATED_SYLLABUS[subKey].color;
    } else {
        const customTitle = $('#eventNameInput').val();
        if (!customTitle) {
            window.showThemedModal({ 
                title: "TITLE REQUIRED", 
                message: "PLEASE ENTER A CUSTOM EVENT TITLE." 
            });
            return;
        }
        eventData.title = customTitle.toUpperCase();
        eventData.subjectKey = 'CUSTOM';
        eventData.color = calSelectedColor;
        eventData.icon = calSelectedIcon;
    }

    let events = getEventsFromLocalStorage();
    const existingIndex = events.findIndex(e => e.id === id);
    if (existingIndex !== -1) {
        events[existingIndex] = eventData;
    } else {
        events.push(eventData);
    }

    saveEventsToLocalStorage(events);
    closeTopicModal();
    if (calendarInstance) calendarInstance.fullCalendar('refetchEvents');
    updateLastSaved();
}

function deleteTopicTask() {
            const eventId = $('#topicEventId').val();
            if (!eventId) return;

            window.showThemedModal({
                title: 'DELETE TASK',
                message: 'ARE YOU SURE YOU WANT TO REMOVE THIS ITEM FROM YOUR CALENDAR? THIS ACTION CANNOT BE UNDONE.',
                type: 'confirm',
                confirmText: 'DELETE',
                cancelText: 'CANCEL',
                onConfirm: () => {
                    let events = getEventsFromLocalStorage();
                    events = events.filter(e => e.id !== eventId);
                    
saveEventsToLocalStorage(events);
            
            // Force the modal to close immediately
            const modal = document.getElementById('topicModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
            
            // Ensure the calendar UI updates to show your new entry
            if (calendarInstance) {
                calendarInstance.fullCalendar('refetchEvents');
            }

            updateLastSaved();
                    
                }
            });
        }
        
        function toggleDateJumpPicker() {
            const input = document.getElementById('dateJump');
            const button = document.getElementById('jumpToDateButton');
            if (input && button) {
                const rect = button.getBoundingClientRect();
                
                // Position the hidden input exactly over the button
                input.style.position = 'fixed';
                input.style.top = `${rect.top}px`;
                input.style.left = `${rect.left}px`;
                input.style.width = `${rect.width}px`;
                input.style.height = `${rect.height}px`;

                input.value = $('#calendar').fullCalendar('getDate').format('YYYY-MM-DD');
                
                // Add class to make it temporarily visible (opacity 0.01) and clickable
                input.classList.add('temp-visible');
                
                input.focus();
                
                input.onblur = function() {
                    input.classList.remove('temp-visible');
                    input.style.position = 'absolute'; 
                }
                
                if (typeof input.showPicker === 'function') {
                    setTimeout(() => {
                        input.showPicker();
                    }, 50);
                } else {
                    input.click();
                }
            }
        }
        
        function jumpToDate(dateString) {
            document.getElementById('dateJump').classList.remove('temp-visible');
            document.getElementById('dateJump').style.position = 'absolute';
            if (dateString && calendarInstance) {
                calendarInstance.fullCalendar('gotoDate', dateString);
            }
        }
        
        function setActiveButton(targetButton, viewName) {
            if (viewName !== 'today') {
                $('.fc-month-button, .fc-basicWeek-button, .fc-basicDay-button').removeClass('fc-state-active');
                $(targetButton).addClass('fc-state-active');
            }
        }

// --- CALENDAR PLACEHOLDER SAMPLES & COLOR FIX ---
function getEventsFromLocalStorage() {
    try {
        const data = localStorage.getItem('review_calendar_events');
        let events = data ? JSON.parse(data) : [];

        if (events.length === 0) {
            events = [
                {
                    id: 'sample-poli-1',
                    title: 'POLITICAL LAW â€“ FIRST TOPIC (SAMPLE)',
                    start: '2026-01-04',
                    end: '2026-01-10',
                    allDay: true,
                    subjectKey: 'poli',
                    topicId: null,
                    description: 'Sample multi-day Political Law topic â€“ will appear in brown!'
                },
                {
                    id: 'sample-rest-1',
                    title: 'REST DAY (SAMPLE)',
                    start: '2026-01-01',
                    end: '2026-01-03',
                    allDay: true,
                    subjectKey: null,
                    className: 'custom-rest-event',
                    backgroundColor: '#D4EDDA',
                    borderColor: '#C3E6CB',
                    textColor: '#155724',
                    description: 'Sample rest period â€“ light green!'
                }
            ];

            localStorage.setItem('review_calendar_events', JSON.stringify(events));
        }

        return events;
    } catch (e) {
        console.error("ERROR READING CALENDAR FROM LOCAL STORAGE:", e);
        return [];
    }
}

// Force green on custom rest event (overrides default blue)
const colorFixStyle = document.createElement('style');
colorFixStyle.innerHTML = `
`;
document.head.appendChild(colorFixStyle);
// --- END FIX ---

        function initializeCalendar() {
            calendarInstance = $('#calendar').fullCalendar({
                header: { left: '', center: '', right: '' },
                defaultView: 'month',
                defaultDate: moment().format('YYYY-MM-DD'),
                navLinks: true, editable: true, contentHeight: 450, timeFormat: 'H:mm', 
                
                viewRender: function(view, element) {
                    const titleText = view.title.toUpperCase();
                    $('#customMonthTitle').text(titleText);
                    $('.fc-button').removeClass('fc-state-active');
                    $(`.fc-${view.name}-button`).addClass('fc-state-active');
                    
                    const now = moment();
                    const isTodayVisible = view.intervalStart.isSameOrBefore(now, 'day') && view.intervalEnd.isSameOrAfter(now, 'day');
                    if (isTodayVisible) {
                        if (view.name === 'month' && view.intervalStart.isSame(now, 'month')) {
                            $('.fc-today-button').addClass('fc-state-active');
                        } else if (view.name === 'basicWeek' || view.name === 'basicDay') {
                            $('.fc-today-button').addClass('fc-state-active');
                        }
                    }
                    $('.fc-head th').addClass('fc-widget-header');
                    syncHeight();
                },
                
                dayClick: function(date, jsEvent, view) {
                    if ($(jsEvent.target).closest('.exam-day-marker').length) return;
                    openTopicModal(date.format('YYYY-MM-DD'));
                },
                eventClick: function(calEvent, jsEvent, view) {
                    jsEvent.preventDefault(); 
                    if (calEvent.className && calEvent.className.includes('exam-day-marker')) {
                        CALENDAR_APP.showCustomAlert("EXAM DAY", `THIS DATE IS MARKED AS **${calEvent.title}**. YOU CANNOT EDIT EXAM MARKERS.`);
                        return;
                    }
                    openTopicModal(null, calEvent); 
                },
// ... inside initializeCalendar configuration ...
events: function(start, end, timezone, callback) {
    const storedEvents = getEventsFromLocalStorage();
    
    const formattedEvents = storedEvents.map(e => ({
        id: e.id, 
        title: e.title, 
        start: e.start, 
        end: e.end, 
        allDay: true,
        backgroundColor: e.color, 
        borderColor: e.borderColor,
        subjectKey: e.subjectKey, 
        topicId: e.topicId,
        icon: e.icon // Ensure the icon is passed to FullCalendar
    }));
    
    const examMarkers = getExamDates();
    const allEvents = formattedEvents.concat(examMarkers);
    callback(allEvents);
},

eventRender: function(event, element) {
    element.find('.fc-time').remove();
    if (event.className && event.className.includes('exam-day-marker')) {
        element.find('.fc-title').prepend(`<i class="fa-solid fa-graduation-cap mr-2"></i>`);
        return;
    }

    // Logic: Use event.icon if it exists (Custom Event), otherwise fallback to fa-book (Study Task)
    let iconName = event.icon || 'book';
    
    // Convert Lucide name to FontAwesome for the calendar or use a span with data-lucide
    const iconHtml = `<span class="event-status-icon"><i data-lucide="${iconName}" class="w-3 h-3 text-white"></i></span>`;
    element.find('.fc-title').wrap('<div class="fc-event-title-wrap"></div>').before(iconHtml);
    
    // Trigger Lucide after a micro-task to render icons inside events
    setTimeout(() => lucide.createIcons(), 0);
},

            });
        }
        function syncHeight() {
            const calendarCard = document.getElementById('calendar-card');
            const detailsElement = document.getElementById('calendar-details');
            if (calendarCard && detailsElement) {
                const cardHeight = calendarCard.offsetHeight;
                detailsElement.style.setProperty('--calendar-height', `${cardHeight}px`);
                detailsElement.setAttribute('data-calendar-ready', 'true');
            }
        }
        function refreshCalendar() {
            if (calendarInstance) {
                calendarInstance.fullCalendar('refetchEvents');
            }
        }


// --- START PINPOINTED FIX: GLOBAL VARS ---
let calSelectedIcon = 'calendar';
let calSelectedColor = '#6D1B1B';
let calModalMode = 'task'; 

function setupCalendarPickers() {
    const iconContainer = document.getElementById('calendar-icon-picker');
    const colorContainer = document.getElementById('calendar-color-picker');
    
    if (!iconContainer || !colorContainer) return;

    // 1. Icons: Use primary theme background for selected
    iconContainer.innerHTML = studyIcons.map(icon => `
        <button type="button" onclick="calSelectedIcon='${icon}'; setupCalendarPickers()" 
            class="calendar-picker-btn border transition-all flex items-center justify-center p-2 rounded-lg 
            ${calSelectedIcon === icon ? 'bg-[var(--theme-primary)] border-[var(--theme-primary)] shadow-lg' : 'border-gray-200 hover:bg-gray-50'}">
            <i data-lucide="${icon}" class="w-5 h-5 ${calSelectedIcon === icon ? 'text-white' : 'text-gray-400'}"></i>
        </button>
    `).join('');
    
    // 2. Colors: Use a thick double-ring effect for the selected color
    colorContainer.innerHTML = studyColors.map(color => `
        <button type="button" onclick="calSelectedColor='${color}'; setupCalendarPickers()" 
            class="w-9 h-9 rounded-full border-2 transition-all hover:scale-110 flex items-center justify-center
            ${calSelectedColor === color ? 'border-[var(--theme-primary)] ring-2 ring-offset-2 ring-[var(--theme-primary)] z-10' : 'border-transparent shadow-sm'}" 
            style="background:${color};">
            ${calSelectedColor === color ? '<i data-lucide="check" class="w-4 h-4 text-white drop-shadow-md"></i>' : ''}
        </button>
    `).join('');
    
    if (window.lucide) lucide.createIcons();
}

// --- START PINPOINTED FIX: CONSOLIDATED OBJECT ---
window.CALENDAR_APP = {
    CALENDAR_EVENTS_KEY: CALENDAR_EVENTS_KEY,
    NOTEPAD_CONTENT_KEY: NOTEPAD_CONTENT_KEY,
    refreshCalendar: refreshCalendar,
    setNotes: applyNotesContent,
    showCustomAlert: showCustomAlert,
    closeCustomAlert: closeCustomAlert,
    openTopicModal: openTopicModal,
    closeTopicModal: closeTopicModal,
    saveTopicTask: saveTopicTask,
    deleteTopicTask: deleteTopicTask,
    populateTopics: populateTopics,
    setActiveButton: setActiveButton,
    toggleDateJumpPicker: toggleDateJumpPicker,
    jumpToDate: jumpToDate,
    undoNotes: undoNotes,
    redoNotes: redoNotes,
    clearNotes: clearNotes,
    copyNotes: copyNotes,
    getExamDates: getExamDates,
    loadNotes: loadNotes,
    initializeCalendar: initializeCalendar,
    syncHeight: syncHeight,

switchModalMode: function(mode) {
    calModalMode = mode;
    const isTask = mode === 'task';
    
    // Toggle Pills
    document.getElementById('mode-btn-task').className = isTask ? 'flex-1 py-2 text-[10px] font-black uppercase rounded-lg bg-white shadow-sm text-[var(--theme-primary)]' : 'flex-1 py-2 text-[10px] font-black uppercase rounded-lg text-gray-500';
    document.getElementById('mode-btn-event').className = !isTask ? 'flex-1 py-2 text-[10px] font-black uppercase rounded-lg bg-white shadow-sm text-[var(--theme-primary)]' : 'flex-1 py-2 text-[10px] font-black uppercase rounded-lg text-gray-500';
    
    // Toggle Section Visibility
    document.getElementById('subject-container').classList.toggle('hidden', !isTask); // Subject stays in right col
    document.getElementById('full-width-topic-container').classList.toggle('hidden', !isTask); // Topic goes full width below
    
    document.getElementById('mode-options-event').classList.toggle('hidden', isTask); // Icons in right col
    document.getElementById('mode-options-color').classList.toggle('hidden', isTask); // Colors full width below
    
    document.getElementById('item-title-container').classList.toggle('hidden', isTask);
    
    if (!isTask) setupCalendarPickers();
},
};
// --- END PINPOINTED FIX ---

        // --- GLOBAL SYLLABUS LOGIC FACTORY (The "createSyllabusLogic" function) ---
        // (Function definition placed here to ensure it's available before initializeSubjectTrackers runs)
        window.createSyllabusLogic = function(subjectName, syllabusData, storageKey, themeIcon, title) {
            
            const self = {
                SUBJECT_NAME: subjectName,
                SUBJECT_TITLE: title,
                SUBJECT_ICON: themeIcon,
                SYLLABUS_DATA: syllabusData, 
                getProgress: getProgress,
                updateOverallProgress: updateOverallProgress,
                exportProgress: exportProgress,
                importProgress: triggerImport,
                processImport: processImport,
                toggleAllSections: toggleAllSections,
                getPanelHtmlWrapper: getPanelHtmlWrapper,
                render: renderSyllabusPanel
            };

            function getProgress() {
                try {
                    const saved = localStorage.getItem(storageKey);
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.error(`Error loading ${subjectName} progress:`, e);
                    return {};
                }
            }

            function saveProgress(progressData) {
                localStorage.setItem(storageKey, JSON.stringify(progressData));
                updateOverallProgress();
                window.updateOverallDashboard(); 
            }
            
            function getTopicStatus(topicId, progressData) {
                const topic = syllabusData.find(t => t.id === topicId);
                if (!topic) return 0;
                
                // ðŸš¨ MODIFIED: Updated threshold from 3 to 4
                const DONE_THRESHOLD = 4;
                
                if (topic.depth === 1) {
                    let sectionBoxesTotal = 0;
                    let sectionBoxesChecked = 0;
                    const startIndex = syllabusData.findIndex(t => t.id === topicId);
                    for (let i = startIndex; i < syllabusData.length; i++) {
                        const currentItem = syllabusData[i];
                        if (i > startIndex && currentItem.depth <= topic.depth) break;
                        if (currentItem.depth === 2 && currentItem.trackable) {
                            const prog = progressData[currentItem.id] || {};
                            const boxesTicked = CHECKLIST_COLUMNS.filter(col => prog[col] === true).length;
                            if (boxesTicked >= DONE_THRESHOLD) { // ðŸš¨ MODIFIED: Uses DONE_THRESHOLD
                                sectionBoxesChecked++;
                            }
                            sectionBoxesTotal++;
                        }
                    }
                    if (sectionBoxesTotal === 0) return 0;
                    if (sectionBoxesChecked === sectionBoxesTotal) return 2;
                    if (sectionBoxesChecked > 0) return 1;
                    return 0;
                } else if (topic.trackable) {
                    const topicProgress = progressData[topicId] || {};
                    const checkedCount = CHECKLIST_COLUMNS.filter(col => topicProgress[col] === true).length;
                    if (checkedCount === CHECKLIST_COLUMNS.length) return 2;
                    if (checkedCount >= DONE_THRESHOLD) return 2; // ðŸš¨ MODIFIED: Uses DONE_THRESHOLD
                    if (checkedCount > 0) return 1;
                    return 0;
                }
                return 0;
            }

            function updateOverallProgress() {
                const progressData = getProgress();
                const mainTopics = syllabusData.filter(t => t.depth === 2 && t.trackable);
                let topicsDoneCount = 0;
                let topicsToReadCount = 0;
                
                // ðŸš¨ MODIFIED: 6 columns
                const DONE_THRESHOLD = 4;
                const columnProgress = CHECKLIST_COLUMNS.map(() => 0);
                const totalMainTopics = mainTopics.length;

                mainTopics.forEach(topic => {
                    const topicProgress = progressData[topic.id] || {};
                    let boxesTicked = 0;
                    CHECKLIST_COLUMNS.forEach((col, index) => {
                        if (topicProgress[col] === true) {
                            boxesTicked++;
                            columnProgress[index]++;
                        }
                    });
                    
                    if (boxesTicked >= DONE_THRESHOLD) { // ðŸš¨ MODIFIED: Uses DONE_THRESHOLD
                        topicsDoneCount++;
                    } else {
                        topicsToReadCount++;
                    }
                });

                const overallProgressPercentage = totalMainTopics > 0 ? ((topicsDoneCount / totalMainTopics) * 100).toFixed(1) : 0.0;
                let barColor;
                if (overallProgressPercentage <= 25) { barColor = '#ef4444'; } 
                else if (overallProgressPercentage <= 50) { barColor = '#f97316'; } 
                else if (overallProgressPercentage <= 75) { barColor = '#facc15'; } 
                else { barColor = '#10b981'; }

                document.getElementById(`progress-done-${subjectName}`) && (document.getElementById(`progress-done-${subjectName}`).textContent = topicsDoneCount);
                document.getElementById(`progress-toread-${subjectName}`) && (document.getElementById(`progress-toread-${subjectName}`).textContent = topicsToReadCount);
                
                const progressElement = document.getElementById(`progress-${subjectName}`);
                if (progressElement) {
                    progressElement.textContent = `${overallProgressPercentage}%`;
                    progressElement.classList.remove('font-light');
                    progressElement.classList.add('progress-percent-bold');
                }
                
                const progressBar = document.getElementById(`progress-bar-${subjectName}`);
                if (progressBar) {
                    progressBar.style.width = `${overallProgressPercentage}%`;
                    progressBar.style.backgroundColor = barColor;
                }

                // ðŸš¨ MODIFIED: Updated column names for progress bars
                const columnHeaderNames = ['codal', 'first_reading', 'second_reading', 'pre_bar_notes', 'pre_week', 'lmts'];
                columnProgress.forEach((tickedCount, index) => {
                    const elementId = `col-progress-bar-${subjectName}-${columnHeaderNames[index]}`;
                    const percentElementId = `col-percent-${subjectName}-${columnHeaderNames[index]}`;
                    const barElement = document.getElementById(elementId);
                    const percentElement = document.getElementById(percentElementId);

                    if (barElement) {
                        const colPercentage = totalMainTopics > 0 ? ((tickedCount / totalMainTopics) * 100).toFixed(1) : 0.0;
                        barElement.style.width = `${colPercentage}%`;
                        if (percentElement) {
                            percentElement.textContent = `${colPercentage}%`;
                        }
                    }
                });
            }

            function renderSyllabusPanel() {
                 const syllabusContainer = document.getElementById(`syllabus-${subjectName}`);
                 if (!syllabusContainer) { setTimeout(renderSyllabusPanel, 10); return; }

                 const topicWithChildren = (function() {
                     const children = new Set();
                     syllabusData.forEach((item, index) => {
                         const nextItem = syllabusData[index + 1];
                         if (nextItem && nextItem.depth > item.depth) {
                             children.add(item.id);
                         }
                     });
                     return children;
                 })();

                 function hasChildren(topicId) { return topicWithChildren.has(topicId); }
                
                const openSections = {};
                document.querySelectorAll(`#subject-tracker-panel-${subjectName} details`).forEach(details => {
                    if (details.id) { openSections[details.id] = details.open; }
                });

                const progress = getProgress();
                let html = '';
                let currentSectionOpen = false;
                let isDepth2Open = false;
                const checkboxClass = `syllabus-checkbox-${subjectName}`;
                
                syllabusData.forEach((item, index) => {
                    const topicId = item.id;
                    const nextItem = syllabusData[index + 1];
                    const currentStatus = getTopicStatus(topicId, progress);

                    const iconName = currentStatus === 2 ? 'check-circle-2' : (currentStatus === 1 ? 'circle-dot' : 'circle');
                    const iconColor = currentStatus === 2 ? 'checked' : (currentStatus === 1 ? 'partial' : 'empty');
                    const iconSize = item.depth === 1 ? 'w-5 h-5' : 'w-4 h-4';
                    const iconTitle = currentStatus === 2 ? 'Clear All' : (currentStatus === 1 ? 'Clear All' : 'Tick All');
                    const isTopLevelTopic = item.depth === 1;

                    if (isTopLevelTopic) {
                        if (isDepth2Open) { html += `</div></details></div>`; isDepth2Open = false; }
                        if (currentSectionOpen) { html += `</div></details></div>`; }
                        
                        const sectionId = `${subjectName}-section-${item.id}`;
                        const isOpen = openSections[sectionId] === false; 
                        const openAttr = isOpen ? 'open' : '';
                        
                        html += `\n<div class="syllabus-sub-section"><details id="${sectionId}" class="w-full" ${openAttr}><summary class="topic-header"><div class="topic-header-text"><i data-lucide="chevron-right" class="w-4 h-4 mr-2 chevron-icon"></i><span class="font-extrabold text-lg text-black/90">${item.topic}</span></div><i data-lucide="${iconName}" class="tick-all-icon ${iconColor} ${iconSize} flex-shrink-0" title="${iconTitle}" onclick="window.handleTickAll${subjectName.toUpperCase()}(${item.id}); event.stopPropagation(); event.preventDefault();"></i></summary><div class="p-2">\n`;
                        currentSectionOpen = true;
                    } else if (item.depth === 2 && item.trackable) {
                        const topicProgress = progress[topicId] || {};
                        const isCollapsible = hasChildren(topicId);

                        if (isDepth2Open && !isCollapsible) { html += `</div></details></div>`; isDepth2Open = false; }

                        const checklist = CHECKLIST_COLUMNS.map(col => {
                            // NEW CLASS: Use 'checkbox-' prefix plus the column name (codal, books, etc.)
                            const columnCheckboxClass = `checkbox-${col}`;
                            const checked = topicProgress[col] === true ? 'checked' : '';
                            
                            // Inject the columnCheckboxClass instead of the subject-specific one
                            return `\n<div class="flex justify-center"><input type="checkbox" data-id="${topicId}" data-column="${col}" ${checked} class="w-4 h-4 border-gray-300 rounded focus:ring-500 ${columnCheckboxClass}" onchange="window.handleCheckboxChange${subjectName.toUpperCase()}(event)"></div>\n`;
                        }).join('');

                        let rowContent = `\n
                            <div class="col-span-1 font-trackable-lg depth2-topic-row">
                                <div class="topic-content-wrapper" style="padding-left: 1.5rem;">
                                    ${isCollapsible ? `<i data-lucide="chevron-right" class="w-3 h-3 depth2-chevron"></i>` : `<span class="w-3 h-3 mr-2 inline-block"></span>`}${item.topic}
                                </div>
                            </div>
                            ${checklist}
                            <div class="flex items-center justify-center space-x-1 pl-2"><i data-lucide="${iconName}" class="tick-all-icon ${iconColor} ${iconSize} flex-shrink-0" title="${iconTitle}" onclick="window.handleTickAll${subjectName.toUpperCase()}(${item.id}); event.stopPropagation(); event.preventDefault();"></i></div>\n
                        `;

                        if (isCollapsible) {
                            const depth2Id = `${subjectName}-depth2-${item.id}`;
                            const isOpen = openSections[depth2Id] === true;
                            const openAttr = isOpen ? 'open' : '';
                            html += `<div class="depth2-details"><details id="${depth2Id}" class="w-full" ${openAttr}><summary class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</summary><div class="depth3-content-wrapper pt-1 pb-2">`;
                            isDepth2Open = true;
                        } else {
                            html += `<div class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</div>`;
                        }

                    } else if (item.depth >= 3) {
                        const dynamicPadding = (item.depth - 2) * 1.5 + 1.5;
                        const fontStyle = item.depth <= 4 ? 'font-medium' : 'font-normal';
                        
                        if (isDepth2Open) {
                             html += `<div class="p-1 border-b border-black/10 text-black/70 italic ${fontStyle} text-sm" style="padding-left: ${dynamicPadding}rem;">${item.topic}</div>`;
                        } else {
                            html += `<div class="checklist-grid hover:bg-gray-50/50 transition"><div>${item.topic}</div></div>`;
                        }
                    }

                    if (item.depth >= 3 && isDepth2Open && (!nextItem || nextItem.depth <= 2)) { html += `</div></details></div>`; isDepth2Open = false; }
                });

                if (currentSectionOpen) {
                    if (isDepth2Open) { html += `</div></details></div>`; }
                    html += `</div></details></div>`;
                }

                syllabusContainer.innerHTML = html;
                
                if (lucide && lucide.createIcons) { lucide.createIcons(); }
                updateOverallProgress();
                updateCollapseButtonText();
            }

function handleCheckboxChange(event) {
                 const checkbox = event.target;
                 const id = checkbox.dataset.id;
                 const column = checkbox.dataset.column;
                 const isChecked = checkbox.checked;
                 
                 // IMPROVED: This now passes true/false to track up OR down
                 window.trackActivity(isChecked); 

                 const progressData = getProgress();
                 if (!progressData[id]) { progressData[id] = {}; }
                 progressData[id][column] = isChecked;
                 saveProgress(progressData);
                 renderSyllabusPanel(); 
            }

            
            function handleTickAll(topicId) {
                 const progressData = getProgress();
                 let topicsToUpdate = [];
                 const currentStatus = getTopicStatus(topicId, progressData);
                 const targetState = currentStatus === 2 ? false : true; 
                 const item = syllabusData.find(t => t.id === topicId);
                 if (!item) return;
                 
                 const startDepth = item.depth;
                 const startIndex = syllabusData.findIndex(t => t.id === topicId);
                 
                 if (startDepth === 2 && item.trackable) {
                     topicsToUpdate.push(item);
                 } else if (startDepth === 1) {
                     for (let i = startIndex; i < syllabusData.length; i++) { 
                         const currentItem = syllabusData[i];
                         if (i > startIndex && currentItem.depth <= startDepth) break;
                         if (currentItem.depth === 2 && currentItem.trackable) {
                             topicsToUpdate.push(currentItem);
                         }
                     }
                 }
                 
                 topicsToUpdate.forEach(topic => {
                     const id = topic.id;
                     if (!progressData[id]) { progressData[id] = {}; }
                     CHECKLIST_COLUMNS.forEach(col => {
                         // ðŸš¨ FIX: If the state is actually changing, notify Analytics
                         if (progressData[id][col] !== targetState) {
                             if (window.trackActivity) window.trackActivity(targetState);
                         }
                         progressData[id][col] = targetState;
                     });
                 });
                 saveProgress(progressData);
                 renderSyllabusPanel();
            }

            function exportProgress() {
                const progressData = localStorage.getItem(storageKey);
                if (!progressData || '{}' === progressData) {
                    showMessageModal("Download Failed", `<p class='text-red-600'>No ${title} progress data found to download.</p>`);
                    return;
                }
                downloadFile(progressData, `${subjectName}-progress.json`, 'application/json');
                showMessageModal("Download Complete", `<p class='text-green-600'>Your ${title} progress has been downloaded as **${subjectName}-progress.json**</p>`);
            }

            function triggerImport() {
                 DOM_ELEMENTS.globalFileInput.dataset.targetSubject = subjectName;
                 DOM_ELEMENTS.globalFileInput.click();
            }

            function processImport(file) {
                 if (!file) { showMessageModal("Upload Canceled", "No file was selected for upload."); return; }
                 if ('application/json' !== file.type && !file.name.endsWith('.json')) { showMessageModal("Upload Error", `<p class='text-red-600'>Invalid file type. Please upload a **.json** file.</p>`); return; }
                 
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const jsonString = e.target.result;
                     try {
                         const importedData = JSON.parse(jsonString);
                         if ('object' !== typeof importedData || null === importedData) { throw new Error("Invalid JSON structure."); }
                         saveProgress(importedData);
                         renderSyllabusPanel();
                         showMessageModal("Success!", `<p class='text-green-600'>${title} progress successfully uploaded and applied.</p>`);
                     } catch (e) {
                         console.error("Import error:", e);
                         showMessageModal("Upload Error", `<p class='text-red-600'>Failed to upload. The file content is not valid JSON. Error: ${e.message}</p>`);
                     }
                 };
                 reader.onerror = function() { showMessageModal("Import Error", `<p class='text-red-600'>Error reading the file.</p>`); };
                 reader.readAsText(file);
            }

            function toggleAllSections() {
                const allDetails = document.querySelectorAll(`#subject-tracker-panel-${subjectName} details`);
                let shouldOpen = false;
                for (const details of allDetails) {
                    if (!details.open) {
                        shouldOpen = true;
                        break;
                    }
                }
                allDetails.forEach(details => { details.open = shouldOpen; });
                if (lucide && lucide.createIcons) { lucide.createIcons(); }
                updateCollapseButtonText(shouldOpen);
            }

            function updateCollapseButtonText(isOpen) {
                const btn = document.getElementById(`collapse-all-btn-${subjectName}`);
                if (btn) {
                    if (typeof isOpen === 'undefined') {
                        const allDetails = document.querySelectorAll(`#subject-tracker-panel-${subjectName} details`);
                        let allOpen = true;
                        for (const details of allDetails) { if (!details.open) { allOpen = false; break; } }
                        isOpen = allOpen;
                    }
                    const iconName = isOpen ? 'chevrons-up' : 'chevrons-down';
                    btn.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i>`; 
                    btn.classList.remove('w-8', 'h-8', 'w-7', 'h-7'); 
                    btn.classList.add('w-6', 'h-6', 'p-0', 'flex', 'items-center', 'justify-center', 'shadow-md'); 
                    if (lucide && lucide.createIcons) { lucide.createIcons(); }
                }
            }
            
            window[`handleTickAll${subjectName.toUpperCase()}`] = handleTickAll;
            window[`handleCheckboxChange${subjectName.toUpperCase()}`] = handleCheckboxChange;

            function getPanelHtmlWrapper(subjectName, title, icon) {
                const themeClass = `syllabus-panel-${subjectName}`;
                const bgButton = subjectName === 'rem' ? 'bg-purple-600' : (subjectName === 'crim' ? 'bg-red-600' : (subjectName === 'lab' ? 'bg-lab-button' : (subjectName === 'civ' ? 'bg-civ-button' : (subjectName === 'comm' ? 'bg-comm-button' : 'bg-poli-button'))));
                const hoverButton = subjectName === 'rem' ? 'hover:bg-purple-700' : (subjectName === 'crim' ? 'hover:bg-red-700' : (subjectName === 'lab' ? 'hover:bg-lab-button-dark' : (subjectName === 'civ' ? 'hover:bg-civ-button-dark' : (subjectName === 'comm' ? 'hover:bg-comm-button-dark' : 'hover:bg-poli-button-dark'))));
                
                const cleanTitle = title.replace(/\s*\([\d\s]*% of Total\)/, '');
                
                return `
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 mt-4 syllabus-panel-container ${themeClass}" id="subject-tracker-panel-${subjectName}">
                    <details class="syllabus-panel">
                        <summary class="syllabus-summary" id="summary-${subjectName}">
                            <div class="syllabus-summary-title-row">
                                <div class="flex items-center">
                                    <i data-lucide="${icon}" class="w-6 h-6 mr-3"></i>${cleanTitle}
                                </div>
                                <div class="flex items-center text-xs">
                                    <span class="text-gray-300 mr-2 font-light hidden sm:inline">Press to Expand/Collapse</span>
                                    <i data-lucide="chevron-right" class="w-6 h-6 ml-2 main-summary-chevron"></i>
                                </div>
                            </div>
                            <div class="syllabus-progress-metrics text-xs">
                                <div class="progress-stats">
                                    <span class="flex items-center"><i data-lucide="check-circle-2" class="w-4 h-4 mr-1 text-gray-200"></i>DONE:&nbsp;<span id="progress-done-${subjectName}">0</span>&nbsp;TOPICS</span>
                                    <span class="flex items-center"><i data-lucide="book-open-text" class="w-4 h-4 mr-1 text-gray-200"></i>TO READ:&nbsp;<span id="progress-toread-${subjectName}">0</span>&nbsp;TOPICS</span>
                                </div>
                                <div class="flex items-center space-x-2 flex-grow min-w-[200px]">
                                    <span class="progress-overall-text flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-1"></i>OVERALL PROGRESS:</span>
                                    <div class="progress-bar-container">
                                        <div id="progress-bar-${subjectName}" class="progress-bar" style="width: 0%;"></div>
                                    </div>
                                    <span id="progress-${subjectName}" class="progress-percent-bold">0.0%</span>
                                </div>
                            </div>
                        </summary>
                        <div class="syllabus-content">
                            
                            <!-- 1. COLUMN HEADERS ðŸš¨ MODIFIED for 6 Columns & Multi-line Text -->
                            <div class="checklist-grid checklist-grid-header mt-1 font-bold text-xs text-center border-b-2 border-black/50">
                                <div class="text-left">SUBJECTS/TOPICS</div> 
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#8b5cf6;"><span class="font-bold text-[0.65rem]">Codal</span></div>
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#eab308;"><span class="font-bold text-[0.65rem]">First Reading (Textbook)</span></div>
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#3b82f6;"><span class="font-bold text-[0.65rem]">Second Reading (Bar-Based)</span></div>
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#10b981;"><span class="font-bold text-[0.65rem]">Pre-Bar Review Notes & Lecture</span></div>
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#f97316;"><span class="font-bold text-[0.65rem]">Pre-Week</span></div>
                                <div class="flex items-center justify-center text-center leading-tight" style="color:#ef4444;"><span class="font-bold text-[0.65rem]">LMTs</span></div>
                                <div class="flex items-center justify-center pt-1">
                                    <button id="collapse-all-btn-${subjectName}" class="w-6 h-6 p-0 flex items-center justify-center text-white ${bgButton} rounded-lg shadow-md ${hoverButton} transition duration-150 whitespace-nowrap">
                                        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Micro-progress Bars ðŸš¨ MODIFIED for 6 Columns & New Threshold -->
                            <div class="checklist-grid checklist-grid-micro-progress text-center">
<div class="text-left italic text-gray-500 col-span-1 pl-1 self-start pt-1" 
     style="font-size: 10px !important; line-height: 1 !important; display: block !important;">
    Overall progress counts only when at least 4 boxes per topic are checked.
</div> 

                                <!-- Column 1: Codal (Purple) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-codal" class="col-progress-bar" style="background-color: #8b5cf6; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-codal" class="text-xs font-semibold mt-1 text-violet-700">0.0%</span>
                                </div>
                                <!-- Column 2: 1st Reading (Yellow) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-first_reading" class="col-progress-bar" style="background-color: #eab308; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-first_reading" class="text-xs font-semibold mt-1 text-yellow-700">0.0%</span>
                                </div>
                                <!-- Column 3: 2nd Reading (Blue) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-second_reading" class="col-progress-bar" style="background-color: #3b82f6; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-second_reading" class="text-xs font-semibold mt-1 text-blue-700">0.0%</span>
                                </div>
                                <!-- Column 4: Pre-Bar Notes (Green) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-pre_bar_notes" class="col-progress-bar" style="background-color: #10b981; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-pre_bar_notes" class="text-xs font-semibold mt-1 text-green-700">0.0%</span>
                                </div>
                                <!-- Column 5: Pre-Week (Orange) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-pre_week" class="col-progress-bar" style="background-color: #f97316; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-pre_week" class="text-xs font-semibold mt-1 text-orange-700">0.0%</span>
                                </div>
                                <!-- Column 6: LMTs (Red) -->
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-lmts" class="col-progress-bar" style="background-color: #ef4444; width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-lmts" class="text-xs font-semibold mt-1 text-red-700">0.0%</span>
                                </div>
                                <div></div>
                            </div>
                            
                            <div id="syllabus-${subjectName}" class="text-xs"></div>
                        </div>
                    </details>
                </div>
                `;
            }

            return self;
        };

// AUTO "Last saved" UPDATE FOR ALL SUBJECTS
const originalCreateSyllabusLogic = window.createSyllabusLogic;
window.createSyllabusLogic = function(...args) {
    const logic = originalCreateSyllabusLogic(...args);
    
    // Override the saveProgress method
    const originalSaveProgress = logic.saveProgress;
    logic.saveProgress = function(progressData) {
        originalSaveProgress.call(this, progressData);
        updateLastSaved();  // â† This makes the footer update!
    };
    
    return logic;
};

        // --- GLOBAL SUBJECT SYLLABUS DATA (Declarations for loading) ---
        
        // This is the CRITICAL change: The load function now uses the file path to load the external JS.
function initializeSubjectTrackers() {
    loadSubjectPanel('rem', 'Syllabus/rem_logic.js');
    loadSubjectPanel('crim', 'Syllabus/crim_logic.js');
    loadSubjectPanel('lab', 'Syllabus/lab_logic.js');
    loadSubjectPanel('civ', 'Syllabus/civ_logic.js');
    loadSubjectPanel('comm', 'Syllabus/comm_logic.js');
    loadSubjectPanel('poli', 'Syllabus/poli_logic.js');
}

        // --- GLOBAL DASHBOARD LOGIC ---
        function drawPieChart(donePercent) {
            const chartEl = document.getElementById('global-pie-chart');
            if (!chartEl) return;

            let fillColor;
            if (donePercent <= 25) { fillColor = '#ef4444'; } 
            else if (donePercent <= 50) { fillColor = '#f97316'; } 
            else if (donePercent <= 75) { fillColor = '#facc15'; } 
            else { fillColor = '#10b981'; }
            
            const backgroundRingColor = (donePercent < 100) ? '#ef4444' : '#e5e7eb';
            const centerTextColor = fillColor; 
            const centerFontSize = '2.5rem'; 
            const centerFontFamily = 'Bebas Neue, sans-serif'; 

            let totalTopics = 0;
            Object.values(SUBJECT_LOGIC_MAP).forEach(logic => {
                const mainTopics = logic.SYLLABUS_DATA.filter(t => t.depth === 2 && t.trackable);
                totalTopics += mainTopics.length;
            });
            const totalTopicsText = `Total Topics: ${totalTopics}`;

            const size = 160; 
            const radius = size / 2;
            const strokeWidth = 35; 
            const center = size / 2;
            
            const circumference = 2 * Math.PI * (radius - strokeWidth / 2);
            const doneOffset = circumference * (1 - (donePercent / 100));

            chartEl.style.width = `${size}px`;
            chartEl.style.height = `${size}px`;

            chartEl.innerHTML = `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                    <circle cx="${center}" cy="${center}" r="${radius - strokeWidth / 2}" fill="none" stroke="${backgroundRingColor}" stroke-width="${strokeWidth}"/>
                    <circle
                        class="ring-done" cx="${center}" cy="${center}" r="${radius - strokeWidth / 2}"
                        fill="none" stroke="#38761d" stroke-width="${strokeWidth}" stroke-dasharray="${circumference}"
                        stroke-dashoffset="${doneOffset}" transform="rotate(-90 ${center} ${center})" stroke-linecap="round"
                    />
                    <circle cx="${center}" cy="${center}" r="${radius - strokeWidth}" fill="white"/>
                    <text x="${center}" y="${center - 10}" text-anchor="middle" alignment-baseline="central" font-size="${centerFontSize}"
                        font-weight="900" fill="${centerTextColor}" font-family="${centerFontFamily}" 
                        style="text-shadow: 1px 1px 0 #cccccc; letter-spacing: 1px;">
                        ${(donePercent).toFixed(0)}%
                    </text>
                     <text x="${center}" y="${center + 20}" text-anchor="middle" alignment-baseline="central" font-size="0.4rem"
                        font-weight="bold" fill="#4a5568" font-family="Inter, sans-serif" style="text-shadow: none;">
                        ${totalTopicsText}
                    </text>
                </svg>
            `;
        }

        function updateOverallDashboard() {
            document.getElementById('today-date-display').textContent = getLocalDisplayDate();

            let totalTrackableTopics = 0;
            let totalDoneTopics = 0;
            let totalToReadTopics = 0;
            
            // ðŸš¨ MODIFIED: Updated threshold from 3 to 4
            const DONE_THRESHOLD = 4;

            Object.values(SUBJECT_LOGIC_MAP).forEach(logic => {
                const progress = logic.getProgress();
                const syllabusData = logic.SYLLABUS_DATA;
                
                const mainTopics = syllabusData.filter(t => t.depth === 2 && t.trackable);
                const currentSubjectTrackable = mainTopics.length;
                let currentSubjectDone = 0;

                mainTopics.forEach(topic => {
                    const topicProgress = progress[topic.id] || {};
                    const boxesTicked = CHECKLIST_COLUMNS.filter(col => topicProgress[col] === true).length;
                    
                    if (boxesTicked >= DONE_THRESHOLD) { // ðŸš¨ MODIFIED: Uses DONE_THRESHOLD
                        currentSubjectDone++;
                    }
                });

                totalTrackableTopics += currentSubjectTrackable;
                totalDoneTopics += currentSubjectDone;
            });

            totalToReadTopics = totalTrackableTopics - totalDoneTopics;

            const donePercent = totalTrackableTopics > 0 ? (totalDoneTopics / totalTrackableTopics) * 100 : 0;
            const toReadPercent = 100 - donePercent;

            drawPieChart(donePercent);
            updateScheduleTable();

            document.getElementById('global-progress-done').textContent = `${donePercent.toFixed(1)}%`;
            document.getElementById('global-total-done-count').textContent = totalDoneTopics;
            
            document.getElementById('global-progress-toread').textContent = `${toReadPercent.toFixed(1)}%`;
            document.getElementById('global-total-toread-count').textContent = totalToReadTopics;
        }

        window.updateOverallDashboard = updateOverallDashboard;


        // --- INITIALIZATION ---
        window.onload = () => {
const last = localStorage.getItem('last_saved');
    if (last) {
        document.getElementById('last-saved').textContent = `â€¢ Last saved: ${last} â€¢`;
    }

            // 1. Initialize Countdown Dates
            COUNTDOWN_DATA.forEach(data => {
                const savedDate = localStorage.getItem(`comp_exam_date_${data.id}`);
                const finalDate = savedDate || data.targetDate;
                if (finalDate) {
                    data.targetDate = finalDate;
                    document.querySelector(`#target-date-display-${data.id} .date-text`).textContent = formatUniqueDate(finalDate);
                }
            });

            // Display today's date
            document.getElementById('today-date-display').textContent = getLocalDisplayDate();
            setInterval(() => {
                document.getElementById('today-date-display').textContent = getLocalDisplayDate();
            }, 60000); 
            
            // 2. Load Calendar Module HTML and initialize its logic (now inline)
            document.getElementById('calendar-module-placeholder').innerHTML = CALENDAR_MODULE_HTML;
            
// 3. Initialize Calendar and Notepad Logic
            window.CALENDAR_APP.loadNotes();

            // ANTI-CACHE LOAD: Force textarea to match Local Storage on every refresh
            const persistentNotes = localStorage.getItem('review_notepad_content');
            const noteArea = document.getElementById('review-notes');
            if (noteArea && persistentNotes !== null) {
                noteArea.value = persistentNotes;
            }

            window.CALENDAR_APP.initializeCalendar();
            
            // Initial sync/toggle check for calendar panel (needed to set notepad height)
            const detailsElement = document.getElementById('calendar-details');
            if(detailsElement) {
                $(detailsElement).on('toggle', function() {
                    const indicator = $('.toggle-indicator i');
                    if ($(this).prop('open')) {
                        indicator.removeClass('fa-chevron-right').addClass('fa-chevron-down');
                        window.CALENDAR_APP.syncHeight();
                    } else {
                        indicator.removeClass('fa-chevron-down').addClass('fa-chevron-right');
                    }
                }).trigger('toggle');
            }


            // 4. Load Subject Panels (This is ASYNCHRONOUS)
            initializeSubjectTrackers();
            
            // 5. Initialize Lucide Icons for static content
            if (lucide && lucide.createIcons) {
                lucide.createIcons();
            }

// 6. Attach General Event Listeners and load user name
            updateAllCountdowns();
            setInterval(updateAllCountdowns, 1000);
            
loadUserName(); // Call immediately on load


            // RESTORE CLICKABLE DATES (Explicit mapping)
            const d1 = document.getElementById('target-date-display-1');
            const d2 = document.getElementById('target-date-display-2');
            const d3 = document.getElementById('target-date-display-3');
            
            if(d1) d1.onclick = () => openModal(1);
            if(d2) d2.onclick = () => openModal(2);
            if(d3) d3.onclick = () => openModal(3);

            // The dashboard update MUST wait for external subjects to load (1.5 seconds delay to be safe)
            setTimeout(window.updateOverallDashboard, 1500);
            
            // Monkey patch saveModal to update schedule table AFTER countdown is saved
            if (typeof saveModal === 'function' && typeof updateScheduleTable === 'function') {
                const originalSaveModal = saveModal;
                saveModal = function() {
                    originalSaveModal();
                    updateScheduleTable();
            refreshTargetsUI();  
                };
            }
            
            document.getElementById('modal-save-btn').addEventListener('click', saveModal);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            
            document.getElementById('message-modal-close-btn')?.addEventListener('click', closeMessageModal);
if (typeof refreshTargetsUI === 'function') {
                refreshTargetsUI();
            }
        };

        // APPENDED: Case Tracker Script from case_tracker.html (at the end of the main script block)
        // MINIFIED CSV DATA
       const csvData = `No.,Full Text,Division,Promulgation Date,Type
001,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1uDBOgvEhwcHFaKuXoivAKSpOXP_fJvIF"", ""City Government of Pasay v. Arellano University"")",3RD DIVISION,07 May 2025,DECISION
002,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1dFdCzxNe7Z6f_lSpJvK8YwUZIWxQFeFS"", ""Antonino v. Banco De Oro"")",3RD DIVISION,23 Apr 2025,DECISION
003,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=163-gwYOh42CtE1uqn_WYM48zRqg1H7lk"", ""Mangudadatu v. Comelec"")",EN BANC,22 Apr 2025,DECISION
004,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TgYfJacpf1nufj0uyLWGo5cb1FPaz8hP"", ""Hisanza v. Bright Maritime"")",3RD DIVISION,07 Apr 2025,DECISION
005,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1E2HMgAHqfInA8VeOkoZUi6jB7KZJwC7e"", ""People v. Akil"")",3RD DIVISION,07 Apr 2025,DECISION
006,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kduLoGGJheIOZZm2-dYAS4FkFk4RL6of"", ""San Pedro v. Spouses Trinidad"")",3RD DIVISION,07 Apr 2025,DECISION
007,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=18SUnBXjR3wwTHDJqnwo-6dqjhzJeFsUR"", ""Rural Bank of San Mateo Isabela v. Ramales"")",3RD DIVISION,02 Apr 2025,DECISION
008,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1D7GzmFcQuyOwOesIIwvZeemEhh4zPq_q"", ""Zamora v. Atty. Mahinay"")",3RD DIVISION,02 Apr 2025,DECISION
009,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1oR5stgaEHxw5vvk2eQeSBuuphNsqNelY"", ""Ocampo v. Batara-Sapad"")",3RD DIVISION,02 Apr 2025,DECISION
010,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1sbLGiaUtubSBRcT2SObaK3HCpjlayj-p"", ""Grand Exploit Builder Development v. Hoegaarden Development Realty"")",3RD DIVISION,02 Apr 2025,DECISION
011,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1C5fzsRrrgFnj3u-oz4ZL4IRaJQFz7OLS"", ""Vera Law v. Atty. Hechanova"")",3RD DIVISION,26 Feb 2025,DECISION
012,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1InoDHCJoV5xqpEdjOjzhOpb5aOjwsL95"", ""Lo v. People"")",3RD DIVISION,26 Feb 2025,DECISION
013,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Qbxs8F-O1ZZOPD-bA4_vII1MkvHB97Df"", ""Spouses Palaganas v. Atty. Panganiban"")",3RD DIVISION,24 Feb 2025,DECISION
014,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1b3rmQtv9YcvrXM6RuYxNzPMYIjPoUSJP"", ""Bonbon v. People"")",3RD DIVISION,24 Feb 2025,DECISION
015,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=13E19PHalkVqGj9SIx-dfhQUfPPRAUE3S"", ""Sillano v. JGC Philippines"")",3RD DIVISION,24 Feb 2025,DECISION
016,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1uSwSeRMF-Lt4-DVh_1-N_1qzjSvnJctQ"", ""Aguiling v. People"")",3RD DIVISION,17 Feb 2025,DECISION
017,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1h4iX9AVoC5yxsQBN9Cc1STDE0K0GZ1rK"", ""People v. Sandiganbayan, Tumang"")",3RD DIVISION,17 Feb 2025,DECISION
018,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1hJM3NwWqy-HD7bNwpP1up_9TR9YvJgal"", ""Bagbagen v. Perez"")",3RD DIVISION,17 Feb 2025,DECISION
019,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1pVTELUnV3jT2dCZEFpfuQ3YAFrm6qGy0"", ""Labastida v. Quires"")",3RD DIVISION,27 Jan 2025,DECISION
020,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1VHiRcgL7XJGKq6Sc2l1R0JBwZ-iwVbfB"", ""Baguinon, Sr. v. People"")",3RD DIVISION,27 Jan 2025,DECISION
021,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1M0GC9d1xv8JUKaw37y5NzUuXjTYZCS4s"", ""Maitim v. Teknika Skills and Trade Services"")",3RD DIVISION,15 Jan 2025,DECISION
022,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HHyqi-DPewdnDJDxHx2gfyh4gEkNZqgA"", ""Del Monte Land Transport Bus Company v. Jaranilla"")",3RD DIVISION,27 Nov 2024,DECISION
023,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1vjkiIsboYfMhKHsLEet9xbit4T_RNL07"", ""People v. Lupoyon"")",3RD DIVISION,11 Nov 2024,DECISION
024,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1KMHjcS4KqzSQbH9vphIlYH4bTbVEcn-c"", ""Fajardo v. San Miguel Foods"")",3RD DIVISION,11 Nov 2024,DECISION
025,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HDp-t-ms_mmVzDzHKJFK0o_sql6qID2J"", ""Noveras v. Comelec"")",EN BANC,22 Oct 2024,DECISION
026,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Ci_UMI1-l4SGthRRb1idz7M8bQ90nQWg"", ""Puguon, Jr. v. People"")",3RD DIVISION,21 Oct 2024,DECISION
027,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1E3OTivVeNbAxaUtuXfRHX1vM5avvX2of"", ""Malapit v. Atty. Watin"")",EN BANC,01 Oct 2024,RESOLUTION
028,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wDQrk0vQR5RjJ5_BBN8VcEEzAtn0zVcr"", ""Pequero v. People"")",3RD DIVISION,07 Aug 2024,DECISION
029,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1oqM7iUaxlUiHy3y_waCF90bXCHQCPwrL"", ""People v. Batomalaque"")",3RD DIVISION,07 Aug 2024,DECISION
030,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1b58xzry26zVcuxenkFXnQFQBUHWUT6Lh"", ""Davantes v. C.F. Sharp Crew Management"")",3RD DIVISION,07 Aug 2024,DECISION
031,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1W32j1TQ3pNPPAX6fTFW-u9fDKfjOYOBR"", ""Legaspi v. Comelec"")",EN BANC,30 Jul 2024,DECISION
032,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=15kdT7bEiOy2Uq7F4_GohJFSvcDS-_t9M"", ""Re Atty. Divina"")",EN BANC,30 Jul 2024,DECISION
033,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ZTMXVpRi9vYy4fXn0wD8plNK_wOIjtmp"", ""Gonzales v. Geronimo"")",EN BANC,30 Jul 2024,DECISION
034,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1asW5GpzZd811KLwjRBzMRnm07_fXkqhn"", ""Stewart v. Atty. Rioflorido"")",3RD DIVISION,17 Jul 2024,DECISION
035,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1hxm223V8R1DYrAoCmfU1ZYgJ__jIWOaJ"", ""OCA v. Judge Villavicencio-Olan"")",EN BANC,25 Jun 2024,DECISION
036,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1WxVVEAy7LoheY9GtTOmDncqju4F-ymyq"", ""People v. Talaue"")",SPECIAL 1ST DIVISION,19 Jun 2024,RESOLUTION
037,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HIbN6A6WbI0pxtkg81TSGZIvIcvwxsGn"", ""People v. Oh"")",3RD DIVISION,05 Jun 2024,DECISION
038,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kw3MOsgy09gPHK1JX__gkTyJVYhILQQT"", ""Ampolitod v. Top Ever Marine Management Phils."")",3RD DIVISION,22 May 2024,DECISION
039,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1GA0ZW1d48Oka6S-vfSXZphgy8eigaFUz"", ""Zoleta v. Ombudsman"")",3RD DIVISION,08 Apr 2024,DECISION
040,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xmKtydq56Kz0PJ_gknVtUp8P-uATlidy"", ""Besmonte v. Napolcom-NCR"")",3RD DIVISION,03 Apr 2024,DECISION
041,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1RAOWSCA1XgRxG3KPEG_6VnYRf7S_N_ZH"", ""Bayron v. COA"")",EN BANC,27 Feb 2024,RESOLUTION
042,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LSgUS8jysp2p2_aUnT0wACrPoVopZP3W"", ""Pacheco v. Reyes"")",3RD DIVISION,26 Feb 2024,DECISION
043,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1AXTJDWXmQvcN5WF-tfOTIeUMEp8nLckL"", ""Galorio v. People"")",3RD DIVISION,19 Feb 2024,DECISION
044,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ho9IargdwqbCBbb07MfX-ciRV2Sj3S1R"", ""Pagtakhan v. People"")",3RD DIVISION,07 Feb 2024,DECISION
045,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LAytIG1OtgaEezWlb-lSemz6PHOOL3Wg"", ""DBP v. COA"")",EN BANC,06 Feb 2024,RESOLUTION
046,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1XXvRNTGywW5BjGFOoxx6xvlBrgrs054l"", ""Denusta v. Migrant Workers Manpower Agency"")",3RD DIVISION,31 Jan 2024,DECISION
047,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LAJ5K2SiOH3C2TIEs1OnnWpyKMndLoFT"", ""Villafuerte v. Atty. Tajanlangit"")",3RD DIVISION,06 Dec 2023,DECISION
048,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HOr8SJZ5PIvs4HxmRgmqWThdGXhG-H8O"", ""Trinidad v. Trinidad"")",3RD DIVISION,06 Dec 2023,DECISION
049,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1pIVpOkTnU9g8eyanZMetwUQyjCoGMDiW"", ""People v. Flores"")",3RD DIVISION,11 Oct 2023,DECISION
050,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=19QTDt56T-sfEyXSqhgqC0j7779kJEn5x"", ""People v. Lala"")",3RD DIVISION,11 Oct 2023,DECISION
051,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=15lE3t888CVvNDIcUGKBy9Coa84Tk5AK_"", ""People v. Pajarilla"")",3RD DIVISION,30 Aug 2023,DECISION
052,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Pji_I-e0XQwz8zw00wOw-SjGgxzn2ve-"", ""People v. XXX220145"")",3RD DIVISION,30 Aug 2023,DECISION
053,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1GRyUnAhaKmtEnpsRbH0ivbh-nn61CTQo"", ""Republic v. Spouses Tan"")",3RD DIVISION,23 Aug 2023,DECISION
054,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HFjXfxxv-sdu5U7wJCZCPlYfftOCYm8n"", ""Bacar v. People"")",3RD DIVISION,23 Aug 2023,DECISION
055,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1EuH7VnRl0PiUKHbTGF6uJSjSN4yCTZaQ"", ""Palo v. Spouses Baquirquir"")",3RD DIVISION,23 Aug 2023,RESOLUTION
056,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=124TYG48Rbl63kISUAxAPASg1YSs-pcmS"", ""Aguilar v. People"")",3RD DIVISION,09 Aug 2023,DECISION
057,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1hk9pZIJjANNndlCL5LGbQvxdX7gii4k1"", ""Grandspan Development v. Franklin Baker, Inc."")",3RD DIVISION,02 Aug 2023,DECISION
058,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Udf6AT9efho2Su3vX6w6Bojt69bkvzsc"", ""Cojuangco-Suntay v. Suntay III"")",3RD DIVISION,02 Aug 2023,DECISION
059,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1od6wXT706LOMuIbC04aARdm83b67G2qf"", ""DBP v. COA"")",EN BANC,11 Jul 2023,DECISION
060,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1qWzk9-s3qzgcJVKrh-hTki2Rwow5At9b"", ""Villanueva v. Comelec"")",EN BANC,11 Jul 2023,DECISION
061,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1QOm4u04iemremtMWq1AG673JJvVhswQt"", ""Arguilles v. Wilhelmsen Smith Bell Manning, Inc."")",3RD DIVISION,10 Jul 2023,DECISION
062,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xoWIk2-DRTuDm0avXwLSRXZcKjqqTNjx"", ""Tijam v. People"")",3RD DIVISION,10 Jul 2023,DECISION
063,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1JmJTPBDT4DNZPgFJDxzwYIRjOHcyfRZf"", ""Ocampo v. Macapagal-Arroyo"")",EN BANC,27 Jun 2023,RESOLUTION
064,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1coshHuRj9eA2ghBntCEjDIQpeYLq2FVj"", ""Mendoza v. Atty. Santiago, Jr."")",3RD DIVISION,14 Jun 2023,DECISION
065,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1MnLjX3Bg7J_8UrakXJze3m-X1CtVlMhI"", ""Gonzaga v. Garcia, Jr."")",3RD DIVISION,26 Apr 2023,DECISION
066,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1D4gkQ4ZjCU1Lk0Dwtuq5zM4ltcW-dm8A"", ""Republic v. Espejo"")",3RD DIVISION,26 Apr 2023,DECISION
067,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1DFEOX0tlN3lSrsAD9wUeojEVn-k8iMeO"", ""Bunayog v. Foscon Shipmanagement, Inc."")",EN BANC,25 Apr 2023,DECISION
068,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1jsKFQ-L8a470vAm3xgC6PMPUE4_SIT5V"", ""Yau v. Judge Veloso"")",3RD DIVISION,19 Apr 2023,DECISION
069,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1amXFqaQUz5LJFYJbDCXiJcE5T3Wi2TDd"", ""Manuel v. People"")",3RD DIVISION,12 Apr 2023,DECISION
070,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14gC-V3DzQwqVRdfkAnrgyLOfc1CqQniw"", ""XXX255877 v. People"")",3RD DIVISION,29 Mar 2023,DECISION
071,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wxRjR4Ztanl8V1IoGkICq8mjthKCi1pb"", ""Asignado v. Ombudsman"")",3RD DIVISION,29 Mar 2023,DECISION
072,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Z6teSC0rxiZvXNFnW0IU4Axl8fHsppO3"", ""Municipality of Sta. Maria, Bulacan v. Buenaventura"")",3RD DIVISION,29 Mar 2023,DECISION
073,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=12SCjx--HER7M_q3FitGWt5ORcN5PiTaf"", ""Citibank Savings, Inc. v. Rogan"")",3RD DIVISION,29 Mar 2023,DECISION
074,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1h9BVU_N-OciUtyfKF6Jm8y38UpcUAM5U"", ""De Guzman v. Spouses Santos"")",3RD DIVISION,29 Mar 2023,DECISION
075,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1DiebWXssr7jijupEn31CzGjEKs1xiUoy"", ""Solis v. Solis-Laynes"")",3RD DIVISION,29 Mar 2023,DECISION
076,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1qruH_L4aQt_FfCapK2QVmiSITPUmLbRb"", ""Diversified Plastic Film System, Inc. v. Philippine Investment One (SPV-AMC), Inc."")",3RD DIVISION,29 Mar 2023,DECISION
077,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1VDKVxlYKPOgyXBmS7w8dXkK5hMSK-pDc"", ""Republic v. Pascual"")",3RD DIVISION,29 Mar 2023,DECISION
078,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=16Zv5N5lbuREKupU08VleTB-4y2PAzboZ"", ""Chevron Philippines v. Looyuko"")",3RD DIVISION,29 Mar 2023,DECISION
079,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1o2kBtAkQRU-zbi6wiWflH9UFteWfdjLy"", ""Land Bank v. Tayko"")",3RD DIVISION,29 Mar 2023,RESOLUTION
080,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1MhRaWvmI_MEGXQ3-d1-_MEH6VccAehu2"", ""Zamora v. Bagatsing, Jr."")",3RD DIVISION,29 Mar 2023,DECISION
081,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1D-2Ac11PYPAtDmm6fT7GnDT1Hl9_zaUV"", ""Reyes v. Ombudsman"")",3RD DIVISION,15 Mar 2023,DECISION
082,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14yx8bgwOunuBP3P7uQACh2UoqMjFVHMR"", ""Heirs of Dimao v. NGCP"")",3RD DIVISION,01 Mar 2023,DECISION
083,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1C1TgKvQsoK8qOpnyi7HSLvtAFUIRZsNo"", ""Conche v. People"")",3RD DIVISION,01 Mar 2023,DECISION
084,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1zrsiyAnCoZhL9ntFnQKPHEUdyJbWfILn"", ""Singgit v. People"")",3RD DIVISION,27 Feb 2023,DECISION
085,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1eNER-IDo8Im_X_nM2RW0czQ7Qd0FS1Hi"", ""Heirs of Manzano v. Kinsonic Philippines, Inc."")",3RD DIVISION,27 Feb 2023,DECISION
086,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10hYRV6Ah7qdaqOE8FdIJ0qFwkAf5c5KM"", ""Land Bank v. Miranda"")",3RD DIVISION,22 Feb 2023,DECISION
087,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=12RXZd_6r-RB2fgthsGEKy70LU7IATAtk"", ""Pabalan v. Sabnani"")",EN BANC,21 Feb 2023,DECISION
088,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Rr4Xs-Bf7zzq4S_Miubyg7SadZ9SbghX"", ""Gotesco Properties v. Cua"")",3RD DIVISION,15 Feb 2023,DECISION
089,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1r7sMQKrKGXgw_3G58n-Qtibo32TnfI0s"", ""Caballes v. CA"")",3RD DIVISION,08 Feb 2023,DECISION
090,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1-GGq9xVmtCfRPS2Z7gg7bSbQgtmiO5Km"", ""Quiambao v. Sumbilla"")",3RD DIVISION,01 Feb 2023,DECISION
091,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wxivOq6vVYBmTT7UKBfBpbgXdf6XdfHR"", ""Bariata v. Carpio-Morales"")",3RD DIVISION,01 Feb 2023,DECISION
092,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1OOOJIm7KQ5188JmZT6B32YAjTnIooAm9"", ""Land Bank v. Spouses Latog"")",3RD DIVISION,01 Feb 2023,DECISION
093,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1NSenizXyN7UoAEcBjX7lee3ZTgXdaN_N"", ""Aquino v. Agua Tierra Oro Mina Development Corporation"")",3RD DIVISION,25 Jan 2023,DECISION
094,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1-XjnA-bDxOBQ9xbj15mdFavBM2ALTYIA"", ""Provincial Prosecutor of Albay v. Lobiano"")",3RD DIVISION,25 Jan 2023,DECISION
095,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1oIdcZuuHeHf_zpQQE_-Gi6pDqNXKZX_c"", ""Suyat v. CA"")",EN BANC,24 Jan 2023,DECISION
096,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Y6qKadpngv6TtRsHNU1mFepWi9jwvSu7"", ""DENR-PENRO of Virac, Catanduanes v. Eastern Island Shipping Lines"")",3RD DIVISION,16 Jan 2023,DECISION
097,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1d1SRaiQYWnULdLlOcVKk563x3DpKTDyI"", ""Vizcarra v. Vizcarra-Nocillado"")",3RD DIVISION,11 Jan 2023,DECISION
098,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14F604dvX_zmPCZgU7HwK-OVbStN3WD2m"", ""Ocampo v. Macapagal-Arroyo"")",EN BANC,10 Jan 2023,DECISION
099,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1XSJFg9k5TUr1sJlA4dXIkBlFCxwdZlzc"", ""Bounsit-Torralba v. Torralba"")",3RD DIVISION,07 Dec 2022,DECISION
100,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ZLs6A9vDSvS6kxkiQzBq7RHeC6hWDaDq"", ""Fort Bonifacio Development Corporation v. Domingo"")",3RD DIVISION,07 Dec 2022,DECISION
101,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=18KkMzROUnUT8KvtJL4TO-EbdS0_-dKCB"", ""Bayron v. COA"")",EN BANC,29 Nov 2022,DECISION
102,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1H1VOhlfT8DgwW21GSupJWEczdJ4eLvBM"", ""Manguerra v. Manguerra-Aberasturi"")",EN BANC,29 Nov 2022,DECISION
103,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1k-4b1eysLH7R-xLG5RiydO0aRtsG6YyX"", ""Nolasco v. Purence Realty Corporation"")",3RD DIVISION,12 Oct 2022,DECISION
104,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=163D0B_Or4N_mYIZHIc-x2kpacDu4ZYBd"", ""Cabrales v. Ombudsman"")",3RD DIVISION,12 Oct 2022,DECISION
105,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1QKee5dAZWJqvrpYnI4NyBbrypIqL91eJ"", ""POrto v. Grant Institute of Trade & Technology, Inc."")",3RD DIVISION,12 Oct 2022,DECISION
106,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1-SL8wmC7yD1NETZvLWIErrCboUIywlzM"", ""Rivera v. Velasco"")",3RD DIVISION,05 Oct 2022,DECISION
107,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1136zoeLByhu75PfWRaE5OfezdiObWpa3"", ""People v. XXX252230"")",3RD DIVISION,05 Oct 2022,DECISION
108,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1znGk8jnKhn_oo0mArcK58L75-_v9cX8T"", ""Superior General of the Religious of the Virgin Mary (R.V.M.) v. Republic"")",3RD DIVISION,05 Oct 2022,DECISION
109,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kRSjbLf5Dd_B4BqIZ8N4p082phSRmtc3"", ""Republic v. Robiegie Corporation"")",3RD DIVISION,03 Oct 2022,DECISION
110,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=146H3f_NI42NdHZeOdYp7Tjey3FBeDj19"", ""Galindez v. Salamanca-Guzman"")",3RD DIVISION,28 Sep 2022,DECISION
111,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1VoOfxs_iIFo7-H_rH-62C3rXWZfpv5Da"", ""Galbinez, Jr. v. McGerry's Restaurant"")",3RD DIVISION,28 Sep 2022,DECISION
112,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1qfDej2iPUz-mSrdbPD-R3LGk30oggSlF"", ""Systems Energizer Corporation v. Bellville Development"")",3RD DIVISION,21 Sep 2022,DECISION
113,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14VD0ML7DeSXLYUzQk4L3sRiA05O5x830"", ""People v. Sernadilla"")",3RD DIVISION,21 Sep 2022,DECISION
114,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1s2naj61nLqC7IzZgBYa-ds0BtjC-fXNU"", ""Heirs of Spouses Binay v. Banaag"")",3RD DIVISION,07 Sep 2022,DECISION
115,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=118ZKW8-7knjEe_zAbkRsgcZh5ThYpMoA"", ""PNB v. Tad-y"")",3RD DIVISION,07 Sep 2022,DECISION
116,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1cQlmo9PBdkYrM9QlLaf6x4eDMqP5lwzs"", ""Land Bank v. Spouses Cortez"")",3RD DIVISION,07 Sep 2022,DECISION
117,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1XPpyM1xW_2sfwrnIhSYTOxVmcxyVsMdY"", ""Estate of Williams v. Percy"")",3RD DIVISION,31 Aug 2022,DECISION
118,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1q0kxoCL3MHtjZP30U9AFCAEh1pTRks-1"", ""Estomo v. CSC-X"")",3RD DIVISION,31 Aug 2022,DECISION
119,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1o_h_qWBEAs4Jqpluepn8CzlZ7buY98Gl"", ""Alarilla v. Lorenzo"")",3RD DIVISION,31 Aug 2022,DECISION
120,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1FJu1BCgrl_QLEXppeqY00c0P-kui-mRD"", ""Calisay v. Atty. Esplana"")",3RD DIVISION,23 Aug 2022,DECISION
121,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LuyXFLJ3gygvC929dAT1DjkX5La2z3JB"", ""Sarion v. People"")",SPECIAL 1ST DIVISION,22 Aug 2022,RESOLUTION
122,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1JF-SQ_zA8CFSJvdC6iGU1iWz9hYLRT8R"", ""NGCP v. Gaite"")",3RD DIVISION,17 Aug 2022,DECISION
123,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LX1JKUQGYaaRxyCa3IXmEJU460dchk4D"", ""Cymar International, Inc. v. Farling Industrial"")",3RD DIVISION,17 Aug 2022,DECISION
124,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=19DX2liUaodY5_C-NQiomSaDwz1e1anKw"", ""Southstar Construction and Development v. Philippine Estates Corporation"")",3RD DIVISION,01 Aug 2022,DECISION
125,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1lEpqSYQP-73LVpXp3iAHyFgVFunW6NLl"", ""Spouses Vargas v. Sta. Lucia Realty and Development"")",3RD DIVISION,27 Jul 2022,DECISION
126,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1PrfN5EjKrEXVPMcWQRhS9kzBlnaGdQ3Z"", ""Hamid v. Gervasio Security and Investigation Agency"")",3RD DIVISION,27 Jul 2022,DECISION
127,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TOOU87JPbCvO97bsEZwNkwnfjSEsgUBY"", ""Malones v. People"")",3RD DIVISION,20 Jul 2022,DECISION
128,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1JB1O-gNUW2akaSaB8F8UylOwD9SkUPPA"", ""Amad v. Comelec"")",EN BANC,05 Jul 2022,DECISION
129,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kBaP8z-TiyERDTUPuunL70qcE7XSdlb4"", ""People v. Pimentel"")",3RD DIVISION,15 Jun 2022,DECISION
130,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1fv7iMpJ5mxCCELrvkOnpcPX4xXTSXgNd"", ""People v. BBB252214"")",EN BANC,14 Jun 2022,DECISION
131,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HliGNDGsXfORyDHa66Y7jW_MMKo2VTKB"", ""Republic v. Buenaventura"")",1ST DIVISION,05 Apr 2022,DECISION
132,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TsJ9rZk1M9KMYqHtJ_Y9YX-XHlKwL-xs"", ""Mangayan v. Atty. Robielos III"")",EN BANC,05 Apr 2022,DECISION
133,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1EPr-pWHWhic2gTyTrgbnqek3K4l2rSew"", ""Bollozos v. Heirs of Vda. de Aguilar"")",1ST DIVISION,29 Mar 2022,DECISION
134,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LZNc4zUiZ6bQ9QS8vxovOq3__HCWKgNS"", ""ABS-CBN v. Magno"")",1ST DIVISION,29 Mar 2022,DECISION
135,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14O7TZHyIVCp5qM7NcTWEKlAEurN5HUyu"", ""Cheng v. People"")",1ST DIVISION,23 Mar 2022,DECISION
136,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LicH4sZVYkiaYFRgjY0EJ1871WJQp0Zq"", ""Rural Bank of Candelaria (Zambales) v. Banluta"")",1ST DIVISION,23 Mar 2022,DECISION
137,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1bJlsFOUokViy9kuA5GnHI37eb6feu8BI"", ""Ombudsman v. Rodas"")",1ST DIVISION,23 Mar 2022,DECISION
138,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=19tkfOcwyi4UzIvpv3bM--z1UREzU1PIG"", ""People v. Cerezo"")",1ST DIVISION,15 Mar 2022,DECISION
139,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1nIoPlE_7tyNYyIvZHkR5R3P_qreZSfPv"", ""Metrobank v. Salazar Realty Corporation"")",1ST DIVISION,09 Mar 2022,DECISION
140,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1SOOmrQiz-x8Pepzz2mDWEInZSjM-_OEq"", ""People v. Ramoy"")",1ST DIVISION,09 Mar 2022,DECISION
141,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1pEJj1jtc83UUbHR-5LOaJMJokGjww1n9"", ""Valderas v. Sulse"")",1ST DIVISION,09 Mar 2022,DECISION
142,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1dNZlZvCBsW4d8Vab3GOniifV-BX3uPKb"", ""De Leon v. Asombrado-Llacuna"")",1ST DIVISION,02 Mar 2022,DECISION
143,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1umu_7vHqDuB_YfUdeFy4pbLfFirC1oXL"", ""Ombudsman v. Hermosura"")",2ND DIVISION,16 Feb 2022,DECISION
144,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1_KwJWCt-Cdx-cFDJXS4IU3ZLedgh6UAY"", ""People v. XXX254254"")",2ND DIVISION,16 Feb 2022,DECISION
145,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1XDuMg3yXY3XkDVYgZIUxwOaeegJVllPK"", ""Malate Construction Development v. Extraordinary Realty Agents & Brokers Cooperative"")",2ND DIVISION,05 Jan 2022,DECISION
146,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1dx9X3eNOTNdBFcx3LmhkOm1bs-RpqOPQ"", ""Saint Wealth Ltd. v. BIR"")",EN BANC,07 Dec 2021,DECISION
147,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1iD3NCsNx8Cos-Mi8u7ICXVsjV6LdeTEi"", ""Limcoma Labor Organization (LLO)-PLAC v. Limcoma Multi-purpose Coop. (Limcoma)"")",2ND DIVISION,29 Nov 2021,DECISION
148,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=16YBgG6Tx2py1iyDDCTn-EBEjOEVKY3Xc"", ""Acosta v. People"")",2ND DIVISION,24 Nov 2021,DECISION
149,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1SZXno-B4SjmUsCfChqbKMXXNhnMkzN-X"", ""Corpuz v. COA"")",EN BANC,23 Nov 2021,DECISION
150,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=17yUfMfW7M9NQu0DUzXR3CTZ_qY53Xpvy"", ""People v. Montilla"")",2ND DIVISION,22 Nov 2021,DECISION
151,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10zvOAro4aVfMoxan2wE8F7RUgD8f5PkG"", ""BW Shipping Philippines v. Ong"")",2ND DIVISION,17 Nov 2021,DECISION
152,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1W-QzhgkARkFnzJMpTKq3yeN70S05gajM"", ""Spouses Domasian v. Demdam"")",2ND DIVISION,17 Nov 2021,DECISION
153,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xQkX_q1GvS4P-i_uF5gjB4jAfrtnkTyI"", ""Bawasanta v. People"")",2ND DIVISION,17 Nov 2021,DECISION
154,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1vREnlglhHhMT8TkGwQOfSDwASjeMNTV6"", ""Coca-Cola FEMSA Philippines, Inc. v. Coca-Cola FEMSA Phils."")",2ND DIVISION,17 Nov 2021,DECISION
155,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1nh20n6jglFutqk2mLHeg3wK8XPmeGNWa"", ""Poeple v. Palabrica III"")",2ND DIVISION,17 Nov 2021,DECISION
156,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xsVkCtIM-4oi1V2e9N6luzar9nFg3Yx8"", ""Bernardo v. Dimaya"")",2ND DIVISION,10 Nov 2021,DECISION
157,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=19Ycp0OWrfgMpSh9kQ2KbueJJ1l0krF5a"", ""McConell Dowell Phil., Inc. v. Bernal"")",2ND DIVISION,10 Nov 2021,DECISION
158,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=16mz9DUULDOKa2BrNQ76sVRs7xcrPrNcE"", ""SBMA v. Subic Bay Marine Exploratorium"")",2ND DIVISION,10 Nov 2021,DECISION
159,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1EDqLvNksyvDWaHeEY1VKbk2zqx2C3oSR"", ""Padojinog v. Ombudsman"")",2ND DIVISION,13 Oct 2021,DECISION
160,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1bYouH89uWdAKHc1srCX_Qnivgd8-2oOd"", ""People v. Amara"")",2ND DIVISION,13 Oct 2021,DECISION
161,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1SpOTQ8cNgjDDTsqFTQYso3NfW-SGe8Av"", ""Gutierrez v. People"")",2ND DIVISION,13 Oct 2021,DECISION
162,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=15FqHpwb6okByscm_3WdR_Bl1WRQHUSRw"", ""Atty. Kayaban, Jr. v. Atty. Palicte, III"")",EN BANC,05 Oct 2021,DECISION
163,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1duqXEss3PU2Jy3H3IoWqPWBapA9yYkks"", ""Lucero v. Delfino"")",2ND DIVISION,29 Sep 2021,DECISION
164,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1pUeuF7vNvZQxyHdB15nG0RRfeUxwLQkq"", ""People v. Peralta"")",2ND DIVISION,29 Sep 2021,DECISION
165,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Vmw7nXePH7ITGMYyU_e47MFalNjfxjxz"", ""Berces v. CSC"")",2ND DIVISION,29 Sep 2021,DECISION
166,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1iQi-jru5PKzurMvoyoP9fSvCPxG0MmUC"", ""The Salvation Army v. SSS"")",2ND DIVISION,15 Sep 2021,DECISION
167,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1FIQiA_3tz_FUZULzUn_X3K-9DA4qZ4wC"", ""Lagao v. People"")",2ND DIVISION,15 Sep 2021,DECISION
168,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1q7XVdZM1SW6UE1CFI_OUO56SlkIThTks"", ""Joven v. Spouses Tulio"")",2ND DIVISION,04 Aug 2021,DECISION
169,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1FntSwk03JinVT6Un-os-mueXtYFFM__Y"", ""Quitalig v. Quitalig"")",2ND DIVISION,04 Aug 2021,DECISION
170,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1noxJq3AKloluUyfxQh86nFvGuCTsKNi8"", ""CF Sharp Crew Management v. Cunanan"")",2ND DIVISION,04 Aug 2021,DECISION
171,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1tOep_DR6Obq6kOzESfuAh_159QsU-ePm"", ""Anacay v. Atty. Alberto"")",2ND DIVISION,04 Aug 2021,DECISION
172,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10FgQ9rBFuj3l3hyOEUfNuhXgW1yGdPdJ"", ""Moreno v. Chateau Royale Sports and Country Club"")",2ND DIVISION,04 Aug 2021,DECISION
173,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1sbJKjxIaw9V6lCJhwRk9p3tIBhbJ7dFk"", ""Ebancuel v. Acierto"")",2ND DIVISION,28 Jul 2021,DECISION
174,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HEyoNVyvKMQ5jsRYfNjiL9dLNPS-p19D"", ""Secretary of DAR v. Mendoza"")",1ST DIVISION,14 Jul 2021,DECISION
175,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1OsNmUpTr13QucbogpDbbXA45gY4xwV4C"", ""People v. San Pedro"")",1ST DIVISION,14 Jul 2021,DECISION
176,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ojaXyih7ToedcR4mrafxuKD4JiyMCKZc"", ""Waterfront Philippines v. SSS"")",1ST DIVISION,06 Jul 2021,DECISION
177,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1AxIQ12avfzvv4uCnFeZWgxWYJcJThaMU"", ""People v. XXX218087"")",1ST DIVISION,06 Jul 2021,DECISION
178,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=149C_MdY6AKu7-FEGZ0s8LubCvvL4KQPP"", ""BSM Crew Service Centre Phils., Inc. v. Llanita"")",1ST DIVISION,06 Jul 2021,DECISION
179,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LoR1ZAYK5L0xDcNnfgIHR4sE91bTefF1"", ""Crown Shipping Services v. Cervas"")",1ST DIVISION,06 Jul 2021,DECISION
180,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1YwtWkGUSbTesAR5-QOaZYpG1mlK1L7GE"", ""Imperial v. People"")",1ST DIVISION,30 Jun 2021,DECISION
181,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=11ZpKVc3z0a0wsCUpGPANsm-EgkBhSCak"", ""PLDT v. Domingo"")",1ST DIVISION,30 Jun 2021,DECISION
182,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kevVFzjV6i7RJxEfv9xKi_Te3GHKScLK"", ""Ambrose v. Suque-Ambrose"")",1ST DIVISION,23 Jun 2021,DECISION
183,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=14uWqoAzZxGZy7Ww6b2F4MtHOGoZxrna1"", ""Atienza v. TKC Heavy Industries Corporation"")",1ST DIVISION,23 Jun 2021,DECISION
184,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wzRZhWriYFSw7dhQfZST538ZvxClTIWj"", ""Almazan v. Bacolod"")",1ST DIVISION,16 Jun 2021,DECISION
185,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1LUwRjUjkeF0Bbzo4GRTuOFz6yz61lBau"", ""BSP v. Ombudsman"")",1ST DIVISION,16 Jun 2021,DECISION
186,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Jh4DOVld81N9pSp3ba40Kqne1pO-G-rv"", ""Authority of the Freeport Area of Bataan v. F.F. Cruz & Co., Inc."")",1ST DIVISION,14 May 2021,DECISION
187,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=12E5dUrxDCzCvUP8o_ZBh1uT7mSiSdTtj"", ""Paga v. Judge Paderanga"")",1ST DIVISION,05 May 2021,RESOLUTION
188,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1drIG8hIvpsHozgvoTGouhzwrUc09-2Ub"", ""De Joya v. Madlangbayan"")",1ST DIVISION,28 Apr 2021,DECISION
189,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ePI82jkRAOrd_RoONmQiy0K8_y5hJrF_"", ""Figueroa v. COA"")",EN BANC,27 Apr 2021,DECISION
190,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1woOyp0kXfj7qYRaaZKNw8qimpc7CrWQ2"", ""Cagayan de Oro Water District v. COA"")",EN BANC,27 Apr 2021,DECISION
191,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Mam4naWUzGY9CeqBTi56vHPZkOJS2v4P"", ""People v. Toledo"")",1ST DIVISION,24 Mar 2021,DECISION
192,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1txaTE0ykrBxu2Kf59-d40q6Ig1R1Q8EV"", ""Feliciano v. People"")",1ST DIVISION,18 Mar 2021,DECISION
193,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1-yykpSAUZa0bTDF-oMBcUX7bZjKKiKlU"", ""Philippine Transmarine Carriers v. Manzano"")",1ST DIVISION,18 Mar 2021,DECISION
194,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1OHOAfrWcHxA7XB9wkh_veX8plOpdhXH2"", ""Sarion v. People"")",1ST DIVISION,18 Mar 2021,DECISION
195,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1hZ-pMLb0sH3OIYv3A2vxF3bJWpsEHg8Q"", ""Toston v. People"")",1ST DIVISION,03 Mar 2021,DECISION
196,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1SpXLXjmJTvRe4Yk4F9SvVg5El3OwlzmK"", ""People v. Coritana"")",1ST DIVISION,03 Mar 2021,DECISION
197,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=18JBJuGwBUOfGcmzQTojEYNkcIL03m_F7"", ""Quisumbing v. Ochoa"")",1ST DIVISION,03 Mar 2021,DECISION
198,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1K4nCsVe5wHnJCry8EkqlbDETyWGzqC3r"", ""Toyo Seat Philippines v. Velasco"")",1ST DIVISION,03 Mar 2021,DECISION
199,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=18F8CIPRN03ANCM6A60X_g3YQ6He9sqXQ"", ""Emzee Foods, Inc. v. Elarfoods, Inc."")",1ST DIVISION,17 Feb 2021,DECISION
200,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1mmrafYdgSO4fXLB-kcipN4T2zIjbuT7s"", ""PNB v. Oaminal"")",1ST DIVISION,17 Feb 2021,DECISION
201,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1q9TGEFzAr6pj8ckZIlwZc32NVQ59OCNr"", ""Republic v. Asuncion"")",1ST DIVISION,17 Feb 2021,DECISION
202,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1BrY8quSI5_-uE7QwFgPX_QfyhT09787Y"", ""Quijano v. People"")",1ST DIVISION,10 Feb 2021,DECISION
203,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1mDV0mY65LtQxo65Dpx7v9EDUbNvOceCR"", ""Banta v. Equitable Bank, Inc."")",1ST DIVISION,10 Feb 2021,DECISION
204,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wBqAQXHRLS1ZvMx6QhXYw5ReM3wAwLj1"", ""Torm Shipping Philippines, Inc. v. Alacre"")",1ST DIVISION,26 Jan 2021,DECISION
205,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1tWafLeUF0qrz-F8HSp5RRG-unpJZjXKQ"", ""Yambao v. Republic"")",1ST DIVISION,26 Jan 2021,DECISION
206,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1_5_TnG5b9-aSskfrcvUVKeb9SSOh9A2k"", ""Bernasconi v. Atty. Demaisip"")",EN BANC,19 Jan 2021,DECISION
207,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TM8m-riVFkkDJoRyOmzhnkFyjaAQWM7m"", ""Metrobank v. Cruz"")",1ST DIVISION,19 Jan 2021,DECISION
208,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1fKaEvwpf7dzf2ZClrmW3uzYlDbzOzqEJ"", ""Balina v. People"")",1ST DIVISION,12 Jan 2021,DECISION
209,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1vT0WTd3Sxh3LVMfMWhUnd78SznggsTQ1"", ""Philippine Phosphate Fertilizer Corporation v. Mayol"")",1ST DIVISION,09 Dec 2020,DECISION
210,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1c3Xr8as2IGQ8t0XPQqXSDpUAam9D1CDX"", ""International Container Terminal Services, Inc. v. Ang"")",1ST DIVISION,09 Dec 2020,DECISION
211,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10DdX66nICqlV0ZTwS5FF6CGHSN2yb83U"", ""Municipality of Isabel, Leyte v. Municipality of Merida, Leyte"")",1ST DIVISION,09 Dec 2020,DECISION
212,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=19O5E5v83odDRlfTnwSjckYc0u7k6QdqC"", ""Menzon v. COA"")",EN BANC,09 Dec 2020,DECISION
213,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1F-wxoaj6GewKyI4zR9UkvmSTDQ9ICBP7"", ""OCA v. Judge Atienza-Turla"")",EN BANC,09 Dec 2020,DECISION
214,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Okoqcd7JItJJZ5elpLr-mRAyewQZDjet"", ""Paez v. Marinduque Electric Cooperative, Inc."")",1ST DIVISION,09 Dec 2020,DECISION
215,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1w5tvq2gX-XedJKG3gBh8pNUDY79YvDrm"", ""Crisologo v. Hao"")",1ST DIVISION,02 Dec 2020,DECISION
216,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1DOrrXIajaeBIco1ZULzXL9RaHFuttVn8"", ""People v. Barrera"")",EN BANC,01 Dec 2020,DECISION
217,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Faijw5tqOjNaomhzgdE5YOt2fQERDDV1"", ""OSG Shipmanagement Manila, Inc. v. De Jesus"")",1ST DIVISION,18 Nov 2020,DECISION
218,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xx4sacOE5DVPqarB8wOw_dsv6o8n3mL8"", ""POEA v. COA"")",EN BANC,17 Nov 2020,DECISION
219,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=16nnf_H6qtSaQQCh2TRG590MKZXRZkkNt"", ""Ombudsman v. Rondon"")",1ST DIVISION,10 Nov 2020,DECISION
220,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1i9F0M9YrUH9PtuKeYd1-lRlnU3T19z4q"", ""Torreta v. COA"")",EN BANC,10 Nov 2020,DECISION
221,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1wGIDmN5i5vBHkOn0ijY1-b8eBR91jfWZ"", ""AFP v. Amogod"")",IST DIVISION,10 Nov 2020,DECISION
222,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10-7RVuRGEjqnmNDMsOrYVv7iUENMwYK3"", ""UEM Mara Philippines v. Wee"")",3RD DIVISION,14 Oct 2020,DECISION
223,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1OpaIqUXXB8Gxe01I_BVAw6ANwacPDLCK"", ""Philconstruct Resources, Inc. v. Aquino"")",3RD DIVISION,07 Oct 2020,DECISION
224,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1m1YlDIWdE5oN6ehB56r4JjUO5bTWMWWx"", ""People v. Loma"")",3RD DIVISION,05 Oct 2020,DECISION
225,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1kyd-U6i8KEj2KKOdLrMsGdcEpxHSW7PK"", ""Salas v. Bunyi-Medina"")",3RD DIVISION,28 Sep 2020,DECISION
226,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1K-yptjknkVS2yeSwnrqYThxLzTgeiVdu"", ""Land Bank v. Hilado"")",3RD DIVISION,23 Sep 2020,DECISION
227,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1xTl2fYsr-VxdzS2PclNAyR70Qtf-Qbwx"", ""Land Bank v. Esteban"")",3RD DIVISION,23 Sep 2020,DECISION
228,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1NQ5jvY1LzvmoVi19bVqFDmjwPo_0hPaR"", ""De Castro v. COA"")",EN BANC,22 Sep 2020,DECISION
229,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=10Db0SxmTAsPjTL5OvZZyAVsVgRU0LTWx"", ""People v. Archivido"")",3RD DIVISION,21 Sep 2020,DECISION
230,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1z3WW7e-8mbf6ZQ1VerAaBd9EQ-KjXTzq"", ""Balbarino v. Pacific Ocean Manning, Inc."")",3RD DIVISION,21 Sep 2020,DECISION
231,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1AzFQl7j1DKE3WHprNEVmOZzqt4os55C7"", ""Ingram v. Atty. Lorica IV"")",3RD DIVISION,16 Sep 2020,DECISION
232,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Uba3bbyPsjJD7FqMKDhRFzYZGzLlKHcb"", ""Judge Ramos v. Atty. Lazo"")",3RD DIVISION,14 Sep 2020,DECISION
233,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1-uQE0DSBCoPzP0mvboZoElaNRNwS7naf"", ""Santos v. V.C. Development Corporation"")",3RD DIVISION,09 Sep 2020,DECISION
234,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1qB_UGs571VUb2Tt3rONWzMJlxKT1y4r_"", ""Sismaet v. Atty. Cruzabra"")",3RD DIVISION,07 Sep 2020,DECISION
235,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1zj8VGt1RCwNl-AVtIMmwOQWcNZreeh4n"", ""IP E-Game Ventures, Inc. v. Beijing Perfect World Software Co., Ltd."")",3RD DIVISION,07 Sep 2020,DECISION
236,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1cl_TOy6fx9xXHcgknj9A0dCmAgOzF5lZ"", ""Unirock Corporation v. CA"")",3RD DIVISION,07 Sep 2020,DECISION
237,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TS1T4NMhvtj2SADJ2psDPI1xziwLnrTF"", ""DBP v. Ronquillo"")",3RD DIVISION,07 Sep 2020,DECISION
238,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1YjXQkICJRb5s7gVDz8h3cb9lpy4P6Rs1"", ""Sierra Grande Realty Corporation v. Ragasa"")",3RD DIVISION,02 Sep 2020,DECISION
239,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1GrsE8XlyrVU_7pkJKlTN86BGgG_wafVA"", ""Reyes v. Elquiero"")",3RD DIVISION,02 Sep 2020,DECISION
240,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ddqPLP2K27HZtIYDJxVz0Hhx0O3MB8fC"", ""Bahia Shipping Services, Inc. v. Castillo"")",3RD DIVISION,02 Sep 2020,DECISION
241,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Zu-YW6FOJA9SPgTnRc3mT7TICnoZww8m"", ""Realiza v. People"")",3RD DIVISION,26 Aug 2020,DECISION
242,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1FKDtd14zLgyZg_wZRIfJKDOz3Q-KFARz"", ""People v. Lopez"")",3RD DIVISION,15 Jul 2020,DECISION
243,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1P0ksToma9IHxDASPr2VWOm4ZnTxVsZJi"", ""Dayandayan v. Spouses Rojas"")",3RD DIVISION,15 Jul 2020,DECISION
244,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1TCtlR1xI3Syuwqwt225RGaUE2Z4LVUx5"", ""People v. Tamano"")",3RD DIVISION,08 Jul 2020,DECISION
245,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1lztM89ze79HrUSApZObYo6biYWG2iipT"", ""Basagan v. Atty. Espina"")",3RD DIVISION,08 Jul 2020,DECISION
246,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Prgh4lsP2sg7dw4cegjdpVhSiN7Ul5V9"", ""Heirs of Torrices v. Atty. Galano"")",EN BANC,07 Jul 2020,RESOLUTION
247,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1R3tRSeTVVrK_btfSF7t1dgRo2CCfiuGo"", ""Dela Cruz v. Parumog"")",3RD DIVISION,17 Jun 2020,DECISION
248,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1ADvVPH4wJTKWvcPpOJmNMqb1_njGKq5Q"", ""Land Bank v. Catadman"")",3RD DIVISION,17 Jun 2020,DECISION
249,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1DskWi7XSOr684Q9LKrkJSeWAhwoibjGp"", ""BPI Family Savings Bank, Inc. v. Spouses Soriano"")",3RD DIVISION,08 Jun 2020,DECISION
250,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1Oyq47o3cALF4r_J0xSYKHfgYlO0Aalv6"", ""People v. Manzanilla"")",3RD DIVISION,08 Jun 2020,DECISION
251,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1HTxu8Uc_ulxUm769jXk9yA3mlbkhx7F5"", ""Nacarion v. People"")",3RD DIVISION,08 Jun 2020,DECISION
252,"=HYPERLINK(""https://drive.google.com/uc?export=download&id=1MvqgS2-Z29UbY7oe19gsa3sMtiZd4Cqw"", ""Violago v. Atty. Aranjuez, Jr."")",3RD DIVISION,09 Mar 2020,RESOLUTION`;

       // APP STATE
       let allCases = [];
       let sortConfig = { column: 0, direction: 'asc' }; // default sort by No.
       const STORAGE_KEY = 'gaerlan_tracker_v1';
 
       // Load Data from Storage
       function getStorageData() {
           return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
       }
 
       // Save Data to Storage
function updateStorage(caseId, field, value) {
           const data = getStorageData();
           if (!data[caseId]) data[caseId] = {};
           data[caseId][field] = value;
           
           // IMPROVED: Track case check/uncheck
           if (field === 'done') window.trackActivity(value); 

           localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
           updateStats();
           updateLastSaved();
       }
 
       // Initial Data Parse
       async function init() { // Added 'async'
           const lines = csvData.trim().split('\n');
           let savedData = getStorageData();
           allCases = [];

           // --- NEW: PRELOAD FROM GITHUB ---
           // Only preload if the user's local storage is empty to avoid overwriting their edits
           if (Object.keys(savedData).length === 0) {
               try {
const response = await fetch('https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/data.json');
                   if (response.ok) {
                       const preloadedData = await response.json();
                       localStorage.setItem(STORAGE_KEY, JSON.stringify(preloadedData));
                       savedData = preloadedData;
                       console.log("Digests preloaded from GitHub.");
                   }
               } catch (err) {
                   console.error("Could not load preload file:", err);
               }
           }
 
for (let i = 1; i < lines.length; i++) {
    const row = lines[i].trim();
    if (!row) continue;

    // Proper CSV parser that respects quotes and inner commas
    const fields = [];
    let current = '';
    let inQuote = false;
    for (let j = 0; j < row.length; j++) {
        const char = row[j];
        if (char === '"' && !inQuote) {
            inQuote = true;
        } else if (char === '"' && inQuote) {
            if (j + 1 < row.length && row[j + 1] === '"') {
                current += '"';
                j++;
            } else {
                inQuote = false;
            }
        } else if (char === ',' && !inQuote) {
            fields.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    fields.push(current.trim());

    const [no, rawLink, division, date, type] = fields;

    let url = "#", title = rawLink || '';
    const match = rawLink.match(/=HYPERLINK\("([^"]+)"\s*,\s*"([^"]+)"\)/i);
    if (match) {
        url = match[1];
        title = match[2];
    }

    allCases.push({no, title, division, date, type, url});
}           
           lucide.createIcons();
           renderTable();
           updateStats();
       }
 
// NOTEPAD PERSISTENCE (ADD THIS BLOCK) 
const NOTEPAD_KEY = '2026_bar_review_notes';

// Function to wait for an element to appear in the DOM (polls every 100ms, up to 10 seconds)
function waitForElement(selector, callback, timeout = 10000, interval = 100) {
    const startTime = Date.now();
    const checkExist = setInterval(() => {
        const element = document.querySelector(selector);
        if (element) {
            clearInterval(checkExist);
            callback(element);
        } else if (Date.now() - startTime > timeout) {
            clearInterval(checkExist);
            console.warn(`Element ${selector} not found after ${timeout}ms`);
        }
    }, interval);
}

// Use the waiter to load and attach listeners once #review-notes exists
waitForElement('#review-notes', (reviewNotes) => {
    // 1. Load saved note
    const saved = localStorage.getItem(NOTEPAD_KEY);
    if (saved !== null) {
        reviewNotes.value = saved;
    }

    // 2. Save automatically while typing (debounced)
    let notepadTimeout;
    reviewNotes.addEventListener('input', (e) => {
        clearTimeout(notepadTimeout);
        notepadTimeout = setTimeout(() => {
            localStorage.setItem(NOTEPAD_KEY, e.target.value);
        }, 400); // Saves 400ms after typing stops
    });

    // 3. Save on blur (extra safety, e.g., when clicking away)
    reviewNotes.addEventListener('blur', (e) => {
        localStorage.setItem(NOTEPAD_KEY, e.target.value);
    });
});

       // RENDER TABLE
       function renderTable() {
           const tbody = document.getElementById('caseTableBody');
           const savedData = getStorageData();
           const searchTerm = document.getElementById('searchInput').value.toLowerCase();
           const filterDiv = document.getElementById('filterDivision').value;
           const filterType = document.getElementById('filterType').value;
 
           // 1. Filter
           let filteredCases = allCases.filter(c => {
               const matchesSearch = c.title.toLowerCase().includes(searchTerm) ||
                                     c.no.includes(searchTerm) ||
                                     c.date.toLowerCase().includes(searchTerm);
               const matchesDiv = filterDiv === "" || c.division === filterDiv;
               const matchesType = filterType === "" || c.type === filterType;
               
               return matchesSearch && matchesDiv && matchesType;
           });
 
           document.getElementById('visibleCount').innerText = filteredCases.length;
 
           // 2. Sort
           filteredCases.sort((a, b) => {
               let valA, valB;
               
               if (sortConfig.column === 0) { // No.
                   valA = parseInt(a.no); valB = parseInt(b.no);
               } else if (sortConfig.column === 1) { // Title
                   valA = a.title.toLowerCase(); valB = b.title.toLowerCase();
               } else if (sortConfig.column === 2) { // Division
                   valA = a.division.toLowerCase(); valB = b.division.toLowerCase();
               } else if (sortConfig.column === 3) { // Date
                   valA = new Date(a.date); valB = new Date(b.date);
               } else if (sortConfig.column === 4) { // Type
                   valA = a.type.toLowerCase(); valB = b.type.toLowerCase();
               }
 
               if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
               if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
               return 0;
           });
 
           // 3. Render HTML
           let html = '';
           filteredCases.forEach(c => {
               const caseState = savedData[c.no] || {};
               const digestExists = caseState.digest && (caseState.digest.doctrine || caseState.digest.facts || caseState.digest.issue || caseState.digest.ruling);
               
               // Division Color Logic
               let divBadgeClass = "bg-gray-100 text-gray-600";
               if (c.division.includes("EN BANC")) divBadgeClass = "bg-red-100 text-red-800 border border-red-200";
               else if (c.division.includes("1ST")) divBadgeClass = "bg-blue-100 text-blue-800 border border-blue-200";
               else if (c.division.includes("2ND")) divBadgeClass = "bg-teal-100 text-teal-800 border border-teal-200";
               else if (c.division.includes("3RD")) divBadgeClass = "bg-orange-100 text-orange-800 border border-orange-200";
 
               // Type Color Logic
               const isDecision = c.type.toUpperCase().includes('DECISION');
               const typeBadgeClass = isDecision ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
               
               // Digest Button Logic
               const digestBtnClass = digestExists ? 'bg-emerald-500 text-white shadow-md hover:bg-emerald-600' : 'bg-white text-gray-500 border border-gray-200 hover:border-[var(--theme-secondary)] hover:text-[var(--theme-primary)]';
               const digestIcon = digestExists ? 'check' : 'plus';
               const digestText = digestExists ? 'View' : 'Add';
 
html += `
<tr class="hover:bg-gray-200 transition-colors group border-b border-gray-50 last:border-b-0">
    <td class="px-2 py-0.5 font-medium text-gray-400 text-[9px]">${c.no}</td>
    <td class="px-3 py-0.5">
        <a href="${c.url}" target="_blank" class="text-blue-700 hover:text-black font-bold text-sm block leading-tight group-hover:underline">
            ${c.title}
        </a>
    </td>
    <td class="px-3 py-0.5 text-center">
        <span class="px-2 py-0.5 inline-flex text-[10px] font-bold uppercase rounded-md tracking-wider ${divBadgeClass}">${c.division}</span>
    </td>
    <td class="px-3 py-0.5 text-center text-xs text-gray-500 whitespace-nowrap font-medium">${c.date}</td>
    <td class="px-3 py-0.5 text-center">
        <span class="px-2 py-0.5 inline-flex text-[10px] font-bold uppercase rounded-md tracking-wider ${typeBadgeClass}">${c.type}</span>
    </td>
    <td class="px-3 py-0.5 text-center">
        <button onclick="openDigestModal('${c.no}', '${c.title.replace(/'/g, "\\'")}')"
                id="btn-digest-${c.no}"
                class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide transition-all ${digestBtnClass}">
            <i data-lucide="${digestIcon}" class="w-3 h-3"></i> ${digestText}
        </button>
    </td>
    <td class="px-3 py-0.5 text-center">
        <div class="flex justify-center">
            <input type="checkbox" class="custom-checkbox w-4 h-4"
                   onchange="updateStorage('${c.no}', 'done', this.checked)"
                   ${caseState.done ? 'checked' : ''}>
        </div>
    </td>
</tr>`;
           });
           

           tbody.innerHTML = html;
           lucide.createIcons();
       }
 
       // --- SORTING ---
function sortTable(columnIndex, type) {
    // Toggle direction if clicking same column
    if (sortConfig.column === columnIndex) {
        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortConfig.column = columnIndex;
        sortConfig.direction = 'asc';
    }
    
    // Explicitly call renderTable to redraw the rows in new order
    renderTable();
    
    // Refresh icons since new rows were injected
    if (window.lucide) lucide.createIcons();
}
 
       // --- FILTER ---
function filterTable() {
    renderTable();
    // Reset the "Check All" box when filtering
    document.getElementById('checkAll').checked = false;
}

// --- TOGGLE ALL ---
function toggleAll(masterCheckbox) {
    const isChecked = masterCheckbox.checked;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterDiv = document.getElementById('filterDivision').value;
    const filterType = document.getElementById('filterType').value;

    // Filter allCases using the same logic as renderTable to get currently visible IDs
    allCases.forEach(c => {
        const matchesSearch = c.title.toLowerCase().includes(searchTerm) ||
                              c.no.includes(searchTerm) ||
                              c.date.toLowerCase().includes(searchTerm);
        const matchesDiv = filterDiv === "" || c.division === filterDiv;
        const matchesType = filterType === "" || c.type === filterType;

        if (matchesSearch && matchesDiv && matchesType) {
            updateStorage(c.no, 'done', isChecked);
        }
    });

    renderTable(); // Refresh the UI
updateLastSaved();
} 
// START EDITING HERE: CLEAN UP updateStats
function updateStats() {
    const data = getStorageData();
    const total = allCases.length;
    let done = 0;
    Object.values(data).forEach(c => { if(c.done) done++; });
    const remaining = total - done;
    const donePercent = total > 0 ? (done / total) * 100 : 0;

    // 1. Update the sidebar/mini bar (if it exists)
    const caseBar = document.getElementById('caseProgressBar');
    if (caseBar) {
        caseBar.style.width = `${donePercent}%`;
        // Reset classes first
        caseBar.classList.remove('bg-black', 'bg-red-500', 'bg-orange-500', 'bg-yellow-400', 'bg-green-500');
        
        // Apply progressive colors
        if (donePercent <= 25) caseBar.classList.add('bg-red-500');
        else if (donePercent <= 50) caseBar.classList.add('bg-orange-500');
        else if (donePercent <= 75) caseBar.classList.add('bg-yellow-400');
        else caseBar.classList.add('bg-green-500');
    }

    // 2. Update the Large Header Progress Bar (inside the Gaerlan section)
    const headerBar = document.getElementById('headerProgressBar');
    if (headerBar) {
        headerBar.style.width = `${donePercent}%`;
        headerBar.classList.remove('bg-white', 'bg-red-500', 'bg-orange-500', 'bg-yellow-400', 'bg-green-500');
        
        if (donePercent <= 25) headerBar.classList.add('bg-red-500');
        else if (donePercent <= 50) headerBar.classList.add('bg-orange-500');
        else if (donePercent <= 75) headerBar.classList.add('bg-yellow-400');
        else headerBar.classList.add('bg-green-500');
    }

// 3. Update Text Labels
    if (document.getElementById('caseCountText')) {
        // Calculate the "To Read" stats first
        const toReadPercent = (100 - donePercent).toFixed(1);
        const toReadCount = total - done;

        // Apply the new creative layout
        document.getElementById('caseCountText').innerText = 
            `${donePercent.toFixed(1)}% DONE â€¢ ${done} CASES READ | ${toReadPercent}% REMAINING â€¢ ${toReadCount} TO READ`;
    }

    if (document.getElementById('casePercentText')) document.getElementById('casePercentText').innerText = `${donePercent.toFixed(1)}%`;
    if (document.getElementById('headerDone')) document.getElementById('headerDone').innerText = done;
    if (document.getElementById('headerRemaining')) document.getElementById('headerRemaining').innerText = remaining;
    if (document.getElementById('headerPercent')) document.getElementById('headerPercent').innerText = `${donePercent.toFixed(1)}%`;
}
       // --- MODAL LOGIC ---
// Start editing here
function openDigestModal(id, title) {
    const data = getStorageData();
    const caseState = data[id] || {}; 
    const caseData = caseState.digest || {}; 
    const caseInfo = allCases.find(c => c.no === id);

    document.getElementById('currentCaseId').value = id;
    
    let titleEl = document.getElementById('modalCaseTitle');
    if (titleEl) titleEl.innerText = title;

    // 1. Set the values first
    document.getElementById('noteGRNo').value = caseData.grNo || '';
    document.getElementById('noteCaseDate').value = caseInfo ? caseInfo.date : '';
    document.getElementById('noteDivision').value = caseInfo ? caseInfo.division : '';
    
    // 2. Define the elements correctly
    const doctrine = document.getElementById('noteDoctrine');
    const facts = document.getElementById('noteFacts');
    const issue = document.getElementById('noteIssue');
    const ruling = document.getElementById('noteRuling');
    const dispositive = document.getElementById('noteDispositive');

    doctrine.value = caseData.doctrine || '';
    facts.value = caseData.facts || '';
    issue.value = caseData.issue || '';
    ruling.value = caseData.ruling || '';
    dispositive.value = caseData.dispositive || '';

    // 3. Show the modal
    const modal = document.getElementById('digestModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // 4. Trigger the expansion logic safely
    const textareas = [doctrine, facts, issue, ruling, dispositive];
    textareas.forEach(el => {
        if (el) {
            autoExpandTextarea(el);
            if (!el.getAttribute('data-expand-bound')) {
                el.addEventListener('input', () => autoExpandTextarea(el));
                el.setAttribute('data-expand-bound', 'true');
            }
        }
    });
    
    setTimeout(() => {
        modal.firstElementChild.classList.remove('scale-95');
        modal.firstElementChild.classList.add('scale-100');
    }, 10);
}
// End editing here
 
       function closeModal() {
           const modal = document.getElementById('digestModal');
           modal.firstElementChild.classList.remove('scale-100');
           modal.firstElementChild.classList.add('scale-95');
           setTimeout(() => {
               modal.classList.add('hidden');
               modal.classList.remove('flex');
           }, 300);
       }
 
// Start editing here
function saveDigest() {
    const id = document.getElementById('currentCaseId').value;
    if (!id) return;

    const digest = {
        grNo: document.getElementById('noteGRNo').value,
        dateText: document.getElementById('noteCaseDate').value,
        doctrine: document.getElementById('noteDoctrine').value,
        facts: document.getElementById('noteFacts').value,
        issue: document.getElementById('noteIssue').value,
        ruling: document.getElementById('noteRuling').value,
        dispositive: document.getElementById('noteDispositive').value
    };
    
    updateStorage(id, 'digest', digest);
    renderTable(); 
    closeModal();
    updateLastSaved();
}
// End editing here

// --- EXPORT TO WORD LOGIC ---
// Start editing here
async function generateDocx(casesToExport, fileName) {
    const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel, PageBreak } = docx;
    const children = [];
    const storageData = getStorageData();

    casesToExport.forEach((c, index) => {
        const data = storageData[c.no]?.digest || null;

        // 1. UPDATED HEADER: Includes G.R. No. and separates the Date
        children.push(new Paragraph({ text: c.title.toUpperCase(), heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }));
        children.push(new Paragraph({ 
            text: `G.R. No. ${data?.grNo || 'N/A'} | Date: ${data?.dateText || c.date}`, 
            alignment: AlignmentType.CENTER, 
            spacing: { after: 400 } 
        }));

        // 2. UPDATED SECTIONS: Added DISPOSITIVE PORTION
        const sections = [
            { label: "DOCTRINE / SYLLABUS", text: data?.doctrine },
            { label: "FACTS", text: data?.facts },
            { label: "ISSUE/S", text: data?.issue },
            { label: "RULING", text: data?.ruling },
            { label: "DISPOSITIVE PORTION", text: data?.dispositive, isFallo: true }
        ];

        sections.forEach(s => {
            children.push(new Paragraph({ 
                children: [new TextRun({ text: s.label, bold: true, underline: {} })], 
                spacing: { before: 200 } 
            }));

            // Logic to prevent "double content" error and format Fallo
            const contentText = s.text ? (s.isFallo ? s.text.toUpperCase() : s.text) : "No digest content provided.";
            
            children.push(new Paragraph({ 
                children: [
                    new TextRun({ 
                        text: s.isFallo ? contentText : `- ${contentText}`, 
                        bold: s.isFallo 
                    })
                ],
                alignment: AlignmentType.JUSTIFIED,
                spacing: { after: 200 }
            }));
        });

        if (index < casesToExport.length - 1) {
            children.push(new Paragraph({ children: [new PageBreak()] }));
        }
    });

    const doc = new Document({ sections: [{ properties: {}, children: children }] });
    Packer.toBlob(doc).then(blob => saveAs(blob, fileName));
}

function exportSingleDigest() {
    const id = document.getElementById('currentCaseId').value;
    const caseObj = allCases.find(c => c.no === id);
    // Format: CaseTitle_Date.docx (removing special characters for safety)
    const safeTitle = caseObj.title.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
    const safeDate = caseObj.date.replace(/[^a-z0-9]/gi, '_');
    generateDocx([caseObj], `${safeTitle}_${safeDate}.docx`);
}

function exportAllDigests() {
    // Fixed name for the bulk export
    generateDocx(allCases, "2026_Gaerlan_Cases.docx");
}
// --- IMPORT LOGIC (JSON Backup) ---
function triggerImport() { document.getElementById('importInput').click(); }

// Start editing here
function importDigests(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            const currentData = getStorageData();
            
            // Merge logic: This combines your current work with the imported file
            const mergedData = { ...currentData, ...importedData };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedData));
            
            alert("Digests imported successfully!");
            
            // Re-sync the modal if it's currently being viewed
            const openId = document.getElementById('currentCaseId').value;
            if(openId) {
                const updatedCase = mergedData[openId]?.digest || {};
                document.getElementById('noteGRNo').value = updatedCase.grNo || '';
                document.getElementById('noteCaseDate').value = updatedCase.dateText || '';
                document.getElementById('noteDoctrine').value = updatedCase.doctrine || '';
                document.getElementById('noteFacts').value = updatedCase.facts || '';
                document.getElementById('noteIssue').value = updatedCase.issue || '';
                document.getElementById('noteRuling').value = updatedCase.ruling || '';
                document.getElementById('noteDispositive').value = updatedCase.dispositive || '';
            }
            renderTable();
            updateStats();
updateLastSaved();
} catch (err) { 
    window.showThemedModal({
        title: 'IMPORT ERROR',
        message: 'INVALID FILE FORMAT. PLEASE USE A .JSON BACKUP FILE.'
    });
}
    };
    reader.readAsText(file);
}

// End editing here

// Replace the start of preloadLatestDigests:
async function preloadLatestDigests() {
    window.showThemedModal({
        title: 'PRELOAD DIGESTS',
        message: 'THIS WILL OVERWRITE CURRENT DIGESTS WITH THE LATEST DATA FROM THE REPO. PROCEED?',
        type: 'confirm',
        confirmText: 'OVERWRITE',
        cancelText: 'CANCEL',
        onConfirm: async () => {
            try {
                const response = await fetch('https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/data.json');
                if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
                
                const preloadedData = await response.json();
                
                // Save to Local Storage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(preloadedData));
                
                // Refresh the UI
                renderTable();
                updateStats();
                updateLastSaved();
                
                window.showThemedModal({ 
                    title: 'SUCCESS', 
                    message: 'LATEST DIGESTS HAVE BEEN SUCCESSFULLY LOADED FROM THE REPO!' 
                });
            } catch (err) {
                console.error("Preload failed:", err);
                window.showThemedModal({ 
                    title: 'ERROR', 
                    message: 'FAILED TO SYNC WITH REPO. PLEASE CHECK YOUR INTERNET CONNECTION.' 
                });
            }
        }
    });
}

// Quick clickable date picker - pops up right on the card!
document.querySelectorAll('.date-display-wrapper').forEach(wrapper => {
    const id = wrapper.id.split('-').pop(); // gets 1, 2, or 3
    const picker = wrapper.querySelector('input[type="date"]');
    const text = wrapper.querySelector('.date-text');

    // Load saved date and display it
    const saved = localStorage.getItem(`comp_exam_date_${id}`) || COUNTDOWN_DATA.find(d => d.id == id).targetDate;
    text.textContent = formatUniqueDate(saved);
    picker.value = saved;

    // Click anywhere on the card â†’ open picker right there
    wrapper.addEventListener('click', () => {
        picker.showPicker ? picker.showPicker() : picker.focus();
    });

    // When user picks a date â†’ save + update everything
    picker.addEventListener('change', () => {
        const newDate = picker.value;
        if (!newDate) return;

        const today = new Date();
        today.setHours(0,0,0,0);
if (new Date(newDate) < today) {
    window.showThemedModal({
        title: 'INVALID DATE',
        message: 'PLEASE SELECT A FUTURE DATE FOR YOUR EXAM COUNTDOWN.'
    });
    picker.value = saved;
    return;
}

        // Save
        localStorage.setItem(`comp_exam_date_${id}`, newDate);
        COUNTDOWN_DATA.find(d => d.id == id).targetDate = newDate;

        // Update display
        text.textContent = formatUniqueDate(newDate);

        // Refresh everything
        updateAllCountdowns();
        updateScheduleTable();
        if (window.CALENDAR_APP && window.CALENDAR_APP.refreshCalendar) {
            window.CALENDAR_APP.refreshCalendar();
        }
    });
});

function updateLastSaved() {
    const now = new Date().toLocaleString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true
    });
    localStorage.setItem('last_saved', now);
    const el = document.getElementById('last-saved');
    if (el) {
        el.textContent = `â€¢ Last saved: ${now} â€¢`;
        // Trigger pulse
        el.classList.remove('save-pulse');
        void el.offsetWidth; // This "resets" the animation
        el.classList.add('save-pulse');
    }
}
// Call this after every save operation


// START EDITING HERE: QUOTE LOGIC
const MOTIVATIONAL_QUOTES = [
    "Padayon Atty! Your future self is already proud of the work you are doing today.",
    "Trust that your hard work will never betray you. You did not come this far to only come this far.",
    "Faith. Grit. Determination.",
    "Do what you could and you have done what you should.",
    "One page at a time, one case at a time. The mountain is climbed one step at a time.",
    "Success is the sum of small efforts, repeated day in and day out.",
    "Believe you can and you're halfway there. Keep the faith, Future Atty!",
    "The struggle youâ€™re in today is developing the strength you need for tomorrow. Padayon!",
    "You are capable of more than you know. Keep reading, keep grinding.",
    "The difference between a successful person and others is not a lack of strength, but a lack of will.",
    "It always seems impossible until it's done.",
    "One page at a time, one case at a time. The mountain is climbed one step at a time."
];

let currentQuoteIndex = parseInt(localStorage.getItem('selected_quote_index')) || 11;

window.changeQuote = function(direction) {
    currentQuoteIndex += direction;
    if (currentQuoteIndex >= MOTIVATIONAL_QUOTES.length) currentQuoteIndex = 0;
    if (currentQuoteIndex < 0) currentQuoteIndex = MOTIVATIONAL_QUOTES.length - 1;
    
    // Save the choice to Local Storage
    localStorage.setItem('selected_quote_index', currentQuoteIndex);
    
    const quoteEl = document.getElementById('quoteText');
    if (quoteEl) {
        quoteEl.style.opacity = 0;
        setTimeout(() => {
            quoteEl.innerText = `"${MOTIVATIONAL_QUOTES[currentQuoteIndex]}"`;
            quoteEl.style.opacity = 1;
        }, 150);
    }
};
const qStyle = document.createElement('style');
qStyle.innerHTML = "#quoteText { transition: opacity 0.2s ease-in-out; }";
document.head.appendChild(qStyle);
// END EDITING HERE

// --- REVIEW TARGETS LOGIC ---
let currentRange = 'weekly'; 
const ANALYTICS_STORE_KEY = 'bar_tracker_analytics_v3';

function getAnalyticsData() {
    const defaultData = { dailyGoal: 50, history: {} };
    try {
        return JSON.parse(localStorage.getItem(ANALYTICS_STORE_KEY)) || defaultData;
    } catch(e) { return defaultData; }
}

window.trackActivity = function(isCheck) {
    const today = new Date().toDateString();
    let data = getAnalyticsData();
    if (!data.history) data.history = {};
    if (!data.history[today]) data.history[today] = 0;
    const oldPercent = Math.min((data.history[today] / data.dailyGoal) * 100, 100);
    
    if (isCheck === true) { data.history[today]++; } 
    else { data.history[today] = Math.max(0, data.history[today] - 1); }

    const newPercent = Math.min((data.history[today] / data.dailyGoal) * 100, 100);
if (oldPercent < 100 && newPercent >= 100) {
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#6D1B1B', '#FECE1B', '#ffffff'] });
}

    localStorage.setItem(ANALYTICS_STORE_KEY, JSON.stringify(data));
    refreshTargetsUI();
};

window.setAnalyticsRange = function(range) {
    currentRange = range;
    document.querySelectorAll('.range-tab').forEach(t => {
t.classList.remove('bg-white', 'shadow-sm', 'text-[var(--theme-primary)]');
        t.classList.add('text-gray-500');
    });
    
    const active = document.getElementById(`range-${range}`);
    if (active) {
        active.classList.remove('text-gray-500');
active.classList.add('bg-white', 'shadow-sm', 'text-[var(--theme-primary)]');
    }
    
    // Toggle the picker visibility
    const picker = document.getElementById('custom-range-picker');
    if (picker) picker.classList.toggle('hidden', range !== 'custom');
    
    refreshTargetsUI();
};

window.updateAnalyticsGoal = function() {
    const val = parseInt(document.getElementById('daily-goal-input').value);
    if (!isNaN(val) && val > 0) {
        let data = getAnalyticsData();
        data.dailyGoal = val;
        localStorage.setItem(ANALYTICS_STORE_KEY, JSON.stringify(data));
        refreshTargetsUI();
        window.showThemedModal({ title: "GOAL UPDATED", message: `TARGET SET TO ${val} BOXES PER DAY!` });
    }
};

window.resetAnalyticsData = function() {
    window.showThemedModal({
        title: 'CLEAR HISTORY',
        message: 'THIS WILL PERMANENTLY WIPE YOUR PRODUCTIVITY HISTORY. PROCEED?',
        type: 'confirm',
        confirmText: 'WIPE ALL',
        onConfirm: () => {
            localStorage.removeItem(ANALYTICS_STORE_KEY);
            refreshTargetsUI();
        }
    });
};

function refreshTargetsUI() {
    const data = getAnalyticsData();
    const history = data.history || {};
    const todayStr = new Date().toDateString();
    const todayCount = history[todayStr] || 0;
    const goal = data.dailyGoal || 50;
    
    // Streak Logic
    let streak = 0;
    let checkDate = new Date();
    while (true) {
        if (history[checkDate.toDateString()] > 0) {
            streak++;
            checkDate.setDate(checkDate.getDate() - 1);
        } else { break; }
    }
    if (document.getElementById('streak-count')) document.getElementById('streak-count').innerText = streak;

    // UI Updates
    const toDoCount = Math.max(0, goal - todayCount);
    const percent = Math.min((todayCount / goal) * 100, 100);
    if (document.getElementById('daily-total')) document.getElementById('daily-total').innerText = todayCount;
    if (document.getElementById('daily-todo')) document.getElementById('daily-todo').innerText = toDoCount;
    if (document.getElementById('daily-target-percent-header')) document.getElementById('daily-target-percent-header').innerText = `${percent.toFixed(0)}%`;
    if (document.getElementById('daily-target-bar-header')) document.getElementById('daily-target-bar-header').style.width = `${percent}%`;
    if (document.getElementById('daily-goal-input')) document.getElementById('daily-goal-input').value = goal;
    if (document.getElementById('daily-target-percent')) document.getElementById('daily-target-percent').innerText = `${percent.toFixed(0)}%`;
    
const targetBar = document.getElementById('daily-target-bar');
    if (targetBar) {
        targetBar.style.width = `${percent}%`;
        targetBar.className = 'h-full transition-all duration-1000 shadow-inner rounded-full'; 
        // SYNCED WITH SUBJECT TRACKER:
        if (percent <= 25) targetBar.classList.add('bg-red-500');
        else if (percent <= 50) targetBar.classList.add('bg-orange-500');
        else if (percent <= 75) targetBar.classList.add('bg-yellow-400');
        else targetBar.classList.add('bg-green-500');
    }
    renderRangeChart(history, goal);
}

function renderRangeChart(history, goal) {
    const chart = document.getElementById('analytics-chart-container');
    const labels = document.getElementById('analytics-labels-container');
    if (!chart || !labels) return;

    // Create professional tooltip if missing
    let tooltip = document.getElementById('chart-tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'chart-tooltip';
        document.body.appendChild(tooltip);
    }

    chart.innerHTML = ''; 
    labels.innerHTML = '';
    const today = new Date();

    if (currentRange === 'monthly') {
        // --- CALENDAR GRID VIEW ---
        chart.className = "grid grid-cols-7 gap-1.5 w-full max-w-[280px] mx-auto p-3 bg-white rounded-xl border border-gray-100 shadow-sm";
        labels.classList.add('hidden'); 

        const weekdays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        weekdays.forEach(day => {
            const h = document.createElement('div');
            h.className = "text-center text-[8px] font-black text-gray-300 pb-1";
            h.innerText = day;
            chart.appendChild(h);
        });

        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // Render Padding
        for (let p = 0; p < firstDay.getDay(); p++) {
            const pad = document.createElement('div');
            pad.className = "aspect-square opacity-0";
            chart.appendChild(pad);
        }

        // Render Days
        for (let d = 1; d <= lastDay.getDate(); d++) {
            const dateObj = new Date(today.getFullYear(), today.getMonth(), d);
            renderElement(dateObj, chart, null, history, goal, true);
        }
    } else {
        // --- BAR CHART VIEW (Weekly / Custom) ---
        chart.className = "flex items-end justify-between h-[200px] gap-1 px-2 border-b border-l border-gray-200 pl-4";
        labels.classList.remove('hidden');
        labels.className = "flex justify-between px-2 pt-2 text-[8px] font-black text-gray-400 uppercase tracking-tighter pl-4";

        let daysToRender = [];
        if (currentRange === 'weekly') {
            for (let i = 6; i >= 0; i--) {
                let d = new Date(); d.setDate(today.getDate() - i);
                daysToRender.push(d);
            }
        } else {
            // Handle Custom Range Inputs
            const sVal = document.getElementById('custom-start').value;
            const eVal = document.getElementById('custom-end').value;
            const start = sVal ? new Date(sVal) : new Date(today);
            const end = eVal ? new Date(eVal) : new Date(today);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                daysToRender.push(new Date(d));
            }
        }
        daysToRender.forEach(d => renderElement(d, chart, labels, history, goal, false));
    }

    // Helper: Component Generator
function renderElement(dateObj, container, labelContainer, history, goal, isCalendar) {
        const dateStr = dateObj.toDateString();
        const count = history[dateStr] || 0;
        const dayPercent = (count / goal) * 100;
        const element = document.createElement('div');

if (isCalendar) {
            // --- SYNCED WITH SUBJECT TRACKER THEME ---
            let bgClass = 'bg-gray-50 text-gray-300';
            if (count > 0) {
                if (dayPercent <= 25) bgClass = 'bg-red-500 text-white'; 
                else if (dayPercent <= 50) bgClass = 'bg-orange-500 text-white';       
                else if (dayPercent <= 75) bgClass = 'bg-yellow-400 text-black';     
                else bgClass = 'bg-green-500 text-white shadow-md';                              
            }
            const isToday = dateStr === new Date().toDateString();
            const todayRing = isToday ? 'ring-2 ring-[var(--theme-primary)] ring-offset-1' : '';
            
            element.className = `heatmap-cell text-[10px] font-black flex items-center justify-center rounded-md transition-all ${bgClass} ${todayRing} h-8 w-8 mx-auto`;
            element.innerText = dateObj.getDate();
        } else {
            const h = Math.min(Math.max((count / (goal * 1.2)) * 100, 3), 100);
            
            // --- SYNCED WITH SUBJECT TRACKER THEME ---
            let barColor = 'bg-red-500';
            if (dayPercent > 75) barColor = 'bg-green-500 shadow-md';
            else if (dayPercent > 50) barColor = 'bg-yellow-400';
            else if (dayPercent > 25) barColor = 'bg-orange-500';
            
            element.className = `flex-1 ${barColor} rounded-t-lg transition-all duration-500 hover:scale-x-105`;
            element.style.height = `${h}%`;
            const lbl = document.createElement('span');
            lbl.className = "flex-1 text-center font-black text-[7px] text-gray-400 mt-1";
            lbl.innerText = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            labelContainer.appendChild(lbl);
        }

        // TOOLTIP INTERACTION
        element.onmouseenter = (e) => {
            tooltip.style.display = 'block';
            tooltip.innerHTML = `<div class="text-center"><div class="text-[8px] opacity-60">${dateStr}</div><div class="text-[11px] font-black">${count} BOXES</div></div>`;
            const rect = e.target.getBoundingClientRect();
            tooltip.style.top = `${rect.top - 50}px`;
            tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2)}px`;
        };
        element.onmouseleave = () => { tooltip.style.display = 'none'; };
        container.appendChild(element);
    }
}

init();

// Universal listener for changes in other tabs
window.addEventListener('storage', () => updateLastSaved());

// Universal listener for clicks/typing in THIS tab (debounced for performance)
let saveTimeout;
document.addEventListener('input', () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        // This triggers the save for everything, including the username
        if (typeof updateLastSaved === 'function') updateLastSaved();
    }, 1000); 
});

document.addEventListener('change', () => {
    if (typeof updateLastSaved === 'function') updateLastSaved();
});
// --- TAB SWITCHING LOGIC ---
window.switchTab = function(tabId) {
    // Hide all contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Deactivate all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-500');
    });

    // Show selected content
    document.getElementById(tabId).classList.add('active');
    
    // Activate clicked button
    const activeBtn = document.getElementById('btn-' + tabId.split('-')[1]);
    activeBtn.classList.add('active');
    activeBtn.classList.remove('text-gray-500');

    // Special handlers for specific tabs to ensure UI refreshes
    if (tabId === 'tab-calendar' && window.CALENDAR_APP) {
        window.CALENDAR_APP.refreshCalendar();
        window.CALENDAR_APP.syncHeight();
    }
    if (tabId === 'tab-dashboard') {
        window.updateOverallDashboard();
    }
    if (tabId === 'tab-analytics' && typeof refreshTargetsUI === 'function') {
        refreshTargetsUI();
    }
    
    // Scroll to top of content area on switch
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

lucide.createIcons();

// --- REVIEW NOTES LOGIC ---
const NOTES_SYLLABUS = {
poli: typeof POLI_SYLLABUS !== 'undefined' ? POLI_SYLLABUS : [],
lab: typeof LAB_SYLLABUS !== 'undefined' ? LAB_SYLLABUS : [],
civ: typeof CIV_SYLLABUS !== 'undefined' ? CIV_SYLLABUS : [],
tax: typeof COMM_TAX_SYLLABUS !== 'undefined' ? COMM_TAX_SYLLABUS : [],
crim: typeof CRIM_SYLLABUS !== 'undefined' ? CRIM_SYLLABUS : [],
rem: typeof REM_ETHICS_SYLLABUS !== 'undefined' ? REM_ETHICS_SYLLABUS : []
};

function switchTab(tabId) {
// 1. Remove active state from all content and buttons
document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

// 2. Add active state to the selected tab and its corresponding nav button
document.getElementById(tabId).classList.add('active');
const btnId = 'btn-' + tabId.split('-')[1];
const targetBtn = document.getElementById(btnId);
if (targetBtn) targetBtn.classList.add('active');

// 3. Trigger specific renderers based on the tab
if (tabId === 'tab-todo') renderTodoView();
if (tabId === 'tab-links') renderLinks();
if (tabId === 'tab-materials') renderMaterials();

// 4. Special handling for Review Notes tab
if (tabId === 'tab-notes') {
const container = document.getElementById('notes-container');
// Only trigger a subject switch if the container is currently empty
if (!container.innerHTML.trim() || container.innerHTML.includes('loader-2')) {
switchNotesSubject('rem');
}
}
}

const loadedScripts = new Set();

function lazyLoadSubject(sub, callback) {
    if (loadedScripts.has(sub)) {
        callback();
        return;
    }

    // ALWAYS show spinner first when switching subjects
    const container = document.getElementById('notes-container');
    container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-16 text-purple-400">
            <i data-lucide="loader-2" class="w-12 h-12 animate-spin mb-4"></i>
            <p class="text-sm font-bold uppercase tracking-wider">Loading ${sub.toUpperCase()} Syllabus...</p>
        </div>`;
    lucide.createIcons();

    const scriptMap = {
        poli: 'Syllabus/poli_logic.js',
        lab: 'Syllabus/lab_logic.js',
        civ: 'Syllabus/civ_logic.js',
        tax: 'Syllabus/comm_logic.js',
        crim: 'Syllabus/crim_logic.js',
        rem: 'Syllabus/rem_logic.js'
    };

    const script = document.createElement('script');
    script.src = scriptMap[sub];

    script.onload = () => {
        // Success: Load the syllabus data
        const syllabusMap = {
            poli: typeof POLI_SYLLABUS !== 'undefined' ? POLI_SYLLABUS: [],
            lab: typeof LAB_SYLLABUS !== 'undefined' ? LAB_SYLLABUS : [],
            civ: typeof CIV_SYLLABUS !== 'undefined' ? CIV_SYLLABUS : [],
            tax: typeof COMM_TAX_SYLLABUS !== 'undefined' ? COMM_TAX_SYLLABUS : [],
            crim: typeof CRIM_SYLLABUS !== 'undefined' ? CRIM_SYLLABUS : [],
            rem: typeof REM_ETHICS_SYLLABUS !== 'undefined' ? REM_ETHICS_SYLLABUS : []
        };
        NOTES_SYLLABUS[sub] = syllabusMap[sub] || [];
        loadedScripts.add(sub);
        callback();
    };

script.onerror = () => {
    console.error(`Failed to load: ${scriptMap[sub]}`);
    container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-16 min-h-[400px]">
            <i data-lucide="alert-triangle" class="w-20 h-20 text-red-400 mb-6"></i>
            <p class="text-xl font-black text-red-600 uppercase tracking-wider mb-4">Load Failed</p>
            <p class="text-sm text-gray-600 text-center max-w-xs mx-auto leading-relaxed px-4">
                Could not load <strong>Syllabus/${sub}_logic.js</strong><br><br>
                The file is missing or the path is incorrect.
            </p>
            <button onclick="switchNotesSubject('${sub}')" 
                    class="mt-8 px-8 py-3 bg-[#6D1B1B] text-white font-black uppercase text-xs rounded-xl shadow-lg hover:bg-[#FECE1B] transition-all">
                Try Again
            </button>
        </div>`;
    lucide.createIcons();
};

    document.head.appendChild(script);
}

function switchNotesSubject(sub) {
const searchInput = document.getElementById('notes-search');
if (searchInput) searchInput.value = '';
document.querySelectorAll('.notes-sub-tab').forEach(b => b.classList.remove('active'));
const activeBtn = document.getElementById('sub-btn-' + sub);
if (activeBtn) activeBtn.classList.add('active');

lazyLoadSubject(sub, () => {
    const container = document.getElementById('notes-container');
    const syllabus = NOTES_SYLLABUS[sub];
    if (!container || !syllabus) return;

    const subjectTitle = activeBtn.innerText.replace(/\s*\(\d+%\)\s*/g, "").replace(/\s*\d+%\s*$/g, "").trim();
    const activeColor = getActiveThemeColor(sub);

// Map specific icons based on subject name
const iconMap = { poli: 'landmark', lab: 'handshake', civ: 'building-2', tax: 'banknote', crim: 'shield', rem: 'gavel' };
const icon = iconMap[sub] || 'book';

// Calculate Stats for the Header
let total = 0, done = 0;
syllabus.forEach((item, index) => {
if (item.depth === 2) {
total++;
const parent = syllabus.slice(0, index).reverse().find(i => i.depth === 1);
if (localStorage.getItem(`note_${sub}_${parent ? parent.topic : ''}_${item.topic}`)?.trim()) done++;
}
});
const percent = total === 0 ? 0 : Math.round((done / total) * 100);

// Premium Subject Header themed after the Materials Tracker
const isTax = sub === 'tax'; // Commercial Law check
const textColor = isTax ? '#000000' : '#FFFFFF'; // Updated to your requested #000000
const mutedColor = isTax ? 'rgba(51, 0, 102, 0.6)' : 'rgba(255, 255, 255, 0.6)';
const btnBg = isTax ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.2)';

container.innerHTML = `
<div class="rounded-xl overflow-hidden mb-6 shadow-md border border-gray-100 transition-all duration-500">
<div class="p-5 flex flex-col gap-4" style="background-color: ${activeColor}">
<div class="flex justify-between items-center" style="color: ${textColor}">
<div class="flex items-center gap-4">
<div class="w-12 h-12 rounded-2xl flex items-center justify-center bg-black/10 shadow-inner">
<i data-lucide="${icon}" class="w-6 h-6" style="color: ${textColor}"></i>
</div>
<div>
<h3 class="font-black uppercase text-lg tracking-widest leading-tight">
${subjectTitle}
</h3>
<p class="text-[10px] font-bold italic tracking-widest uppercase" style="color: ${mutedColor}">
Official Syllabus Review Notes â€¢ #AweSAMBar2026
</p>
</div>
</div>
<button onclick="exportSubjectNotes('${sub}')"
class="text-[10px] font-black border px-4 py-2 rounded-xl transition-all shadow-sm"
style="background-color: ${btnBg}; color: ${textColor}; border-color: ${mutedColor}">
EXPORT PDF
</button>
</div>

<div class="flex flex-wrap items-center gap-6 px-1" style="color: ${textColor}">
<div class="flex items-center gap-2">
<i data-lucide="check-circle" class="w-4 h-4" style="opacity: 0.8"></i>
<span class="text-[10px] font-black uppercase tracking-tighter">FINISHED: ${done} TOPICS</span>
</div>
<div class="flex items-center gap-2">
<i data-lucide="book-open" class="w-4 h-4" style="opacity: 0.8"></i>
<span class="text-[10px] font-black uppercase tracking-tighter">REMAINING: ${total - done}</span>
</div>
<div class="flex-grow flex items-center gap-4">
<span class="text-[10px] font-black uppercase tracking-tighter">PROGRESS:</span>
<div class="flex-grow h-2.5 bg-black/10 rounded-full overflow-hidden border border-black/5 shadow-inner">
<div class="h-full bg-white transition-all duration-700 ease-out" style="width: ${percent}%"></div>
</div>
<span class="text-[10px] font-black">${percent}%</span>
</div>
</div>
</div>
</div>

<div id="notes-list-wrapper"></div>`;
// Render the actual syllabus list below the header
const listWrapper = document.getElementById('notes-list-wrapper');
syllabus.forEach((item, index) => {
if (item.depth === 1) {
listWrapper.innerHTML += `
<details class="group bg-white rounded-xl border border-gray-200 overflow-hidden mb-3 shadow-sm" onclick="renderSubTopics(this, '${sub}', ${index})">
<summary class="p-4 font-black text-sm text-[#6D1B1B] cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none border-l-4" style="border-color: ${activeColor}">
<span class="uppercase tracking-wider">${item.topic}</span>
<i data-lucide="chevron-down" class="w-4 h-4 transition-transform group-open:rotate-180 opacity-40"></i>
</summary>
<div class="p-2 bg-gray-50/30 sub-content-area"><div class="flex justify-center py-4"><i data-lucide="loader-2" class="animate-spin text-purple-300"></i></div></div>
</details>`;
}
});
lucide.createIcons();
updateProgress();
setTimeout(setupNotesLiveUpdate, 500);
});
}

function renderSubTopics(detailsElement, sub, startIndex) {
const contentArea = detailsElement.querySelector('.sub-content-area');
if (contentArea.dataset.loaded === "true") return;

const syllabus = NOTES_SYLLABUS[sub];
const fragment = document.createDocumentFragment();
let i = startIndex + 1;

while (i < syllabus.length && syllabus[i].depth > 1) {
const item = syllabus[i];
const parent = syllabus.slice(0, i).reverse().find(s => s.depth === 1);
const storageKey = `note_${sub}_${parent ? parent.topic : ''}_${item.topic}`;

const div = document.createElement('div');
div.className = "bg-white p-4 rounded-lg border border-purple-100 shadow-inner mb-3 ml-4";
div.innerHTML = `
<label class="block text-[10px] font-black text-[#FECE1B] uppercase mb-2 tracking-widest">${item.topic}</label>
<textarea class="auto-expand w-full bg-transparent border-none outline-none resize-none overflow-hidden text-[13px]"
placeholder="Take notes..."
oninput="autoExpand(this); saveNoteRecursive('${storageKey}', this.value); debounceUpdateProgressAndSave()"
>${localStorage.getItem(storageKey) || ''}</textarea>`;
fragment.appendChild(div);
i++;
}

contentArea.innerHTML = '';
contentArea.appendChild(fragment);
contentArea.dataset.loaded = "true";
setTimeout(setupNotesLiveUpdate, 100);

setTimeout(() => {
contentArea.querySelectorAll('textarea').forEach(autoExpand);
lucide.createIcons();
}, 10);
}

// Global helper for the recursion
function saveNoteRecursive(key, val) {
localStorage.setItem(key, val);
}


function updateProgress() {
let totalSubtopics = 0;
let completedSubtopics = 0;

Object.keys(NOTES_SYLLABUS).forEach(sub => {
const syllabus = NOTES_SYLLABUS[sub];
if (!syllabus.length) return;

let subCount = 0;
let subDone = 0;

syllabus.forEach((item, index) => {
if (item.depth === 2) {
totalSubtopics++;
subCount++;
const parent = syllabus.slice(0, index).reverse().find(i => i.depth === 1);
// Topic is DONE only if note exists and is not just whitespace
const savedContent = localStorage.getItem(`note_${sub}_${parent ? parent.topic : ''}_${item.topic}`);
if (savedContent && savedContent.trim().length > 0) {
completedSubtopics++;
subDone++;
}
}
});

const percent = Math.round((subDone / subCount) * 100) || 0;
const btn = document.getElementById('sub-btn-' + sub);
if (btn) {
    // Clean, short subject names
    const subjectNames = {
        poli: 'Political Law',
        civ: 'Civil Law',
        rem: 'Remedial Law',
        crim: 'Criminal Law',
        lab: 'Labor Law',
        tax: 'Commercial Law'
    };
    const cleanName = subjectNames[sub] || sub.toUpperCase();

    const percent = Math.round((subDone / subCount) * 100) || 0;

btn.innerHTML = `
    <div class="flex items-center justify-between gap-2">
        <span class="font-black text-[10px] tracking-tighter truncate">${cleanName}</span>
        <div class="flex items-center gap-1">
            <div class="w-16 bg-gray-200 h-1.5 rounded-full overflow-hidden flex-shrink-0">
                <div class="h-full transition-all duration-500" 
                     style="width: ${percent}%; background-color: ${getActiveThemeColor(sub)}">
                </div>
            </div>
            <span class="text-[9px] font-bold min-w-[24px] text-right ${sub === 'tax' ? 'text-gray-800' : 'text-white'}">
                ${percent}%
            </span>
        </div>
    </div>`;

    // Keep the active tab highlighted
    if (document.querySelector('.notes-sub-tab.active') === btn) {
        btn.classList.add('active');
    }
}
});

// Update Master Progress Bar UI
const totalPercent = Math.round((completedSubtopics / totalSubtopics) * 100) || 0;
const fill = document.getElementById('notes-master-progress-fill');
const text = document.getElementById('notes-master-percent');

if (fill) {
fill.style.width = totalPercent + '%';

// Dynamic Color Logic: Red -> Orange -> Yellow -> Green
let progressColor = '#ef4444'; // Default Red (0-25%)
if (totalPercent > 25 && totalPercent <= 50) progressColor = '#f97316'; // Orange
if (totalPercent > 50 && totalPercent <= 75) progressColor = '#eab308'; // Yellow
if (totalPercent > 75) progressColor = '#22c55e'; // Green

fill.style.background = progressColor;
}

if (text) {
text.innerText = totalPercent + '%';
if (totalPercent > 25) text.style.color = fill.style.background;
}
}


function getActiveThemeColor(sub) {
const colors = { poli: '#795548', civ: '#1e3a8a', rem: '#674ea7', lab: '#38761d', tax: '#eab308', crim: '#b33a3a' };
return colors[sub] || '#6D1B1B';
}

function saveNote(sub, mainTopic, subTopic, val) {
localStorage.setItem(`note_${sub}_${mainTopic}_${subTopic}`, val);
}

function autoExpand(textarea) {
textarea.style.height = 'inherit';
textarea.style.height = textarea.scrollHeight + 'px';
}


// --- TO-DO LOGIC ---
let todoMode = 'daily';
let todoOffset = 0;

// Storage structure: { "date_string": [{text: "...", done: false}] }
let todoStorage = JSON.parse(localStorage.getItem('bar_todos_v2')) || {};

function switchTodoMode(mode) {
todoMode = mode;
document.querySelectorAll('.todo-mode-btn').forEach(b => {
b.classList.remove('selected-active', 'bg-white', 'text-[#6D1B1B]'); // Clear all possible active states
b.classList.add('text-white'); // Reset to default white text
});
const activeBtn = document.getElementById(`todo-btn-${mode}`);
if(activeBtn) {
activeBtn.classList.add('selected-active');
activeBtn.classList.remove('text-white');
}
renderTodoView();
}

function navigateTodo(dir) {
const jumpAmount = (todoMode === 'weekly') ? 7 : 1;
todoOffset += (dir * jumpAmount);
renderTodoView();
}

function jumpToToday() {
todoOffset = 0;
renderTodoView();
}

window.jumpToSpecificDate = function(dateString) {
// If the string contains a dash (YYYY-MM-DD), it's from the date picker
// If it's a long string like "Tue Dec 30 2025", it's from the mini-calendar
const useTimestamp = dateString.includes('-') ? dateString + "T00:00:00" : dateString;

const targetDate = new Date(useTimestamp);
const today = new Date();

// Normalize both to midnight for perfect math
today.setHours(0, 0, 0, 0);
targetDate.setHours(0, 0, 0, 0);

// Check if the date is valid before updating
if (isNaN(targetDate.getTime())) {
console.error("Attempted to jump to an invalid date:", dateString);
return;
}

const diffTime = targetDate.getTime() - today.getTime();
todoOffset = Math.round(diffTime / (1000 * 60 * 60 * 24));

renderTodoView();
};

function handleJumpToDate(val) {
if (!val) return;

// Simply pass the value to our universal jumper logic
window.jumpToSpecificDate(val);

// Reset picker UI
document.getElementById('date-jumper').value = '';
}


function renderTodoView() {
const container = document.getElementById('todo-render-container');
const title = document.getElementById('todo-view-title');
const dateDisplay = document.getElementById('todo-date-display');
const baseDate = new Date();
const viewingDate = new Date(baseDate);
viewingDate.setDate(viewingDate.getDate() + todoOffset);

const dateKey = viewingDate.toDateString();
const tasks = todoStorage[dateKey] || [];

if (todoMode === 'daily') {
    title.innerText = "DAILY TASKS";
    dateDisplay.innerText = viewingDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    const calendarEvents = JSON.parse(localStorage.getItem('review_calendar_events')) || [];
    const year = viewingDate.getFullYear();
    const month = String(viewingDate.getMonth() + 1).padStart(2, '0');
    const day = String(viewingDate.getDate()).padStart(2, '0');
    const currentFormattedDate = `${year}-${month}-${day}`;

    const syncedCalendarTasks = calendarEvents.filter(event => {
        const start = event.start; 
        const end = event.end ? moment(event.end).subtract(1, 'days').format('YYYY-MM-DD') : start;
        return currentFormattedDate >= start && currentFormattedDate <= end;
    });

    let syncedHtml = '';
if (syncedCalendarTasks.length > 0) {
        syncedHtml = `<div class="mb-4 space-y-2">
            <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1 ml-1">Synced from Calendar</p>
            ${syncedCalendarTasks.map(event => {
                // Logic: Use event.icon if it exists (Custom Event), otherwise fallback to book (Study Task)
                const displayIcon = event.icon || 'book';
                return `
                <div class="flex items-center gap-3 p-3 rounded-xl border-l-4 shadow-sm bg-white" style="border-color: ${event.color || '#FECE1B'}">
                    <i data-lucide="${displayIcon}" class="w-4 h-4" style="color: ${event.color || '#FECE1B'}"></i>
                    <span class="text-[11px] font-black uppercase tracking-tight text-gray-700">${event.title}</span>
                    <span class="ml-auto text-[8px] font-bold text-gray-400 italic">From Calendar</span>
                </div>`;
            }).join('')}
        </div>`;
    }

    let calendarHtml = '<div class="mini-calendar-sidebar">';
    for (let i = -1; i <= 1; i++) {
        const calDate = new Date(viewingDate.getFullYear(), viewingDate.getMonth() + i, 1);
        calendarHtml += generateMiniCal(calDate, viewingDate);
    }
    calendarHtml += '</div>';

    container.innerHTML = `
    <div class="daily-layout-grid">
        <div class="space-y-4">
            ${syncedHtml} 
            <div class="flex items-center gap-2">
                <button onclick="addTodoItem('${dateKey}')" class="flex-grow text-sm font-black text-[var(--theme-primary)]  border-2 border-dashed border-[#FECE1B]/30 px-6 py-2 rounded-xl uppercase flex items-center justify-center gap-2 hover:bg-[var(--theme-primary)] hover:text-white transition-all">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> ADD A TASK
                </button>
                ${tasks.length > 0 ? `<button onclick="clearDayTasks('${dateKey}')" class="clear-all-btn whitespace-nowrap px-4 py-2 h-full rounded-xl border-2">Clear All</button>` : ''}
            </div>
            <div id="list-${dateKey}">${renderTaskList(dateKey, 'large')}</div>
        </div>
        ${calendarHtml}
    </div>`;
} 
else {
title.innerText = "WEEKLY TASKS";
const baseDate = new Date();
const viewingDate = new Date(baseDate);
viewingDate.setDate(viewingDate.getDate() + todoOffset);

const startOfWeek = new Date(viewingDate);
startOfWeek.setDate(viewingDate.getDate() - viewingDate.getDay());

const endOfWeek = new Date(startOfWeek);
endOfWeek.setDate(startOfWeek.getDate() + 6);

const options = { month: 'long', day: 'numeric', year: 'numeric' };
dateDisplay.innerText = `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', options)}`;

// DEFINE THE SIDEBAR CALENDARS FIRST
let calendarSidebarHtml = '<div class="flex flex-col gap-4">';
for (let i = -1; i <= 1; i++) {
const calDate = new Date(viewingDate.getFullYear(), viewingDate.getMonth() + i, 1);
calendarSidebarHtml += generateMiniCal(calDate, viewingDate);
}
calendarSidebarHtml += '</div>';

// BUILD THE 7-DAY CARDS
let daysHtml = '';
for (let i = 0; i < 7; i++) {
const dayDate = new Date(startOfWeek);
dayDate.setDate(startOfWeek.getDate() + i);
const dateKey = dayDate.toDateString();

// Fix: Filter out empty placeholder tasks for the counter
const tasks = (todoStorage[dateKey] || []).filter(t => t.text.trim() !== "");
const totalTasks = tasks.length;
const doneTasks = tasks.filter(t => t.done).length;

const isFinished = totalTasks > 0 && doneTasks === totalTasks;
const progressText = `${doneTasks}/${totalTasks} DONE`;

const colFullDate = dayDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
const isSaturday = dayDate.getDay() === 6;
const spanClass = isSaturday ? 'saturday-span' : '';

// Dynamic badge color and animation
const badgeClass = isFinished
? 'bg-green-500 text-white border-green-600 scale-110 shadow-lg success-pop'
: 'bg-purple-50 text-[#FECE1B] border-purple-100';

daysHtml += `
<div class="weekly-day-card ${spanClass}">
<div class="flex items-start justify-between border-b-2 border-[#FECE1B] mb-3 pb-2">
<div>
<span class="block font-black text-[#6D1B1B] text-sm uppercase tracking-widest">${dayDate.toLocaleDateString('en-US', {weekday:'long'})}</span>
<span class="block text-[10px] text-gray-400 font-bold uppercase">${colFullDate}</span>
</div>
<div class="flex flex-col items-end">
<span class="text-[9px] font-black px-2 py-0.5 rounded-full border uppercase tracking-tighter transition-all duration-300 ${badgeClass}">
${progressText}
</span>
</div>
</div>

<div class="flex gap-1 w-full mb-3">
<button onclick="addTodoItem('${dateKey}')" class="add-task-btn-thin flex-grow border border-dashed border-var(--theme-primary) rounded py-1 text-[9px] font-bold text-var(--theme-primary) uppercase hover:bg-red-50 transition-all">
+ Add Task
</button>
</div>

<div id="list-${dateKey}" class="w-full space-y-1">${renderTaskList(dateKey, 'small')}</div>
</div>`;
}

// RENDER EVERYTHING
container.innerHTML = `
<div class="weekly-planner-grid">
<div class="weekly-tasks-stack">
${daysHtml}
</div>
<div class="mini-calendar-sidebar">
${calendarSidebarHtml}
</div>
</div>`;
} // This bracket safely closes the "else" logic

// Refresh everything
lucide.createIcons();
document.querySelectorAll('.task-row textarea').forEach(el => autoExpand(el));
}

function clearDayTasks(dateKey) {
// Replaced browser confirm with the themed modal
showThemedConfirm(
"Clear Agenda",
"Are you sure you want to delete all tasks for this day? This action cannot be undone.",
() => {
todoStorage[dateKey] = [];
saveAndRefresh();
}
);
}

function generateMiniCal(monthDate, selectedDate) {
const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).getDay();
const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
const today = new Date();

let html = `
<div class="mini-cal">
<div class="mini-cal-header">${monthName}</div>
<div class="mini-cal-grid">
<div class="mini-cal-day-label">S</div><div class="mini-cal-day-label">M</div>
<div class="mini-cal-day-label">T</div><div class="mini-cal-day-label">W</div>
<div class="mini-cal-day-label">T</div><div class="mini-cal-day-label">F</div>
<div class="mini-cal-day-label">S</div>`;

for (let i = 0; i < firstDay; i++) html += '<div></div>';

// UPDATED DATE GENERATION:
for (let day = 1; day <= daysInMonth; day++) {
const checkDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), day);
const dateKey = checkDate.toDateString();
let classes = "mini-cal-date";

if (dateKey === new Date().toDateString()) classes += " mini-cal-today";
if (dateKey === selectedDate.toDateString()) classes += " mini-cal-viewing";

// Added onclick to jump to date
html += `<div class="${classes}" onclick="jumpToSpecificDate('${dateKey}')">${day}</div>`;
}
html += `</div></div>`;
return html;
}

function renderTaskList(dateKey, sizeClass) {
let tasks = todoStorage[dateKey] || [];

// If truly empty, return empty string so the card just shows the "Add Task" button
if (tasks.length === 0) return '';

const inputClass = sizeClass === 'large' ? 'task-input-large' : 'task-input-small';
const iconSize = sizeClass === 'large' ? 'w-5 h-5' : 'w-3.5 h-3.5';

return tasks.map((task, i) => `
<div class="task-row group">
<input type="checkbox"
onchange="toggleTodo('${dateKey}', ${i})"
${task.done ? 'checked' : ''}
class="w-5 h-5 rounded border-gray-300 text-[#6D1B1B] flex-shrink-0">

<textarea rows="1"
oninput="autoExpand(this); editTodo('${dateKey}', ${i}, this.value)"
class="bg-transparent border-none outline-none flex-grow ${inputClass} ${task.done ? 'line-through text-gray-300' : 'text-gray-700'} resize-none overflow-hidden"
placeholder="Enter task..."
>${task.text}</textarea>

<div class="task-actions">
<button onclick="removeTodo('${dateKey}', ${i})" class="text-red-400 hover:text-red-600 transition-colors">
<i data-lucide="trash-2" class="${iconSize}"></i>
</button>
</div>
</div>
`).join('');
}

function addTodoItem(dateKey) {
    if (!todoStorage[dateKey]) todoStorage[dateKey] = [];
    const newTaskText = 'New Task';
    todoStorage[dateKey].push({ text: newTaskText, done: false });
    saveAndRefresh();
}

function toggleTodo(dateKey, i) {
todoStorage[dateKey][i].done = !todoStorage[dateKey][i].done;

// Check for confetti trigger
const tasks = (todoStorage[dateKey] || []).filter(t => t.text.trim() !== "");
const totalTasks = tasks.length;
const doneTasks = tasks.filter(t => t.done).length;

if (totalTasks > 0 && doneTasks === totalTasks && todoStorage[dateKey][i].done) {
createConfetti();
}

saveAndRefresh();
}

function createConfetti() {
for (let i = 0; i < 50; i++) {
const confetti = document.createElement('div');
confetti.className = 'confetti-piece';
confetti.style.left = Math.random() * 100 + 'vw';
confetti.style.backgroundColor = ['#FECE1B', '#6D1B1B', '#FFD700', '#22c55e'][Math.floor(Math.random() * 4)];
confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
confetti.style.opacity = Math.random();
document.body.appendChild(confetti);
setTimeout(() => confetti.remove(), 3000);
}
}

function editTodo(dateKey, i, val) {
todoStorage[dateKey][i].text = val;
// Save to storage but DO NOT call renderTodoView() here
localStorage.setItem('bar_todos_v2', JSON.stringify(todoStorage));
}

function removeTodo(dateKey, i) {
todoStorage[dateKey].splice(i, 1);
saveAndRefresh();
}

function saveAndRefresh() {
localStorage.setItem('bar_todos_v2', JSON.stringify(todoStorage));
renderTodoView();
}

// Data and Constants
const studyIcons = [
'gavel', 'shield', 'handshake', 'building-2', 'banknote', 'landmark',
'book', 'book-open', 'graduation-cap', 'pencil', 'library', 'file-text',
'folder', 'clipboard-list', 'scale', 'bookmark', 'link', 'archive', 'globe', 
'laptop-minimal-check', 'cake', 'search', 'triangle-alert', 'cloud', 'heart', 
'calendar-days', 'alarm-clock-check'
];

const studyColors = [
// ROW 1: Deep & Sophisticated (Dark Tones)
'#5D4037', // Brown
'#6D1B1B', // Deep Purple
'#1B5E20', // Forest Green
'#B71C1C', // Deep Red
'#0D47A1', // Royal Blue
'#E65100', // Deep Orange
'#880E4F', // Deep Pink
'#F57F17', // Golden Yellow
'#263238', // Gunmetal Gray
'#311B92', // Indigo
// ROW 2: Deep & Muted
'#8D6E63', // Soft Clay
'#FBC02D', // Mustard Yellow
'#689F38', // Light Olive
'#EC407A', // Rose
'#EF5350', // Soft Red
'#42A5F5', // Sky Blue
'#AB47BC', // Amethyst
'#FFA726', // Amber
'#78909C', // Slate
'#26A69A' // Seafoam
];

let selectedIcon = 'link';
let selectedColor = '#00BCD4';
let userLinks = JSON.parse(localStorage.getItem('bar_user_links')) || [];

function toggleLinkModal(show) {
const modal = document.getElementById('link-modal');
modal.classList.toggle('hidden', !show);
modal.classList.toggle('flex', show);
if(show) setupPickers();
}

// Logic for Link Modal Pickers
function setupPickers() {
const iconContainer = document.getElementById('icon-picker');
const colorContainer = document.getElementById('color-picker');

iconContainer.innerHTML = studyIcons.map(icon => `
<button onclick="selectedIcon='${icon}'; setupPickers()"
class="p-1.5 border rounded-lg flex justify-center transition-all ${selectedIcon === icon ? 'border-[#FECE1B] bg-red-50 shadow-sm' : 'border-transparent hover:bg-white'}">
<i data-lucide="${icon}" class="w-3.5 h-3.5 ${selectedIcon === icon ? 'text-[#6D1B1B]' : 'text-gray-400'}"></i>
</button>
`).join('');

colorContainer.innerHTML = studyColors.map(color => `
<button onclick="selectedColor='${color}'; setupPickers()"
class="w-8 h-8 rounded-full border-2 transition-all hover:scale-110 active:scale-95 shadow-md ${selectedColor === color ? 'border-[#6D1B1B] ring-2 ring-[#FECE1B] ring-offset-1' : 'border-white hover:border-gray-200'}"
style="background:${color}"></button>
`).join('');
lucide.createIcons();
}

function saveLink() {
const title = document.getElementById('link-title').value;
const url = document.getElementById('link-url').value;

if(!title || !url) return alert("Title and URL required!");

userLinks.push({ title, url, icon: selectedIcon, color: selectedColor });
localStorage.setItem('bar_user_links', JSON.stringify(userLinks));

// Reset inputs
document.getElementById('link-title').value = '';
document.getElementById('link-url').value = '';

toggleLinkModal(false);
renderLinks();
}

function deleteLink(index, e) {
e.preventDefault();
e.stopPropagation(); // Prevents the link from opening

const linkTitle = userLinks[index].title;

showThemedConfirm(
"Delete Resource",
`Are you sure you want to remove "${linkTitle}"? This cannot be undone.`,
() => {
userLinks.splice(index, 1);
localStorage.setItem('bar_user_links', JSON.stringify(userLinks));
renderLinks();
}
);
}

function renderLinks() {
const container = document.getElementById('links-grid');
container.innerHTML = userLinks.map((link, i) => `
<a href="${link.url}" target="_blank" class="link-pill" style="background: ${link.color}">
<div class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center mr-3">
<i data-lucide="${link.icon}" class="w-5 h-5 text-white"></i>
</div>
<span>${link.title}</span>
<div class="flex gap-1">
<button onclick="editLink(${i}, event)" class="edit-link p-1 bg-black/10 rounded hover:bg-white/20 transition-colors">
<i data-lucide="pencil" class="w-3 h-3 text-white"></i>
</button>
<button onclick="deleteLink(${i}, event)" class="delete-link p-1 bg-black/10 rounded hover:bg-red-500 transition-colors">
<i data-lucide="trash-2" class="w-3 h-3 text-white"></i>
</button>
</div>
</a>
`).join('');
lucide.createIcons();
}

// --- INITIALIZE ---
window.onload = () => {
// Set your desired starting tab here
const defaultTab = 'tab-dashboard';

// 1. Initialize all data trackers first
renderTodoView();
renderLinks();
renderMaterials();

// 2. Pre-load the default subject logic in the background
lazyLoadSubject('rem', () => {
updateProgress(); // This ensures subject percentages show up on the buttons immediately
});

// 3. Switch to your preferred tab
switchTab(defaultTab);
};

/* --- THEMED MODAL SYSTEM --- */
function showThemedConfirm(title, message, onConfirm) {
const container = document.getElementById('themed-modal-container');
const content = document.getElementById('themed-modal-content');

content.innerHTML = `
<div class="modal-header-bg p-4 text-white font-black header-font text-xl tracking-widest uppercase">
${title}
</div>
<div class="p-6">
<p class="text-gray-600 font-bold text-sm leading-relaxed">${message}</p>
</div>
<div class="p-4 bg-gray-50 flex gap-3">
<button onclick="closeThemedModal()" class="flex-1 py-3 text-gray-400 font-black uppercase text-[10px] tracking-widest hover:text-gray-600 transition-colors">
Cancel
</button>
<button id="themed-modal-confirm-btn" class="flex-1 py-3 bg-[#6D1B1B] text-white font-black uppercase text-[10px] tracking-widest rounded-xl shadow-lg shadow-red-200 hover:bg-[#FECE1B] transition-all">
Confirm
</button>
</div>
`;

container.classList.remove('hidden');
container.classList.add('flex');

document.getElementById('themed-modal-confirm-btn').onclick = () => {
onConfirm();
closeThemedModal();
};
}

function closeThemedModal() {
const container = document.getElementById('themed-modal-container');
container.classList.add('hidden');
container.classList.remove('flex');
}

let editingLinkIndex = null; // Tracks if we are editing or adding new

function editLink(index, e) {
e.preventDefault(); // Stop the link from opening
editingLinkIndex = index;
const link = userLinks[index];

// Fill modal with existing data
document.getElementById('link-title').value = link.title;
document.getElementById('link-url').value = link.url;
selectedIcon = link.icon;
selectedColor = link.color;

toggleLinkModal(true);
}

// Modify your saveLink function to handle updates
function saveLink() {
const title = document.getElementById('link-title').value;
const url = document.getElementById('link-url').value;

if(!title || !url) return alert("Title and URL required!");

const linkData = { title, url, icon: selectedIcon, color: selectedColor };

if (editingLinkIndex !== null) {
// Update existing
userLinks[editingLinkIndex] = linkData;
editingLinkIndex = null; // Reset
} else {
// Add new
userLinks.push(linkData);
}

localStorage.setItem('bar_user_links', JSON.stringify(userLinks));

// Reset inputs
document.getElementById('link-title').value = '';
document.getElementById('link-url').value = '';

toggleLinkModal(false);
renderLinks();
}

// Also, reset editingLinkIndex when simply opening the modal to add a new link
function toggleLinkModal(show) {
const modal = document.getElementById('link-modal');
modal.classList.toggle('hidden', !show);
modal.classList.toggle('flex', show);
if(show) {
setupPickers();
} else {
editingLinkIndex = null; // Reset if closed
}
}

function exportSubjectNotes(sub) {
const syllabus = NOTES_SYLLABUS[sub];
const btn = document.getElementById('sub-btn-' + sub);
// Clean subject name: Remove any trailing percentage (e.g., "85%") from button text
let subjectName = btn ? btn.innerText : sub.toUpperCase();

// Remove anything that looks like a percentage at the end (e.g., " 85%")
subjectName = subjectName.replace(/\s*\d+%?\s*$/, '').trim();

// Fallback clean names if needed
const cleanNames = {
    poli: 'POLITICAL LAW',
    civ: 'CIVIL LAW',
    rem: 'REMEDIAL LAW',
    crim: 'CRIMINAL LAW',
    lab: 'LABOR LAW',
    tax: 'COMMERCIAL LAW'
};
subjectName = cleanNames[sub] || subjectName;
const themeColor = getActiveThemeColor(sub);

const printWindow = window.open('', '_blank');

function escapeHtml(text) {
return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

// REDUCED PADDING: Changed from 40px to 20px for wider content
let printTemplate = `
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&display=swap" rel="stylesheet">
<div style="font-family: 'Inter', sans-serif; padding: 20px; color: #1a1a1a;">

<div style="border-bottom: 5px solid ${themeColor}; margin-bottom: 20px; padding-bottom: 10px;">
<div style="font-family: 'Bebas Neue', cursive; font-size: 48px; color: ${themeColor}; letter-spacing: 2px; line-height: 1;">
#AweSAMBar2026 â€¢ ${subjectName}
</div>
<div style="font-size: 10px; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-top: 5px;">
Review Notes â€¢ As of ${new Date().toLocaleDateString()}
</div>
</div>`;

syllabus.forEach((item, i) => {
const isNote = !(i + 1 < syllabus.length && syllabus[i+1].depth > item.depth);
const indent = (item.depth - 1) * 20;

// TIGHTER MARGINS: Reduced top margin from 15px to 8px
let depthStyle = `margin-left: ${indent}px; margin-top: 8px; font-family: 'Inter', sans-serif;`;

if (item.depth === 1) {
depthStyle = `font-family: 'Inter', sans-serif; font-size: 20px; color: ${themeColor}; margin-top: 30px; margin-bottom: 10px; padding: 8px 15px; background-color: ${themeColor}08; border-left: 5px solid ${themeColor}; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;`;
} else if (item.depth === 2) {
depthStyle += `font-weight: 900; font-size: 15px; text-transform: uppercase; color: #374151; border-bottom: 1px solid #eee; padding-bottom: 3px;`;
} else if (item.depth === 3) {
depthStyle += `font-weight: 800; font-size: 13px; color: #4b5563;`;
} else {
depthStyle += `font-weight: 700; font-size: 11px; font-style: italic; color: #6b7280;`;
}

printTemplate += `<div style="${depthStyle}">${item.topic}</div>`;

if (isNote) {
let path = [];
let currentD = item.depth;
for (let j = i - 1; j >= 0; j--) {
if (syllabus[j].depth < currentD) {
path.unshift(syllabus[j].topic);
currentD = syllabus[j].depth;
}
}
const key = `note_${sub}_${path.join('_')}_${item.topic}`;
let rawNote = localStorage.getItem(key) || "";
const isEmpty = rawNote.trim() === "";

// LOGIC: If empty, show a blank space with a min-height for handwriting
printTemplate += `
<div style="
display: block;
width: auto;
margin-left: ${indent + 20}px;
margin-top: 5px;
margin-bottom: 15px;
padding-left: 15px;
border-left: 2px solid #e5e7eb;
font-family: 'Inter', sans-serif;
min-height: ${isEmpty ? '40px' : 'auto'};
">
<div style="
white-space: pre-wrap;
font-size: 13px;
line-height: 1.6;
color: #1f2937;
word-wrap: break-word;
overflow-wrap: break-word;
">
${isEmpty ? '' : escapeHtml(rawNote)}
</div>
</div>`;
}
});

printTemplate += `
<div style="margin-top: 60px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
<div style="font-family: 'Bebas Neue', cursive; font-size: 16px; color: #9ca3af; letter-spacing: 1px;">
Generated via #AweSAMBar2026 Tracker â€¢ 2026bar-reviewtracker.vercel.app
</div>
<div style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: ${themeColor}; margin-top: 5px; letter-spacing: 1px;">
â€¢ Faith. Grit. Determination. â€¢
</div>
</div>
</div>`;

printWindow.document.write(printTemplate);
printWindow.document.close();

setTimeout(() => { printWindow.print(); }, 800);
}

let searchTimeout;
function handleNotesSearch(query) {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(() => {
const wrapper = document.getElementById('notes-list-wrapper');
const searchTerm = query.toLowerCase().trim();

// Reset view if empty
if (!searchTerm) {
wrapper.querySelectorAll('details').forEach(d => {
d.classList.remove('hidden');
d.open = false;
});
return;
}

const sub = document.querySelector('.notes-sub-tab.active').dataset.sub;
const syllabus = NOTES_SYLLABUS[sub];

wrapper.querySelectorAll('details').forEach((details, index) => {
const chapterIdx = parseInt(details.getAttribute('onclick').match(/\d+/)[0]);
const chapterText = syllabus[chapterIdx].topic.toLowerCase();

// Check if chapter matches OR any subtopic matches
let hasMatch = chapterText.includes(searchTerm);

// Peek at subtopics for this chapter
let i = chapterIdx + 1;
while (i < syllabus.length && syllabus[i].depth > 1) {
if (syllabus[i].topic.toLowerCase().includes(searchTerm)) {
hasMatch = true;
break;
}
i++;
}

if (hasMatch) {
details.classList.remove('hidden');
if (searchTerm.length > 2) {
details.open = true;
renderSubTopics(details, sub, chapterIdx); // Force render if match found
}
} else {
details.classList.add('hidden');
}
});
}, 300);
}

let materialsData = JSON.parse(localStorage.getItem('bar_materials')) || [];
let currentMatEditId = null;
let currentTopicParentId = null;
let currentTopicMatId = null;
let selectedMatIcon = 'book';
let selectedMatColor = '#FECE1B';

// --- MATERIAL MODAL LOGIC ---
function openMaterialModal(id = null) {
currentMatEditId = id;
const modal = document.getElementById('material-entry-modal');
const title = document.getElementById('mat-modal-title');

if (id) {
const mat = materialsData.find(m => m.id === id);
document.getElementById('mat-name').value = mat.name;
selectedMatIcon = mat.icon || 'book';
selectedMatColor = mat.color || '#FECE1B';
title.innerText = "Edit Material";
} else {
document.getElementById('mat-name').value = '';
selectedMatIcon = 'book';
selectedMatColor = '#FECE1B';
title.innerText = "New Review Material";
}

setupMatPickers();
modal.classList.remove('hidden');
modal.classList.add('flex');
lucide.createIcons();
}

// Logic for Material Modal Pickers
function setupMatPickers() {
const iconContainer = document.getElementById('mat-icon-picker');
const colorContainer = document.getElementById('mat-color-picker');

iconContainer.innerHTML = studyIcons.map(icon => `
<button onclick="selectedMatIcon='${icon}'; setupMatPickers()"
class="p-1.5 border rounded-lg flex justify-center transition-all ${selectedMatIcon === icon ? 'border-[#FECE1B] bg-red-50 shadow-sm' : 'border-transparent hover:bg-white'}">
<i data-lucide="${icon}" class="w-3.5 h-3.5 ${selectedMatIcon === icon ? 'text-[#6D1B1B]' : 'text-gray-400'}"></i>
</button>
`).join('');

colorContainer.innerHTML = studyColors.map(color => `
<button onclick="selectedMatColor='${color}'; setupMatPickers()"
class="w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${selectedMatColor === color ? 'border-[#6D1B1B] ring-2 ring-[#FECE1B]' : 'border-white shadow-sm'}"
style="background:${color}"></button>
`).join('');
lucide.createIcons();
}

function saveMaterialEntry() {
const name = document.getElementById('mat-name').value;
if (!name) return;

if (currentMatEditId) {
const mat = materialsData.find(m => m.id === currentMatEditId);
mat.name = name;
mat.icon = selectedMatIcon;
mat.color = selectedMatColor;
} else {
materialsData.push({
id: Date.now(),
name: name,
icon: selectedMatIcon,
color: selectedMatColor,
topics: []
});
}

closeMaterialModal();
saveMaterials();
}

function closeMaterialModal() {
document.getElementById('material-entry-modal').classList.add('hidden');
document.getElementById('material-entry-modal').classList.remove('flex');
}

// --- TOPIC MODAL LOGIC ---
function addTopic(materialId, parentId = null) {
currentTopicMatId = materialId;
currentTopicParentId = parentId;

document.getElementById('topic-title').value = '';
document.getElementById('topic-trackable').checked = true;

const modal = document.getElementById('topic-entry-modal');
modal.classList.remove('hidden');
modal.classList.add('flex');

document.getElementById('save-topic-btn').onclick = saveTopicEntry;
}

/* Start Edit at Line 1928 */
function saveTopicEntry() {
    const title = document.getElementById('topic-title').value;
    const isTrackable = document.getElementById('topic-trackable').checked;
    if (!title) return;

    const newTopic = {
        id: Date.now(),
        title: title,
        isTrackable: isTrackable,
        done: false,
        subtopics: []
    };

    const material = materialsData.find(m => m.id === currentTopicMatId);
    if (!currentTopicParentId) {
        material.topics.push(newTopic);
    } else {
        const findRecursive = (list) => {
            for (let t of list) {
                if (t.id === currentTopicParentId) { t.subtopics.push(newTopic); return true; }
                if (t.subtopics && findRecursive(t.subtopics)) return true;
            }
        };
        findRecursive(material.topics);
    }
    
    // FIX: Hide the Materials Topic modal specifically
    document.getElementById('topic-entry-modal').classList.add('hidden');
    document.getElementById('topic-entry-modal').classList.remove('flex');
    
    saveMaterials();
}
/* End Edit at Line 1956 */

// --- RENDER & CORE LOGIC ---
function renderMaterials() {
const container = document.getElementById('materials-grid');
if (!container) return;

container.innerHTML = materialsData.map(m => {
// Progress Calculation Logic
let totalTrackable = 0;
let doneTrackable = 0;

const countProgress = (list) => {
list.forEach(t => {
if (t.isTrackable) {
totalTrackable++;
if (t.done) doneTrackable++;
}
if (t.subtopics && t.subtopics.length > 0) countProgress(t.subtopics);
});
};
countProgress(m.topics);

const toReadCount = totalTrackable - doneTrackable;
const percent = totalTrackable === 0 ? 0 : Math.round((doneTrackable / totalTrackable) * 100);

// Dynamic Progress Color Logic
let barColor = '#ef4444'; // Red (0-25%)
if (percent > 25) barColor = '#f97316'; // Orange
if (percent > 50) barColor = '#eab308'; // Yellow
if (percent > 75) barColor = '#22c55e'; // Green

const isCollapsed = m.collapsed || false; // Check saved state

return `
<div class="material-panel bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6" style="--panel-color: ${m.color}">
<div class="p-4 flex flex-col gap-3 text-white cursor-pointer" style="background-color: ${m.color}" onclick="toggleCollapse(${m.id}, event)">
<div class="flex justify-between items-center">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-xl flex items-center justify-center bg-white/20 shadow-inner">
<i data-lucide="${m.icon}" class="w-5 h-5 text-white"></i>
</div>
<div>
<h3 class="font-black uppercase text-sm tracking-widest text-white">${m.name}</h3>
<p class="text-[9px] font-bold text-white/60 italic tracking-wide mt-0.5">Review Material Tracker â€¢ ${isCollapsed ? 'Press to Expand' : 'Press to Collapse'}</p>
</div>
</div>
<div class="flex gap-1" onclick="event.stopPropagation()"> <div class="flex items-center bg-white/10 rounded-lg px-1 mr-1">
<button onclick="moveMaterial(${m.id}, -1)" class="p-1 text-white/70 hover:text-white"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
<button onclick="moveMaterial(${m.id}, 1)" class="p-1 text-white/70 hover:text-white"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
</div>
<button onclick="addTopic(${m.id})" class="text-[10px] font-black bg-white/20 hover:bg-white/40 text-white border border-white/30 px-3 py-1.5 rounded-lg">+ TOPIC</button>
<button onclick="openMaterialModal(${m.id})" class="p-2 text-white/70 hover:text-white"><i data-lucide="settings" class="w-4 h-4"></i></button>
<button onclick="deleteMaterial(${m.id})" class="p-2 text-white/70 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
</div>
</div>

<div class="flex flex-wrap items-center gap-4 px-1">
<div class="flex items-center gap-1.5">
<i data-lucide="check-circle" class="w-3.5 h-3.5 opacity-80"></i>
<span class="text-[10px] font-black uppercase tracking-tighter">DONE: ${doneTrackable} TOPICS</span>
</div>
<div class="flex items-center gap-1.5">
<i data-lucide="book-open" class="w-3.5 h-3.5 opacity-80"></i>
<span class="text-[10px] font-black uppercase tracking-tighter">TO READ: ${toReadCount} TOPICS</span>
</div>
<div class="flex-grow flex items-center gap-3">
<span class="text-[10px] font-black uppercase tracking-tighter whitespace-nowrap">OVERALL PROGRESS:</span>
<div class="flex-grow h-2 bg-white/20 rounded-full overflow-hidden border border-white/10 shadow-inner">
<div class="h-full transition-all duration-700 ease-out" style="width: ${percent}%; background-color: ${barColor}"></div>
</div>
<span class="text-[10px] font-black">${percent}%</span>
</div>
</div>
</div>

<div class="p-4 space-y-1 ${isCollapsed ? 'hidden' : ''}">
${m.topics.length === 0
? `<p class="font-family text-[18px] text-center text-gray-400 italic py-6">
No topics added yet.
<span class="block mt-2 text-xs not-italic font-bold text-[#FECE1B]">
Click + TOPIC to start tracking.
</span>
</p>`
: renderTopicsRecursive(m.topics, m.id)}
</div>
</div>`;

}).join('');
lucide.createIcons();
}

// Add this global state at the top of your script
let collapsedTopics = JSON.parse(localStorage.getItem('bar_collapsed_topics')) || {};

function renderTopicsRecursive(topics, materialId) {
return topics.map((t) => {
const hasChildren = t.subtopics && t.subtopics.length > 0;
const isCollapsed = collapsedTopics[t.id] || false;
const textStyle = !t.isTrackable ? 'text-[#6D1B1B] font-black uppercase' : (t.done ? 'line-through text-gray-400' : 'text-gray-700');

return `
<div class="topic-wrapper mb-1">
<div class="flex items-center justify-between py-1 trackable-item group">
<div class="flex items-center gap-2 flex-grow min-w-0">
<div onclick="${hasChildren ? `toggleTopicCollapse(${t.id})` : ''}"
class="cursor-pointer p-1 -ml-1 transition-transform ${isCollapsed ? '' : 'rotate-90'} ${hasChildren ? 'opacity-100' : 'opacity-20'}">
<i data-lucide="chevron-right" class="w-3.5 h-3.5 text-[#FECE1B]"></i>
</div>

${t.isTrackable ?
`<input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleMaterialItem(${materialId}, ${t.id})" class="w-4 h-4 rounded border-red-300">` : ''}

<textarea
rows="1"
oninput="autoExpand(this); updateTopicTitle(${materialId}, ${t.id}, this.value)"
class="bg-transparent border-none outline-none flex-grow resize-none overflow-hidden text-xs ${textStyle}"
>${t.title}</textarea>
</div>

<div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">
<div class="flex flex-col -space-y-1 mr-1">
<button onclick="moveTopic(${materialId}, ${t.id}, -1)" class="text-gray-300 hover:text-[#FECE1B] transition-colors">
<i data-lucide="chevron-up" class="w-3 h-3"></i>
</button>
<button onclick="moveTopic(${materialId}, ${t.id}, 1)" class="text-gray-300 hover:text-[#FECE1B] transition-colors">
<i data-lucide="chevron-down" class="w-3 h-3"></i>
</button>
</div>

<button onclick="addTopic(${materialId}, ${t.id})" class="text-[9px] text-[#FECE1B] font-black uppercase tracking-tighter">+ Sub</button>
<button onclick="deleteTopic(${materialId}, ${t.id})" class="text-red-300 hover:text-red-500">
<i data-lucide="trash-2" class="w-3 h-3"></i>
</button>
</div>
</div>

<div class="nested-topic ${isCollapsed ? 'hidden' : ''}">
${renderTopicsRecursive(t.subtopics, materialId)}
</div>
</div>`;
}).join('');
}

// Add this function to handle the live data updates
function updateTopicTitle(materialId, topicId, newVal) {
const material = materialsData.find(m => m.id === materialId);
const findAndUpdate = (list) => {
for (let t of list) {
if (t.id === topicId) {
t.title = newVal;
return true;
}
if (t.subtopics && findAndUpdate(t.subtopics)) return true;
}
};
findAndUpdate(material.topics);
// We save to localStorage but DON'T re-render the whole list to prevent losing focus/cursor position
localStorage.setItem('bar_materials', JSON.stringify(materialsData));
}

function toggleMaterialItem(materialId, topicId) {
const material = materialsData.find(m => m.id === materialId);
let justFinished = false;

// Helper function to mark all descendants as done/undone
const markDescendants = (list, isDone) => {
list.forEach(t => {
t.done = isDone;
if (t.subtopics && t.subtopics.length > 0) markDescendants(t.subtopics, isDone);
});
};

const findAndToggle = (list) => {
for (let t of list) {
if (t.id === topicId) {
t.done = !t.done;
if (t.done) justFinished = true;

// If this is a parent, apply the same state to all children
if (t.subtopics && t.subtopics.length > 0) {
markDescendants(t.subtopics, t.done);
}
return true;
}
if (t.subtopics && findAndToggle(t.subtopics)) return true;
}
};

findAndToggle(material.topics);
if (justFinished) createConfetti();
saveMaterials();
}


function deleteMaterial(id) {
const mat = materialsData.find(m => m.id === id);
showThemedConfirm(
"Delete Material",
`Are you sure you want to remove "${mat.name}"? This will delete all tracked progress.`,
() => {
materialsData = materialsData.filter(m => m.id !== id);
saveMaterials();
}
);
}

function saveMaterials() {
localStorage.setItem('bar_materials', JSON.stringify(materialsData));
renderMaterials();
}

function deleteTopic(materialId, topicId) {
showThemedConfirm(
"Delete Topic",
"Remove this topic and all its sub-topics?",
() => {
const material = materialsData.find(m => m.id === materialId);
const findAndDelete = (list, id) => {
const index = list.findIndex(t => t.id === id);
if (index !== -1) {
list.splice(index, 1);
return true;
}
for (let t of list) {
if (t.subtopics && findAndDelete(t.subtopics, id)) return true;
}
};
findAndDelete(material.topics, topicId);
saveMaterials(); // Save and refresh UI
}
);
}

function moveTopic(materialId, topicId, direction) {
const material = materialsData.find(m => m.id === materialId);

const findAndMove = (list) => {
const index = list.findIndex(t => t.id === topicId);
if (index !== -1) {
const newIndex = index + direction;
if (newIndex >= 0 && newIndex < list.length) {
// Swap elements in the array
const temp = list[index];
list[index] = list[newIndex];
list[newIndex] = temp;
return true;
}
return false;
}
for (let t of list) {
if (t.subtopics && findAndMove(t.subtopics)) return true;
}
return false;
};

if (findAndMove(material.topics)) {
saveMaterials(); // This re-renders everything to show the new order
}
}
function moveMaterial(id, direction) {
const index = materialsData.findIndex(m => m.id === id);
if (index === -1) return;

const newIndex = index + direction;
if (newIndex >= 0 && newIndex < materialsData.length) {
// Swap materials in the array
const temp = materialsData[index];
materialsData[index] = materialsData[newIndex];
materialsData[newIndex] = temp;

saveMaterials(); // Save to localStorage and refresh the grid
}
}

function toggleCollapse(id, event) {
const mat = materialsData.find(m => m.id === id);
if (mat) {
mat.collapsed = !mat.collapsed;
saveMaterials(); // Save the collapsed state to localStorage
}
}

function toggleTopicCollapse(topicId) {
collapsedTopics[topicId] = !collapsedTopics[topicId];
localStorage.setItem('bar_collapsed_topics', JSON.stringify(collapsedTopics));
renderMaterials(); // Refresh to show/hide
}

// AUTO-INIT EVERYTHING ON LOAD
window.addEventListener('DOMContentLoaded', () => {
    // 1. Fix duplicate Tailwind/Lucide loads (remove one set in <head>)
    // Already good â€“ you have only one now

    // 2. Load all subject logic files so Bar Subjects panels populate
    initializeSubjectTrackers();

    // 3. Initialize Calendar properly
    document.getElementById('calendar-module-placeholder').innerHTML = CALENDAR_MODULE_HTML;
    window.CALENDAR_APP.loadNotes();
    window.CALENDAR_APP.initializeCalendar();
    setTimeout(() => window.CALENDAR_APP.syncHeight(), 100);

    // 4. Auto-load default Review Notes subject so it's not "stuck loading"
    switchNotesSubject('rem'); // or 'poli' â€“ whatever you prefer as default

    // 5. Render other tabs that need it
    renderMaterials();
    renderTodoView();
    renderLinks();

// UPDATE: Add this block here to reload username on every load/refresh
    const savedUsername = localStorage.getItem('user_display_name'); // Corrected Key
    if (savedUsername && savedUsername.trim() !== '') {
        const usernameInput = document.getElementById('user-name-input'); // Corrected ID
        if (usernameInput) {
            usernameInput.value = `Welcome, ${savedUsername}! âœ¨`;
        }
    }
    // END UPDATE

    // 6. Update dashboard stats (wait a bit for subjects to load)
    setTimeout(() => {
        Object.values(SUBJECT_LOGIC_MAP).forEach(logic => logic?.render());
        updateOverallDashboard();
        updateProgress(); // For notes master bar
    }, 2000);

    // 7. Start countdowns
    updateAllCountdowns();
    setInterval(updateAllCountdowns, 1000);

    lucide.createIcons();
});


// Debounced update to avoid calling too often while typing fast
let progressUpdateTimeout;
function debounceUpdateProgressAndSave() {
    clearTimeout(progressUpdateTimeout);
    progressUpdateTimeout = setTimeout(() => {
        updateProgress();         // Updates master bar + subject tab percentages
        updateLastSaved();        // Updates footer "Last saved" time + pulse
    }, 800); // Wait 800ms after user stops typing
}

// Optional: Also update on blur (when clicking away)
function setupNotesLiveUpdate() {
    document.querySelectorAll('#notes-list-wrapper textarea').forEach(textarea => {
        textarea.addEventListener('blur', () => {
            updateProgress();
            updateLastSaved();
        });
    });
}

    </script>

<div id="themed-modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[200] p-4">
<div id="themed-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-animate-in border border-red-100">
</div>
</div>

</body>
</html>
