<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Review Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚖️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&display=swap');

        /* Global & Countdown Styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        .header-font {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: .1em;
        }

        .header-bg {
            background-color: #6d1b1b;
            /* Deep Maroon */
            border-bottom: 5px solid #fece1b;
        }

        .card-header-bg {
            background-color: #7f2b2b;
            /* Slightly Lighter Maroon */
        }

        .time-value {
            font-size: 1.75rem;
            font-weight: 900;
            line-height: 1;
            color: #1a202c;
        }

        .time-label {
            font-size: .875rem;
            font-weight: 700;
            color: #4a5568;
            text-transform: uppercase;
        }

        .date-display-wrapper {
            display: inline-block;
            padding-bottom: 0;
            cursor: pointer;
            transition: color .2s;
        }

        .date-display-wrapper:hover .date-text {
            color: #1d4ed8;
        }

        .date-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.25rem;
            font-weight: 800;
            color: #000000;
            text-transform: uppercase;
            letter-spacing: .15em;
            line-height: 1;
        }

        /* NEW CUSTOM DASHBOARD STYLES */
        .border-custom-yellow {
            border-color: #fece1b;
        }
        .text-custom-yellow {
            color: #fece1b;
        }
        .bg-chart-done {
            background-color: #38761d;
            /* Dark Green */
        }
        .bg-chart-toread {
            background-color: #93c47d;
            /* Lighter Green/Olive */
        }
        .text-chart-title {
            color: #6d1b1b;
            /* Deep Maroon */
        }
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            /* Allows wrap on small screens */
        }
        .chart-panel {
            width: 100%;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .schedule-panel {
            width: 100%;
            padding: 1rem;
        }
        @media (min-width: 1024px) {
            /* Tailwind lg breakpoint */
            .chart-panel {
                width: 35%;
                padding: 1.5rem;
                border-right: 1px solid #e5e7eb;
                border-bottom: none;
                min-width: 300px;
            }
            .schedule-panel {
                flex-grow: 1;
                width: 65%;
                padding: 1.5rem;
                border-left: 1px solid #e5e7eb;
            }
        }
        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            border: 2px dashed #e5e7eb;
            /* Added dashed border around table */
        }
        .schedule-table th,
        .schedule-table td {
            padding: 0.4rem 0.6rem;
            vertical-align: middle;
        }
        .schedule-header th {
            background-color: #ffd966;
            /* Gold/Yellow from image */
            color: #000000;
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid #a32a2a;
        }
        .subject-cell {
            font-weight: 600;
            color: white;
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-sparkline {
            width: 100%;
            height: 1.25rem;
            background-color: #e5e7eb;
            /* Gray-200 */
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            /* Added inner shadow */
            padding: 2px;
            /* Added padding to give bars more room */
        }
        .sparkline-fill {
            height: 100%;
            background-color: #f9cb9c;
            /* Light Orange/Yellow-Orange (Placeholder, actual color set by bg-*) */
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            /* Added shadow for lift */
            border: 2px solid white;
            /* White border for definition */
            max-width: 100%;
        }

        /* Subject Colors for Schedule (used by sparkline-fill) */
        .bg-poli {
            background-color: #795548;
        }
        /* Brown */
        .bg-comm {
            background-color: #eab308;
        }
        /* Yellow */
        .bg-civ {
            background-color: #1e3a8a;
        }
        /* Blue */
        .bg-lab {
            background-color: #38761d;
        }
        /* Green */
        .bg-crim {
            background-color: #b33a3a;
        }
        /* Red */
        .bg-rem {
            background-color: #674ea7;
        }
        /* Purple */
        /* END NEW CUSTOM DASHBOARD STYLES */


        /* Syllabus Panel Common Styles */
        .syllabus-panel-container {
            border-radius: .75rem;
            overflow: hidden;
        }

        .syllabus-summary {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            list-style: none;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: space-between;
            gap: .5rem;
        }

        /* ... (rest of custom CSS, truncated for brevity) ... */
        .syllabus-sub-section {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: .5rem;
        }

        .chevron-icon {
            transition: transform .2s;
            display: inline-block;
            margin-right: .5rem;
        }

        .syllabus-sub-section[open]>details>.topic-header .chevron-icon {
            transform: rotate(90deg);
        }

        .depth2-details {
            list-style: none;
            margin-bottom: .25rem;
            border: 1px solid #f3f4f6;
            border-radius: .375rem;
            overflow: hidden;
            background-color: #fafafa;
        }

        .depth2-details>summary {
            list-style: none;
            cursor: pointer;
            padding: 0;
            background-color: #ffffff;
        }

        .depth2-details>summary::-webkit-details-marker {
            display: none;
        }

        .depth2-chevron {
            transition: transform .2s;
            transform: rotate(0deg);
            flex-shrink: 0;
            margin-right: .5rem;
        }

        .depth2-details[open] .depth2-chevron {
            transform: rotate(90deg);
        }

        .topic-content-wrapper {
            display: flex;
            align-items: flex-start;
            padding-left: .5rem;
        }

        .checklist-grid.checklist-grid-header>div:first-child {
            padding-left: 0;
            align-items: center;
            text-align: center;
        }

        .depth3-content-wrapper>div {
            display: block;
            padding: .25rem .5rem;
        }

        .checklist-grid>div:nth-child(n+2):nth-child(-n+6) {
            border-right: 1px dashed #d1d5db;
        }

        .checklist-grid>div:nth-child(6) {
            border-right: none;
        }

        .checklist-label-capsule {
            font-size: .65rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            word-break: keep-all;
            padding: .15rem .35rem;
            border-radius: 9999px;
            line-height: 1;
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, .05);
        }

        .col-progress-codal {
            background-color: #8b5cf6;
            /* Violet-500 */
        }

        .col-progress-lectures {
            background-color: #facc15;
            /* Yellow-400 (Books/Lectures) */
        }

        .col-progress-reviewer {
            background-color: #3b82f6;
            /* Blue-500 */
        }

        .col-progress-barqas {
            background-color: #10b981;
            /* Emerald-500 */
        }

        .col-progress-cases {
            background-color: #f97316;
            /* Orange-500 */
        }

        .capsule-codal {
            background-color: #8b5cf6;
        }

        .capsule-books {
            background-color: #eab308;
            /* Yellow-600 for contrast */
        }

        .capsule-reviewer {
            background-color: #3b82f6;
        }

        .capsule-barqas {
            background-color: #10b981;
        }

        .capsule-cases {
            background-color: #f97316;
        }

        .tick-all-icon {
            cursor: pointer;
            transition: color .2s, transform .2s;
            color: #9ca3af;
        }

        .tick-all-icon.checked {
            color: #10b981;
        }

        .tick-all-icon.partial {
            color: #f59e0b;
        }

        .tick-all-icon:hover {
            transform: scale(1.1);
        }

        .col-progress-bar-container {
            height: .4rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: .25rem;
            width: 100%;
        }

        .col-progress-bar {
            height: 100%;
            transition: width .3s ease-in-out;
        }

        .status-message-row {
            padding-top: .25rem;
            padding-bottom: .25rem;
        }

        .checklist-grid-micro-progress {
            padding-top: .25rem;
            padding-bottom: .5rem;
        }

        .depth3-content-wrapper .checklist-grid>div:first-child {
            grid-column: 1 / span 7;
            padding-left: 2.5rem;
        }

        .depth2-topic-row {
            grid-column: 1 / span 1;
            display: flex;
            align-items: flex-start;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-1 sm:p-2">

    <div class="max-w-6xl mx-auto space-y-2">

        <!-- 1. HEADER PANEL -->
        <header class="header-bg text-white py-3 px-4 sm:py-4 sm:px-6 rounded-xl shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex-shrink-0 w-16 h-16 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/USA.png" alt="USA Logo" class="w-full h-full object-cover" onerror="this.outerHTML = '<i data-lucide=\'graduation-cap\' class=\'w-12 h-12 text-yellow-300\'></i>'">
                </div>
                <div class="text-center mx-4 flex-grow">
                    <h1 class="text-xl sm:text-3xl font-extrabold header-font tracking-wider mb-2 underline">UNIVERSITY OF SAN AGUSTIN</h1>
                    <h2 class="text-3xl sm:text-5xl italic font-extrabold header-font tracking-widest" style="text-shadow: 2px 2px 0 #000000;">2026 COMPREHENSIVE EXAM REVIEW TRACKER</h2>
                </div>
                <div class="flex-shrink-0 w-24 h-24 flex items-center justify-center rounded-full overflow-hidden">
                    <img src="https://raw.githubusercontent.com/ariiannemay/2026-USACOL-Comprehensive-Exam-Tracker/main/usacol%20logo.png" alt="USACoL Logo" class="w-full h-full object-cover" onerror="this.outerHTML = '<i data-lucide=\'shield\' class=\'w-12 h-12 text-yellow-300\'></i>'">
                </div>
            </div>
        </header>

        <!-- 2. COUNTDOWN PANELS (Hourglass color fixed to inherited white) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="card-day-1" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <!-- Removed text-custom-yellow class from the icons -->
                <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>Comprehensive Exam Day 1<i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                <div class="p-2 text-center">
                    <div class="mb-2 flex justify-center items-center">
                        <span id="target-date-display-1" class="date-display-wrapper" data-target-date="2026-06-14"><span class="date-text"></span></span>
                    </div>
                    <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col"><span id="days-1" class="time-value">000</span><span class="time-label">Days</span></div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-1" class="time-value">00</span><span class="time-label">Hrs</span></div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-1" class="time-value">00</span><span class="time-label">Mins</span></div>
                        <div class="flex flex-col"><span id="secs-1" class="time-value">00</span><span class="time-label">Secs</span></div>
                    </div>
                </div>
            </div>
            <div id="card-day-2" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <!-- Removed text-custom-yellow class from the icons -->
                <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>Comprehensive Exam Day 2<i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                <div class="p-2 text-center">
                    <div class="mb-2 flex justify-center items-center">
                        <span id="target-date-display-2" class="date-display-wrapper" data-target-date="2026-06-21"><span class="date-text"></span></span>
                    </div>
                    <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col"><span id="days-2" class="time-value">000</span><span class="time-label">Days</span></div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-2" class="time-value">00</span><span class="time-label">Hrs</span></div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-2" class="time-value">00</span><span class="time-label">Mins</span></div>
                        <div class="flex flex-col"><span id="secs-2" class="time-value">00</span><span class="time-label">Secs</span></div>
                    </div>
                </div>
            </div>
            <div id="card-day-3" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden">
                <!-- Removed text-custom-yellow class from the icons -->
                <div class="flex items-center justify-between card-header-bg text-white p-2 text-lg font-bold text-center border-b-4 border-custom-yellow">
                    <i data-lucide="hourglass" class="w-6 h-6 mr-2"></i>Comprehensive Exam Day 3<i data-lucide="hourglass" class="w-6 h-6 ml-2"></i>
                </div>
                <div class="p-2 text-center">
                    <div class="mb-2 flex justify-center items-center">
                        <span id="target-date-display-3" class="date-display-wrapper" data-target-date="2026-06-28"><span class="date-text"></span></span>
                    </div>
                    <div class="grid grid-cols-4 py-2 border-y-2 border-dashed border-gray-300">
                        <div class="flex flex-col"><span id="days-3" class="time-value">000</span><span class="time-label">Days</span></div>
                        <div class="flex flex-col border-l-2 border-r-2 border-dashed border-gray-300"><span id="hrs-3" class="time-value">00</span><span class="time-label">Hrs</span></div>
                        <div class="flex flex-col border-r-2 border-dashed border-gray-300"><span id="mins-3" class="time-value">00</span><span class="time-label">Mins</span></div>
                        <div class="flex flex-col"><span id="secs-3" class="time-value">00</span><span class="time-label">Secs</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Overall Progress (DASHBOARD) -->
        <div id="overall-dashboard" class="bg-white rounded-xl shadow-lg border border-gray-300 p-0">
            <div class="dashboard-container">
                
                <!-- LEFT SIDE: CHART & TODAY IS -->
                <div class="chart-panel">
                    <div class="header-bg p-2 rounded-lg mb-4 text-center header-font">
                        <span class="text-xs font-light tracking-wide text-white">TODAY IS</span>
                        <!-- Date Text uses the larger 'date-text' style defined for the countdown but overrides color to white for the header -->
                        <span id="today-date-display" class="date-text text-xl font-bold block" style="color: white; text-shadow: none;"></span>
                    </div>

                    <h3 class="text-3xl font-extrabold header-font tracking-wider text-chart-title text-center mt-6 mb-4">REVIEW PROGRESS</h3>
                    
                    <!-- Chart Area -->
                    <div id="global-pie-chart" class="w-full relative mx-auto my-4" style="width: 250px; height: 250px;">
                        <!-- SVG chart will be dynamically injected here -->
                    </div>
                    
                    <!-- Progress Metrics -->
                    <div class="flex justify-around text-lg font-bold mt-4 px-2">
                        <!-- To Read Metric -->
                        <div class="text-center">
                            <div class="flex items-baseline space-x-1">
                                <span id="global-progress-toread" class="text-chart-toread text-2xl">0.0%</span>
                                <span class="text-chart-toread text-sm">TO-READ</span>
                            </div>
                            <div class="text-gray-600 font-semibold text-xs mt-1">
                                <span id="global-total-toread-count">0</span> TOPICS
                            </div>
                        </div>

                        <!-- Done Metric -->
                        <div class="text-center">
                            <div class="flex items-baseline space-x-1">
                                <span id="global-progress-done" class="text-chart-done text-2xl">0.0%</span>
                                <span class="text-chart-done text-sm">DONE</span>
                            </div>
                            <div class="text-gray-600 font-semibold text-xs mt-1">
                                <span id="global-total-done-count">0</span> TOPICS
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDE: SCHEDULE TABLE -->
                <div class="schedule-panel">
                    <h3 class="text-2xl font-extrabold header-font tracking-wider text-gray-800 mb-4 text-center">COMPREHENSIVE EXAM SCHEDULE</h3>

                    <table class="schedule-table">
                        <thead>
                            <tr class="schedule-header">
                                <th style="width: 20%;" class="border-b-2 border-r-2 border-t-2 border-l-2">DATE</th>
                                <th style="width: 45%;" class="border-b-2 border-t-2 border-r-2">SUBJECT</th>
                                <th style="width: 10%;" class="border-b-2 border-t-2 border-r-2">%</th>
                                <th style="width: 25%;" class="border-b-2 border-t-2 border-r-2">OVERALL PROGRESS*</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Day 1 -->
                            <tr class="border-b border-gray-200">
                                <td rowspan="2" class="text-center font-bold text-base border-r border-gray-300">June 14, 2026<br><span class="text-gray-500 font-normal text-xs">SUNDAY</span></td>
                                <td class="border-r border-gray-300"><div class="subject-cell bg-poli" data-subject="poli">Political and Public International Law</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">15%</td>
                                <td><div id="sparkline-poli" class="progress-bar-sparkline"><div class="sparkline-fill bg-poli" style="width: 0%;"></div></div></td>
                            </tr>
                            <tr class="border-b-2 border-gray-300/50">
                                <td class="border-r border-gray-300"><div class="subject-cell bg-comm" data-subject="comm">Commercial and Taxation Laws</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">20%</td>
                                <td><div id="sparkline-comm" class="progress-bar-sparkline"><div class="sparkline-fill bg-comm" style="width: 0%;"></div></div></td>
                            </tr>

                            <!-- Day 2 -->
                            <tr class="border-b border-gray-200">
                                <td rowspan="2" class="text-center font-bold text-base border-r border-gray-300">June 21, 2026<br><span class="text-gray-500 font-normal text-xs">SUNDAY</span></td>
                                <td class="border-r border-gray-300"><div class="subject-cell bg-civ" data-subject="civ">Civil Law and Land Titles and Deeds</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">20%</td>
                                <td><div id="sparkline-civ" class="progress-bar-sparkline"><div class="sparkline-fill bg-civ" style="width: 0%;"></div></div></td>
                            </tr>
                            <tr class="border-b-2 border-gray-300/50">
                                <td class="border-r border-gray-300"><div class="subject-cell bg-lab" data-subject="lab">Labor and Social Legislation</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">10%</td>
                                <td><div id="sparkline-lab" class="progress-bar-sparkline"><div class="sparkline-fill bg-lab" style="width: 0%;"></div></div></td>
                            </tr>

                            <!-- Day 3 -->
                            <tr class="border-b border-gray-200">
                                <td rowspan="2" class="text-center font-bold text-base border-r border-gray-300">June 28, 2026<br><span class="text-gray-500 font-normal text-xs">SUNDAY</span></td>
                                <td class="border-r border-gray-300"><div class="subject-cell bg-crim" data-subject="crim">Criminal Law</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">10%</td>
                                <td><div id="sparkline-crim" class="progress-bar-sparkline"><div class="sparkline-fill bg-crim" style="width: 0%;"></div></div></td>
                            </tr>
                            <tr>
                                <td class="border-r border-gray-300"><div class="subject-cell bg-rem" data-subject="rem">Remedial Law, Legal Ethics, & Legal Forms</div></td>
                                <td class="text-center text-gray-800 border-r border-gray-300">25%</td>
                                <td><div id="sparkline-rem" class="progress-bar-sparkline"><div class="sparkline-fill bg-rem" style="width: 0%;"></div></div></td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="text-xs italic text-gray-600 text-right mt-2">* INCLUDING BOOK/LECTURES, CODAL, REVIEWER, LMTS, AND SAMPLES/CASES</p>
                </div>

            </div>
        </div>

        <!-- 4. SUBJECT TRACKERS (Dynamic Content) -->
        <div id="subject-trackers-container" class="space-y-4">
            <!-- Subject panels will be dynamically injected here by the JS modules in this order: rem, crim, lab, civ, comm, poli -->
            <div id="subject-tracker-panel-rem"></div>
            <div id="subject-tracker-panel-crim"></div>
            <div id="subject-tracker-panel-lab"></div>
            <div id="subject-tracker-panel-civ"></div>
            <div id="subject-tracker-panel-comm"></div>
            <div id="subject-tracker-panel-poli"></div> 
        </div>
        
    </div>

    <!-- Modals (Date Edit & Message) -->
    <div id="date-edit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4">Edit Target Date</h3>
            <label for="new-target-date" class="block text-sm font-medium text-gray-700 mb-2">Select New Date:</label>
            <input type="date" id="new-target-date" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
            <p id="modal-error" class="text-sm text-red-600 hidden mb-4">Please select a future date.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-upload-input" accept=".json" class="hidden">

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-96 max-w-sm">
            <h3 id="message-modal-title" class="text-xl font-bold text-gray-900 mb-4">Message</h3>
            <div id="message-modal-content" class="text-sm text-gray-700 mb-4 break-words"></div>
            <div id="modal-actions" class="flex justify-end space-x-3 mt-4">
                <button id="message-modal-close-btn" class="px-3 py-1.5 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <!-- Dynamic JavaScript Loader and Core Logic -->
    <script>
        // --- CORE UTILITY AND COUNTDOWN LOGIC (REMAINS IN INDEX) ---
        
        const CHECKLIST_COLUMNS = ['codal', 'books', 'reviewer', 'barqas', 'cases'];
        const COUNTDOWN_DATA = [
            {id:1,targetDate:localStorage.getItem('comp_exam_date_1')||'2026-06-14'},
            {id:2,targetDate:localStorage.getItem('comp_exam_date_2')||'2026-06-21'},
            {id:3,targetDate:localStorage.getItem('comp_exam_date_3')||'2026-06-28'}
        ];
        
        const DOM_ELEMENTS = {
            modal: document.getElementById('date-edit-modal'),
            modalTitle: document.getElementById('modal-title'),
            dateInput: document.getElementById('new-target-date'),
            saveBtn: document.getElementById('modal-save-btn'),
            cancelBtn: document.getElementById('modal-cancel-btn'),
            errorMsg: document.getElementById('modal-error'),
            fileUploadInput: document.getElementById('file-upload-input'),
            messageModal: document.getElementById('message-modal'),
            messageModalTitle: document.getElementById('message-modal-title'),
            messageModalContent: document.getElementById('message-modal-content'),
            messageModalCloseBtn: document.getElementById('message-modal-close-btn'),
            subjectContainer: document.getElementById('subject-trackers-container')
        };
        
        let currentEditingId = null;
        const SUBJECT_LOGIC_MAP = {}; // Map to store subject logic objects after loading

        // Utility Functions
        function formatUniqueDate(dateString){if(!dateString)return'';const date=new Date(dateString+'T00:00:00');return date.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}).toUpperCase();}
        function formatNumber(num){return num.toString().padStart(num>=100?3:2,'0');}
        function downloadFile(data,filename,type){const blob=new Blob([data],{type:type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
        function showMessageModal(title,content){
            const modal=DOM_ELEMENTS.messageModal;
            const titleEl=DOM_ELEMENTS.messageModalTitle;
            const contentEl=DOM_ELEMENTS.messageModalContent;
            if(titleEl)titleEl.textContent=title;
            if(contentEl)contentEl.innerHTML=content;
            
            const actionsEl=document.getElementById('modal-actions');
            if(actionsEl){
                actionsEl.innerHTML=`\n<button id="message-modal-close-btn" class="px-3 py-1.5 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Close</button>\n`;
                document.getElementById('message-modal-close-btn')?.addEventListener('click', closeMessageModal);
            }
            if(modal){
                modal.classList.remove('hidden');
                modal.style.display='flex';
            }
        }
        function closeMessageModal(){DOM_ELEMENTS.messageModal.classList.add('hidden');DOM_ELEMENTS.messageModal.style.display='none';}
        
        // Countdown Logic
        function calculateCountdown(targetDateString,id){const now=new Date();const target=new Date(targetDateString+'T00:00:00Z');if(target<=now){const elements=[`days-${id}`,`hrs-${id}`,`mins-${id}`,`secs-${id}`];elements.forEach(elId=>{const el=document.getElementById(elId);if(el)el.textContent=elId===`days-${id}`?'000':'00';});return;}const diffInMilliseconds=target-now;const days=Math.floor(diffInMilliseconds/(1000*60*60*24));const hours=Math.floor(diffInMilliseconds%(1000*60*60*24)/(1000*60*60));const minutes=Math.floor(diffInMilliseconds%(1000*60*60)/(1000*60));const seconds=Math.floor(diffInMilliseconds%(1000*60)/1000);document.getElementById(`days-${id}`).textContent=formatNumber(days);document.getElementById(`hrs-${id}`).textContent=formatNumber(hours);document.getElementById(`mins-${id}`).textContent=formatNumber(minutes);document.getElementById(`secs-${id}`).textContent=formatNumber(seconds);}
        function updateAllCountdowns(){COUNTDOWN_DATA.forEach(data=>{calculateCountdown(data.targetDate,data.id);});}
        function openModal(id){currentEditingId=id;const data=COUNTDOWN_DATA.find(d=>d.id===id);document.getElementById('modal-title').textContent=`Edit Target Date - Day ${id}`;document.getElementById('new-target-date').value=data.targetDate;document.getElementById('modal-error').classList.add('hidden');document.getElementById('date-edit-modal').classList.remove('hidden');document.getElementById('date-edit-modal').style.display='flex';}
        function closeModal(){document.getElementById('date-edit-modal').classList.add('hidden');document.getElementById('date-edit-modal').style.display='none';currentEditingId=null;}
        function saveModal(){const newDateString=document.getElementById('new-target-date').value;const newDate=new Date(newDateString);const now=new Date();if(newDate<=now||!newDateString){document.getElementById('modal-error').textContent="Please select a future date.";document.getElementById('modal-error').classList.remove('hidden');return;}const data=COUNTDOWN_DATA.find(d=>d.id===currentEditingId);if(data){data.targetDate=newDateString;document.querySelector(`#target-date-display-${currentEditingId} .date-text`).textContent=formatUniqueDate(newDateString);localStorage.setItem(`comp_exam_date_${currentEditingId}`,newDateString);updateAllCountdowns();}closeModal();}
        
        // Global File Upload Handler (Used by all subject modules)
        function handleFileUpload(event){
            const file = event.target.files[0];
            const targetSubject = event.target.dataset.targetSubject;
            
            if (file && targetSubject && SUBJECT_LOGIC_MAP[targetSubject]) {
                SUBJECT_LOGIC_MAP[targetSubject].processImport(file);
            } else if (!file) {
                showMessageModal("Upload Canceled", "No file was selected for upload.");
            } else {
                showMessageModal("Upload Error", "Could not determine the target subject for the upload.");
            }
            event.target.value = '';
        }

        // Subject Logic Loader
        function loadSubjectPanel(subjectName, filePath) {
            const script = document.createElement('script');
            script.src = filePath;
            script.type = 'text/javascript';
            script.onload = () => {
                // Ensure the logic function is defined globally by the loaded script
                if (window[`create${subjectName.toUpperCase()}_LOGIC`]) {
                    const logic = window[`create${subjectName.toUpperCase()}_LOGIC`]();
                    SUBJECT_LOGIC_MAP[subjectName] = logic;
                    
                    // The logic.render() function inside the factory will handle injecting the content 
                    // by replacing the placeholder div's outerHTML with the actual content.
                    
                    logic.render();
                    // Attach event listeners for buttons that are now in the DOM
                    document.getElementById(`export-progress-btn-${subjectName}`)?.addEventListener('click', logic.exportProgress);
                    document.getElementById(`import-progress-btn-${subjectName}`)?.addEventListener('click', logic.importProgress);
                    document.getElementById(`collapse-all-btn-${subjectName}`)?.addEventListener('click', logic.toggleAllSections);
                } else {
                    console.error(`Failed to find initialization function for ${subjectName}`);
                }
            };
            document.head.appendChild(script);
        }

        // --- GLOBAL DASHBOARD LOGIC (Replicated from image) ---

        function drawPieChart(donePercent) {
            const chartEl = document.getElementById('global-pie-chart');
            if (!chartEl) return;

            const size = 250;
            const radius = size / 2;
            const strokeWidth = 50;
            const halfSize = size / 2;
            const center = halfSize;
            
            // Background ring (Gray)
            const circumference = 2 * Math.PI * (radius - strokeWidth / 2);
            
            // Done arc (Green)
            const doneOffset = circumference * (1 - (donePercent / 100));

            // To-Read arc (Light Green)
            const toReadOffset = circumference * (1 - ((100 - donePercent) / 100));


            chartEl.innerHTML = `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                    <!-- Background Circle -->
                    <circle 
                        cx="${center}" 
                        cy="${center}" 
                        r="${radius - strokeWidth / 2}" 
                        fill="none" 
                        stroke="#e5e7eb" 
                        stroke-width="${strokeWidth}"
                    />
                    
                    <!-- Done Arc (Green) -->
                    <circle
                        class="ring-done"
                        cx="${center}"
                        cy="${center}"
                        r="${radius - strokeWidth / 2}"
                        fill="none"
                        stroke="#38761d" 
                        stroke-width="${strokeWidth}"
                        stroke-dasharray="${circumference}"
                        stroke-dashoffset="${doneOffset}"
                        transform="rotate(-90 ${center} ${center})"
                        stroke-linecap="round"
                    />

                    <!-- To-Read Arc (Olive Green) -->
                    <circle
                        class="ring-toread"
                        cx="${center}"
                        cy="${center}"
                        r="${radius - strokeWidth / 2}"
                        fill="none"
                        stroke="#93c47d" 
                        stroke-width="${strokeWidth}"
                        stroke-dasharray="${circumference}"
                        stroke-dashoffset="${toReadOffset}"
                        transform="rotate(${-90 + (donePercent * 3.6)} ${center} ${center})"
                        stroke-linecap="round"
                    />

                    <!-- Inner Circle (White background for text) -->
                    <circle 
                        cx="${center}" 
                        cy="${center}" 
                        r="${radius - strokeWidth}" 
                        fill="white"
                    />
                    
                    <!-- Inner Percentage Text -->
                    <text 
                        x="${center}" 
                        y="${center}" 
                        text-anchor="middle" 
                        alignment-baseline="central" 
                        font-size="2.5rem" 
                        font-weight="900" 
                        fill="#38761d" /* MODIFIED: Used DONE color for primary percentage */
                        font-family="Bebas Neue, sans-serif" 
                        style="text-shadow: 1px 1px 0 #000000;"
                    >
                        ${(donePercent).toFixed(0)}%
                    </text>
                </svg>

                <!-- Status labels for outer display (Replicating image style) -->
                <div style="position: absolute; top: 35px; right: 20px; color: #38761d; font-weight: bold; font-size: 0.9rem; transform: rotate(10deg);">DONE</div>
                <div style="position: absolute; bottom: 35px; left: 20px; color: #93c47d; font-weight: bold; font-size: 0.9rem; transform: rotate(-10deg);">TO-READ</div>
            `;
        }

        function updateOverallDashboard() {
            // Display today's date
            const today = new Date();
            document.getElementById('today-date-display').textContent = formatUniqueDate(today.toISOString().split('T')[0]);

            let totalTrackableTopics = 0;
            let totalDoneTopics = 0;
            let totalToReadTopics = 0;


            // 1. Calculate Global Progress from all subject modules
            Object.values(SUBJECT_LOGIC_MAP).forEach(logic => {
                const subjectName = logic.SUBJECT_NAME;
                const progress = logic.getProgress();
                const syllabusData = logic.SYLLABUS_DATA;
                
                // Use the same definition of trackable topics (depth 2 and trackable: true)
                const mainTopics = syllabusData.filter(t => t.depth === 2 && t.trackable);
                const currentSubjectTrackable = mainTopics.length;
                let currentSubjectDone = 0;

                mainTopics.forEach(topic => {
                    const topicProgress = progress[topic.id] || {};
                    const boxesTicked = CHECKLIST_COLUMNS.filter(col => topicProgress[col] === true).length;
                    
                    if (boxesTicked >= 3) {
                        currentSubjectDone++;
                    }
                });

                totalTrackableTopics += currentSubjectTrackable;
                totalDoneTopics += currentSubjectDone;
                
                // 2. Update Sparkline for each subject
                const currentSubjectToRead = currentSubjectTrackable - currentSubjectDone;
                
                const subjectProgressPercentage = currentSubjectTrackable > 0 ? ((currentSubjectDone / currentSubjectTrackable) * 100) : 0;
                const sparklineEl = document.querySelector(`#sparkline-${subjectName} .sparkline-fill`);
                if (sparklineEl) {
                    sparklineEl.style.width = `${subjectProgressPercentage.toFixed(1)}%`;
                }
            });

            totalToReadTopics = totalTrackableTopics - totalDoneTopics;


            // 3. Update Chart and Metrics
            const donePercent = totalTrackableTopics > 0 ? (totalDoneTopics / totalTrackableTopics) * 100 : 0;
            const toReadPercent = 100 - donePercent;

            drawPieChart(donePercent);

            // Update display metrics (DONE / TO READ)
            document.getElementById('global-progress-done').textContent = `${donePercent.toFixed(1)}%`;
            document.getElementById('global-total-done-count').textContent = totalDoneTopics;
            
            document.getElementById('global-progress-toread').textContent = `${toReadPercent.toFixed(1)}%`;
            document.getElementById('global-total-toread-count').textContent = totalToReadTopics;
        }

        // Expose function globally
        window.updateOverallDashboard = updateOverallDashboard;
        
        // --- GLOBAL SYLLABUS LOGIC FACTORY (Modified to call updateOverallDashboard) ---
        window.createSyllabusLogic = function(subjectName, syllabusData, storageKey, themeIcon, title) {
            // ... (rest of factory logic remains the same) ...

            function getProgress() {
                try {
                    const saved = localStorage.getItem(storageKey);
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.error(`Error loading ${subjectName} progress:`, e);
                    return {};
                }
            }

            function saveProgress(progressData) {
                localStorage.setItem(storageKey, JSON.stringify(progressData));
                updateOverallProgress();
                // IMPORTANT: Call global dashboard update after local progress changes
                window.updateOverallDashboard(); 
            }
            
            // ***************************************************************
            // FIX: Ensure getPanelHtml first injects the placeholder div 
            //      if it doesn't exist, which should be handled by the external JS
            //      but we add a fallback for initial stability.
            // ***************************************************************
            function renderSyllabusPanel() {
                 const syllabusContainer = document.getElementById(`syllabus-${subjectName}`);
                 const panelContainer = document.getElementById(`subject-tracker-panel-${subjectName}`);
                 
                 // FIX START: If the panel container doesn't exist, we must inject the full HTML
                 // The previous version of this logic was removed from index.html,
                 // but the external JS files depend on calling getPanelHtml/render 
                 // to inject content into the *placeholder divs* in the body.
                 
                 // Re-add logic to handle initial content injection by the external files.
                 // This mirrors the logic stripped from the original files which relied on direct document.write/innerHTML.

                 if (!panelContainer || !syllabusContainer) {
                     const container = document.getElementById('subject-trackers-container');
                     if (container) {
                         const existingPlaceholder = document.getElementById(`subject-tracker-panel-${subjectName}`);
                         if (existingPlaceholder) {
                            // Inject actual panel content by replacing the placeholder div
                            existingPlaceholder.outerHTML = getPanelHtml(subjectName, title, themeIcon);
                            // Rerun render logic after injection to populate the content fully (recursion handles the rest)
                            return renderSyllabusPanel();
                         }
                     }
                     return;
                 }
                // FIX END
                 


                 const topicWithChildren = (function() {
                     const children = new Set();
                     syllabusData.forEach((item, index) => {
                         const nextItem = syllabusData[index + 1];
                         if (nextItem && nextItem.depth > item.depth) {
                             children.add(item.id);
                         }
                     });
                     return children;
                 })();

                 function hasChildren(topicId) {
                     return topicWithChildren.has(topicId);
                 }
                
                // 1. Capture current open states to preserve them across re-render
                const openSections = {};
                document.querySelectorAll(`#syllabus-${subjectName} details`).forEach(details => {
                    if (details.id) {
                        openSections[details.id] = details.open;
                    }
                });

                const progress = getProgress();
                let html = '';
                let currentSectionOpen = false;
                let isDepth2Open = false;
                
                const checkboxClass = `syllabus-checkbox-${subjectName}`;
                
                syllabusData.forEach((item, index) => {
                    const topicId = item.id;
                    const nextItem = syllabusData[index + 1];
                    const currentStatus = getTopicStatus(topicId, progress);
                    const iconName = currentStatus === 2 ? 'check-circle-2' : (currentStatus === 1 ? 'circle-half' : 'circle');
                    const iconColor = currentStatus === 2 ? 'checked' : (currentStatus === 1 ? 'partial' : 'empty');
                    const iconSize = item.depth === 1 ? 'w-5 h-5' : 'w-4 h-4';
                    const iconTitle = currentStatus === 2 ? 'Clear All' : (currentStatus === 1 ? 'Clear All' : 'Tick All');

                    const isTopLevelTopic = item.depth === 1;

                    if (isTopLevelTopic) {
                        if (isDepth2Open) { html += `</div></details></div>`; isDepth2Open = false; }
                        if (currentSectionOpen) { html += `</div></details></div>`; }
                        
                        const sectionId = `${subjectName}-section-${item.id}`;
                        // This ensures default state is collapsed unless explicitly saved as open
                        const isOpen = openSections[sectionId] === true; 
                        const openAttr = isOpen ? 'open' : '';
                        
                        html += `\n<div class="syllabus-sub-section"><details id="${sectionId}" class="w-full" ${openAttr}><summary class="topic-header"><div class="topic-header-text"><i data-lucide="chevron-right" class="w-4 h-4 mr-2 chevron-icon"></i><span class="font-extrabold text-lg text-black/90">${item.topic}</span></div><i data-lucide="${iconName}" class="tick-all-icon ${iconColor} ${iconSize} flex-shrink-0" title="${iconTitle}" onclick="window.handleTickAll${subjectName.toUpperCase()}(${item.id}); event.stopPropagation(); event.preventDefault();"></i></summary><div class="p-2">\n`;
                        currentSectionOpen = true;
                    } else if (item.depth === 2 && item.trackable) {
                        const topicProgress = progress[topicId] || {};
                        const isCollapsible = hasChildren(topicId);

                        if (isDepth2Open && !isCollapsible) { html += `</div></details></div>`; isDepth2Open = false; }

                        const checklist = CHECKLIST_COLUMNS.map(col => {
                            const checked = topicProgress[col] === true ? 'checked' : '';
                            return `\n<div class="flex justify-center"><input type="checkbox" data-id="${topicId}" data-column="${col}" ${checked} class="w-4 h-4 border-gray-300 rounded focus:ring-500 ${checkboxClass}" onchange="window.handleCheckboxChange${subjectName.toUpperCase()}(event)"></div>\n`;
                        }).join('');

                        let rowContent = `\n
                            <div class="col-span-1 font-trackable-lg depth2-topic-row">
                                <div class="topic-content-wrapper" style="padding-left: 1.5rem;">
                                    ${isCollapsible ? `<i data-lucide="chevron-right" class="w-3 h-3 depth2-chevron"></i>` : `<span class="w-3 h-3 mr-2 inline-block"></span>`}${item.topic}
                                </div>
                            </div>
                            ${checklist}
                            <div class="flex items-center justify-center space-x-1 pl-2"><i data-lucide="${iconName}" class="tick-all-icon w-4 h-4 ${iconColor}" title="${iconTitle}" onclick="window.handleTickAll${subjectName.toUpperCase()}(${item.id}); event.stopPropagation(); event.preventDefault();"></i></div>\n
                        `;

                        if (isCollapsible) {
                            const depth2Id = `${subjectName}-depth2-${item.id}`;
                            const isOpen = openSections[depth2Id] === true;
                            const openAttr = isOpen ? 'open' : '';
                            html += `<div class="depth2-details"><details id="${depth2Id}" class="w-full" ${openAttr}><summary class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</summary><div class="depth3-content-wrapper pt-1 pb-2">`;
                            isDepth2Open = true;
                        } else {
                            html += `<div class="checklist-grid hover:bg-gray-50/50 transition">${rowContent}</div>`;
                        }

                    } else if (item.depth >= 3) {
                        const dynamicPadding = (item.depth - 2) * 1.5 + 1.5;
                        const fontStyle = item.depth <= 4 ? 'font-medium' : 'font-normal';
                        
                        if (isDepth2Open) {
                             html += `<div class="p-1 border-b border-black/10 text-black/70 italic ${fontStyle} text-sm" style="padding-left: ${dynamicPadding}rem;">${item.topic}</div>`;
                        } else {
                            html += `<div class="checklist-grid hover:bg-gray-50/50 transition"><div>${item.topic}</div></div>`;
                        }
                    }

                    if (item.depth >= 3 && isDepth2Open && (!nextItem || nextItem.depth <= 2)) { html += `</div></details></div>`; isDepth2Open = false; }
                });

                if (currentSectionOpen) {
                    if (isDepth2Open) { html += `</div></details></div>`; }
                    html += `</div></details></div>`;
                }

                syllabusContainer.innerHTML = html;
                
                if (lucide && lucide.createIcons) {
                    lucide.createIcons();
                }
                updateOverallProgress();
                updateCollapseButtonText();
            }

            function handleCheckboxChange(event) {
                 const checkbox = event.target;
                 const id = checkbox.dataset.id;
                 const column = checkbox.dataset.column;
                 const isChecked = checkbox.checked;
                 const progressData = getProgress();
                 if (!progressData[id]) {
                     progressData[id] = {};
                 }
                 progressData[id][column] = isChecked;
                 saveProgress(progressData);
                 renderSyllabusPanel(); 
            }
            
            function handleTickAll(topicId) {
                 const progressData = getProgress();
                 let topicsToUpdate = [];
                 const currentStatus = getTopicStatus(topicId, progressData);
                 const targetState = currentStatus === 2 ? false : true; 
                 const item = syllabusData.find(t => t.id === topicId);
                 if (!item) return;
                 
                 const startDepth = item.depth;
                 const startIndex = syllabusData.findIndex(t => t.id === topicId);
                 
                 if (startDepth === 2 && item.trackable) {
                     topicsToUpdate.push(item);
                 } else if (startDepth === 1) {
                     for (let i = startIndex; i < syllabusData.length; i++) {
                         const currentItem = syllabusData[i];
                         if (i > startIndex && currentItem.depth <= startDepth) break;
                         if (currentItem.depth === 2 && currentItem.trackable) {
                             topicsToUpdate.push(currentItem);
                         }
                     }
                 }
                 
                 topicsToUpdate.forEach(topic => {
                     const id = topic.id;
                     if (!progressData[id]) {
                         progressData[id] = {};
                     }
                     CHECKLIST_COLUMNS.forEach(col => {
                         progressData[id][col] = targetState;
                     });
                 });
                 saveProgress(progressData);
                 renderSyllabusPanel();
            }

            function exportProgress() {
                const progressData = localStorage.getItem(storageKey);
                if (!progressData || '{}' === progressData) {
                    showMessageModal("Download Failed", `<p class='text-red-600'>No ${title} progress data found to download.</p>`);
                    return;
                }
                downloadFile(progressData, `${subjectName}-progress.json`, 'application/json');
                showMessageModal("Download Complete", `<p class='text-green-600'>Your ${title} progress has been downloaded as **${subjectName}-progress.json**</p>`);
            }

            function triggerImport() {
                 DOM_ELEMENTS.fileUploadInput.dataset.targetSubject = subjectName;
                 DOM_ELEMENTS.fileUploadInput.click();
            }

            function processImport(file) {
                 if (!file) { showMessageModal("Upload Canceled", "No file was selected for upload."); return; }
                 if ('application/json' !== file.type && !file.name.endsWith('.json')) { showMessageModal("Upload Error", `<p class='text-red-600'>Invalid file type. Please upload a **.json** file.</p>`); return; }
                 
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const jsonString = e.target.result;
                     try {
                         const importedData = JSON.parse(jsonString);
                         if ('object' !== typeof importedData || null === importedData) { throw new Error("Invalid JSON structure."); }
                         saveProgress(importedData);
                         renderSyllabusPanel();
                         showMessageModal("Success!", `<p class='text-green-600'>${title} progress successfully uploaded and applied.</p>`);
                     } catch (e) {
                         console.error("Import error:", e);
                         showMessageModal("Upload Error", `<p class='text-red-600'>Failed to upload. The file content is not valid JSON.</p>`);
                     }
                 };
                 reader.onerror = function() { showMessageModal("Upload Error", `<p class='text-red-600'>Error reading the file.</p>`); };
                 reader.readAsText(file);
            }

            function toggleAllSections() {
                const allDetails = document.querySelectorAll(`#subject-tracker-panel-${subjectName} details`);
                
                let shouldOpen = false;
                for (const details of allDetails) {
                    if (!details.open) {
                        shouldOpen = true;
                        break;
                    }
                }
                allDetails.forEach(details => {
                    details.open = shouldOpen;
                });
                
                if (lucide && lucide.createIcons) {
                    lucide.createIcons();
                }
                updateCollapseButtonText(shouldOpen);
            }

            function updateCollapseButtonText(isOpen) {
                const btn = document.getElementById(`collapse-all-btn-${subjectName}`);
                if (btn) {
                    if (typeof isOpen === 'undefined') {
                        const allDetails = document.querySelectorAll(`#subject-tracker-panel-${subjectName} details`);
                        let allOpen = true;
                        for (const details of allDetails) {
                            if (!details.open) {
                                allOpen = false;
                                break;
                            }
                        }
                        isOpen = allOpen;
                    }
                    const iconName = isOpen ? 'chevrons-up' : 'chevrons-down';
                    const text = isOpen ? 'Collapse All' : 'Expand All';
                    btn.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4 mr-1"></i> ${text}`;
                    if (!btn.classList.contains('flex')) { btn.classList.add('flex', 'items-center', 'justify-center'); }
                    if (lucide && lucide.createIcons) { lucide.createIcons(); }
                }
            }
            
            // Attach unique global handlers for onclick/onchange HTML events
            window[`handleTickAll${subjectName.toUpperCase()}`] = handleTickAll;
            window[`handleCheckboxChange${subjectName.toUpperCase()}`] = handleCheckboxChange;

            function getPanelHtml(subjectName, title, icon) {
                const themeClass = `syllabus-panel-${subjectName}`;
                // Using subject-specific theme classes for the expand button
                const bgButton = subjectName === 'rem' ? 'bg-purple-600' : (subjectName === 'crim' ? 'bg-red-600' : (subjectName === 'lab' ? 'bg-lab-button' : (subjectName === 'civ' ? 'bg-civ-button' : (subjectName === 'comm' ? 'bg-comm-button' : 'bg-poli-button'))));
                const hoverButton = subjectName === 'rem' ? 'hover:bg-purple-700' : (subjectName === 'crim' ? 'hover:bg-red-700' : (subjectName === 'lab' ? 'hover:bg-lab-button-dark' : (subjectName === 'civ' ? 'hover:bg-civ-button-dark' : (subjectName === 'comm' ? 'hover:bg-comm-button-dark' : 'hover:bg-poli-button-dark'))));
                
                return `
                <div class="bg-white rounded-xl shadow-lg border border-gray-300 mt-4 syllabus-panel-container ${themeClass}" id="subject-tracker-panel-${subjectName}">
                    <details class="syllabus-panel">
                        <summary class="syllabus-summary" id="summary-${subjectName}">
                            <div class="syllabus-summary-title-row">
                                <div class="flex items-center">
                                    <i data-lucide="${icon}" class="w-6 h-6 mr-3"></i>${title}
                                </div>
                                <div class="flex items-center text-xs">
                                    (${title.match(/\((.*?)\)/)?.[1] || '0%'} of Total)
                                    <i data-lucide="chevron-right" class="w-6 h-6 ml-2 main-summary-chevron"></i>
                                </div>
                            </div>
                            <div class="syllabus-progress-metrics text-xs">
                                <div class="progress-stats">
                                    <span class="flex items-center"><i data-lucide="check-circle-2" class="w-4 h-4 mr-1 text-gray-200"></i>DONE:&nbsp;<span id="progress-done-${subjectName}">0</span>&nbsp;TOPICS</span>
                                    <span class="flex items-center"><i data-lucide="book-open-text" class="w-4 h-4 mr-1 text-gray-200"></i>TO READ:&nbsp;<span id="progress-toread-${subjectName}">0</span>&nbsp;TOPICS</span>
                                </div>
                                <div class="flex items-center space-x-2 flex-grow min-w-[200px]">
                                    <span class="progress-overall-text flex items-center"><i data-lucide="chart-spline" class="w-4 h-4 mr-1"></i>OVERALL PROGRESS:</span>
                                    <div class="progress-bar-container">
                                        <div id="progress-bar-${subjectName}" class="progress-bar" style="width: 0%;"></div>
                                    </div>
                                    <span id="progress-${subjectName}" class="progress-percent-bold">(0.0%)</span>
                                </div>
                            </div>
                        </summary>
                        <div class="syllabus-content">
                            <div class="w-full flex flex-col md:flex-row justify-between items-start md:items-center gap-2 status-message-row border-b border-gray-200">
                                <div class="text-xs font-semibold text-gray-700 italic leading-snug flex-grow pt-0 whitespace-nowrap">Overall progress only counts if at least 3 checklist boxes are marked for each topic row.</div>
                                <div class="flex flex-wrap gap-2">
                                    <button id="import-progress-btn-${subjectName}" class="px-3 py-1 text-xs font-semibold text-gray-700 bg-white rounded-lg border border-gray-300 shadow-sm hover:bg-gray-100 transition duration-150 whitespace-nowrap"><i data-lucide="upload" class="w-4 h-4 mr-1 inline-block"></i> Upload Progress</button>
                                    <button id="export-progress-btn-${subjectName}" class="px-3 py-1 text-xs font-semibold text-gray-700 bg-white rounded-lg border border-gray-300 shadow-sm hover:bg-gray-100 transition duration-150 whitespace-nowrap"><i data-lucide="download" class="w-4 h-4 mr-1 inline-block"></i> Download Progress</button>
                                    <button id="collapse-all-btn-${subjectName}" class="px-3 py-1 text-xs font-semibold text-white ${bgButton} rounded-lg shadow-md ${hoverButton} transition duration-150 whitespace-nowrap"><i data-lucide="chevrons-up" class="w-4 h-4 mr-1"></i> Collapse All</button>
                                </div>
                            </div>
                            <div class="checklist-grid checklist-grid-header mt-1 font-bold text-xs text-center border-b-2 border-black/50">
                                <div>SUBJECTS/TOPICS</div>
                                <div class="flex items-center justify-center"><span class="checklist-label-capsule capsule-codal">Codal</span></div>
                                <div class="flex items-center justify-center"><span class="checklist-label-capsule capsule-books">Books</span></div>
                                <div class="flex items-center justify-center"><span class="checklist-label-capsule capsule-reviewer">Reviewer</span></div>
                                <div class="flex items-center justify-center"><span class="checklist-label-capsule capsule-barqas">Bar QAs</span></div>
                                <div class="flex items-center justify-center"><span class="checklist-label-capsule capsule-cases">Cases</span></div>
                                <div></div>
                            </div>
                            <div class="checklist-grid checklist-grid-micro-progress text-center border-t border-gray-300">
                                <div></div>
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-codal" class="col-progress-bar col-progress-codal" style="width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-codal" class="text-xs font-semibold mt-1 text-violet-700">0.0%</span>
                                </div>
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-books" class="col-progress-bar col-progress-lectures" style="width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-books" class="text-xs font-semibold mt-1 text-yellow-700">0.0%</span>
                                </div>
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-reviewer" class="col-progress-bar col-progress-reviewer" style="width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-reviewer" class="text-xs font-semibold mt-1 text-blue-700">0.0%</span>
                                </div>
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-barqas" class="col-progress-bar col-progress-barqas" style="width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-barqas" class="text-xs font-semibold mt-1 text-green-700">0.0%</span>
                                </div>
                                <div class="px-1 flex flex-col items-center justify-start">
                                    <div class="col-progress-bar-container">
                                        <div id="col-progress-bar-${subjectName}-cases" class="col-progress-bar col-progress-cases" style="width: 0%;"></div>
                                    </div>
                                    <span id="col-percent-${subjectName}-cases" class="text-xs font-semibold mt-1 text-orange-700">0.0%</span>
                                </div>
                                <div></div>
                            </div>
                            <div id="syllabus-${subjectName}" class="text-xs"></div>
                        </div>
                    </details>
                </div>
                `;
            }


            return {
                SUBJECT_NAME: subjectName,
                SUBJECT_TITLE: title,
                SUBJECT_ICON: themeIcon,
                SYLLABUS_DATA: syllabusData, // Expose syllabus data for global calculation
                getProgress: getProgress, // Expose getProgress for global aggregation
                render: renderSyllabusPanel,
                updateOverallProgress: updateOverallProgress,
                exportProgress: exportProgress,
                importProgress: triggerImport,
                processImport: processImport,
                toggleAllSections: toggleAllSections,
                getPanelHtml: getPanelHtml
            };
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            // 1. Initialize Countdown Dates
            COUNTDOWN_DATA.forEach(data => {
                const savedDate = localStorage.getItem(`comp_exam_date_${data.id}`);
                const finalDate = savedDate || data.targetDate;
                if (finalDate) {
                    data.targetDate = finalDate;
                    document.querySelector(`#target-date-display-${data.id} .date-text`).textContent = formatUniqueDate(finalDate);
                }
            });

            // 2. Load Subject Panels (This is the load sequence, ensuring the correct order)
            loadSubjectPanel('rem', 'rem_logic.js');
            loadSubjectPanel('crim', 'crim_logic.js');
            loadSubjectPanel('lab', 'lab_logic.js');
            loadSubjectPanel('civ', 'civ_logic.js');
            loadSubjectPanel('comm', 'comm_logic.js');
            loadSubjectPanel('poli', 'poli_logic.js');
            
            // 3. Initialize Lucide Icons for static content
            if (lucide && lucide.createIcons) {
                lucide.createIcons();
            }

            // 4. Attach General Event Listeners
            updateAllCountdowns();
            setInterval(updateAllCountdowns, 1000);
            
            // Call once initially, and rely on subject logic to call on subsequent changes
            // Moved to the bottom of the load process to ensure all modules are registered first
            setTimeout(window.updateOverallDashboard, 500); 
            
            document.getElementById('target-date-display-1').addEventListener('click', () => openModal(1));
            document.getElementById('target-date-display-2').addEventListener('click', () => openModal(2));
            document.getElementById('target-date-display-3').addEventListener('click', () => openModal(3));
            document.getElementById('modal-save-btn').addEventListener('click', saveModal);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            DOM_ELEMENTS.fileUploadInput.addEventListener('change', handleFileUpload);
            document.getElementById('message-modal-close-btn')?.addEventListener('click', closeMessageModal);
        };
    </script>
</body>
</html>
